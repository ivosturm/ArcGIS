// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.
//>>built
define("esri/PopupInfo","dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/_base/json dojo/i18n dojo/has dojo/Deferred dojo/sniff dojo/promise/all dojox/html/entities ./lang ./kernel ./request ./promiseList ./ArcadeExpression ./tasks/query ./tasks/QueryTask ./tasks/RelationshipQuery ./tasks/StatisticDefinition ./arcadeProfiles/popupProfile ./layers/support/attributeUtils dojo/i18n!dojo/cldr/nls/number".split(" "),function(u,m,k,E,Q,I,J,K,A,L,q,F,M,B,N,z,G,O,P,C,R,H){u=u(null,{declaredClass:"esri.PopupInfo",
_reNewline:/(\n)/ig,_reExprField:/^\s*expression\//i,_reExprFieldPattern:/\{expression\/([^\}]+)\}/ig,_exprPrefix:"expression/",_relatedFieldPrefix:"relationships/",initialize:function(a,b){if(a){m.mixin(this,b);this.info=a;this.title=this.getTitle;this.content=this.getContent;this._exprCache=this._compileExpressions(this.info.expressionInfos);var c=this._fieldLabels={},d=this._fieldsMap={};this.info.fieldInfos&&k.forEach(this.info.fieldInfos,function(a){var b=a.fieldName.toLowerCase(),e=this._isExpressionField(b)?
this.getExpressionInfo(b):null;c[b]=e?e.title:a.label;d[b]=a},this);this.titleHasRelatedFields=!(!this.info.title||-1===this.info.title.indexOf("{"+this._relatedFieldPrefix));this.titleHasAsyncExpressions=this._titleHasAsyncExpressions();this.contentHasAsyncExpressions=this._contentHasAyncExpressions()}},toJson:function(){return E.fromJson(E.toJson(this.info))},getTitle:function(){},getContent:function(){},getFieldInfo:function(a){var b;k.some(this.info&&this.info.fieldInfos,function(c){c.fieldName===
a&&(b=c);return!!b});return b},getExpressionInfo:function(a){if(a=this._getExprField(a)){a=a.toLowerCase();var b;k.some(this.info.expressionInfos,function(c){c.name.toLowerCase()===a&&(b=c);return!!b});return b}},getExpressionFieldsInTitle:function(){return this._getExprFieldsFromTemplatedString(this.info.title)},getExpressionFieldsInContent:function(){var a=this._collectExprFieldsFromTemplatedString(this.info.description,[]);this.info.description||k.forEach(this.info.fieldInfos,function(b){b.visible&&
this._collectExprField(b.fieldName,a)},this);k.forEach(this.info.mediaInfos,function(b){this._collectExprFieldsFromTemplatedString(b.title,a);this._collectExprFieldsFromTemplatedString(b.caption,a);if(b=b.value)this._collectExprFieldsFromTemplatedString(b.linkURL,a),this._collectExprFieldsFromTemplatedString(b.sourceURL,a),k.forEach(b.fields,function(b){this._collectExprField(b,a)},this),this._collectExprField(b.normalizeField,a),this._collectExprField(b.tooltipField,a)},this);return a},getRequiredExpressionFields:function(){return this.getExpressionFieldsInTitle().concat(this.getExpressionFieldsInContent())},
hasGeometryOperations:function(){return k.some(this._getArcadeExpressions(),function(a){return a.hasGeometryOperations()})},hasAsyncExpressions:function(){return k.some(this._getArcadeExpressions(),function(a){return a.async})},initializeArcadeEngine:function(){return C.initialize(this._getArcadeExpressions())},getComponents:function(a,b){var c=this.info,d={initArcadeEngine:this.initializeArcadeEngine()};c.fieldInfos&&(c=k.filter(c.fieldInfos,function(a){return-1!==a.fieldName.indexOf(this._relatedFieldPrefix)},
this))&&0<c.length&&(d.relatedInfo=this._getRelatedRecords({graphic:a,fieldsInfo:c}));this._needFullResolutionFeature(a)&&(d.fullResolutionFeature=this._getFullResolutionFeature(a));return B(d).then(m.hitch(this,function(c){c=c.fullResolutionFeature;var d=b&&b.evaluateAllExpressions,e=d?null:this.getRequiredExpressionFields();c=(d?this.hasAsyncExpressions():this._hasAsyncExpressions(e))?this._fetchAttributesAsync(a,c,e):this._fetchAttributes(a,c,e);return B([c]).then(m.hitch(this,function(b){return this._getPopupValues(a,
b[0])}))}))},getAttachments:function(a){var b=a.getSourceLayer();a=a.attributes;if(this.info.showAttachments&&b&&b.hasAttachments&&b.objectIdField&&(a=a&&a[b.objectIdField]))return b.queryAttachmentInfos(a)},_needFullResolutionFeature:function(a){return(a=a.getSourceLayer())?"function"===typeof a.getMaxAllowableOffset&&0<a.getMaxAllowableOffset()&&this.hasGeometryOperations():!1},_getFullResolutionFeature:function(a){var b=a.getSourceLayer(),c=b.objectIdField;a=(a=a.attributes)&&c&&a[c];if(null==
a)return null;var d=new z;d.where=c+"\x3d"+a;d.maxAllowableOffset=0;d.outFields=[c];b._enableCacheHint(d);return b.queryFeatures(d).then(function(a){return a.features&&a.features[0]})},_isExpressionField:function(a){return this._reExprField.test(a)},_getExprField:function(a){return this._isExpressionField(a)?a.replace(this._reExprField,""):null},_collectExprField:function(a,b){(a=this._getExprField(a))&&b.push(a);return b},_collectExprFieldsFromTemplatedString:function(a,b){a=this._getExprFieldsFromTemplatedString(a);
a.length&&Array.prototype.push.apply(b,a);return b},_getExprFieldsFromTemplatedString:function(a){a=a?a.match(this._reExprFieldPattern):null;return k.map(a,function(a){return a.replace(this._reExprFieldPattern,"$1")},this)},_titleHasAsyncExpressions:function(){return this._hasAsyncExpressions(this.getExpressionFieldsInTitle())},_contentHasAyncExpressions:function(){return this._hasAsyncExpressions(this.getExpressionFieldsInContent())},_hasAsyncExpressions:function(a){return k.some(a,function(a){a=
this._exprCache[a];return!(!a||!a.async)},this)},_compileExpressions:function(a){var b={};k.forEach(a,function(a){var c=a.returnType&&a.returnType.toLowerCase();b[a.name]=new N({expression:a.expression,returnType:"number"===c?"number":"string",profile:C})});return b},_getArcadeExpressions:function(){var a=[],b;for(b in this._exprCache)a.push(this._exprCache[b]);return a},_fetchAttributesAsync:function(a,b,c){var d=this._fetchAttributes(a,b,c);a={};for(var e in d)(b=d[e])&&b.then&&(a[e]=b);return B(a).then(m.hitch(this,
function(a){for(var b in a){var c=a[b];d[b]=c instanceof Error?null:this._processArcadeResult(c)}return d}))},_processArcadeResult:function(a){"string"===typeof a&&(a=L.encode(a));return a},_fetchAttributes:function(a,b,c){var d=m.clone(a.attributes)||{},e=b&&b.geometry,f=this._exprPrefix,p=this._exprCache;c=c||k.map(this.info.expressionInfos,function(a){return a.name});k.forEach(c,function(b){var c=f+b;b=(b=p[b])?a.evaluateExpression(b,this._getEvalOptions(b,a,e)):null;d[c]=this._processArcadeResult(b)},
this);return d},_getEvalOptions:function(a,b,c){var d=a.hasGeometryOperations(),e=b.getSourceLayer(),f=e&&(e.getMap()||e.parentLayer&&e.parentLayer.getMap());a=C.getEvalOptions({expression:a,feature:b,layer:e,map:f,spatialReference:f&&f.spatialReference});b=a.context.vars.$feature;d=!(!d||!c);b&&d&&(b._geometry=c);a.skipCache=d;return a},_getPopupValues:function(a,b,c){b=b||this._fetchAttributes(a);var d=this.info,e=a.getSourceLayer(),f=m.clone(b),p="",n="",w,g,l,h,t,r=e&&e._getDateOpts&&e._getDateOpts().properties,
r=r&&r.slice(0),v={dateFormat:{properties:r,formatter:"DateFormat"+this._insertOffset(this._dateFormats.shortDateShortTime)},format:null};if(this._relatedInfo)for(h in this._relatedInfo)if(this._relatedInfo.hasOwnProperty(h)){var x=this._relatedInfo[h],D=this._relatedLayersInfo[h];x&&(k.forEach(x.relatedFeatures,function(a){for(t in a.attributes)if(a.attributes.hasOwnProperty(t)&&"esriRelCardinalityOneToOne"===D.relation.cardinality){var c=this._toRelatedFieldName([D.relation.id,t]);b[c]=f[c]=a.attributes[t]}},
this),k.forEach(x.relatedStatsFeatures,function(a){for(t in a.attributes)if(a.attributes.hasOwnProperty(t)){var c=this._toRelatedFieldName([D.relation.id,t]);b[c]=f[c]=a.attributes[t]}},this))}for(g in f)h=this._fieldsMap[g.toLowerCase()],x=this._getLayerFieldInfo(e,g),h&&x&&(h.fieldName=x.name),f[g]=this._formatValue(f[g],g,v),r&&h&&h.format&&h.format.dateFormat&&(h=k.indexOf(r,g),-1<h&&r.splice(h,1));if(e)for(g in r=e.typeIdField,b)b.hasOwnProperty(g)&&-1===g.indexOf(this._relatedFieldPrefix)&&
(l=b[g],q.isDefined(l)&&(h=this._getDomainName(e,a,g,l),q.isDefined(h)?f[g]=h:g===r&&(h=this._getTypeName(e,a,l),q.isDefined(h)&&(f[g]=h))));d.title&&(p=this._processFieldsInLinks(this._fixTokens(d.title,e),b),p=m.trim(this._removeEmptyHref(q.substitute(f,p,v)||"")));if(c)return{title:p};d.description&&(n=this._processFieldsInLinks(this._fixTokens(d.description,e),b),n=m.trim(this._removeEmptyHref(q.substitute(f,n,v)||"")));d.fieldInfos&&(w=[],k.forEach(d.fieldInfos,function(a){(g=a.fieldName)&&a.visible&&
w.push([this._fieldLabels[g.toLowerCase()]||g,q.substitute(f,"${"+g+"}",v)||""])},this));var y,u;d.mediaInfos&&(y=[],k.forEach(d.mediaInfos,function(a){u=0;l=a.value;switch(a.type){case "image":var c=l.sourceURL,c=c&&m.trim(this._removeEmptyHref(q.substitute(b,this._fixTokens(c,e))));u=!!c;break;case "piechart":case "linechart":case "columnchart":case "barchart":var d,c=l.normalizeField;l.fields=k.map(l.fields,function(a){return(d=this._getLayerFieldInfo(e,a))?d.name:a},this);c&&(d=this._getLayerFieldInfo(e,
c),l.normalizeField=d?d.name:c);u=k.some(l.fields,function(a){return q.isDefined(b[a])||-1!==a.indexOf(this._relatedFieldPrefix)&&this._relatedInfo},this);break;default:return}if(u){a=m.clone(a);l=a.value;var c=a.title?this._processFieldsInLinks(this._fixTokens(a.title,e),b):"",g=a.caption?this._processFieldsInLinks(this._fixTokens(a.caption,e),b):"";a.title=c?m.trim(this._removeEmptyHref(q.substitute(f,c,v)||"")):"";a.caption=g?m.trim(this._removeEmptyHref(q.substitute(f,g,v)||"")):"";if("image"===
a.type)l.sourceURL=q.substitute(b,this._fixTokens(l.sourceURL,e)),l.linkURL&&(l.linkURL=m.trim(q.substitute(b,this._fixTokens(l.linkURL,e))||""));else{var h,n;k.forEach(l.fields,function(a,c){if(-1!==a.indexOf(this._relatedFieldPrefix))n=this._getRelatedChartInfos(a,l,b,v),n instanceof Array?l.fields=n:l.fields[c]=n;else{var d=b[a],d=void 0===d?null:d;h=b[l.normalizeField]||0;d&&h&&(d/=h);l.fields[c]={y:d,tooltip:(this._fieldLabels[a.toLowerCase()]||a)+":\x3cbr/\x3e"+this._formatValue(d,a,v,!!h)}}},
this)}y.push(a)}},this));return{title:p,description:n,hasDescription:!!d.description,fields:w&&w.length?w:null,mediaInfos:y&&y.length?y:null,formatted:f,editSummary:!1!==d.showLastEditInfo&&e&&e.getEditSummary?e.getEditSummary(a):""}},_getRelatedChartInfos:function(a,b,c,d){var e,f,p,n,m,g;e=[];g=this._fromRelatedFieldName(a);m=g[0];f=this._relatedInfo[m];m=this._relatedLayersInfo[m];f&&k.forEach(f.relatedFeatures,function(f){f=f.attributes;var h,l;for(l in f)if(f.hasOwnProperty(l)&&l===g[1]){h={};
n=f[l];b.normalizeField&&(p=-1!==b.normalizeField.indexOf(this._relatedFieldPrefix)?f[this._fromRelatedFieldName(b.normalizeField)[1]]:c[b.normalizeField]);n&&p&&(n/=p);if(b.tooltipField)if(-1!==b.tooltipField.indexOf(this._relatedFieldPrefix)){var k=this._fromRelatedFieldName(b.tooltipField)[1],m=q.isDefined(f[k])?this._formatValue(f[k],b.tooltipField,d,!!p):k;h.tooltip=m+":\x3cbr/\x3e"+this._formatValue(n,k,d,!!p)}else h.tooltip=(this._fieldLabels[a.toLowerCase()]||a)+":\x3cbr/\x3e"+this._formatValue(n,
b.tooltipField,d,!!p);else h.tooltip=n;h.y=n;e.push(h)}},this);return"esriRelCardinalityOneToMany"===m.relation.cardinality||"esriRelCardinalityManyToMany"===m.relation.cardinality?e:e[0]},_dateFormats:{shortDate:"(datePattern: 'M/d/y', selector: 'date')",shortDateShortTime:"(datePattern: 'M/d/y', timePattern: 'h:mm a', selector: 'date and time')",shortDateShortTime24:"(datePattern: 'M/d/y', timePattern: 'H:mm', selector: 'date and time')",shortDateLongTime:"(datePattern: 'M/d/y', timePattern: 'h:mm:ss a', selector: 'date and time')",
shortDateLongTime24:"(datePattern: 'M/d/y', timePattern: 'H:mm:ss', selector: 'date and time')",shortDateLE:"(datePattern: 'd/M/y', selector: 'date')",shortDateLEShortTime:"(datePattern: 'd/M/y', timePattern: 'h:mm a', selector: 'date and time')",shortDateLEShortTime24:"(datePattern: 'd/M/y', timePattern: 'H:mm', selector: 'date and time')",shortDateLELongTime:"(datePattern: 'd/M/y', timePattern: 'h:mm:ss a', selector: 'date and time')",shortDateLELongTime24:"(datePattern: 'd/M/y', timePattern: 'H:mm:ss', selector: 'date and time')",
longMonthDayYear:"(datePattern: 'MMMM d, y', selector: 'date')",longMonthDayYearShortTime:"(datePattern: 'MMMM d, y', timePattern: 'h:mm a', selector: 'date and time')",longMonthDayYearShortTime24:"(datePattern: 'MMMM d, y', timePattern: 'H:mm', selector: 'date and time')",longMonthDayYearLongTime:"(datePattern: 'MMMM d, y', timePattern: 'h:mm:ss a', selector: 'date and time')",longMonthDayYearLongTime24:"(datePattern: 'MMMM d, y', timePattern: 'H:mm:ss', selector: 'date and time')",dayShortMonthYear:"(datePattern: 'd MMM y', selector: 'date')",
dayShortMonthYearShortTime:"(datePattern: 'd MMM y', timePattern: 'h:mm a', selector: 'date and time')",dayShortMonthYearShortTime24:"(datePattern: 'd MMM y', timePattern: 'H:mm', selector: 'date and time')",dayShortMonthYearLongTime:"(datePattern: 'd MMM y', timePattern: 'h:mm:ss a', selector: 'date and time')",dayShortMonthYearLongTime24:"(datePattern: 'd MMM y', timePattern: 'H:mm:ss', selector: 'date and time')",longDate:"(datePattern: 'EEEE, MMMM d, y', selector: 'date')",longDateShortTime:"(datePattern: 'EEEE, MMMM d, y', timePattern: 'h:mm a', selector: 'date and time')",
longDateShortTime24:"(datePattern: 'EEEE, MMMM d, y', timePattern: 'H:mm', selector: 'date and time')",longDateLongTime:"(datePattern: 'EEEE, MMMM d, y', timePattern: 'h:mm:ss a', selector: 'date and time')",longDateLongTime24:"(datePattern: 'EEEE, MMMM d, y', timePattern: 'H:mm:ss', selector: 'date and time')",longMonthYear:"(datePattern: 'MMMM y', selector: 'date')",shortMonthYear:"(datePattern: 'MMM y', selector: 'date')",year:"(datePattern: 'y', selector: 'date')"},_dateFormatsJson:{shortDate:{datePattern:"M/d/y",
selector:"date"},shortDateShortTime:{datePattern:"M/d/y",timePattern:"h:mm a",selector:"date and time"},shortDateShortTime24:{datePattern:"M/d/y",timePattern:"H:mm",selector:"date and time"},shortDateLongTime:{datePattern:"M/d/y",timePattern:"h:mm:ss a",selector:"date and time"},shortDateLongTime24:{datePattern:"M/d/y",timePattern:"H:mm:ss",selector:"date and time"},shortDateLE:{datePattern:"d/M/y",selector:"date"},shortDateLEShortTime:{datePattern:"d/M/y",timePattern:"h:mm a",selector:"date and time"},
shortDateLEShortTime24:{datePattern:"d/M/y",timePattern:"H:mm",selector:"date and time"},shortDateLELongTime:{datePattern:"d/M/y",timePattern:"h:mm:ss a",selector:"date and time"},shortDateLELongTime24:{datePattern:"d/M/y",timePattern:"H:mm:ss",selector:"date and time"},longMonthDayYear:{datePattern:"MMMM d, y",selector:"date"},longMonthDayYearShortTime:{datePattern:"MMMM d, y",timePattern:"h:mm a",selector:"date and time"},longMonthDayYearShortTime24:{datePattern:"MMMM d, y",timePattern:"H:mm",selector:"date and time"},
longMonthDayYearLongTime:{datePattern:"MMMM d, y",timePattern:"h:mm:ss a",selector:"date and time"},longMonthDayYearLongTime24:{datePattern:"MMMM d, y",timePattern:"H:mm:ss",selector:"date and time"},dayShortMonthYear:{datePattern:"d MMM y",selector:"date"},dayShortMonthYearShortTime:{datePattern:"d MMM y",timePattern:"h:mm a",selector:"date and time"},dayShortMonthYearShortTime24:{datePattern:"d MMM y",timePattern:"H:mm",selector:"date and time"},dayShortMonthYearLongTime:{datePattern:"d MMM y",
timePattern:"h:mm:ss a",selector:"date and time"},dayShortMonthYearLongTime24:{datePattern:"d MMM y",timePattern:"H:mm:ss",selector:"date and time"},longDate:{datePattern:"EEEE, MMMM d, y",selector:"date"},longDateShortTime:{datePattern:"EEEE, MMMM d, y",timePattern:"h:mm a",selector:"date and time"},longDateShortTime24:{datePattern:"EEEE, MMMM d, y",timePattern:"H:mm",selector:"date and time"},longDateLongTime:{datePattern:"EEEE, MMMM d, y",timePattern:"h:mm:ss a",selector:"date and time"},longDateLongTime24:{datePattern:"EEEE, MMMM d, y",
timePattern:"H:mm:ss",selector:"date and time"},longMonthYear:{datePattern:"MMMM y",selector:"date"},shortMonthYear:{datePattern:"MMM y",selector:"date"},year:{datePattern:"y",selector:"date"}},_reHref:/href\s*=\s*\"([^\"]+)\"/ig,_reHrefApos:/href\s*=\s*\'([^\']+)\'/ig,_fixTokens:function(a,b){var c=this;return a.replace(/(\{([^\{\r\n]+)\})/g,function(a,e,f){a=c._getLayerFieldInfo(b,f);return"$"+(a?"{"+a.name+"}":e)})},_encodeAttributes:function(a){a=m.clone(a)||{};var b,c;for(b in a)(c=a[b])&&"string"===
typeof c&&(c=encodeURIComponent(c).replace(/\'/g,"\x26apos;"),a[b]=c);return a},_processFieldsInLinks:function(a,b){var c=this._encodeAttributes(b);b=m.hitch(this,this._addValuesToHref,b,c);a&&(a=a.replace(this._reHref,b).replace(this._reHrefApos,b));return a},_addValuesToHref:function(a,b,c,d){d=d&&m.trim(d);return c=q.substitute(d&&0===d.indexOf("${")?a:b,c)},_getLayerFieldInfo:function(a,b){return a&&a.getField?a.getField(b):null},_formatValue:function(a,b,c,d){var e=this._fieldsMap[b.toLowerCase()],
f=e&&e.format;b=-1!==k.indexOf(c.dateFormat.properties,b);var p="number"===typeof a&&!b&&(!f||!f.dateFormat);if(!q.isDefined(a)||!e||!q.isDefined(f))return this._applyFormatting(a,p);var n,e=f.hasOwnProperty("places")||f.hasOwnProperty("digitSeparator"),w=f.hasOwnProperty("digitSeparator")?f.digitSeparator:!0;if(e&&!b)n={formatType:"NumberFormat",places:q.isDefined(f.places)&&(!d||0<f.places)?Number(f.places):Infinity};else if(f.dateFormat)n=m.mixin({formatType:"DateFormat",utcOffset:this.utcOffset},
this._dateFormatsJson[f.dateFormat]||this._dateFormatsJson.shortDateShortTime);else return this._applyFormatting(a,p);var g=this._applyFormatFunctions(a,n,c);e&&-1<a.constructor.toString().indexOf("Array")&&(g="",k.forEach(a,m.hitch(this,function(a,b){b&&(g+=" ");g+=this._applyFormatFunctions(a,n,c)})));e&&!w&&H.group&&(g=g.replace(new RegExp("\\"+H.group,"g"),""));b&&(g='\x3cspan class\x3d"esriDateValue"\x3e'+g+"\x3c/span\x3e");return this._applyFormatting(g,p)},_applyFormatFunctions:function(a,
b,c){b&&c&&(c.format={myKey:b});a=q.substitute({myKey:a},"${myKey}",c)||"";b&&c&&(c.format=null);return a},_applyFormatting:function(a,b){return b?this._forceLTR(a):this._applyPreWrap(a)},_forceLTR:function(a){var b=K("ie");return b&&10>=b?a:"\x3cspan class\x3d'esriNumericValue'\x3e"+a+"\x3c/span\x3e"},_applyPreWrap:function(a){return"string"===typeof a?a.replace(this._reNewline,"\x3cspan class\x3d'charNewLine'\x3e$1\x3c/span\x3e"):a},_insertOffset:function(a){a&&(a=q.isDefined(this.utcOffset)?a.replace(/\)\s*$/,
", utcOffset:"+this.utcOffset+")"):a);return a},_getDomainName:function(a,b,c,d){return(a=a.getDomain&&a.getDomain(c,{feature:b}))&&a.codedValues?a.getName(d):null},_getTypeName:function(a,b,c){return(a=a.getType&&a.getType(b))&&a.name},_getRelatedRecords:function(a){var b=a.graphic,c;this._relatedLayersInfoPromise||(this._relatedLayersInfoPromise=this._getRelatedLayersInfo(a).then(m.hitch(this,function(a){for(c in a)a.hasOwnProperty(c)&&a[c]&&(this._relatedLayersInfo[c].relatedLayerInfo=a[c])})));
return this._relatedLayersInfoPromise.then(m.hitch(this,function(){return this._queryRelatedLayers(b)})).then(m.hitch(this,function(a){this._setRelatedRecords(b,a);return a}))},_getRelatedLayersInfo:function(a){var b=a.fieldsInfo,c,d,e={};c=a.graphic.getSourceLayer();this._relatedLayersInfo||(this._relatedLayersInfo={});k.forEach(b,function(a){var b,d,e,f;b=this._fromRelatedFieldName(a.fieldName);d=b[0];b=b[1];d&&(!this._relatedLayersInfo[d]&&c&&c.relationships&&(k.some(c.relationships,function(a){if(a.id==
d)return f=a,!0}),f&&(this._relatedLayersInfo[d]={relation:f,relatedFields:[],outStatistics:[]})),this._relatedLayersInfo[d]&&(this._relatedLayersInfo[d].relatedFields.push(b),a.statisticType&&(e=new P,e.statisticType=a.statisticType,e.onStatisticField=b,e.outStatisticFieldName=b,this._relatedLayersInfo[d].outStatistics.push(e))))},this);for(d in this._relatedLayersInfo)this._relatedLayersInfo.hasOwnProperty(d)&&this._relatedLayersInfo[d]&&(a=this._relatedLayersInfo[d].relation,a=c.url.replace(/[0-9]+$/,
a.relatedTableId),this._relatedLayersInfo[d].relatedLayerUrl=a,e[d]=M({url:a,content:{f:"json"},callbackParamName:"callback"}));return A(e)},_queryRelatedLayers:function(a){var b={},c;for(c in this._relatedLayersInfo)this._relatedLayersInfo.hasOwnProperty(c)&&(b[c]=this._queryRelatedLayer({graphic:a,relatedInfo:this._relatedLayersInfo[c]}));return A(b)},_queryRelatedLayer:function(a){var b,c,d,e,f,p,n,q,g,l,h,t,r;b=a.graphic;c=b.getSourceLayer();d=c.url.match(/[0-9]+$/g)[0];h=a.relatedInfo;l=h.relatedLayerInfo;
t=h.relatedLayerUrl;a=h.relation;k.some(l.relationships,function(a){if(a.relatedTableId===parseInt(d,10))return e=a,!0},this);e&&(f=new z,k.some(l.fields,function(a){if(a.name===e.keyField)return q=-1!==k.indexOf(["esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble"],a.type)?"number":"string",!0}),e.relationshipTableId&&e.keyFieldInRelationshipTable?(r=new J,this._queryRelatedRecords(b,e).then(m.hitch(this,function(a){var d;(d=a[b.attributes[c.objectIdField]])?
(a=k.map(d.features,function(a){return a.attributes[l.objectIdField]},this),h.outStatistics&&0<h.outStatistics.length&&l.supportsStatistics&&(g=new z,g.where=this._chunkWhereInClause(l.objectIdField,a,1E3),g.outFields=f.outFields,g.outStatistics=h.outStatistics),g&&(p=new G(t),p.execute(g).then(m.hitch(this,function(a){var b=[];b.push(d);b.push(a);r.resolve(b)})))):r.resolve()}))):(n="string"===q?e.keyField+"\x3d'"+b.attributes[a.keyField]+"'":e.keyField+"\x3d"+b.attributes[a.keyField],f.where=n,
f.outFields=h.relatedFields,h.outStatistics&&0<h.outStatistics.length&&l.supportsStatistics&&(g=new z,g.where=f.where,g.outFields=f.outFields,g.outStatistics=h.outStatistics),p=new G(t),n=[],n.push(p.execute(f)),g&&n.push(p.execute(g))));return n?A(n):r?r.promise:void 0},_setRelatedRecords:function(a,b){this._relatedInfo=[];for(var c in b)b.hasOwnProperty(c)&&b[c]&&(a=b[c],this._relatedInfo[c]={},this._relatedInfo[c].relatedFeatures=a[0].features,q.isDefined(a[1])&&(this._relatedInfo[c].relatedStatsFeatures=
a[1].features))},_handlerErrorResponse:function(a,b){a.reject(b)},_fromRelatedFieldName:function(a){var b=[];-1!==a.indexOf(this._relatedFieldPrefix)&&(a=a.split("/"),b=a.slice(1));return b},_toRelatedFieldName:function(a){var b="";a&&0<a.length&&(b=this._relatedFieldPrefix+a[0]+"/"+a[1]);return b},_queryRelatedRecords:function(a,b){var c=a.getSourceLayer(),d=new O;d.outFields=["*"];d.relationshipId=b.id;d.objectIds=[a.attributes[c.objectIdField]];return c.queryRelatedFeatures(d)},_removeEmptyHref:function(a){return a.replace(/href=(""|'')/gi,
"")},_chunkWhereInClause:function(a,b,c){for(var d=0,e=[];d<b.length;)e.push(a+" IN ("+b.slice(d,c+d)+")"),d+=c;return e.join(" OR ")}});I("extend-esri")&&(F.PopupInfo=F.PopupInfoTemplate=u);return u});