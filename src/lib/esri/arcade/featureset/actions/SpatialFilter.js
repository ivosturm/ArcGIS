// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.
//>>built
var __extends=this&&this.__extends||function(){var p=function(l,b){p=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(b,g){for(var d in g)g.hasOwnProperty(d)&&(b[d]=g[d])};return p(l,b)};return function(l,b){function d(){this.constructor=l}p(l,b);l.prototype=null===b?Object.create(b):(d.prototype=b.prototype,new d)}}();
define("esri/arcade/featureset/actions/SpatialFilter","require exports ../sources/Empty ../support/FeatureSet ../support/IdSet ../support/shared ../../polyfill/promiseUtils ../../../geometry/geometryEngineAsync".split(" "),function(p,l,b,d,g,m,n,h){var f=function(a){function b(e){var c=a.call(this,e)||this;c._relation="";c._relationGeom=null;c._relationString="";c.declaredClass="esri.arcade.featureset.actions.SpatialFilter";c._relationString=e.relationString;c._parent=e.parentfeatureset;c._maxProcessing=
40;c._relation=e.relation;c._relationGeom=e.relationGeom;return c}__extends(b,a);b.prototype._getSet=function(e){var c=this;return null===this._wset?this._ensureLoaded().then(function(){return c._parent._getFilteredSet("esriSpatialRelRelation"!==c._relation?c._relation:c._relation+":"+c._relationString,c._relationGeom,null,null,e)}).then(function(a){c._checkCancelled(e);c._wset=new g(a._candidates.slice(0),a._known.slice(0),a._ordered,c._clonePageDefinition(a.pagesDefinition));return c._wset}):n.resolve(this._wset)};
b.prototype._isInFeatureSet=function(e){var c=this._parent._isInFeatureSet(e);if(c===m.IdState.NotInFeatureSet)return c;c=this._idstates[e];return void 0===c?m.IdState.Unknown:c};b.prototype._getFeature=function(e,c,a){return this._parent._getFeature(e,c,a)};b.prototype._getFeatures=function(e,c,a,b){return this._parent._getFeatures(e,c,a,b)};b.prototype._featureFromCache=function(a){return this._parent._featureFromCache(a)};b.prototype.executeSpatialRelationTest=function(a){if(null===a.geometry)return n.resolve(!1);
switch(this._relation){case "esriSpatialRelEnvelopeIntersects":var c=m.shapeExtent(this._relationGeom);a=m.shapeExtent(a.geometry);return h.intersects(c,a);case "esriSpatialRelIntersects":return h.intersects(this._relationGeom,a.geometry);case "esriSpatialRelContains":return h.contains(this._relationGeom,a.geometry);case "esriSpatialRelOverlaps":return h.overlaps(this._relationGeom,a.geometry);case "esriSpatialRelWithin":return h.within(this._relationGeom,a.geometry);case "esriSpatialRelTouches":return h.touches(this._relationGeom,
a.geometry);case "esriSpatialRelCrosses":return h.crosses(this._relationGeom,a.geometry);case "esriSpatialRelRelation":return h.relate(this._relationGeom,a.geometry,this._relationString)}};b.prototype._fetchAndRefineFeatures=function(a,c,b){var e=this,d=new g([],a,!1,null),q=Math.min(c,a.length);return this._parent._getFeatures(d,-1,q,b).then(function(){e._checkCancelled(b);for(var c=[],d=0;d<q;d++){var k=e._parent._featureFromCache(a[d]);c.push(e.executeSpatialRelationTest(k))}return n.all(c)}).then(function(b){for(var d=
0;d<c;d++)e._idstates[a[d]]=!0===b[d]?m.IdState.InFeatureSet:m.IdState.NotInFeatureSet;return"success"})};b.prototype._getFilteredSet=function(a,c,b,d,k){var e=this;return this._ensureLoaded().then(function(){return e._parent._getFilteredSet("esriSpatialRelRelation"!==e._relation?e._relation:e._relation+":"+e._relationString,e._relationGeom,b,d,k)}).then(function(a){e._checkCancelled(k);return null!==c?new g(a._candidates.slice(0).concat(a._known.slice(0)),[],a._ordered,e._clonePageDefinition(a.pagesDefinition)):
new g(a._candidates.slice(0),a._known.slice(0),a._ordered,e._clonePageDefinition(a.pagesDefinition))})};b.prototype._stat=function(a,c,b,d,k,f,g){var e=this;return""!==b?n.resolve({calculated:!1}):this._parent._stat(a,c,"esriSpatialRelRelation"!==this._relation?this._relation:this._relation+":"+this._relationString,this._relationGeom,k,f,g).then(function(h){return!1===h.calculated?null===k&&""===b&&null===d?e._manualStat(a,c,f,g):{calculated:!1}:h})};b.prototype._canDoAggregates=function(a,c,b,d,
f){return""!==b||null!==d||null===this._parent?n.resolve(!1):this._parent._canDoAggregates(a,c,"esriSpatialRelRelation"!==this._relation?this._relation:this._relation+":"+this._relationString,this._relationGeom,f)};b.prototype._getAggregatePagesDataSourceDefinition=function(a,c,b,d,f,g,h){return null===this._parent?n.reject(Error("Should never be called")):this._parent._getAggregatePagesDataSourceDefinition(a,c,"esriSpatialRelRelation"!==this._relation?this._relation:this._relation+":"+this._relationString,
this._relationGeom,f,g,h)};return b}(d);d._featuresetFunctions.intersects=function(a){return null===a||void 0===a?new b({parentfeatureset:this}):new f({parentfeatureset:this,relation:"esriSpatialRelIntersects",relationGeom:a})};d._featuresetFunctions.envelopeIntersects=function(a){return null===a||void 0===a?new b({parentfeatureset:this}):new f({parentfeatureset:this,relation:"esriSpatialRelEnvelopeIntersects",relationGeom:a})};d._featuresetFunctions.contains=function(a){return null===a||void 0===
a?new b({parentfeatureset:this}):new f({parentfeatureset:this,relation:"esriSpatialRelContains",relationGeom:a})};d._featuresetFunctions.overlaps=function(a){return null===a||void 0===a?new b({parentfeatureset:this}):new f({parentfeatureset:this,relation:"esriSpatialRelOverlaps",relationGeom:a})};d._featuresetFunctions.within=function(a){return null===a||void 0===a?new b({parentfeatureset:this}):new f({parentfeatureset:this,relation:"esriSpatialRelWithin",relationGeom:a})};d._featuresetFunctions.touches=
function(a){return null===a||void 0===a?new b({parentfeatureset:this}):new f({parentfeatureset:this,relation:"esriSpatialRelTouches",relationGeom:a})};d._featuresetFunctions.crosses=function(a){return null===a||void 0===a?new b({parentfeatureset:this}):new f({parentfeatureset:this,relation:"esriSpatialRelCrosses",relationGeom:a})};d._featuresetFunctions.relate=function(a,d){return null===a||void 0===a?new b({parentfeatureset:this}):new f({parentfeatureset:this,relation:"esriSpatialRelRelation",relationGeom:a,
relationString:d})};return f});