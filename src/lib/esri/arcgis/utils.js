// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.
//>>built
define("esri/arcgis/utils","require dojo/_base/lang dojo/_base/array dojo/_base/connect dojo/_base/Deferred dojo/_base/json dojo/_base/url dojo/on dojo/DeferredList dojo/dom-construct dojo/sniff dojox/gfx/_base ../kernel ../config ../Color ../lang ../request ../SpatialReference ../map ../urlUtils ../geometry/Point ../geometry/ScreenPoint ../geometry/Extent ../geometry/webMercatorUtils ../symbols/jsonUtils ../renderers/jsonUtils ../dijit/PopupTemplate ../dijit/Popup ../tasks/query ../tasks/GeometryService ../layers/ArcGISTiledMapServiceLayer ../layers/FeatureLayer dojo/i18n!../nls/jsapi".split(" "),
function(L,n,h,w,u,M,fb,X,F,gb,wb,pa,C,N,hb,k,D,E,ib,Y,jb,qa,G,ra,H,J,sa,kb,lb,mb,nb,x,Z){function aa(a){return!(!a||"BingMapsAerial"!==a.layerType&&"BingMapsAerial"!==a.type)}function ba(a){return!(!a||"BingMapsRoad"!==a.layerType&&"BingMapsRoad"!==a.type)}function O(a){return aa(a)||ba(a)||!(!a||"BingMapsHybrid"!==a.layerType&&"BingMapsHybrid"!==a.type)}function ta(a){return!(!a||"OpenStreetMap"!==a.layerType&&"OpenStreetMap"!==a.type)}function K(a){return!!(a&&a.url&&(-1<"ArcGISFeatureLayer ArcGISImageServiceLayer ArcGISImageServiceVectorLayer ArcGISMapServiceLayer ArcGISStreamLayer ArcGISTiledImageServiceLayer ArcGISTiledMapServiceLayer".split(" ").indexOf(a.layerType)||
!a.layerType&&!a.type))}function I(a){return D({url:r.arcgisUrl+"/"+a.itemId+"/data",content:{f:"json"},callbackParamName:"callback"},{disableIdentityLookup:!0,_preLookup:!0})}function ca(a,e){var d={f:"json"};e&&(d.token=e);return D({url:a,content:d,callbackParamName:"callback"},{disableIdentityLookup:!0})}function da(a){!a.layerDefinition||a.layerDefinition.drawingInfo&&a.layerDefinition.drawingInfo.labelingInfo||(a.showLabels=!1);a.itemProperties.layerDefinition&&(a.layerDefinition?(a.layerDefinition.drawingInfo||
(a.layerDefinition.drawingInfo=a.itemProperties.layerDefinition.drawingInfo),k.isDefined(a.layerDefinition.definitionExpression)||(a.layerDefinition.definitionExpression=a.itemProperties.layerDefinition.definitionExpression),k.isDefined(a.layerDefinition.minScale)||(a.layerDefinition.minScale=a.itemProperties.layerDefinition.minScale),k.isDefined(a.layerDefinition.maxScale)||(a.layerDefinition.maxScale=a.itemProperties.layerDefinition.maxScale)):a.layerDefinition=a.itemProperties.layerDefinition);
!a.itemProperties.popupInfo||a.popupInfo||a.disablePopup||(a.popupInfo=a.itemProperties.popupInfo);k.isDefined(a.itemProperties.showLabels)&&!k.isDefined(a.showLabels)&&(a.showLabels=a.itemProperties.showLabels);k.isDefined(a.itemProperties.showLegend)&&!k.isDefined(a.showLegend)&&(a.showLegend=a.itemProperties.showLegend);k.isDefined(a.itemProperties.refreshInterval)&&!k.isDefined(a.refreshInterval)&&(a.refreshInterval=a.itemProperties.refreshInterval)}function ua(a){da(a);a.itemProperties.layerDefinition&&
a.layerDefinition&&(!k.isDefined(a.layerDefinition.maximumTrackPoints)&&k.isDefined(a.itemProperties.layerDefinition.maximumTrackPoints)&&(a.layerDefinition.maximumTrackPoints=a.itemProperties.layerDefinition.maximumTrackPoints),!a.layerDefinition.definitionGeometry&&a.itemProperties.layerDefinition.definitionGeometry&&(a.layerDefinition.definitionGeometry=a.itemProperties.layerDefinition.definitionGeometry));a.itemProperties.purgeOptions&&!a.purgeOptions&&(a.purgeOptions=a.itemProperties.purgeOptions)}
function P(a,e){var d=new u;e=a.itemData;var b=[],c=[];h.forEach(e.operationalLayers,function(a){if(a.itemId&&K(a)){var f=a.url.toLowerCase();-1<f.indexOf("/featureserver")||-1<f.indexOf("/mapserver/")?(c.push(a),b.push(I(a))):-1<f.indexOf("/mapserver")&&-1===f.indexOf("/mapserver/")&&(!a.layers||!k.isDefined(a.minScale)&&!k.isDefined(a.maxScale))?(c.push(a),b.push(I(a))):-1<f.indexOf("/imageserver")&&!k.isDefined(a.minScale)&&!k.isDefined(a.maxScale)?(c.push(a),b.push(I(a))):-1<f.indexOf("/streamserver")&&
(c.push(a),b.push(I(a)))}});e.baseMap&&e.baseMap.baseMapLayers&&h.forEach(e.baseMap.baseMapLayers,function(a){a.itemId&&"VectorTileLayer"!==a.layerType&&(c.push(a),b.push(I(a)))});if(0<b.length){var g={};(new F(b)).addCallback(function(b){h.forEach(c,function(a,c){if((c=b[c][1])&&!(c instanceof Error)&&(g[a.itemId]=c,K(a))){var f=a.url.toLowerCase();(-1<f.indexOf("/featureserver")||-1<f.indexOf("/mapserver/"))&&c.layers?h.forEach(c.layers,function(c){var b="/featureserver/"+c.id;(b=f.match(b+"$")==
b)||(b="/mapserver/"+c.id,b=f.match(b+"$")==b);b&&(a.itemProperties=c,da(a))}):-1<f.indexOf("/streamserver")?(a.itemProperties=c,ua(a)):-1<f.indexOf("/mapserver")?(c.layers&&!a.layers&&(a.layers=c.layers),k.isDefined(c.minScale)&&!k.isDefined(a.minScale)&&(a.minScale=c.minScale),k.isDefined(c.maxScale)&&!k.isDefined(a.maxScale)&&(a.maxScale=c.maxScale),k.isDefined(c.refreshInterval)&&!k.isDefined(a.refreshInterval)&&(a.refreshInterval=c.refreshInterval),c.visibleLayers&&!a.visibleLayers&&(a.visibleLayers=
c.visibleLayers)):-1<f.indexOf("/imageserver")&&(k.isDefined(c.minScale)&&!k.isDefined(a.minScale)&&(a.minScale=c.minScale),k.isDefined(c.maxScale)&&!k.isDefined(a.maxScale)&&(a.maxScale=c.maxScale),k.isDefined(c.refreshInterval)&&!k.isDefined(a.refreshInterval)&&(a.refreshInterval=c.refreshInterval),!c.popupInfo||a.popupInfo||a.disablePopup||(a.popupInfo=c.popupInfo),c.renderingRule&&!a.renderingRule&&(a.renderingRule=c.renderingRule,c.renderingRule.functionName&&(a.renderingRule.rasterFunction=
c.renderingRule.functionName)),c.bandIds&&!a.bandIds&&(a.bandIds=c.bandIds),c.mosaicRule&&!a.mosaicRule&&(a.mosaicRule=c.mosaicRule),c.format&&!a.format&&(a.format=c.format),k.isDefined(c.compressionQuality)&&!k.isDefined(a.compressionQuality)&&(a.compressionQuality=c.compressionQuality),!c.layerDefinition||!c.layerDefinition.definitionExpression||k.isDefined(a.layerDefinition)&&k.isDefined(a.layerDefinition.definitionExpression)||(a.layerDefinition=a.layerDefinition||{},a.layerDefinition.definitionExpression=
c.layerDefinition.definitionExpression))}});a.relatedItemsData=g;d.callback(a)})}else d.callback(a);return d}function ob(a,e){var d=new u,b=a.itemData,c=b.baseMap.baseMapLayers[0];if(O(c))if(c.portalUrl&&C.id)delete e.bingMapsKey,C.id.checkSignInStatus(Y.urlToObject(r.arcgisUrl).path).then(n.hitch(null,function(a,b,d,e,g){ca(c.portalUrl,g.token).then(n.hitch(null,ea,a,b,d,e),n.hitch(null,Q,a,b,d,e))},a,e,b,d),n.hitch(null,function(a,b,d,e,g){ca(c.portalUrl).then(n.hitch(null,ea,a,b,d,e),n.hitch(null,
Q,a,b,d,e))},a,e,b,d));else if(e.bingMapsKey){var g=new z({bingMapsKey:e.bingMapsKey,mapStyle:z.MAP_STYLE_AERIAL});w.connect(g,"onLoad",n.hitch(this,function(){d.callback([a,e])}));w.connect(g,"onError",function(f){delete e.bingMapsKey;a.itemData=R(b);c=a.itemData.baseMap.baseMapLayers[0];c.errors=[];c.errors.push({message:"The owner of the application has not provided a valid Bing Key for the Bing Map it includes. Switching to Esri layers."});d.callback([a,e])})}else a.itemData=R(b),c=a.itemData.baseMap.baseMapLayers[0],
c.errors=[],c.errors.push({message:"The owner of the application has not provided a Bing Key for the Bing Map it includes. Switching to Esri layers."}),d.callback([a,e]);else d.callback([a,e]);return d}function pb(a){var e=new u,d,b;a=a.itemData;var c=a.baseMap&&a.baseMap.baseMapLayers;if(S&&!S.supported())for(a=0;a<c.length;a++){var g=c[a];if(!g.isReference){"VectorTileLayer"===g.layerType&&(d=g.itemId,b=a);break}}d?fa(d,!1).addBoth(function(a){var f=/^https?:\/\/basemaps(dev)?\.arcgis\.com\/arcgis\/rest\/services\/World_Basemap\/VectorTileServer/i;
a&&a.item&&f.test(a.item.url)&&(c[b]={id:"FB_"+g.id,layerType:"ArcGISTiledMapServiceLayer",opacity:"opacity"in g?g.opacity:1,visibility:"visibility"in g?g.visibility:!0,url:"https://services.arcgisonline.com/arcgis/rest/services/World_Street_Map/MapServer"});e.resolve()}):e.resolve();return e}function ea(a,e,d,b,c){c.bingKey?(e.bingMapsKey=c.bingKey,c=new z({bingMapsKey:e.bingMapsKey,mapStyle:z.MAP_STYLE_AERIAL}),w.connect(c,"onLoad",n.hitch(this,function(){b.callback([a,e])})),w.connect(c,"onError",
function(c){delete e.bingMapsKey;a.itemData=R(d);c=a.itemData.baseMap.baseMapLayers[0];c.errors=[];c.errors.push({message:"The owner of the map has not provided a valid Bing Key for the Bing Map it includes. Switching to Esri layers."});b.callback([a,e])})):Q(a,e,d,b)}function Q(a,e,d,b){delete e.bingMapsKey;a.itemData=R(d);d=a.itemData.baseMap.baseMapLayers[0];d.errors=[];d.errors.push({message:"The owner of the map has not provided a Bing Key for the Bing Map it includes. Switching to Esri layers."});
b.callback([a,e])}function R(a){aa(a.baseMap.baseMapLayers[0])?a.baseMap={title:"Imagery",baseMapLayers:[{id:"World_Imagery_2017",visibility:!0,opacity:1,url:"https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer"}]}:ba(a.baseMap.baseMapLayers[0])?a.baseMap={title:"Streets",baseMapLayers:[{id:"World_Street_Map_8421",opacity:1,visibility:!0,url:"https://services.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer"}]}:a.baseMap={title:"Imagery with Labels",baseMapLayers:[{id:"World_Imagery_6611",
opacity:1,visibility:!0,url:"https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer"},{id:"World_Boundaries_and_Places_1145",isReference:!0,opacity:1,visibility:!0,url:"https://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer"}]};return a}function ga(a,e,d,b){var c=a.dynamicLayerInfos||a.layerInfos,g=e.layers;if(g&&c)if(b.usePopupManager){var f;h.forEach(c,function(a){var c=a.id;if(!a.subLayerIds)for(a=0;a<g.length;a++){var b=g[a];
if(b.id===c&&b.popupInfo){f||(f={});f[c]={infoTemplate:new d(b.popupInfo),layerUrl:b.layerUrl};break}}});f&&a.setInfoTemplates(f)}else{var l=[],m=[],t=[],p=[],y=[],q=[];h.forEach(c,function(c){var b=c.id;if(!c.subLayerIds&&-1!==h.indexOf(a.visibleLayers,b))for(c=0;c<g.length;c++){var f=g[c];if(f.id===b){m.push(b);l.push(f.popupInfo);t.push(f.layerUrl||"");f.layerDefinition&&f.layerDefinition.definitionExpression?p.push(f.layerDefinition.definitionExpression):p.push("");y.push(k.isDefined(f.minScale)?
f.minScale:null);q.push(k.isDefined(f.maxScale)?f.maxScale:null);break}}});l.length&&(a.__popups=l,a.__popupIds=m,a.__popupUrls=t,a.__popupWhereClauses=p,a.__popupMinScales=y,a.__popupMaxScales=q,a.__resourceInfo=e.resourceInfo)}}function va(a){if(!a)return!1;var e=(new fb(r.arcgisUrl)).authority;return-1!==a.indexOf(".arcgis.com/")||-1!==a.indexOf(e)}function wa(a){return a?-1!==a.indexOf("/services.arcgisonline.com/")||-1!==a.indexOf("/server.arcgisonline.com/"):!1}function B(a){"https:"===location.protocol&&
(va(a)||wa(a))&&(a=a.replace("http:","https:"));return a}function ha(a,e,d){var b=[],c;a.displayLevels||(b=h.map(a.resourceInfo.tileInfo.lods,function(a){return a.level}));a.exclusionAreas&&(c=n.clone(a.exclusionAreas),c=h.map(c,function(a){a.geometry=new G(a.geometry);return a}));b=new nb(B(a.url),{resourceInfo:a.resourceInfo,opacity:a.opacity,visible:a.visibility,displayLevels:a.displayLevels||b,id:a.id,minScale:a.minScale,maxScale:a.maxScale,refreshInterval:a.refreshInterval,exclusionAreas:c});
d.ignorePopups||ga(b,a,e,d);return b}function ia(a,e){if(!a||!e||0===e.length)return[];e=","+e+",";var d=[],b,c=",";for(b=0;b<a.length;b++)if(null!==a[b].subLayerIds){if(-1===e.indexOf(","+a[b].id+",")||-1<c.indexOf(","+a[b].id+","))c+=a[b].subLayerIds.toString()+","}else-1<e.indexOf(","+a[b].id+",")&&-1===c.indexOf(","+a[b].id+",")&&d.push(a[b].id);return d}function xa(a,e,d){var b=new ya;b.format="png24";a.resourceInfo&&a.resourceInfo.supportedImageFormatTypes&&-1<a.resourceInfo.supportedImageFormatTypes.indexOf("PNG32")&&
(b.format="png32");var b=new za(B(a.url),{resourceInfo:a.resourceInfo,opacity:a.opacity,visible:a.visibility,id:a.id,imageParameters:b,minScale:a.minScale,maxScale:a.maxScale,refreshInterval:a.refreshInterval}),c=a.visibleLayers;if(!a.visibleLayers){var g="";h.forEach(b.layerInfos,function(a){a.defaultVisibility&&(g+=(0<g.length?",":"")+a.id)});c=g}if(a.layers&&0<a.layers.length){var f=[],l=[],m,t=[],p,k;h.forEach(a.layers,function(c){var b=c.layerDefinition;b&&b.definitionExpression&&(f[c.id]=b.definitionExpression);
if(b&&b.source){m=null;k=b.source;if("mapLayer"===k.type){var d=h.filter(a.resourceInfo.layers,function(a){return a.id===k.mapLayerId});d.length&&(m=n.mixin(d[0],c))}else m=n.mixin({},c);m&&(m.source=k,delete m.popupInfo,m=new Aa(m),a.visibleLayers&&(d="string"==typeof a.visibleLayers?a.visibleLayers.split(","):a.visibleLayers,-1<h.indexOf(d,c.id)?m.defaultVisibility=!0:m.defaultVisibility=!1),l.push(m))}b&&null!=b.transparency&&(d=b.drawingInfo||{},null==d.transparency&&(d.transparency=b.transparency,
b.drawingInfo=d));b&&b.source&&b.drawingInfo&&(p=new Ba(b.drawingInfo),t[c.id]=p)},this);0<f.length&&b.setLayerDefinitions(f);0<l.length?(b.setDynamicLayerInfos(l,!0),0<t.length&&b.setLayerDrawingOptions(t,!0)):(c=ia(b.layerInfos,c),b.setVisibleLayers(c))}else c=ia(b.layerInfos,c),b.setVisibleLayers(c);d.ignorePopups||ga(b,a,e,d);return b}function qb(a,e,d){var b=new Ca;b.bandIds=a.bandIds;null!=a.format&&(b.format=a.format,null!=a.compressionQuality&&(b.compressionQuality=a.compressionQuality));
if(a.renderingRule&&a.renderingRule.rasterFunction){var c=new Da(a.renderingRule);b.renderingRule=c}a.mosaicRule&&(c=new Ea(a.mosaicRule),b.mosaicRule=c);k.isDefined(a.noData)&&(b.noData=a.noData);k.isDefined(a.noDataInterpretation)&&(b.noDataInterpretation=a.noDataInterpretation);k.isDefined(a.interpolation)&&(b.interpolation=a.interpolation);c=a.layerType?"ArcGISImageServiceVectorLayer"===a.layerType:!1;k.isDefined(a.layerType)||(c=a.resourceInfo.hasMultidimensions&&("esriImageServiceDataTypeVector-UV"===
a.resourceInfo.serviceDataType||"esriImageServiceDataTypeVector-MagDir"===a.resourceInfo.serviceDataType));b={resourceInfo:a.resourceInfo,opacity:a.opacity,visible:a.visibility,id:a.id,imageServiceParameters:b,minScale:a.minScale,maxScale:a.maxScale,refreshInterval:a.refreshInterval};b=c?new Fa(B(a.url),b):new Ga(B(a.url),b);a.layerDefinition&&(a.layerDefinition.drawingInfo&&a.layerDefinition.drawingInfo.renderer&&(c=J.fromJson(a.layerDefinition.drawingInfo.renderer),b.setRenderer(c)),a.layerDefinition.definitionExpression&&
b.setDefinitionExpression(a.layerDefinition.definitionExpression,!0));!d.ignorePopups&&a.popupInfo&&b.setInfoTemplate(new e(a.popupInfo));return b}function ja(a,e,d){var b=[102113,102100,3857],c=d||new E(e[0].layerObject.fullExtent.spatialReference),g=new E(a.resourceInfo.fullExtent.spatialReference);return c.wkt==g.wkt&&(c.wkid==g.wkid||k.isDefined(c.latestWkid)&&c.latestWkid==g.wkid||k.isDefined(g.latestWkid)&&c.wkid==g.latestWkid||k.isDefined(c.latestWkid)&&c.latestWkid==g.latestWkid)||c.wkid&&
g.wkid&&h.some(b,function(a){return a===g.wkid})&&h.some(b,function(a){return a===c.wkid})?!0:!1}function ka(a,e,d){if(!e[0].layerObject.tileInfo)return!1;a=a.resourceInfo.tileInfo;e=e[0].layerObject.tileInfo;d=d.width>d.height?d.width:d.height;for(var b=!1,c=!1,g=0;g<a.lods.length;g++){for(var f=a.lods[g].scale/a.dpi,l=0;l<e.lods.length;l++){var m=e.lods[l].scale/e.dpi;if(Math.abs(m-f)/m<1/d)if(b){c=!0;break}else b=!0}if(c)break}return c||b&&(1===a.lods.length||1===e.lods.length)?!0:!1}function Ha(a,
e,d,b,c,g){var f,l,m=d._clazz;if(ta(a))f=new Ia({id:a.id,opacity:a.opacity,visible:null!==a.visibility&&void 0!==a.visibility?a.visibility:!0});else if(a&&("WFS"===a.layerType||"WFS"===a.type)){var t={customParameters:a.wfsInfo.customParameters,geometryType:a.layerDefinition.geometryType,id:a.id,labelingInfo:a.layerDefinition.drawingInfo.labelingInfo,maxFeatures:a.wfsInfo.maxFeatures,mode:a.mode,name:a.wfsInfo.name,showLabels:!0,swapXY:a.wfsInfo.swapXY,title:a.title,url:a.url,version:a.wfsInfo.version,
visible:a.visibility,wkid:a.layerDefinition.spatialReference.wkid};f=new Ja;f.fromJson(t,function(){k.isDefined(a.opacity)&&f.setOpacity(a.opacity);k.isDefined(a.visibility)&&f.setVisibility(a.visibility);(a.minScale||a.maxScale)&&f.setScaleRange(a.minScale,a.maxScale);f.renderer=J.fromJson(a.layerDefinition.drawingInfo.renderer,{geometryType:t.geometryType});!d.ignorePopups&&a.popupInfo&&f.setInfoTemplate(new m(a.popupInfo));f.emit("fromJsonComplete")})}else if(a&&("WMS"===a.layerType||"WMS"===a.type)){var p=
[],y=[];h.forEach(a.layers,function(a){y.push(new Ka({name:a.name,title:a.title,legendURL:a.legendURL||a.legendUrl,queryable:a.queryable,showPopup:a.showPopup}));p.push(a.name)},this);a.visibleLayers&&(p=a.visibleLayers);b=new G(a.extent[0][0],a.extent[0][1],a.extent[1][0],a.extent[1][1],new E({wkid:4326}));b={customLayerParameters:a.customLayerParameters,customParameters:a.customParameters,extent:b,layerInfos:y,version:a.version,maxWidth:a.maxWidth,maxHeight:a.maxHeight,featureInfoFormat:a.featureInfoFormat,
getFeatureInfoURL:a.featureInfoUrl,getMapURL:a.mapUrl,spatialReferences:a.spatialReferences,title:a.title,copyright:a.copyright,minScale:a.minScale||0,maxScale:a.maxScale||0,format:a.format};f=new La(a.url,{id:a.id,visibleLayers:p,format:"png",transparent:a.firstLayer?!1:!0,opacity:a.opacity,visible:null!==a.visibility?a.visibility:!0,resourceInfo:b,refreshInterval:a.refreshInterval});f.spatialReference.wkid=b.spatialReferences[0]}else if(a&&("KML"===a.layerType||"KML"===a.type)){l=a.url;if(C.id){var q=
C.id.findCredential(Y.urlToObject(r.arcgisUrl).path);q&&(e=r.arcgisUrl.substring(r.arcgisUrl.indexOf("//")+2,r.arcgisUrl.indexOf("/",r.arcgisUrl.indexOf("//")+3)),c=e.split("."),c=c[c.length-2]+"."+c[c.length-1],g=l.indexOf(c),-1<g&&(l="https://"+e+l.substring(g+c.length),l+="?token\x3d"+q.token))}f=new Ma(l,{id:a.id,visible:null!==a.visibility?a.visibility:!0,outSR:b,refreshInterval:a.refreshInterval});w.connect(f,"onLoad",function(){(a.opacity||0===a.opacity)&&f.setOpacity(a.opacity);k.isDefined(a.minScale)&&
k.isDefined(a.maxScale)&&f.setScaleRange(a.minScale,a.maxScale);a.visibleFolders&&h.forEach(f.folders,function(b){-1<h.indexOf(a.visibleFolders,b.id)?f.setFolderVisibility(b,!0):f.setFolderVisibility(b,!1)},this)})}else if(!a||"WebTiledLayer"!==a.layerType&&"WebTiledLayer"!==a.type)if(!a||"GeoRSS"!==a.layerType&&"GeoRSS"!==a.type)if(a&&("CSV"===a.layerType||"CSV"===a.type)&&a.url)b={layerDefinition:a.layerDefinition,columnDelimiter:a.columnDelimiter,id:a.id?a.id:null,visible:null!==a.visibility?a.visibility:
!0,opacity:a.opacity,refreshInterval:a.refreshInterval},a.locationInfo&&(b.latitudeFieldName=a.locationInfo.latitudeFieldName,b.longitudeFieldName=a.locationInfo.longitudeFieldName),!d.ignorePopups&&a.popupInfo&&(b.infoTemplate=new m(a.popupInfo)),f=new Qa(a.url,b);else if("VectorTileLayer"===a.layerType&&a.styleUrl)f=new S(a.styleUrl,{id:a.id,minScale:a.minScale,maxScale:a.maxScale,opacity:a.opacity,visible:a.visibility});else if(a.layerDefinition&&!a.url)b=M.fromJson(M.toJson(a)),delete b.id,delete b.opacity,
delete b.visibility,f=new x(b,{id:a.id,opacity:a.opacity,visible:a.visibility,outFields:["*"],autoGeneralize:!0}),!d.ignorePopups&&b.popupInfo&&f.setInfoTemplate(new m(b.popupInfo)),Ra(f);else if(O(a))d.bingMapsKey?(b=z.MAP_STYLE_AERIAL_WITH_LABELS,aa(a)?b=z.MAP_STYLE_AERIAL:ba(a)&&(b=z.MAP_STYLE_ROAD),f=new z({bingMapsKey:d.bingMapsKey,mapStyle:b,opacity:a.opacity,id:a.id}),w.connect(f,"onError",n.hitch(this,function(a){a.errors=a.errors||[];a.errors.push({message:"This application does not have a valid Bing Key for the Bing layer that is included in this map. [type:"+
(a?a.layerType||a.type:"")+"]"})},a))):(a.errors=a.errors||[],a.errors.push({message:"This application does not provide a Bing Key for the Bing layer that is included in this map. [type:"+(a?a.layerType||a.type:"")+"]"}));else if(a.resourceInfo&&(a.resourceInfo.mapName||""===a.resourceInfo.mapName))f=!0===a.resourceInfo.singleFusedMapCache&&(a.baseMapLayer||ja(a,e,b)&&ka(a,c,g))?ha(a,m,d):xa(a,m,d);else if(a.resourceInfo&&a.resourceInfo.pixelSizeX)f=!0===a.resourceInfo.singleFusedMapCache&&(a.baseMapLayer||
ja(a,e,b)&&ka(a,c,g))?ha(a,m,d):qb(a,m,d);else if(a.resourceInfo&&"Feature Layer"===a.resourceInfo.type){a.capabilities&&(a.resourceInfo.capabilities=a.capabilities);var v;!1===d.editable?v=!1:d.privileges&&-1===h.indexOf(d.privileges,"features:user:edit")&&C.id&&C.id.findCredential(a.url)&&(v=!1);f=new x(B(a.url),{resourceInfo:a.resourceInfo,opacity:a.opacity,visible:a.visibility,id:a.id,mode:a.mode===x.MODE_SELECTION?x.MODE_SELECTION:x.MODE_AUTO,editable:v,outFields:["*"],autoGeneralize:!0,refreshInterval:a.refreshInterval});
!d.ignorePopups&&a.popupInfo&&f.setInfoTemplate(new m(a.popupInfo));a.layerDefinition&&(a.layerDefinition.drawingInfo&&a.layerDefinition.drawingInfo.renderer&&(b=J.fromJson(a.layerDefinition.drawingInfo.renderer,{geometryType:f.geometryType}),b.isMaxInclusive=!0,f.setRenderer(b)),a.layerDefinition.drawingInfo&&a.layerDefinition.drawingInfo.labelingInfo&&(b=h.map(a.layerDefinition.drawingInfo.labelingInfo,function(a){return new la(a)}),f.setLabelingInfo(b)),a.layerDefinition.definitionExpression&&
f.setDefinitionExpression(a.layerDefinition.definitionExpression),k.isDefined(a.layerDefinition.minScale)&&f.setMinScale(a.layerDefinition.minScale),k.isDefined(a.layerDefinition.maxScale)&&f.setMaxScale(a.layerDefinition.maxScale));Ra(f)}else a.resourceInfo&&a.resourceInfo.streamUrls&&(b={resourceInfo:a.resourceInfo,opacity:a.opacity,visible:a.visibility,id:a.id},a.layerDefinition&&(l=a.layerDefinition.drawingInfo,a.layerDefinition.definitionGeometry&&(q=q||{},q.geometry=a.layerDefinition.definitionGeometry),
k.isDefined(a.layerDefinition.definitionExpression)&&(q=q||{},q.where=a.layerDefinition.definitionExpression),k.isDefined(a.layerDefinition.maximumTrackPoints)&&(b.maximumTrackPoints=a.layerDefinition.maximumTrackPoints)),q&&(b.filter=q),a.purgeOptions&&(b.purgeOptions=a.purgeOptions),f=new Sa(B(a.url),b),l&&l.renderer&&(b=l.renderer,f.setRenderer(J.fromJson(b,{geometryType:a.resourceInfo.geometryType}))),l&&l.labelingInfo&&(b=h.map(l.labelingInfo,function(a){return new la(a)}),f.setLabelingInfo(b)),
!d.ignorePopups&&a.popupInfo&&f.setInfoTemplate(new m(a.popupInfo)),a.layerDefinition&&(k.isDefined(a.layerDefinition.minScale)&&f.setMinScale(a.layerDefinition.minScale),k.isDefined(a.layerDefinition.maxScale)&&f.setMaxScale(a.layerDefinition.maxScale)),X.once(f,"error",function(b){a.errors.push({message:"Error loading stream layer. Check websocket url"})}));else f=new Pa(a.url,{id:a.id,opacity:a.opacity,outSpatialReference:b,refreshInterval:a.refreshInterval}),w.connect(f,"onLoad",function(){!1===
a.visibility&&f.hide();k.isDefined(a.minScale)&&k.isDefined(a.maxScale)&&f.setScaleRange(a.minScale,a.maxScale);var b=f.getFeatureLayers();h.forEach(b,function(c){a.pointSymbol&&"esriGeometryPoint"===c.geometryType?(c.renderer.symbol=H.fromJson(a.pointSymbol),1===b.length&&(f.pointSymbol=H.fromJson(a.pointSymbol))):a.lineSymbol&&"esriGeometryPolyline"===c.geometryType?(c.renderer.symbol=H.fromJson(a.lineSymbol),1===b.length&&(f.polylineSymbol=H.fromJson(a.lineSymbol))):a.polygonSymbol&&"esriGeometryPolygon"===
c.geometryType&&(c.renderer.symbol=H.fromJson(a.polygonSymbol),1===b.length&&(f.polygonSymbol=H.fromJson(a.polygonSymbol)))})});else if(f=new Na(a.templateUrl,{id:a.id,visible:null!==a.visibility?a.visibility:!0,opacity:a.opacity,copyright:a.copyright,fullExtent:a.fullExtent&&new G(a.fullExtent),initialExtent:a.fullExtent&&new G(a.fullExtent),subDomains:a.subDomains,tileInfo:a.tileInfo?new Oa(a.tileInfo):null,refreshInterval:a.refreshInterval,wmtsInfo:a.wmtsInfo}),k.isDefined(a.minScale)||k.isDefined(a.maxScale))f.loaded?
f.setScaleRange(a.minScale,a.maxScale):w.connect(f,"onLoad",function(){f.setScaleRange(a.minScale,a.maxScale)});f&&(f.arcgisProps={title:a.title},a.baseMapLayer&&(a.isReference?(f.attr("data-reference",!0),f._basemapGalleryLayerType="reference"):f._basemapGalleryLayerType="basemap"),f instanceof x&&a.layerDefinition&&a.layerDefinition.featureReduction&&"cluster"===a.layerDefinition.featureReduction.type&&(b=a.layerDefinition.featureReduction,b.clusterSize&&(b.clusterSize=pa.pt2px(b.clusterSize)),
b.clusterRadius&&(b.clusterRadius=pa.pt2px(b.clusterRadius)),b.popupInfo&&(b.infoTemplate=new sa(b.popupInfo),delete b.popupInfo),f.setFeatureReduction(b)));return f}function ma(a,e,d,b,c){h.forEach(a,function(f){f.layerObject=Ha(f,a,e,d,b,c)});var g=h.filter(a,function(a){return!a.isReference}),f=h.filter(a,function(a){return!!a.isReference});return a=g.concat(f)}function na(a){var e=null;a=a[0];a.url&&K(a)&&a.resourceInfo.spatialReference&&(e=new E,a.resourceInfo.spatialReference.wkid&&(e.wkid=
a.resourceInfo.spatialReference.wkid),a.resourceInfo.spatialReference.wkt&&(e.wkt=a.resourceInfo.spatialReference.wkt));O(a)||ta(a)?e=new E({wkid:102100}):a&&("WMS"===a.layerType||"WMS"===a.type)&&(e=new E({wkid:a.spatialReferences[0]}));return e}function Ta(a,e,d,b,c,g,f,l){h.forEach(e,function(b){b.url&&K(b)&&(b.resourceInfo=a[b.deferredsPos][1],delete b.deferredsPos)});g=g||na(e);e=ma(e,d,g,f,l);c.callback(e);return c}function Ra(a){!window.CanvasRenderingContext2D&&a.renderer&&"esri.renderer.HeatmapRenderer"===
a.renderer.declaredClass&&a.setRenderer(J.fromJson({type:"simple",symbol:{color:[77,77,77,255],size:6,angle:0,xoffset:0,yoffset:0,type:"esriSMS",style:"esriSMSCircle",outline:{color:[255,255,255,255],width:.75,type:"esriSLS",style:"esriSLSSolid"}}}))}function Ua(a,e){var d=B(a);return D({url:d,content:{f:"json"},callbackParamName:"callback",error:function(a,c){a.message=a.message?a.message+(" [url:"+d+"]"):"[url:"+d+"]";e.push(a);N.defaults.io.errorHandler(a,c)}})}function Va(a){var e=r.arcgisUrl+
"/"+a.itemId+"/data";return D({url:e,content:{f:"json"},callbackParamName:"callback",error:function(d,b){d.message=d.message?d.message+(" [url:"+e+"]"):"[url:"+e+"]";a.errors=a.errors||[];a.errors.push(d);N.defaults.io.errorHandler(d,b)}})}function Wa(a,e,d){var b=new u;if(!(d.featureCollection&&d.featureCollection.layers||d.layers))return console.log("Invalid Feature Collection item data [item id: "+a.itemId+"]: ",d),a.errors=a.errors||[],a.errors.push({message:"Invalid Feature Collection item data. [item id: "+
a.itemId+"]"}),b.errback(),b;d.layers&&(d.featureCollection={layers:d.layers},delete d.layers,k.isDefined(d.showLegend)&&(d.featureCollection.showLegend=d.showLegend,delete d.showLegend));Xa(a,d.featureCollection,e).then(function(c){d.featureCollection=c;a.featureCollection&&a.featureCollection.layers?h.forEach(d.featureCollection.layers,function(b,c){c=a.featureCollection.layers[c];c.popupInfo||c.layerDefinition?c.layerDefinition?(k.isDefined(c.layerDefinition.minScale)&&k.isDefined(c.layerDefinition.maxScale)&&
(c.layerDefinition.minScale!==b.layerDefinition.minScale||c.layerDefinition.maxScale!==b.layerDefinition.maxScale)&&(delete b.layerDefinition.minScale,delete b.layerDefinition.maxScale),c.layerDefinition.drawingInfo&&M.toJson(c.layerDefinition.drawingInfo)!==M.toJson(b.layerDefinition.drawingInfo)&&delete b.layerDefinition.drawingInfo,c.layerDefinition.showLegend!==b.layerDefinition.showLegend&&delete b.layerDefinition.showLegend,c.layerDefinition=n.mixin(c.layerDefinition,b.layerDefinition)):c.layerDefinition=
b.layerDefinition:(c.popupInfo=b.popupInfo,c.layerDefinition=b.layerDefinition);c.featureSet=b.featureSet;c.nextObjectId=b.nextObjectId}):(a.featureCollection=a.featureCollection||{},a.featureCollection=n.mixin(a.featureCollection,d.featureCollection));b.callback(a)});return b}function Xa(a,e,d){var b=new u;L(["./csv"],function(c){var g=[];h.forEach(e.layers,function(a){a.featureSet&&a.featureSet.features&&a.featureSet.features.length&&a.featureSet.features[0].geometry&&a.featureSet.features[0].geometry.spatialReference&&
(a.deferredsPos=g.length,g.push(c.projectFeatureCollection(a,d,a.featureSet.features[0].geometry.spatialReference)))});(new F(g)).addCallback(function(){h.forEach(e.layers,function(b){k.isDefined(b.deferredsPos)&&(g[b.deferredsPos].results&&g[b.deferredsPos].results.length?b=g[b.deferredsPos].results[0]:(console.log("Errors projecting feature collection. ["+a.title+" - "+b.layerDefinition.name+"]"),b.errors=b.errors||[],b.errors.push({message:"Errors projecting feature collection. ["+a.title+" - "+
b.layerDefinition.name+"]"})),delete b.deferredsPos)});b.callback(e)})});return b}function T(a,e,d,b,c){var g=new u,f=new u,l=[],m;h.forEach(a.operationalLayers,function(a){a.itemId&&"Feature Collection"==a.type&&l.push(Va(a).then(n.hitch(null,Wa,a,d)))});0===l.length?Ya(a,e,d,b,f,c):(m=new F(l),m.addCallback(function(g){Ya(a,e,d,b,f,c)}));f.then(function(a){l=[];h.forEach(a,function(a){var b;a=a.layerObject;a instanceof x&&!a.loaded&&!a.loadError?(b=new u,X.once(a,"load, error",function(){b.callback(a)}),
l.push(b)):a&&"esri.layers.WFSLayer"===a.declaredClass&&!a.loadError&&(b=new u,X.once(a,"fromJsonComplete, error",function(c){b.callback(a)}),l.push(b))});if(l.length){var b=new u;m=new F(l);m.addCallback(function(){b.callback(a)});return b.promise}return a}).then(function(a){var b=[];h.forEach(a,function(a){var c=a.layerObject;c&&(c instanceof x||"esri.layers.StreamLayer"===c.declaredClass)?c.loaded&&c.labelingInfo&&(a.showLabels||c._collection?b.push(c):c.setShowLabels&&c.setShowLabels(!1)):c&&
"esri.layers.WFSLayer"===c.declaredClass&&c.loaded&&c.labelingInfo&&b.push(c)});b.length?L(["../layers/LabelLayer"],function(c){var d=new c;h.forEach(b,function(a){d.addFeatureLayer(a)});a.push({layerObject:d});g.callback(a)}):g.callback(a)});return g}function Ya(a,e,d,b,c,g){var f=[],l=[],m=[];h.forEach(a.operationalLayers,function(a,b){if(a.featureCollection&&a.featureCollection.layers){var c=a.featureCollection.layers.length;h.forEach(a.featureCollection.layers,function(d,e){var f=!0;a.visibleLayers&&
-1==h.indexOf(a.visibleLayers,e)&&(f=!1);d.visibility=a.visibility&&f;d.opacity=a.opacity;d.id=(a.id||"operational"+b)+"_"+e;a.title&&(d.title=1!==c&&d.layerDefinition.name&&a.title!==d.layerDefinition.name?a.title+" - "+d.layerDefinition.name:a.title);m.push(d)},this)}else m.push(a)});h.forEach(a.baseMap.baseMapLayers,function(a,b){a.baseMapLayer=!0;a.id=a.id||"base"+b;f.push(a)});h.forEach(m,function(a,b){a.id=a.id||"operational"+b;f.push(a)});h.forEach(f,function(a){a.url&&K(a)&&(a.deferredsPos=
l.length,a.errors=a.errors||[],l.push(Ua(a.url,a.errors)))});0===l.length?(d=d||na(f),f=ma(f,e,d,b,g),c.callback(f)):(new F(l)).addCallback(function(a){Ta(a,f,e,l,c,d,b,g)});return c}function U(a,e,d,b){var c=a.minScale,g=a.maxScale;if(10.1>=d.version&&e)for(a=e.length-1;0<=a;a--){if(e[a].id==b)if(0==c&&0<e[a].minScale?c=e[a].minScale:0<c&&0==e[a].minScale?c=d.minScale:0<c&&0<e[a].minScale&&(c=Math.min(c,e[a].minScale)),g=Math.max(d.maxScale||0,e[a].maxScale||0),d.setScaleRange(c,g),-1<e[a].parentLayerId)b=
e[a].parentLayerId;else break}else 10.1<d.version&&(h.forEach(a.layerInfos,function(a){a.id==b&&(0==c&&0<a.minScale?c=a.minScale:0<c&&0==a.minScale||0<c&&0<a.minScale&&(c=Math.min(c,a.minScale)),g=Math.max(g||0,a.maxScale||0))}),d.setScaleRange(c,g))}function V(a,e,d,b){var c=a.url,g=a.__popupIds,f=a.__popupUrls,l=a.__popupWhereClauses,m=a.__popupMinScales,t=a.__popupMaxScales,p=a.__resourceInfo,y=[];h.forEach(a.__popups,function(b,v){if(b){var q,n=[];h.forEach(b.fieldInfos,function(a){"shape"!==
a.fieldName.toLowerCase()&&n.push(a.fieldName)});if(a.dynamicLayerInfos&&0<a.dynamicLayerInfos.length){var r=h.filter(a.dynamicLayerInfos,function(a){return g[v]==a.id})[0].source;q=new x(c+"/dynamicLayer",{parentLayer:a,id:a.id+"_"+g[v],source:r,outFields:n,mode:x.MODE_SELECTION,infoTemplate:b&&new d(b),drawMode:!1,visible:a.visible,autoGeneralize:!0});var u=function(b,c){0<l[b].length&&c.setDefinitionExpression(l[b]);if(k.isDefined(m[b])||k.isDefined(t[b]))if(k.isDefined(a.minScale)||k.isDefined(a.maxScale)){var d=
a.minScale,f=a.maxScale;0==d&&0<m[b]?d=m[b]:0<d&&0==m[b]||0<d&&0<m[b]&&(d=Math.min(d,m[b]));f=Math.max(f||0,t[b]||0);c.setScaleRange(d,f)}else c.setScaleRange(m[b],t[b]);else U(a,e||p.layers,c,g[b])};q.loaded?u(v,q):w.connect(q,"onLoad",function(a){u(v,q)})}else{var z=null,A=c+"/"+g[v];if(f[v].length)A=f[v];else if(e)for(r=0;r<e.length;r++)if(e[r].id===g[v]){z=e[r];break}q=new x(B(A),{parentLayer:a,id:a.id+"_"+g[v],outFields:n,mode:x.MODE_SELECTION,infoTemplate:b&&new d(b),drawMode:!1,visible:a.visible,
resourceInfo:z,autoGeneralize:!0});q.loaded?(0<l[v].length&&q.setDefinitionExpression(l[v]),U(a,e||p.layers,q,g[v])):w.connect(q,"onLoad",function(b){0<l[v].length&&q.setDefinitionExpression(l[v]);U(a,e||p.layers,b,g[v])})}y.push(q)}});0<y.length&&(w.connect(a,"onVisibilityChange",n.hitch(this,function(a,b){h.forEach(a,function(a){b?a.show():a.hide()})},y)),w.connect(b,"onLayerRemove",n.hitch(this,function(a,c,d){a.id===d.id&&h.forEach(c,function(a){b.removeLayer(a)})},a,y)));delete a.__popups;delete a.__popupIds;
delete a.__popupUrls;delete a.__popupWhereClauses;delete a.__popupMinScales;delete a.__popupMaxScales;delete a.__resourceInfo;return y}function Za(a){return D({url:B(a.url+"/layers"),content:{f:"json"},callbackParamName:"callback",error:function(){}})}function $a(a,e,d){var b=[];h.forEach(a,function(a){var c=a.__popups;c&&1<c.length&&10<=a.version&&(a.__deferredsPos=b.length,b.push(Za(a)))});var c=[];0<b.length?(new F(b)).addCallback(function(b){h.forEach(a,function(a){a.__popups&&0<a.__popups.length&&
(a.__deferredsPos||0===a.__deferredsPos?(c=c.concat(V(a,b[a.__deferredsPos][1].layers,d,e)),delete a.__deferredsPos):c=c.concat(V(a,null,d,e)))});e.addLayers(c)}):(h.forEach(a,function(a){a.__popups&&0<a.__popups.length&&(c=c.concat(V(a,null,d,e)))}),e.addLayers(c))}function ab(a){h.forEach(a,function(a){var d=a.layer;d.toJson&&(a=d.toJson(),a.featureSet&&d.name&&-1<d.name.indexOf("Text")&&h.forEach(a.featureSet.features,function(a,c){a.attributes.TEXT&&(c=d.graphics[c],c.symbol.setText(a.attributes.TEXT),
a.symbol.horizontalAlignment&&(c.symbol.align=a.symbol.horizontalAlignment),c.setSymbol(c.symbol),c.setAttributes(a.attributes))},this))})}function bb(a){var e=6;h.forEach(a,function(a){if(a=a.renderer)"esri.renderer.SimpleRenderer"===a.declaredClass?((a=a.symbol)&&a.xoffset&&(e=Math.max(e,Math.abs(a.xoffset))),a&&a.yoffset&&(e=Math.max(e,Math.abs(a.yoffset)))):"esri.renderer.UniqueValueRenderer"!==a.declaredClass&&"esri.renderer.ClassBreaksRenderer"!==a.declaredClass||h.forEach(a.infos,function(a){(a=
a.symbol)&&a.xoffset&&(e=Math.max(e,Math.abs(a.xoffset)));a&&a.yoffset&&(e=Math.max(e,Math.abs(a.yoffset)))})});return e}function oa(a){var e=this,d=e.infoWindow,b=a.graphic;if(e.loaded){d.hide();d.clearFeatures();var c=[];h.forEach(e.graphicsLayerIds,function(a){(a=e.getLayer(a))&&a instanceof x&&a.loaded&&a.visible&&(a.clearSelection(),a.infoTemplate&&!a.suspended&&c.push(a))});h.forEach(e.layerIds,function(a){(a=e.getLayer(a))&&-1!==a.declaredClass.indexOf("ArcGISImageServiceLayer")&&a.loaded&&
a.visible&&a.infoTemplate&&c.push(a)});b=b&&b.getInfoTemplate()?b:null;if(c.length||b){var g=bb(c),f=a.screenPoint,l=e.toMap(new qa(f.x-g,f.y+g)),g=e.toMap(new qa(f.x+g,f.y-g)),m=new G(l.x,l.y,g.x,g.y,e.spatialReference),k=new lb;k.geometry=m;k.timeExtent=e.timeExtent;var p=!0,l=h.map(c,function(b){b=b&&b.isFeatureReductionActive&&b.isFeatureReductionActive()?b.getFeatureReductionLayer():b;var c;if(-1!==b.declaredClass.indexOf("ArcGISImageServiceLayer"))k.geometry=a.mapPoint,p=!1,c=b.queryVisibleRasters(k,
{rasterAttributeTableFieldPrefix:"Raster.",returnDomainValues:!0}),c.addCallback(function(){return b.getVisibleRasters()});else if("function"===typeof b.selectFeatures)c=b.selectFeatures(k),c.addCallback(function(){return b.getSelectedFeatures()});else{c=new u;var d=h.filter(b.graphics,function(a){return a&&a.visible&&m.intersects(a.geometry)});c.resolve(d)}return c});b&&(g=new u,g.callback([b]),l.splice(0,0,g));if(!h.some(l,function(a){return-1===a.fired})){var n=b?1:0;h.forEach(c,function(a){n=
-1!==a.declaredClass.indexOf("ArcGISImageServiceLayer")?n+a.getVisibleRasters().length:n+a.getSelectedFeatures().length});if(!n)return}d.setFeatures(l);d.show(a.mapPoint,{closestFirst:p})}}}function rb(a,e){var d=e.mapOptions||{},b;d.infoWindow||(b=new kb({visibleWhenEmpty:!1},gb.create("div")),d.infoWindow=b);k.isDefined(d.showInfoWindowOnClick)||e.usePopupManager||(d.showInfoWindowOnClick=!1);a=new ib(a,d);w.connect(a,"onLayersAddResult",ab);return a}function A(a,e,d,b,c,g){var f,l,m,k;b.map?(f=
b.map,l=b.clickEventHandle,m=b.clickEventListener,k=b.errors):(f=rb(b,c),c.ignorePopups||c.disableClickBehavior||c.usePopupManager||(l=w.connect(f,"onClick",oa),m=oa));f.addLayers(a);c.ignorePopups||c.usePopupManager||$a(a,f,c._clazz);var p=k||[];h.forEach(e,function(a){a.errors&&(p=p.concat(a.errors))},this);f.loaded?g.callback({map:f,itemInfo:d,errors:p,clickEventHandle:l,clickEventListener:m}):w.connect(f,"onLoad",function(){g.callback({map:f,itemInfo:d,errors:p,clickEventHandle:l,clickEventListener:m})})}
function W(a,e,d,b,c){var g=[];h.forEach(c,function(a){n.isArray(a.layerObject)?h.forEach(a.layerObject,function(a){g.push(a)}):g.push(a.layerObject)});if(O(c[0]))var f=setInterval(function(){if(c[0].layerObject&&c[0].layerObject.loaded)clearInterval(f),cb(a,e,d,b,c,g);else if(c[0].errors){clearInterval(f);var m="";c[0].errors&&c[0].errors.length&&(m=" ("+c[0].errors[0].message+")");b.errback(Error(Z.arcgis.utils.baseLayerError+m))}},10);else if(!g[0]&&c[0].baseMapLayer){var l="";c[0].errors&&c[0].errors.length&&
(l=" ("+c[0].errors[0].message+")");b.errback(Error(Z.arcgis.utils.baseLayerError+l))}else cb(a,e,d,b,c,g)}function cb(a,e,d,b,c,g){try{var f=d.mapOptions||{};d.mapOptions=f;var l=a.itemData;!f.backgroundColor&&l.background&&l.background.color&&null!=l.background.color[0]&&(f.backgroundColor=hb.toDojoColor(l.background.color));g=h.filter(g,k.isDefined);if(e.map||f.extent)A(g,c,a,e,d,b);else{var m=g[0].spatialReference;if(f.center&&(null!=f.zoom||f.scale)&&(n.isArray(f.center)&&(f.center=new jb(f.center)),
ra.canProject(f.center,m))){A(g,c,a,e,d,b);return}var t=a.item;if(t&&t.extent&&t.extent.length){var p=new G(t.extent[0][0],t.extent[0][1],t.extent[1][0],t.extent[1][1],new E({wkid:4326}));4326===m.wkid?(f.extent=p,A(g,c,a,e,d,b)):900913===m.wkid||102100===m.wkid||102113===m.wkid||3857===m.wkid?(p.xmin=Math.max(p.xmin,-180),p.xmax=Math.min(p.xmax,180),p.ymin=Math.max(p.ymin,-89.99),p.ymax=Math.min(p.ymax,89.99),f.extent=ra.geographicToWebMercator(p),A(g,c,a,e,d,b)):d.geometryServiceURL||N.defaults.geometryService?
(d.geometryServiceURL?new mb(d.geometryServiceURL):N.defaults.geometryService).project([p],m,function(m){m=m[0];f.extent=f.extent||m;A(g,c,a,e,d,b)},function(){A(g,c,a,e,d,b)}):b.errback(Error(Z.arcgis.utils.geometryServiceError))}else A(g,c,a,e,d,b)}}catch(y){b.errback(y)}}function sb(a){var e=[];h.forEach(a.operationalLayers,function(a){a.featureCollection?e.push({featureCollection:a.featureCollection,visibility:a.visibility,title:a.title}):a.layerObject&&e.push({layer:a.layerObject,visibility:a.visibility,
title:a.title})});return e}function db(a){var e=[],d=a.baseMap.baseMapLayers;a.operationalLayers&&(d=d.concat(a.operationalLayers));h.forEach(d,function(a){var b={};if(a.featureCollection&&(!a||"CSV"!==a.layerType&&"CSV"!==a.type))!0===a.featureCollection.showLegend&&h.forEach(a.featureCollection.layers,function(c){if(!1!==c.showLegend){var d=c.layerObject.renderer;b={layer:c.layerObject,title:a.title,defaultSymbol:d&&d.defaultSymbol&&d.defaultLabel?!0:!1};1<a.featureCollection.layers.length&&(b.title+=
" - "+c.layerDefinition.name);e.push(b)}});else if(a.baseMapLayer&&!0===a.showLegend&&a.layerObject||!a.baseMapLayer&&!1!==a.showLegend&&a.layerObject&&!(a.layerObject instanceof x&&a.layerObject.mode===x.MODE_SELECTION)){var d=a.layerObject.renderer,f=a.layerObject.declaredClass,d=!d||d&&d.defaultSymbol&&d.defaultLabel?!0:!1;if(10.1>a.layerObject.version&&("esri.layers.ArcGISDynamicMapServiceLayer"===f||"esri.layers.ArcGISTiledMapServiceLayer"===f)||"esri.layers.ArcGISImageServiceLayer"===f)d=!0;
b={layer:a.layerObject,title:a.title,defaultSymbol:d};a.layers&&(f=h.map(h.filter(a.layers,function(a){return!1===a.showLegend}),function(a){return a.id}),f.length&&(b.hideLayers=f));e.push(b)}});return e}function tb(a,e){function d(a,b){h.forEach(a,function(a,c){switch(a){case "../layers/ArcGISDynamicMapServiceLayer":za=b[c];break;case "../layers/ArcGISImageServiceLayer":Ga=b[c];break;case "../layers/ArcGISImageServiceVectorLayer":Fa=b[c];break;case "../layers/CSVLayer":Qa=b[c];break;case "../layers/DynamicLayerInfo":Aa=
b[c];break;case "../layers/GeoRSSLayer":Pa=b[c];break;case "../layers/ImageParameters":ya=b[c];break;case "../layers/ImageServiceParameters":Ca=b[c];break;case "../layers/KMLLayer":Ma=b[c];break;case "../layers/LabelClass":la=b[c];break;case "../layers/LayerDrawingOptions":Ba=b[c];break;case "../layers/MosaicRule":Ea=b[c];break;case "../layers/OpenStreetMapLayer":Ia=b[c];break;case "../layers/RasterFunction":Da=b[c];break;case "../layers/StreamLayer":Sa=b[c];break;case "../layers/TileInfo":Oa=b[c];
break;case "../layers/VectorTileLayer":S=b[c];break;case "../virtualearth/VETiledLayer":z=b[c];break;case "../layers/WebTiledLayer":Na=b[c];break;case "../layers/WFSLayer":Ja=b[c];break;case "../layers/WMSLayer":La=b[c];break;case "../layers/WMSLayerInfo":Ka=b[c]}})}var b=new u;a=a.itemData;e=[];a.baseMap&&a.baseMap.baseMapLayers&&(e=e.concat(a.baseMap.baseMapLayers));a.operationalLayers&&(e=e.concat(a.operationalLayers));a=h.map(e,function(a){return a&&a.layerType});var c=[],g=[];e=!1;for(var f=
0;f<a.length;f++){switch(a[f]){case "ArcGISFeatureLayer":-1===h.indexOf(c,"../layers/LabelClass")&&c.push("../layers/LabelClass");break;case "ArcGISImageServiceLayer":case "ArcGISTiledImageServiceLayer":-1===h.indexOf(c,"../layers/ArcGISImageServiceLayer")&&(c.push("../layers/ArcGISImageServiceLayer"),g.push("../layers/ImageServiceParameters"),g.push("../layers/MosaicRule"),g.push("../layers/RasterFunction"));break;case "ArcGISImageServiceVectorLayer":-1===h.indexOf(c,"../layers/ArcGISImageServiceVectorLayer")&&
(c.push("../layers/ArcGISImageServiceVectorLayer"),g.push("../layers/ImageServiceParameters"),g.push("../layers/MosaicRule"),g.push("../layers/RasterFunction"));break;case "ArcGISMapServiceLayer":case "ArcGISTiledMapServiceLayer":-1===h.indexOf(c,"../layers/ArcGISDynamicMapServiceLayer")&&(c.push("../layers/ArcGISDynamicMapServiceLayer"),g.push("../layers/DynamicLayerInfo"),g.push("../layers/ImageParameters"),g.push("../layers/LayerDrawingOptions"));break;case "ArcGISStreamLayer":-1===h.indexOf(c,
"../layers/StreamLayer")&&c.push("../layers/StreamLayer");-1===h.indexOf(c,"../layers/LabelClass")&&c.push("../layers/LabelClass");break;case "BingMapsAerial":case "BingMapsHybrid":case "BingMapsRoad":-1===h.indexOf(c,"../virtualearth/VETiledLayer")&&c.push("../virtualearth/VETiledLayer");break;case "CSV":-1===h.indexOf(c,"../layers/CSVLayer")&&(c.push("../layers/CSVLayer"),g.push("./csv"));break;case "GeoRSS":-1===h.indexOf(c,"../layers/GeoRSSLayer")&&c.push("../layers/GeoRSSLayer");break;case "KML":-1===
h.indexOf(c,"../layers/KMLLayer")&&c.push("../layers/KMLLayer");break;case "OpenStreetMap":-1===h.indexOf(c,"../layers/OpenStreetMapLayer")&&c.push("../layers/OpenStreetMapLayer");break;case "VectorTileLayer":-1===h.indexOf(c,"../layers/VectorTileLayer")&&c.push("../layers/VectorTileLayer");break;case "WebTiledLayer":-1===h.indexOf(c,"../layers/WebTiledLayer")&&(c.push("../layers/WebTiledLayer"),g.push("../layers/TileInfo"));break;case "WFS":-1===h.indexOf(c,"../layers/WFSLayer")&&c.push("../layers/WFSLayer");
break;case "WMS":-1===h.indexOf(c,"../layers/WMSLayer")&&(c.push("../layers/WMSLayer"),g.push("../layers/WMSLayerInfo"));break;default:e=!0}if(e)break}e&&(c=ub,g=vb);c.length?L(c,function(){d(c,arguments);g.length?L(g,function(){d(g,arguments);b.resolve()}):b.resolve()}):b.resolve();return b}function eb(a,e,d,b){var c=b.itemData;c.baseMap&&c.baseMap.baseMapLayers&&c.baseMap.baseMapLayers.length&&(c.baseMap.baseMapLayers[0].firstLayer=!0);var g=e.layerMixins,f=g&&g.length;if(f){var k=function(a){for(var b=
0;b<f;b++){var c=g[b];if(c.mixin)if(c.hasOwnProperty("id")){if(a.id===c.id){n.mixin(a,c.mixin);break}}else if(a.url===c.url){n.mixin(a,c.mixin);break}}};h.forEach(c.baseMap&&c.baseMap.baseMapLayers,k);h.forEach(c.operationalLayers,k)}tb(b,e).then(function(){return pb(b,e)}).then(function(){return ob(b,e)}).then(function(b){var c=b[0],e=b[1];if(c.itemData.operationalLayers&&0!==c.itemData.operationalLayers.length){var f=new u,g=c.itemData.baseMap.baseMapLayers.slice(),k=h.filter(c.itemData.baseMap.baseMapLayers,
function(a){return!a.isReference});b={item:c.item,itemData:{baseMap:{baseMapLayers:k}}};c.itemData.baseMap.baseMapLayers=h.filter(c.itemData.baseMap.baseMapLayers,function(a){return a.isReference});P(b,e).addCallback(function(b){T(b.itemData,e).addCallback(n.hitch(null,W,b,a,e,f))});f.then(function(a){P(c,e).addCallback(function(b){T(b.itemData,e,a.map.spatialReference,k,a.map).addCallback(function(c){b.itemData.baseMap.baseMapLayers=g;W(b,a,e,d,c)})})},n.hitch(d,d.errback))}else P(c,e).addCallback(function(b){T(b.itemData,
e).addCallback(n.hitch(null,W,b,a,e,d))})})}function fa(a,e){"undefined"===typeof e&&(e=!0);r._arcgisUrl&&0<r._arcgisUrl.length&&(r.arcgisUrl=r._arcgisUrl);var d=r.arcgisUrl+"/"+a,b={},c=new u;D({url:d,content:{f:"json"},callbackParamName:"callback",load:function(a){b.item=a;e?D({url:d+"/data",content:{f:"json"},callbackParamName:"callback",load:function(a){b.itemData=a;c.callback(b)},error:function(a){c.errback(a)}}):c.callback(b)},error:function(a){c.errback(a)}});return c}var r,za,Ga,Fa,Qa,Aa,
Pa,ya,Ca,Ma,la,Ba,Ea,Ia,Da,Sa,Oa,S,z,Na,Ja,La,Ka,ub="../layers/ArcGISDynamicMapServiceLayer ../layers/ArcGISImageServiceLayer ../layers/ArcGISImageServiceVectorLayer ../layers/CSVLayer ../layers/GeoRSSLayer ../layers/KMLLayer ../layers/LabelClass ../layers/OpenStreetMapLayer ../layers/StreamLayer ../layers/VectorTileLayer ../virtualearth/VETiledLayer ../layers/WebTiledLayer ../layers/WFSLayer ../layers/WMSLayer".split(" "),vb="./csv ../layers/DynamicLayerInfo ../layers/ImageParameters ../layers/ImageServiceParameters ../layers/LayerDrawingOptions ../layers/MosaicRule ../layers/RasterFunction ../layers/TileInfo ../layers/WMSLayerInfo".split(" ");
r={arcgisUrl:Y.getProtocolForWebResource()+"//www.arcgis.com/sharing/rest/content/items",getItem:fa,createMap:function(a,e,d){var b=new u;d=d||{};var c=d.infoTemplateClass;d._clazz=c&&(n.isObject(c)?c:n.getObject(c))||sa;n.isString(a)?fa(a).addCallback(n.hitch(null,eb,e,d,b)).addErrback(n.hitch(b,b.errback)):eb(e,d,b,a);b.addCallback(function(a){var b=a.map;b&&(b.tables=n.getObject("itemInfo.itemData.tables",!1,a)||[])});return b},getLayerList:function(a){return a&&a.itemInfo&&a.itemInfo.itemData?
sb(a.itemInfo.itemData):[]},getLegendLayers:function(a){return a&&a.itemInfo&&a.itemInfo.itemData?db(a.itemInfo.itemData):[]},_arcgisUrl:null,_getItemProps:P,_getItemData:I,_getBingKey:ca,_portalUrlResponse:ea,_portalUrlFailure:Q,_processFSItemProperties:da,_processSSItemProperties:ua,_getLayers:T,_preBuildLayerObjects:Ta,_buildLayerObjects:ma,_preCreateMap:W,_getMapSR:na,_createMap:A,_addSelectionLayers:$a,_createSelectionFeatureLayers:V,_getServiceInfo:Ua,_getFeatureCollectionItem:Va,_mergeFeatureCollectionItem:Wa,
_projectFeatureCollection:Xa,_getLayersInfo:Za,_initLayer:Ha,_loadAsCached:ha,_loadAsDynamic:xa,_processPopups:ga,_onLayersAddResult:ab,_sameSpatialReferenceAsBasemap:ja,_sameTilingSchemeAsBasemap:ka,_showPopup:oa,_calculateClickTolerance:bb,_getVisibleFeatureLayers:ia,_updateLayerScaleInfo:U,_checkUrl:B,_isHostedService:va,_isAgolService:wa,_getLegendLayers:db};n.setObject("arcgis.utils",r,C);return r});