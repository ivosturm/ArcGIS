// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.
//>>built
define("esri/dijit/Attribution","dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/_base/connect dojo/_base/kernel dojo/has dojo/query dojo/dom dojo/dom-attr dojo/dom-construct dojo/dom-style dojo/dom-class dojo/dom-geometry ../kernel ../lang ../SpatialReference ../geometry/webMercatorUtils ../geometry/Extent".split(" "),function(t,h,l,p,z,A,G,B,u,w,q,k,x,C,y,D,E,F){t=t(null,{declaredClass:"esri.dijit.Attribution",itemDelimiter:" | ",listClass:"esriAttributionList",itemClass:"esriAttributionItem",
lastItemClass:"esriAttributionLastItem",delimiterClass:"esriAttributionDelim",constructor:function(b,a){try{h.mixin(this,b);this._attributions={};this._pendingDfds={};this._activeLayers=[];this._sharedLayers=[];this._layerHandles={};var c=this.domNode=B.byId(a),d=this.map,e="\x3cspan class\x3d'"+this.listClass+"'\x3e\x3c/span\x3e";c&&(u.set(c,"innerHTML",e),this.listNode=z.query(".esriAttributionList",c)[0],this.itemNodes={});this._eventConnections=[p.connect(d,"onLayerAdd",this,this._onLayerAdd),
p.connect(d,"onLayerRemove",this,this._onLayerRemove),p.connect(d,"onLayerSuspend",this,this._onLayerSuspend),p.connect(d,"onLayerResume",this,this._onLayerResume),p.connect(d,"onResize",this,this._adjustFocus),p.connect(d,"onExtentChange",this,this._onExtentChange)];if(d.loaded){var f=d.layerIds.concat(d.graphicsLayerIds),g,m,r=f.length;for(m=0;m<r;m++)g=d.getLayer(f[m]),g.loaded&&this._onLayerAdd(g)}}catch(H){}},startup:function(){},destroy:function(){l.forEach(this._eventConnections,p.disconnect);
w.destroy(this.listNode);var b=this._layerHandles,a;for(a in b)b[a]&&b[a].remove();this.map=this.domNode=this._eventConnections=this.listNode=this._attributions=this._pendingDfds=this.itemNodes=this._activeLayers=this._lastItem=this._sharedLayers=this._layerHandles=null},_onLayerAdd:function(b){try{var a=this._attributions,c=b.id;if(!y.isDefined(a[c])&&b.showAttribution){if(b.hasAttributionData){var d=b.getAttributionData();this._pendingDfds[c]=1;a[c]=d;d.addBoth(h.partial(this._onAttributionLoad,
this,b))}else a[c]=b.copyright||b.copyrightText||"",a[c]?(b.suspended||this._activeLayers.push(c),this._createNode(c)):this._onLayerRemove(b);-1<b.declaredClass.toLowerCase().indexOf("vetiledlayer")&&(this._layerHandles[c]=b.on("map-style-change",h.hitch(this,function(){this._onLayerRemove(b);this._onLayerAdd(b)})))}}catch(e){}},_onAttributionLoad:function(b,a,c){var d=b._attributions,e=b._pendingDfds,f=a.id;if(e&&e[f]){delete e[f];if(!c||c instanceof Error)c="";d[f]=c?b._createIndexByLevel(c,-1!==
a.declaredClass.toLowerCase().indexOf("vetiledlayer")):a.copyright||a.copyrightText||"";d[f]?(a.suspended||b._activeLayers.push(f),b._createNode(f)):b._onLayerRemove(a)}},_onLayerRemove:function(b){try{var a=b.id,c=this.itemNodes,d,e=-1;this._onLayerSuspend(b);this._layerHandles[a]&&this._layerHandles[a].remove();delete this._attributions[a];delete this._pendingDfds[a];delete this._layerHandles[a];d=this._getGroupIndex(a);-1!==d&&(e=l.indexOf(this._sharedLayers[d],a),-1!==e&&(this._sharedLayers[d].splice(e,
1),1>=this._sharedLayers[d].length&&this._sharedLayers.splice(d,1)));c[a]&&-1===e&&w.destroy(c[a]);delete c[a];this._updateLastItem()}catch(f){}},_onLayerSuspend:function(b){try{var a=b.id;if(this._attributions[a]){var c=l.indexOf(this._activeLayers,a),d=this.itemNodes[a];-1!==c&&this._activeLayers.splice(c,1);d&&this._toggleItem(d,!1,this._getGroupIndex(a))}}catch(e){}},_adjustFocus:function(){var b=this.domNode.scrollWidth>this.domNode.clientWidth,a=k.contains(this.domNode,"esriAttributionOpen");
u.set(this.domNode,"tabIndex",b||a?"0":"")},_onLayerResume:function(b){try{var a=b.id,c=this._attributions[a],d=this.itemNodes[a];if(c&&(-1===l.indexOf(this._activeLayers,a)&&this._activeLayers.push(a),d)){var e=h.isString(c)?c:this._getContributorsList(c,this.map.extent,this.map.getLevel());h.isString(c)||u.set(d,"innerHTML",e?e+this._getDelimiter():"");e&&this._toggleItem(d,!0,this._getGroupIndex(a))}}catch(f){}},_onExtentChange:function(b,a,c,d){try{var e=this._activeLayers,f=this._attributions,
g=this.itemNodes,m,r,k,v,n=e.length||0;for(v=0;v<n;v++)if(r=e[v],k=f[r],(m=g[r])&&!h.isString(k)){var l=this._getContributorsList(k,b,d?d.level:-1);u.set(m,"innerHTML",l?l+this._getDelimiter():"");this._toggleItem(m,!!l,-1)}}catch(I){}this._adjustCursorStyle()},_createNode:function(b){if(this.domNode){var a=this._checkShareInfo(b),c=a&&a.sharedWith,c=c&&this.itemNodes[c],d=this.map,e=this._attributions[b],e=h.isString(e)?e:this._getContributorsList(e,d.extent,d.getLevel()),d=!!e&&!d.getLayer(b).suspended;
c?(this.itemNodes[b]=c,this._toggleItem(c,d,a.index)):(b=this.itemNodes[b]=w.create("span",{"class":this.itemClass,innerHTML:e?e+this._getDelimiter():"",style:{display:d?"inline":"none"}},this.listNode),d&&this._setLastItem(b));this._adjustCursorStyle()}},_checkShareInfo:function(b){var a=this._attributions,c,d,e=-1,f=a[b],g;if(f&&h.isString(f)){for(d in a)if(c=a[d],d!==b&&c&&h.isString(c)&&c.length===f.length&&c.toLowerCase()===f.toLowerCase()){g=d;break}a=this._sharedLayers;c=a.length;if(g){for(d=
0;d<c;d++)if(f=a[d],-1!==l.indexOf(f,g)){e=d;f.push(b);break}-1===e&&(e=a.push([g,b])-1)}}return-1<e?{index:e,sharedWith:g}:null},_getGroupIndex:function(b){var a=this._sharedLayers,c,d=a.length,e=-1;for(c=0;c<d;c++)if(-1!==l.indexOf(a[c],b)){e=c;break}return e},_getDelimiter:function(){var b=this.itemDelimiter;return b?"\x3cspan class\x3d'"+this.delimiterClass+"'\x3e"+b+"\x3c/span\x3e":""},_toggleItem:function(b,a,c){if(-1<c&&!a){c=this._sharedLayers[c];var d,e=c.length,f=this._activeLayers;for(d=
0;d<e;d++)if(-1!==l.indexOf(f,c[d]))return}q.set(b,"display",a?"inline":"none");this._updateLastItem()},_updateLastItem:function(){var b=this.listNode.childNodes,a;a=b.length;var c;if(a)for(--a;0<=a;a--)if(c=b[a],"none"!==q.get(c,"display")){this._setLastItem(c);break}this._adjustCursorStyle()},_setLastItem:function(b){var a=this.itemClass,c=this.lastItemClass;this._lastItem&&k.replace(this._lastItem,a,c);b&&(k.replace(b,c,a),this._lastItem=b)},_createIndexByLevel:function(b,a){b=b.contributors;var c,
d,e,f,g=b?b.length:0,m,k,l=new D(4326),h={},n;for(f=0;f<g;f++)for(c=b[f],k=(d=c.coverageAreas)?d.length:0,m=0;m<k;m++)for(e=d[m],n=e.bbox,n={extent:E.geographicToWebMercator(new F(n[1],n[0],n[3],n[2],l)),attribution:c.attribution||"",zoomMin:e.zoomMin-(a&&e.zoomMin?1:0),zoomMax:e.zoomMax-(a&&e.zoomMax?1:0),score:y.isDefined(e.score)?e.score:100,objectId:f},e=n.zoomMin;e<=n.zoomMax;e++)h[e]=h[e]||[],h[e].push(n);return h},_getContributorsList:function(b,a,c){var d="";if(a&&y.isDefined(c)&&-1<c){b=
b[c];c=a.getCenter().normalize();for(var e=b?b.length:0,f=[],g={},d=0;d<e;d++)a=b[d],!g[a.objectId]&&a.extent.contains(c)&&(g[a.objectId]=1,f.push(a));f.sort(function(a,b){return b.score-a.score||a.objectId-b.objectId});e=f.length;for(d=0;d<e;d++)f[d]=f[d].attribution;d=f.join(", ")}return d},_adjustCursorStyle:function(){var b=x.position(this.listNode.parentNode,!0).h;k.contains(this.listNode.parentNode,"esriAttributionOpen")?(k.remove(this.listNode.parentNode,"esriAttributionOpen"),b>x.position(this.listNode.parentNode,
!0).h?(q.set(this.listNode.parentNode,"cursor","pointer"),k.add(this.listNode.parentNode,"esriAttributionOpen")):q.set(this.listNode.parentNode,"cursor","default")):(k.add(this.listNode.parentNode,"esriAttributionOpen"),b<x.position(this.listNode.parentNode,!0).h?q.set(this.listNode.parentNode,"cursor","pointer"):q.set(this.listNode.parentNode,"cursor","default"),k.remove(this.listNode.parentNode,"esriAttributionOpen"));this._adjustFocus()}});A("extend-esri")&&h.setObject("dijit.Attribution",t,C);
return t});