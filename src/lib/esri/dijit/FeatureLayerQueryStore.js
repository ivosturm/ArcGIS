// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.
//>>built
define("esri/dijit/FeatureLayerQueryStore","dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has dojo/promise/all dojo/Deferred ../request ../tasks/query ../tasks/RelationshipQuery ../dijit/FeatureLayerQueryResult dojo/i18n!../nls/jsapi".split(" "),function(h,k,f,t,q,u,l,v,w,x,y){var r=h(null,{layer:null,data:null,objectIds:null,idProperty:"id",totalCount:0,batchCount:25,where:null,orderByFields:null,getAttachments:!1,getRelatedRecords:!1,constructor:function(a){h.safeMixin(this,a);this.data=
[];this.idProperty=this.layer.objectIdField;this.idProperty||(a=JSON.parse(this.layer._json),a.uniqueIdField&&a.uniqueIdField.name&&(this.idProperty=a.uniqueIdField.name))},get:function(a){return this.data[a]},getIdentity:function(a){return a[this.idProperty]},query:function(a,b){var d=new u,c=new v;a=b.start||0;var m=b.count||this.batchCount,h=this.layer.relationships,g=this.layer.advancedQueryCapabilities;b=b.objectIds||this.objectIds;var e={fields:[],features:[],attachmentInfos:{},relatedRecordInfos:{},
count:0,total:this.totalCount,exceededTransferLimit:!1};b&&b.length?c.objectIds=b.length>=a+this.batchCount?b.slice(a,a+m):b.slice(a):(c.start=a,c.num=m,c.where=this.where);var l=g&&g.supportsOrderBy&&this.orderByFields&&this.orderByFields.length;l&&(c.orderByFields=this.orderByFields);g&&g.supportsQueryWithCacheHint&&(c.cacheHint=!0);c.returnGeometry=!1;c.outFields=["*"];this.layer.queryFeatures(c).then(k.hitch(this,function(a){if(a.features&&a.features.length){var b=a.objectIdFieldName;b||(f.some(a.fields,
function(a,c){if("esriFieldTypeOID"===a.type)return b=a.name,!1}),!b&&a.uniqueIdField&&(b=a.uniqueIdField.name),b||(b=this.idProperty));var n=[],p=[],m={};this.objectIds&&!l&&(f.forEach(a.features,function(a,c){m[a.attributes[b]]=a}),a.features=f.map(c.objectIds,function(a){return m[a]}));var g=f.map(a.features,function(a){var c=a.attributes,d=c[b];n.push(d);this.data[d]=a;return c},this);e.exceededTransferLimit=!!a.exceededTransferLimit;e.count=a.features.length;e.features=g;e.fields=a.fields;this.getAttachments&&
this.getRelatedRecords?(p.push(this._queryAttachments(n)),f.forEach(h,function(a){p.push(this._queryRelatedRecords(n,a))},this),q(p).then(k.hitch(this,function(a){e.attachmentInfos=this._createAttachmentInfoLookup(a.shift());e.relatedRecordInfos=this._createRelatedRecordInfoLookup(a);d.resolve(e)})).otherwise(function(){d.resolve(e)})):this.getRelatedRecords?(f.forEach(h,function(a){p.push(this._queryRelatedRecords(n,a))},this),q(p).then(k.hitch(this,function(a){e.relatedRecordInfos=this._createRelatedRecordInfoLookup(a);
d.resolve(e)})).otherwise(function(){d.resolve(e)})):this.getAttachments?this._queryAttachments(n).then(k.hitch(this,function(a){e.attachmentInfos=this._createAttachmentInfoLookup(a);d.resolve(e)})).otherwise(function(){d.resolve(e)}):d.resolve(e)}else d.resolve(e)})).otherwise(function(a){d.reject(e)});return new x(d)},_queryRelatedRecords:function(a,b){var d=this.layer,c=d.advancedQueryCapabilities;if(c&&c.supportsAdvancedQueryRelated)return this._queryRelatedRecordCount(a,b);c=new w;c.outFields=
["*"];c.returnGeometry=!1;c.relationshipId=b.id;c.objectIds=a;return d.queryRelatedFeatures(c)},_queryRelatedRecordCount:function(a,b){return l({url:this.layer._url.path+"/queryRelatedRecords",content:{f:"json",objectIds:a.toString(),outFields:["*"],returnGeometry:!1,relationshipId:b.id,returnCountOnly:!0},handleAs:"json",callbackParamName:"callback"})},_createRelatedRecordInfoLookup:function(a){var b=this.layer.relationships,d={};f.forEach(a,function(a,f){d[b[f].id]=a});return d},_queryAttachments:function(a){return l({url:this.layer._url.path+
"/queryAttachments",content:{f:"json",objectIds:a.toString()},handleAs:"json",callbackParamName:"callback"})},_createAttachmentInfoLookup:function(a){var b={};f.forEach(a.attachmentGroups,function(a){b[a.parentObjectId]={attachments:a.attachmentInfos}});return b}});t("extend-esri")&&k.setObject("dijit.FeatureLayerQueryStore",r,y);return r});