// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.
//>>built
require({cache:{"url:esri/dijit/FeatureTable/templates/Grid.html":'\x3cdiv\x3e\r\n  \x3cdiv class\x3d"${css.borderContainer}" data-dojo-attach-point\x3d "_gridBorderContainerNode" data-dojo-type\x3d"dijit/layout/BorderContainer" gutters\x3d"false"\x3e\r\n    \x3cdiv class\x3d"${css.contentPane} ${css.menu}" data-dojo-attach-point\x3d "_gridHeaderNode" data-dojo-type\x3d"dijit/layout/ContentPane" data-dojo-props\x3d"region: \'top\'"\x3e\r\n      \x3cdiv class\x3d"${css.menuItem} ${css.loadingIndicator} ${css.hidden}" data-dojo-attach-point\x3d "_gridLoadingIndicatorNode"\x3e\x3c/div\x3e\r\n      \x3cdiv class\x3d"${css.menuItem} ${css.menuOptions}" data-dojo-attach-point\x3d "_menuNode" \x3e\r\n        \x3cdiv data-dojo-attach-point\x3d "_gridMenuNode"\x3e\x3c/div\x3e\r\n      \x3c/div\x3e\r\n      \x3cdiv class\x3d"${css.menuItem} ${css.title}" data-dojo-attach-point\x3d "_gridTitleNode"\x3e\x3c/div\x3e\r\n    \x3c/div\x3e\r\n    \x3cdiv class\x3d"${css.contentPane}" data-dojo-attach-point\x3d "_gridContentPaneNode" data-dojo-type\x3d"dijit/layout/ContentPane" data-dojo-props\x3d"region: \'center\'"\x3e\r\n      \x3cdiv class\x3d"${css.grid}" data-dojo-attach-point\x3d"_gridNode"\x3e\x3c/div\x3e\r\n    \x3c/div\x3e\r\n  \x3c/div\x3e\r\n\x3c/div\x3e'}});
define("esri/dijit/FeatureTable/Grid","../../kernel ../../arcadeProfiles/popupProfile ./dataUtils ./dialogUtils dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/aspect dojo/has dojo/keys dojo/on dojo/string dojo/dom-class dojo/dom-construct dojo/Deferred dojox/html/entities dijit/_TemplatedMixin dijit/_WidgetsInTemplateMixin dijit/_WidgetBase dijit/a11yclick dijit/focus dijit/Menu dijit/MenuItem dijit/Tooltip dijit/form/Button dijit/form/DateTextBox dijit/form/DropDownButton dijit/form/NumberTextBox dijit/form/Select dijit/form/SimpleTextarea dijit/form/TimeTextBox dijit/form/ValidationTextBox dijit/layout/BorderContainer dijit/layout/ContentPane dgrid/OnDemandGrid dgrid/Selection dgrid/selector dgrid/Keyboard dgrid/editor dgrid/extensions/Pagination dgrid/extensions/DijitRegistry dgrid/extensions/ColumnHider dgrid/extensions/ColumnResizer dojo/i18n!../../nls/jsapi dojo/text!./templates/Grid.html".split(" "),
function(Q,R,g,I,J,f,n,K,S,z,t,D,A,r,T,B,E,U,V,x,W,L,C,X,ka,M,la,F,G,N,Y,H,ma,na,Z,aa,ba,ca,da,ea,fa,ga,ha,ia,ja){E=J([V,E,U],{declaredClass:"esri.dijit.FeatureTable.Grid",baseClass:"esri-feature-table-grid",templateString:ja,map:null,layer:null,layerInfo:null,idProperty:"id",sort:null,defaultSort:null,filterIds:null,where:null,batchCount:50,editable:!1,editOn:"dblclick, keypress",css:null,showAttachments:!1,showRelatedRecords:!1,showCyclicalRelationships:!1,showStatistics:!1,showFieldDetails:!1,
showGridHeader:!0,showGridMenu:!0,showFilterMenuItems:!0,showDefaultSortMenuItem:!0,showFeatureCount:!0,showDataTypes:!1,showColumnHeaderTooltips:!1,showColumnHeaderTooltipsWithDescription:!1,showColumnHider:!1,syncSelection:!1,menuFunctions:null,columnMenuFunctions:null,gridOptions:null,dateOptions:null,visibleLayerIds:null,showExpressionFields:!1,loaded:!1,store:null,columns:null,fieldInfos:null,customFieldInfos:null,expressionInfos:null,expressionCache:{},noDataMessage:"",featureCount:0,selectedFeatureCount:0,
selectedRows:null,selectedRowIds:null,optionsMenu:null,optionsMenuAnchor:null,columnMenu:null,rollbackInfos:null,attachmentInfos:null,relatedRecordInfos:null,relatedRecordCounts:null,_i18nStrings:ia.widgets.FeatureTable,_numericFieldTypes:["esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble","esriFieldTypeSmallInteger","number"],_unsupportedFieldTypes:["esriFieldTypeRaster","esriFieldTypeBlob","esriFieldTypeGeometry","esriFieldTypeXML"],_activeEditors:[],_relationshipColumnLimit:5,_nullConstant:"ft_null",
_watchers:null,_tableTitle:null,_previousSelectedRowIds:null,_loading:0,postMixInProperties:function(){this.inherited(arguments);this.set({sort:{},columns:[],fieldInfos:[],selectedRows:[],selectedRowIds:[],rollbackInfos:{},attachmentInfos:{},relatedRecordInfos:{},relatedRecordCounts:{},_watchers:[],_previousSelectedRowIds:[]})},startup:function(){this.inherited(arguments);this.showExpressionFields&&this.expressionInfos&&(this.expressionCache=g.compileExpressions(this.expressionInfos));this.dGrid=
this._generateBaseGrid();this._cleanUpGrid();this.dGrid.startup();this.dGrid.resize();this.updateHeaderText();this._generateOptionsMenu();this.showGridHeader||this.hideHeader();this.showGridMenu||this.hideOptionsMenu();this._addGridListeners()},destroy:function(){this.inherited(arguments);this.optionsMenu&&this.optionsMenu.destroy();this.columnMenu&&this.columnMenu.destroyRecursive();n.forEach(this._watchers,function(a){a.remove()})},resize:function(){this._gridBorderContainerNode&&this._gridBorderContainerNode.resize();
this._gridHeaderNode&&this._gridHeaderNode.resize();this._gridContentPaneNode&&this._gridContentPaneNode.resize();this.dGrid&&this.dGrid.resize()},setHeaderTitle:function(a){this._gridTitleNode&&(this._gridTitleNode.innerHTML=a)},showHeader:function(){A.remove(this._gridHeaderNode.domNode,this.css.hidden);this.resize()},hideHeader:function(){A.add(this._gridHeaderNode.domNode,this.css.hidden);this.resize()},showLoadingIndicator:function(){this._gridLoadingIndicatorNode&&0===this._loading&&A.remove(this._gridLoadingIndicatorNode,
this.css.hidden);this._loading++},hideLoadingIndicator:function(){this._loading--;this._gridLoadingIndicatorNode&&!this._loading&&A.add(this._gridLoadingIndicatorNode,this.css.hidden)},showOptionsMenu:function(){this._menuNode&&A.remove(this._menuNode,this.css.hidden)},hideOptionsMenu:function(){this._menuNode&&A.add(this._menuNode,this.css.hidden)},updateNoDataMessage:function(a){this.dGrid.set("noDataMessage",a)},showColumnHiderMenu:function(){this.gridOptions.columnHider&&this.dGrid._toggleColumnHiderMenu()},
refresh:function(){this.dGrid&&this.dGrid.refresh();0===this.featureCount&&this.hideLoadingIndicator();this._updateSelection().then(f.hitch(this,this.updateHeaderText))},getRowById:function(a){return this.dGrid.row(a)||{}},getRowDataById:function(a){return(a=this.getRowById(a))&&a.data?a.data:{}},emptyStore:function(){this.updateNoDataMessage("");this.updateStore(null)},updateStore:function(a){this.set("store",a);this.dGrid.set("store",a)},updateSort:function(a){this.set("sort",a[0]);this.dGrid.set("sort",
a)},updateSelectionMode:function(a){this.dGrid.set("selectionMode",a)},getColumns:function(){return this.dGrid.columns},styleColumn:function(a,b){return this.dGrid.styleColumn(a,b)},clearSelection:function(){this.dGrid.clearSelection();this._updateSelection().then(f.hitch(this,this.updateHeaderText));this.emit("clear-selection")},centerOnSelection:function(){var a=this.map,b=this.selectedRowIds;if(a&&b&&0!==b.length)return g.queryLayerForFeatures({layer:this.layer,ids:b}).then(f.hitch(function(b){(b=
b.features)&&0<b.length&&a.setExtent(g.calculateExtentFromFeatures(b))}))},selectRows:function(a,b,d){var c=this.dGrid,e=[],k;this._closeCellEditors();this.clearSelection();a instanceof Array?(n.forEach(a,function(a){c._select(a);e.push(this.getRowById(a))},this),k=a[0]):(c._select(a),k=a,e=[this.getRowById(a)]);this._updateSelection().then(f.hitch(this,function(){this.updateHeaderText();d||this.emit("row-select",{rows:e,grid:this.dGrid});b&&this._scrollToRow(k)}))},_generateBaseGrid:function(){var a=
this.gridOptions||{},b=[fa,Z,aa,da,ba,ca];a.pagination&&b.push(ea);a.columnHider&&b.push(ga);a.columnResizer&&b.push(ha);return new (J(b))({columns:this.columns,sort:[this.defaultSort],noDataMessage:this.noDataMessage,selectionMode:a.selectionMode,allowSelectAll:a.allowSelectAll,allowTextSelection:a.allowTextSelection,cellNavigation:a.cellNavigation,keepScrollPosition:a.keepScrollPosition,pageSizeOptions:a.pageSizeOptions,queryRowsOverlap:a.queryRowsOverlap,minRowsPerPage:this.batchCount,maxRowsPerPage:this.batchCount,
pagingDelay:this.pagingDelay,query:f.hitch(this,this._getQueryForGrid)},this._gridNode)},_getQueryForGrid:function(a){return!this.filterIds||-1!==n.indexOf(this.filterIds,a[this.idProperty])},_cleanUpGrid:function(){var a=this.dGrid,b=K.before(a,"removeRow",f.hitch(this,function(b){n.forEach(this.columns.length,function(d,c){d=a.cell(b,c).element;(d=d.contents||d)&&d.widget&&d.widget.destroyRecursive()})})),d=K.after(a,"renderHeader",function(){a._sortListener.remove()});this._watchers.push(b,d)},
_setUpColumns:function(a){a=this._generateFieldInfos(a);var b=this._generateColumns(a);this.set({columns:b,fieldInfos:a});this.dGrid.set("columns",b);return{fieldInfos:a,columns:b}},_generateFieldInfos:function(a){if(a&&0!==a.length&&this.layerInfo){a=this._orderFieldsForDisplay(a);var b=this.layer,d=this.layerInfo,c=[],e=this.customFieldInfos;n.forEach(a,function(a){var f=a.name,h=a.length||null,k=g.findFirst(b.fields,"name",f)||{},l=g.findFirst(e,"name",f)||g.findFirst(e,"fieldName",f);if(g.isExpressionField(f)){var k=
g.getExpressionInfo(this.expressionInfos,f),q=R.isAsync(this.expressionCache[k.name]);c.push({name:k.name,expression:!0,hasFeatureSetOperations:q,length:h,hidden:!l.visible,alias:a.alias,type:a.type,editable:a.editable,nullable:a.nullable,domain:!1,typeId:!1,subtypeDomain:!1,format:l.format||null,dateOptions:null,description:a.description})}else{var q=this.idProperty,p=this.outFields,r=this.hiddenFields,O,y,w,v,P;O=l&&(l.label||l.alias)||k.alias;y=b.getDomain&&b.getDomain(f)?b.getDomain(f):!1;w=!(!d.typeIdField||
f!==d.typeIdField);v=d.types&&n.some(d.types,function(a){if(a.domains&&a.domains[f]&&a.domains[f].name)return!0});P=!this._getFieldVisibility({field:a,hiddenFields:r,customFieldInfo:l,outFields:p});p=d.editable&&d.editCapabilities.canUpdate;r=l&&("undefined"!==typeof l.editable&&!1!==k.editable||"undefined"!==typeof l.isEditable&&!1!==k.isEditable);c.push({name:f,alias:O,length:h,type:a.type,hidden:P,editable:p&&f!==q&&k&&"undefined"!==k.editable?r?!!l.editable||!!l.isEditable:!!k.editable:!1,nullable:!!k.nullable,
domain:y,typeId:w,subtypeDomain:v,format:l&&l.format?l.format:null,dateOptions:l&&(l.dateOptions||l.format&&l.format.dateFormat)||null,stringOptions:l&&l.stringOptions?l.stringOptions:null,description:a.description})}},this);n.every(c,function(a){return a.hidden})&&(g.findFirst(c,"name",this.idProperty).hidden=!1);this.showRelatedRecords&&(a=this._generateRelatedRecordFieldInfos({relationships:b.relationships}),c=c.concat(a));this.showAttachments&&c.push({alias:this._i18nStrings.photosAndFiles,name:"esriAttachments",
type:"esriAttachments",editable:d.editable});return c}},_destroyColumns:function(){this.dGrid&&this.dGrid._destroyColumns()},_getFieldVisibility:function(a){var b=a.field,d=a.outFields,c=a.customFieldInfo;a=-1!==n.indexOf(a.hiddenFields,b.name);c=!(!c||!1!==c.visible);d="*"!==d[0]&&-1===n.indexOf(d,b.name);b="esriFieldTypeOID"===b.type||"esriFieldTypeGlobalID"===b.type;return!(a||b&&(c||d)||c||d)},_applyEdits:function(a){var b=a.row,d=a.rollbackInfo;this.showLoadingIndicator();d&&this._updateRollbackInfos(d);
this.emit("data-change",{row:b,rollbackInfo:d});return g.applyEditsFromRow({layer:this.layer,idProperty:this.idProperty,row:b}).then(f.hitch(this,function(a){var c=a.updates||[];c&&c.length&&n.forEach(c,function(a){a.success||(a.error?this.emit("error",{message:a.error}):this.emit("error",{message:this._i18nStrings.errorUpdateFailed}),d?(b=this.getRowDataById(d.rowId),b[d.fieldName]=d.oldValue,this.dGrid.updateDirty(d.rowId,d.fieldName,d.oldValue),this.refresh()):this.emit("error",{message:this._i18nStrings.errorRollback}))},
this);this.hideLoadingIndicator();this.emit("edits-complete",a)})).otherwise(f.hitch(this,function(){d&&(b=this.getRowDataById(d.rowId),b[d.fieldName]=d.oldValue,this.dGrid.updateDirty(d.rowId,d.fieldName,d.oldValue),this.refresh());this.hideLoadingIndicator();this.emit("error",{message:this._i18nStrings.errorUpdateFailed})}))},_updateRollbackInfos:function(a){if(a){var b=a.rowId;this.rollbackInfos[b]||(this.rollbackInfos[b]=[]);this.rollbackInfos[b].push(a)}},_updateSelection:function(){var a=this.dGrid.selection,
b=new T,d=[],c=[],e,f;for(f in a)a.hasOwnProperty(f)&&(e=parseInt(f,10),c.push(e),e=this.dGrid.row(e),(e=e.data)&&d.push(e));a={selectedRows:d,selectedRowIds:c,selectedFeatureCount:c.length};this.set(a);b.resolve(a);return b},_scrollToRow:function(a){var b=this.store,d=this.dGrid,c=d.row(a),e=this.sort;if(c&&b)if(c.element)c.element.scrollIntoView();else if(a=b.data[a]||c.data)b=e&&e.attribute===this.idProperty&&e.descending?b.data.length-n.indexOf(b.data,a):n.indexOf(b.data,a),d.scrollTo({x:0,y:d.rowHeight*
b-d.rowHeight}),c.element?c.element.scrollIntoView():setTimeout(function(){c.element&&c.element.scrollIntoView()},200)},_generateColumns:function(a){a=f.clone(a)||[];var b=[];n.forEach(a,function(a){a.expression?b.push(this._generateExpressionColumn(a)):"esriAttachments"===a.type?b.push(this._generateAttachmentsColumn(a)):"esriRelatedRecords"===a.type?b.push(this._generateRelatedRecordsColumn(a)):"esriFieldTypeDate"===a.type?this.dateOptions.timeEnabled||a.dateOptions&&a.dateOptions.timeEnabled?b.push(this._generateDateTimeColumn(a)):
b.push(this._generateDateColumn(a)):a.subtypeDomain&&!a.typeId?b.push(this._generateSubtypeDomainColumn(a)):a.domain?b.push(this._generateDomainColumn(a)):a.typeId?b.push(this._generateTypeColumn(a)):-1<n.indexOf(this._numericFieldTypes,a.type)?b.push(this._generateNumberColumn(a)):-1===n.indexOf(this._unsupportedFieldTypes,a.type)&&b.push(this._generateStringColumn(a))},this);return b},_orderFieldsForDisplay:function(a){var b=this.outFields,d=this.idProperty,c=[];if(b&&"*"===b[0])c=f.clone(a);else{if(!g.isValueEmpty(d)&&
-1===n.indexOf(b,d)){var e=g.findFirst(a,"name",d);e&&c.push(e)}n.forEach(b,function(b){var e=g.findFirst(a,"name",b);e&&b!==d&&-1===n.indexOf(c,e)&&c.push(e)},this);n.forEach(a,function(a){-1===n.indexOf(c,a)&&c.push(f.clone(a))})}return c},_generateDateColumn:function(a){var b=a.dateOptions||this.dateOptions;return{label:a.alias,field:a.name,type:a.type,hidden:a.hidden,className:this.css.dateValue,get:f.hitch(this,function(d){return g.isValueEmpty(d[a.name])?null:g.formatDateForLocale({dateOptions:b,
timestamp:new Date(d[a.name]),fieldInfo:a})}),renderCell:f.hitch(this,function(b,c,e){c=r.create("div",{innerHTML:g.isValueEmpty(c)?"":c},e);this._setUpDateCell({row:b,cellNode:e,fieldInfo:a,container:c})}),renderHeaderCell:f.hitch(this,function(){return this._getColumnHeaderCellContent({fieldInfo:a})})}},_generateDateTimeColumn:function(a){return{label:a.alias,field:a.name,type:a.type,hidden:a.hidden,className:this.css.dateValue,get:f.hitch(this,function(b){return g.isValueEmpty(b[a.name])?null:
g.formatDateForLocale({dateOptions:a.dateOptions||this.dateOptions,timestamp:new Date(b[a.name]),fieldInfo:a})}),renderCell:f.hitch(this,function(b,d,c){d=r.create("div",{innerHTML:g.isValueEmpty(d)?"":d},c);this._setUpDateTimeCell({row:b,cellNode:c,fieldInfo:a,container:d})}),renderHeaderCell:f.hitch(this,function(){return this._getColumnHeaderCellContent({fieldInfo:a})})}},_generateDomainColumn:function(a){return{label:a.alias,field:a.name,type:a.type,hidden:a.hidden,get:function(b){return g.getDomainValueFromRow({fieldInfo:a,
row:b})},renderHeaderCell:f.hitch(this,function(){return this._getColumnHeaderCellContent({fieldInfo:a})}),renderCell:f.hitch(this,function(b,d,c){var e=r.create("div");if(a.domain.codedValues)d=this._formatStringCellContent({fieldInfo:a,value:d}),d=String(d),d=B.encode(d),this._setUpCodedValueDomainCell({row:b,cellNode:c,fieldInfo:a,container:e});else if("range"===a.domain.type)d=this._formatNumberCellContent({fieldInfo:a,value:d}),this._setUpRangeDomainCell({row:b,cellNode:c,fieldInfo:a,container:e});
else{this.emit("error",{message:this._i18nStrings.errorDomainType});return}e.innerHTML=d;r.place(e,c)})}},_generateTypeColumn:function(a){return{label:a.alias,field:a.name,type:a.type,hidden:a.hidden,get:f.hitch(this,function(b){var d=g.getTypeValueFromRow({layerInfo:this.layerInfo,fieldInfo:a,row:b});return g.isValueEmpty(d)?b[a.name]:d}),renderCell:f.hitch(this,function(b,d,c){d=this._formatStringCellContent({fieldInfo:a,value:d});d=r.create("div",{innerHTML:d},c);this._setUpTypeCell({row:b,cellNode:c,
fieldInfo:a,container:d})}),renderHeaderCell:f.hitch(this,function(){return this._getColumnHeaderCellContent({fieldInfo:a})})}},_generateSubtypeDomainColumn:function(a){return{label:a.alias,field:a.name,type:a.type,hidden:a.hidden,editOn:this.editOn,editor:"text",get:f.hitch(this,function(b){return g.getSubtypeDomainValue({layerInfo:this.layerInfo,fieldInfo:a,row:b})}),renderHeaderCell:f.hitch(this,function(){return this._getColumnHeaderCellContent({fieldInfo:a})}),renderCell:f.hitch(this,function(b,
d,c){d=this._formatStringCellContent({fieldInfo:a,value:d});d=r.create("div",{innerHTML:d},c);this._setUpSubtypeDomainCell({row:b,cellNode:c,fieldInfo:a,container:d})})}},_generateNumberColumn:function(a){return{label:a.alias,field:a.name,type:a.type,hidden:a.hidden,renderHeaderCell:f.hitch(this,function(){return this._getColumnHeaderCellContent({fieldInfo:a})}),renderCell:f.hitch(this,function(b,d,c){d=this._formatNumberCellContent({fieldInfo:a,value:d});d=r.create("div",{innerHTML:d},c);this._setUpNumberCell({row:b,
cellNode:c,fieldInfo:a,container:d})})}},_generateStringColumn:function(a){return{label:a.alias,field:a.name,type:a.type,hidden:a.hidden,renderHeaderCell:f.hitch(this,function(){return this._getColumnHeaderCellContent({fieldInfo:a})}),renderCell:f.hitch(this,function(b,d,c){d=this._formatStringCellContent({fieldInfo:a,value:d});d=r.create("div",{innerHTML:d},c);this._setUpStringCell({row:b,cellNode:c,fieldInfo:a,container:d})})}},_generateAttachmentsColumn:function(a){var b=this.layerInfo||{};return{label:a.alias,
field:a.name,type:"esriAttachments",sortable:!1,get:f.hitch(this,function(a){a=this.attachmentInfos[a[this.idProperty]];var c;c=b.queryAttachmentsSupported?0:null;return a&&a.attachments?a.attachments.length:c}),renderCell:f.hitch(this,function(b,c,e){this._generateAttachmentsCell({row:b,fieldInfo:a,cellValue:c,cellNode:e})}),renderHeaderCell:f.hitch(this,function(){return this._getColumnHeaderCellContent({fieldInfo:a,cssClass:this.css.attachmentsTitle})})}},_generateRelatedRecordsColumn:function(a){return{label:a.alias,
field:a.name,type:"esriRelatedRecords",hidden:a.hidden,sortable:!1,get:f.hitch(this,function(b){return this._getRelatedRecordsCount({featureId:b[this.idProperty],relationshipId:a.relationship.id})}),renderCell:f.hitch(this,function(b,d,c){this._generateRelatedRecordsCell({row:b,fieldInfo:a,cellValue:d,cellNode:c})}),renderHeaderCell:f.hitch(this,function(){return this._getColumnHeaderCellContent({fieldInfo:a,cssClass:this.css.relatedRecordsTitle})})}},_generateExpressionColumn:function(a){return{label:a.alias,
field:a.name,type:"esriExpressions",sortable:!1,get:f.hitch(this,function(b){return a.hasFeatureSetOperations?null:this._getExpressionValueForField(a.name,b)}),renderCell:f.hitch(this,function(b,d,c){this._generateExpressionCell({row:b,fieldInfo:a,cellValue:d,cellNode:c})}),renderHeaderCell:f.hitch(this,function(){return this._getColumnHeaderCellContent({fieldInfo:a,cssClass:this.css.expressionsTitle})})}},_closeCellEditors:function(){n.forEach(this._activeEditors,function(a){a.widget.onBlur()});
this.set("_activeEditors",[])},_getColumnHeaderCellContent:function(a){var b=a.fieldInfo,d=a.cssClass||null;a=this.css;var c,e;e=r.create("div",{className:a.columnHeader});c=d?a.columnHeaderTitle+" "+d:a.columnHeaderTitle;!b.editable&&this.editable&&this.layerInfo.editable&&r.create("span",{className:a.lockedIconContainer+" "+a.lockedIcon},e);d=B.encode(b.alias||b.name);r.create("div",{innerHTML:d,className:c},e);r.create("div",{className:a.columnHeaderClear},e);if(this.showColumnHeaderTooltips||
this.showColumnHeaderTooltipsWithDescription)this.showColumnHeaderTooltipsWithDescription&&this.layer.supportsFieldDescription&&b.description&&b.description.value&&(d+=" - "+B.encode(b.description.value)),this.own(new X({connectId:[e],label:"\x3cdiv class\x3d"+a.columnHeaderTooltip+"\x3e"+d+"\x3c/div\x3e"}));d="esriExpressions"===b.type||"esriRelatedRecords"===b.type||"esriAttachments"===b.type;this.showDataTypes&&!d&&(r.create("div",{innerHTML:b.type.replace("esriFieldType",""),className:a.columnHeaderType},
e),r.create("div",{className:a.columnHeaderClear},e));return e},_setUpNumberCell:function(a){var b=a.row,d=a.cellNode,c=a.fieldInfo,e=a.container,k=this.idProperty,m=g.isIntegerFieldType(c.type)?0:"0,20",h,u;t(d,this.editOn,f.hitch(this,function(){var a=g.isFeatureEditable({layer:this.layer,layerInfo:this.layerInfo,attributes:b});this.editable&&c.editable&&!1!==a&&(a=g.compareIntArrays(this.selectedRowIds,this._previousSelectedRowIds),this.editOn!=x||a)&&(h&&h.destroy(),this._closeCellEditors(),e.innerHTML=
"",h=new F({value:b[c.name],required:!c.nullable,constraints:{places:m}}),h.placeAt(e),h.focus(),h.textbox.select(),this.emit("editor-show",{cell:d,editor:h,grid:this}),h.on("blur",f.hitch(this,function(){e.innerHTML=this._formatNumberCellContent({fieldInfo:c,value:b[c.name]});d.focus();this.emit("editor-hide",{cell:d,editor:h,grid:this})})),h.on("keydown",function(a){a.keyCode===z.ENTER&&h.isValid()&&h.focusNode.blur()}),h.on("change",f.hitch(this,function(a){u={fieldName:c.name,oldValue:b[c.name],
rowId:b[k],row:b};if(""===a||isNaN(a))a=null;h.isValid()?(b[c.name]=a,e.innerHTML=this._formatNumberCellContent({fieldInfo:c,value:a}),this._applyEdits({row:b,rollbackInfo:u})):e.innerHTML=this._formatNumberCellContent({fieldInfo:c,value:b[c.name]});h.destroy()})),this._activeEditors.push({id:b[k],widget:h}))}))},_setUpDateCell:function(a){var b=a.row,d=a.cellNode,c=a.fieldInfo,e=a.container,k=this.idProperty,m,h;t(d,this.editOn,f.hitch(this,function(){var a=g.isFeatureEditable({layer:this.layer,
layerInfo:this.layerInfo,attributes:b});if(this.editable&&c.editable&&!1!==a&&(a=g.compareIntArrays(this.selectedRowIds,this._previousSelectedRowIds),this.editOn!=x||a)){this._closeCellEditors();e.innerHTML="";h=c.dateOptions&&c.dateOptions.datePattern?c.dateOptions.datePattern:this.dateOptions.datePattern;m=g.isValueEmpty(b[c.name])?null:new Date(b[c.name]);var l=new M({value:m,constraints:{datePattern:h}});l.placeAt(e);l.focus();l.textbox.select();this.emit("editor-show",{cell:d,editor:l,grid:this});
l.on("blur",f.hitch(this,function(){e.innerHTML=g.isValueEmpty(b[c.name])?null:g.formatDateForLocale({dateOptions:this.dateOptions,timestamp:b[c.name],fieldInfo:c});d.focus();this.emit("editor-hide",{cell:d,editor:l,grid:this})}));l.on("keydown",function(a){a.keyCode===z.ENTER&&l.isValid()&&l.focusNode.blur()});l.on("change",f.hitch(this,function(a){if(l.isValid()){var d={fieldName:c.name,oldValue:b[c.name],rowId:b[k],row:b};b[c.name]=g.isValueEmpty(a)?null:a.getTime();e.innerHTML=g.isValueEmpty(b[c.name])?
null:g.formatDateForLocale({dateOptions:this.dateOptions,timestamp:b[c.name],fieldInfo:c});this._applyEdits({row:b,rollbackInfo:d})}else e.innerHTML=g.isValueEmpty(b[c.name])?null:g.formatDateForLocale({dateOptions:this.dateOptions,timestamp:b[c.name],fieldInfo:c})}))}}))},_setUpDateTimeCell:function(a){var b=a.row,d=a.cellNode,c=a.fieldInfo,e=a.container,k=this.idProperty,m,h,u;t(d,this.editOn,f.hitch(this,function(){var a=g.isFeatureEditable({layer:this.layer,layerInfo:this.layerInfo,attributes:b});
if(this.editable&&c.editable&&!1!==a&&(a=g.compareIntArrays(this.selectedRowIds,this._previousSelectedRowIds),this.editOn!=x||a)){this._closeCellEditors();e.innerHTML="";h=c.dateOptions&&c.dateOptions.datePattern?c.dateOptions.datePattern:this.dateOptions.datePattern;u=c.dateOptions&&c.dateOptions.timePattern?c.dateOptions.timePattern:this.dateOptions.timePattern;m=g.isValueEmpty(b[c.name])?null:new Date(b[c.name]);var q=new M({value:m,constraints:{datePattern:h}}),p=new Y({value:m,constraints:{timePattern:u}});
q.placeAt(e);p.placeAt(e);q.focus();q.textbox.select();this.emit("editor-show",{cell:d,editor:[q,p],grid:this});q.on("change",f.hitch(this,function(a){q.isValid()&&(null===a||""===a?p.setValue(null):(a=p.getValue(),null===a&&(a=new Date(0,0),p.setValue(a))))}));p.on("change",f.hitch(this,function(a){p.isValid()&&(null===a||""===a?q.setValue(null):(a=q.getValue(),null===a&&(a=new Date(0,0),q.setValue(a))))}));var r=W.watch("activeStack",f.hitch(this,function(a,f,h){a=-1!==n.indexOf(f,q.id)||-1!==n.indexOf(f,
p.id);h=-1===n.indexOf(h,q.id)&&-1===n.indexOf(h,p.id);if(a&&h){r.remove();this.emit("editor-hide",{cell:d,editor:[q,p],grid:this});a=q.getValue();f=p.getValue();h=b[c.name];if(p.isValid()&&q.isValid()){a&&f?(a=g.getCombinedDateTime(a,f).getTime(),e.innerHTML=g.formatDateForLocale({dateOptions:this.dateOptions,timestamp:new Date(a),fieldInfo:c})):(a=null,e.innerHTML="");if(b[c.name]===a)return;b[c.name]=a;this._applyEdits({row:b,rollbackInfo:{fieldName:c.name,oldValue:h,rowId:b[k],row:b}})}else e.innerHTML=
null===h?"":g.formatDateForLocale({dateOptions:this.dateOptions,timestamp:b[c.name],fieldInfo:c});q.destroy();p.destroy()}}))}}))},_setUpCodedValueDomainCell:function(a){var b=a.row,d=a.cellNode,c=a.fieldInfo;t(d,this.editOn,f.hitch(this,function(){var e=g.isFeatureEditable({layer:this.layer,layerInfo:this.layerInfo,attributes:b});if(this.editable&&c.editable&&!1!==e&&(this.editOn!=x||g.compareIntArrays(this.selectedRowIds,this._previousSelectedRowIds))){var k=c.name,e=c.domain.codedValues,m=a.container,
h=b[this.idProperty],u=[];this._closeCellEditors();m.innerHTML="";n.forEach(e,function(a){u.push({label:B.encode(String(a.name)),value:String(a.code),selected:b[k]===a.code})});g.isValueEmpty(b[k])?u.push({label:this._i18nStrings.empty,value:this._nullConstant,selected:!0,disabled:!c.nullable}):c.nullable&&u.push({label:this._i18nStrings.empty,value:this._nullConstant});var l=new G({options:u,"class":this.css.select,style:{width:"100%"}});l.placeAt(m);l.focus();this.emit("editor-show",{cell:d,editor:l,
grid:this});l.on("blur",f.hitch(this,function(){var a=g.getDomainValueFromRow({fieldInfo:c,row:b}),a=this._formatStringCellContent({fieldInfo:c,value:a}),a=String(a);m.innerHTML=B.encode(a);this.emit("editor-hide",{cell:d,editor:l,grid:this});this._activeEditors.pop()}));l.on("keydown",function(a){a.keyCode===z.ENTER&&l.focusNode.blur()});l.on("change",f.hitch(this,function(a){var d={fieldName:k,oldValue:b[k],rowId:h,row:b};a===this._nullConstant?a=null:g.isNumericFieldType(c.type)&&(a=Number(a));
b[k]=a;l.onBlur();this._applyEdits({row:b,rollbackInfo:d});l.destroy();l=null}));this._activeEditors.push({id:h,widget:l})}}))},_setUpRangeDomainCell:function(a){var b=a.row,d=a.cellNode,c=a.fieldInfo,e=a.container,k=c.domain.minValue,m=c.domain.maxValue,h=this.idProperty,u=g.isIntegerFieldType(c.type)?0:"0,20",l;t(d,this.editOn,f.hitch(this,function(){var a=g.isFeatureEditable({layer:this.layer,layerInfo:this.layerInfo,attributes:b});if(this.editable&&c.editable&&!1!==a&&(a=g.compareIntArrays(this.selectedRowIds,
this._previousSelectedRowIds),this.editOn!=x||a)){this._closeCellEditors();e.innerHTML="";var p=new F({value:b[c.name],required:!c.nullable,constraints:{min:k,max:m,places:u}});p.placeAt(e);p.focus();p.textbox.select();this.emit("editor-show",{cell:d,editor:p,grid:this});p.on("blur",f.hitch(this,function(){e.innerHTML=this._formatNumberCellContent({fieldInfo:c,value:b[c.name]});this.emit("editor-hide",{cell:d,editor:p,grid:this});this._activeEditors.pop()}));p.on("keydown",function(a){a.keyCode===
z.ENTER&&p.isValid()&&p.focusNode.blur()});p.on("change",f.hitch(this,function(a){l={fieldName:c.name,oldValue:b[c.name],rowId:b[h],row:b};p.isValid()&&(b[c.name]=a,this._applyEdits({row:b,rollbackInfo:l}));p.onBlur();p.destroy();p=null}));this._activeEditors.push({id:b[h],widget:p})}}))},_setUpTypeCell:function(a){var b=a.row,d=a.cellNode,c=a.fieldInfo,e=a.container,k=this.idProperty,m=this.layerInfo,h=m.types,u;t(d,this.editOn,f.hitch(this,function(){var a=g.isFeatureEditable({layer:this.layer,
layerInfo:this.layerInfo,attributes:b});if(this.editable&&c.editable&&!1!==a&&(this.editOn!=x||g.compareIntArrays(this.selectedRowIds,this._previousSelectedRowIds))){this._closeCellEditors();e.innerHTML="";var a=g.isValueEmpty(g.getTypeValueFromRow({layerInfo:this.layerInfo,fieldInfo:c,row:b})),q=c.name,p=b[q],r=[];n.forEach(h,function(a){r.push({label:a.name,value:String(a.id),selected:p===a.id})});g.isValueEmpty(p)?r.push({label:this._i18nStrings.empty,value:this._nullConstant,selected:!0,disabled:!0}):
a&&r.push({label:p,value:p,selected:!0,disabled:!0});var t=new G({options:r,"class":this.css.select,style:{width:"100%"}});t.placeAt(e);t.focus();this.emit("editor-show",{cell:d,editor:t,grid:this});t.on("blur",f.hitch(this,function(){var a=g.getTypeValueFromRow({layerInfo:m,fieldInfo:c,row:b});e.innerHTML=this._formatStringCellContent({fieldInfo:c,value:a||p});this.emit("editor-hide",{cell:d,editor:t,grid:this.grid});this._activeEditors.pop()}));t.on("keydown",function(a){a.keyCode===z.ENTER&&t.focusNode.blur()});
t.on("change",f.hitch(this,function(a){u={fieldName:q,oldValue:p,rowId:b[k],row:b};a===this._nullConstant?a=null:g.isNumericFieldType(c.type)&&(a=Number(a));b[q]=a;t.onBlur();this._applyEdits({row:b,rollbackInfo:u});t.destroy();t=null}));this._activeEditors.push({id:b[k],widget:t})}}))},_setUpSubtypeDomainCell:function(a){var b=a.cellNode;t(b,this.editOn,f.hitch(this,function(){var d=this.layerInfo,c=a.fieldInfo,e=a.row,k=g.isFeatureEditable({layer:this.layer,layerInfo:d,attributes:e});if(this.editable&&
c.editable&&!1!==k&&(this.editOn!=x||g.compareIntArrays(this.selectedRowIds,this._previousSelectedRowIds))){this._closeCellEditors();var m=e[this.idProperty],h=c.name,d=g.findFirst(d.types,"id",e[d.typeIdField]),u=a.container,l={},q;u.innerHTML="";d&&d.domains&&(q=d.domains[h]);if(q&&"inherited"===q.type||!q&&c.domain)q=c.domain;if(q&&q.codedValues){var p=q.codedValues,r=g.findFirst(p,"code",e[h]),t=!1,y=[];n.forEach(p,function(a){y.push({label:a.name,value:String(a.code),selected:e[h]===a.code});
a.code===r&&(t=!0)});g.isValueEmpty(e[h])&&c.nullable?y.push({label:this._i18nStrings.empty,value:this._nullConstant,selected:!0}):g.isValueEmpty(e[h])&&!c.nullable?y.push({label:this._i18nStrings.empty,value:this._nullConstant,selected:!0,disabled:!0}):c.nullable&&y.push({label:this._i18nStrings.empty,value:this._nullConstant});t||r||null===e[h]||y.push({label:e[h].toString(),value:"N/A",selected:!0,disabled:!0});var w=new G({options:y,"class":this.css.select,style:{width:"100%"}});w.placeAt(u);
w.focus();this.emit("editor-show",{cell:b,editor:w,grid:this});w.on("blur",f.hitch(this,function(){var a=g.findFirst(p,"code",e[h]);u.innerHTML=a?this._formatStringCellContent({fieldInfo:c,value:a.name}):this._formatStringCellContent({fieldInfo:c,value:e[h]});this.emit("editor-hide",{cell:b,editor:w,grid:this});this._activeEditors.pop()}));w.on("keydown",function(a){a.keyCode===z.ENTER&&w.focusNode.blur()});w.on("change",f.hitch(this,function(a){l={fieldName:h,oldValue:e[h],rowId:m,row:e};a===this._nullConstant?
a=null:g.isNumericFieldType(c.type)&&(a=Number(a));e[h]=a;w.onBlur();this._applyEdits({row:e,rollbackInfo:l});w.destroy();w=null}));this._activeEditors.push({id:m,widget:w})}else{var v=new F({value:e[h],required:!c.nullable});q&&"range"===q.type&&(v.constraints={min:q.minValue,max:q.maxValue,places:g.isIntegerFieldType(c.type)?0:"0,20"});v.placeAt(u);v.focus();v.textbox.select();this.emit("editor-show",{cell:b,editor:v,grid:this});v.on("blur",f.hitch(this,function(){u.innerHTML=e[h];this.emit("editor-hide",
{cell:b,editor:v,grid:this});this._activeEditors.pop()}));v.on("keydown",function(a){a.keyCode===z.ENTER&&v.isValid()&&v.focusNode.blur()});v.on("change",f.hitch(this,function(a){l={fieldName:h,oldValue:e[h],rowId:m,row:e};if(""===a||isNaN(a))a=null;v.isValid()&&(e[h]=a,this._applyEdits({row:e,rollbackInfo:l}));v.onBlur();v.destroy();v=null}));this._activeEditors.push({id:m,widget:v})}}}))},_setUpStringCell:function(a){var b=a.row,d=a.cellNode,c=a.fieldInfo,e=a.container,k=this.idProperty;t(d,this.editOn,
f.hitch(this,function(){var a=g.isFeatureEditable({layer:this.layer,layerInfo:this.layerInfo,attributes:b});if(this.editable&&c.editable&&!1!==a&&(a=g.compareIntArrays(this.selectedRowIds,this._previousSelectedRowIds),this.editOn!=x||a)){this._closeCellEditors();e.innerHTML="";var a=c.stringOptions,h;h=a&&a.input&&"textarea"===a.input?new N({value:b[c.name],required:!c.nullable,maxLength:c.length?c.length:null,trim:!0}):new H({value:b[c.name],required:!c.nullable,maxLength:c.length?c.length:null});
h.placeAt(e);h.focus();h.textbox.select();this.emit("editor-show",{cell:d,editor:h,grid:this});h.on("blur",f.hitch(this,function(){e.innerHTML=this._formatStringCellContent({fieldInfo:c,value:b[c.name]});d.focus();this.emit("editor-hide",{cell:d,editor:h,grid:this});this._activeEditors.pop()}));h.on("keydown",function(a){a.keyCode===z.ENTER&&h instanceof H&&h.isValid()&&h.focusNode.blur()});h.on("change",f.hitch(this,function(a){var d={fieldName:c.name,oldValue:b[c.name],rowId:b[k],row:b};""===a&&
(a=null);h instanceof H&&h.isValid()?(b[c.name]=a,this._applyEdits({row:b,rollbackInfo:d})):h instanceof N&&(!g.isValueEmpty(a)||g.isValueEmpty(a)&&c.nullable)&&(b[c.name]=a,this._applyEdits({row:b,rollbackInfo:d}));e.innerHTML=this._formatStringCellContent({fieldInfo:c,value:b[c.name]});h.destroy();h=null}));this._activeEditors.push({id:b[k],widget:h})}}))},_formatStringCellContent:function(a){var b=a.value;a=a.fieldInfo?a.fieldInfo.format:null;return g.isValueEmpty(b)?"":a?a.embeddedHTML||!1===
a.link?b:a.template?D.substitute(a.template,{value:b}):b:g.generateLinkFromString(b)},_formatNumberCellContent:function(a){var b=a.fieldInfo?a.fieldInfo.format:null;a=a.value;if(g.isValueEmpty(a))return"";a=g.formatNumberForLocale(a,b);b&&b.template&&(a=D.substitute(b.template,{value:a}));this.isLeftToRight()||(a='\x3cspan dir\x3d"ltr"\x3e'+a+"\x3c/span\x3e");return a},_generateAttachmentsCell:function(a){if(this.layerInfo){var b=a.row,d=a.cellValue,c=a.cellNode,e=a.fieldInfo;a=this.layerInfo;var k=
this.css,m=this._i18nStrings,h,u;u=g.isValueEmpty(d)?"":D.substitute(m.parenValue,{value:d});h=r.create("div",{innerHTML:u,className:k.attachmentsCell},c);r.create("span",{innerHTML:0<d||!a.queryAttachmentsSupported?" "+m.show:this.editable&&a.editable?" "+m.add:"",className:k.attachmentsLink},h);t(h,x,f.hitch(this,function(){this._showAttachmentsHandler({row:b,fieldInfo:e,cellValue:d,cellNode:c,textContainer:h})}))}},_generateRelatedRecordsCell:function(a){var b=a.row,d=a.cellValue,c=a.cellNode,
e=a.fieldInfo;a=this.css;var k=this._i18nStrings,m;m=g.isValueEmpty(d)?"":D.substitute(k.parenValue,{value:d})+" ";m=r.create("div",{innerHTML:m,className:a.relatedRecordsCell},c);r.create("span",{innerHTML:0<d?k.show:"",className:a.relatedRecordsLink},m);t(c,x,f.hitch(this,function(a){0<d&&(a=this.dGrid.cell(a).column,this._showRelatedRecordsHandler({row:b,fieldInfo:e,column:a,count:d}))}))},_generateExpressionCell:function(a){var b=a.row,d=a.cellValue,c=a.fieldInfo,e=r.create("div",{className:this.css.expressionsCell},
a.cellNode);if(c.hasFeatureSetOperations)var g=r.create("span",{innerHTML:this._i18nStrings.show,className:this.css.expressionsLink},e),m=t(e,x,f.hitch(this,function(){var a=r.create("div",{className:this.css.cellLoadingIndicator});r.place(a,g,"replace");(a=this._getExpressionValueForField(c.name,b))&&a.then?a.then(f.hitch(this,function(a){e.innerHTML=this._formatExpressionCellContent(c,a)})).otherwise(f.hitch(this,function(a){e.innerHTML=this._i18nStrings.dataError})):e.innerHTML="";m.remove()}));
else e.innerHTML=this._formatExpressionCellContent(c,d)},updateHeaderText:function(a){var b=a?a.count:null,d=a?a.selectedCount:null,c=a?a.title:null;a=a?a.showFilterCount:!0;c=g.isValueEmpty(c)?this._tableTitle||this.layer.name||this._i18nStrings.untitled:c;b=g.isValueEmpty(b)?this.featureCount:b;d=g.isValueEmpty(d)?this.selectedFeatureCount:d;this.filterIds&&0<this.filterIds.length&&a&&(b=this.filterIds.length);this.showFeatureCount?this.setHeaderTitle(D.substitute(this._i18nStrings.gridHeader,{gridTitle:c,
featureCount:b,featureSelectedCount:d})):this.setHeaderTitle(c)},_generateOptionsMenu:function(){var a=this.css,b=this._i18nStrings,a=r.create("div",{className:a.menuItem+" "+a.button+" "+a.menuIcon,title:b.options,"aria-label":b.options,tabIndex:0},this._gridMenuNode);t(a,[x,"keydown"],f.hitch(this,function(a){"Tab"!==a.key&&this._showOptionsMenu(a)}));this.optionsMenuAnchor=a},_showOptionsMenu:function(a){var b=this.optionsMenuAnchor,d=this.css,c,e,g,m;this.optionsMenu&&(this.optionsMenu.destroy(),
this.optionsMenu=null);e=b.getBoundingClientRect();g=e.top+e.height;m=this.isLeftToRight()?e.left+e.width:e.right-e.width;c=new L({className:d.optionsMenu});e=this._generateOptionsMenuItems();n.forEach(e,function(a){a=new C({label:a.label,baseClass:d.menuItem,onClick:f.hitch(this,a.callback)});c.addChild(a)},this);c._openMyself({target:a.target,delegatedTarget:b,iframe:null,coords:{x:m,y:g}});this.optionsMenu=c},_generateOptionsMenuItems:function(){var a=[];this.showDefaultSortMenuItem&&a.push({label:this._i18nStrings.defaultSort,
callback:this._sortFieldDefaultCallback});this.showFilterMenuItems?a.push({label:this._i18nStrings.showSelected,callback:this._showSelectedRecordsCallback},{label:this._i18nStrings.clearSelection,callback:this._clearFilterCallback}):a.push({label:this._i18nStrings.clearSelection,callback:this.clearSelection});this.gridOptions.columnHider&&a.push({label:this._i18nStrings.toggleColumns,callback:this.showColumnToggleMenu});this.map&&this.syncSelection&&a.push({label:this._i18nStrings.centerOnSelection,
callback:this.centerOnSelection});this.menuFunctions&&0<this.menuFunctions.length&&n.forEach(this.menuFunctions,function(b){a.push({label:b.label,callback:b.callback})},this);return a},_sortFieldDefaultCallback:function(){var a=this.defaultSort.attribute,b=this.defaultSort.descending;this.set("sort",{field:a,descending:b});this.emit("sort",{field:a,descending:b,orderByFields:[g.getOrderByString(a,b)]})},_showSelectedRecordsCallback:function(){0!==this.selectedRowIds.length&&this.emit("show-selected-records",
{ids:this.selectedRowIds})},_clearFilterCallback:function(){this.emit("clear-selection");this.emit("clear-filter")},showColumnToggleMenu:function(){this.dGrid._toggleColumnHiderMenu()},_generateColumnMenu:function(a){var b=this.dGrid.cell(a),d=b?b.column:null;if(d){var c=this.columnMenu,e=this.css,k=this.columnMenuFunctions,d=d.id,m=this.dGrid.columns[d],h=g.findFirst(this.fieldInfos,"name",m.field),u;c&&this.set("columnMenu",null);!1!==m.sortable&&(u=new L({className:e.columnMenu}),this._generateSortMenuItems({menu:u,
columnId:d}),this._generateStatisticsMenuItem({menu:u,fieldInfo:h,columnId:d}),this._generateFieldDetailsMenuItem({menu:u,fieldInfo:h,column:m}),k&&0<k.length&&n.forEach(k,function(a){u.addChild(new C({label:a.label,iconClass:a.iconClass||"",baseClass:a.baseClass||"",onClick:f.hitch(this,a.callback,h)}))}),u.startup(),this._showColumnMenu({menu:u,cell:b,evt:a,fieldInfo:h,previousMenu:c}),this.set("columnMenu",u))}},_showColumnMenu:function(a){var b=a.menu,d=a.cell,c=a.evt,e=a.previousMenu,f;f=d.element.getBoundingClientRect();
a=f.top+f.height;f=this.isLeftToRight()?f.right-f.width:f.right;b._openMyself({target:c.target,delegatedTarget:d,iframe:null,coords:{x:f,y:a}});t(b,"close",function(){e&&(e.destroyRecursive(),e=null)})},_generateSortMenuItems:function(a){var b=a.menu;a=a.columnId;var d=this.css;b.addChild(new C({label:this._i18nStrings.sortAsc,iconClass:d.sortAscendingIcon,baseClass:d.menuItem,onClick:f.hitch(this,this._sortFieldAscendingHandler,a)}));b.addChild(new C({label:this._i18nStrings.sortDesc,iconClass:d.sortDescendingIcon,
baseClass:d.menuItem,onClick:f.hitch(this,this._sortFieldDescendingHandler,a)}))},_sortFieldAscendingHandler:function(a){var b=this.dGrid.columns[a];this.emit("sort",{column:b,id:a,field:b.field,descending:!1,orderByFields:[g.getOrderByString(b.field,!1)]})},_sortFieldDescendingHandler:function(a){var b=this.dGrid.columns[a];this.emit("sort",{column:b,id:a,field:b.field,descending:!0,orderByFields:[g.getOrderByString(b.field,!0)]})},_generateStatisticsMenuItem:function(a){var b=a.menu,d=a.fieldInfo,
c=this.css,e=this.layer,k=!!this.layerInfo.isFeatureCollection,e=e.advancedQueryCapabilities.supportsStatistics||e.supportsStatistics;!this.showStatistics||!e||!d||d.domain&&d.domain.codedValues||d.subtypeDomain||d.typeId||k||g.isNumericFieldType(d.type)&&b.addChild(new C({label:this._i18nStrings.statistics,iconClass:c.statisticsIcon,baseClass:c.menuItem,onClick:f.hitch(this,this._showStatisticsHandler,a)}))},_generateFieldDetailsMenuItem:function(a){if(this.showFieldDetails){var b=a.menu,d=a.fieldInfo,
c=parseInt(a.column.id,10);a=this.css;"esriFieldTypeOID"!==d.type&&"esriFieldTypeGlobalID"!==d.type&&-1===n.indexOf(this._unsupportedFieldTypes,d.type)&&b.addChild(new C({label:this._i18nStrings.showDetailedView,iconClass:a.propertiesIcon,baseClass:a.menuItem,onClick:f.hitch(this,function(){this.emit("show-detailed-field-view",{columnId:c,fieldInfo:d})})}))}},_fetchAttachments:function(a){return g.queryLayerForAttachments({layer:this.layer,ids:a||null})},_showAttachmentsHandler:function(a){var b=
a.row,d=a.fieldInfo,c=a.cellValue,e=a.cellNode,g=this.layerInfo,m=b[this.idProperty],h,n;if(0!==c||g.editCapabilities.canCreate)a=I.generateAttachmentsDialog({layer:this.layer,featureId:m,attachments:this.attachmentInfos[m]?this.attachmentInfos[m].attachments:[],editable:this.editable&&g.editable,css:this.css}),n=a.featureAttachments,h=n.attachments,this.own(n.on("add-complete",f.hitch(this,function(a){this.attachmentInfos[m]||(this.attachmentInfos[m]={attachments:[]});this.attachmentInfos[m].attachments=
a.attachments;g.queryAttachmentsSupported&&(c+=1);e.innerHTML="";this._generateAttachmentsCell({row:b,fieldInfo:d,cellValue:c,cellNode:e});this.emit("add-attachment-complete",a)})),n.on("delete-complete",f.hitch(this,function(a){this.attachmentInfos[m]||(this.attachmentInfos[m]={attachments:[]});this.attachmentInfos[m].attachments=a.attachments;g.queryAttachmentsSupported&&--c;e.innerHTML="";this._generateAttachmentsCell({row:b,fieldInfo:d,cellValue:c,cellNode:e});this.emit("delete-attachment-complete",
a)}))),this.emit("show-attachments",{featureId:m,attachments:h,dialog:a.dialog})},_updateAttachmentInfos:function(a){return f.mixin(this.attachmentInfos,a)},_fetchRelatedRecords:function(a){return g.queryLayerForRelatedRecords({layer:this.layer,ids:a.ids||null,relationship:a.relationship,outFields:a.outFields||["*"]})},_showRelatedRecordsHandler:function(a){var b=a.row,d=this.idProperty,c=b[d],e=a.fieldInfo.relationship;a=a.count;var f=this.columns,m=this.layer,h=m.getField(e.keyField),r=(h=h?h.name:
null)?b[h]:null,l,q;l=n.filter(f,function(a){return!a.hidden});d=[g.findFirst(l,"field",m.displayField),g.findFirst(l,"field",h),g.findFirst(l,"type","esriFieldTypeString"),g.findFirstNumberColumn(f,d),g.findFirst(l,"type","esriFieldTypeDate")];n.some(d,function(a){if(this._validateRelatedColumnDisplay(a))return q=n.indexOf(f,a),!0},this);g.isValueEmpty(q)&&(q=0);this.emit("show-related-records",{row:b,featureId:c,keyField:h,keyFieldValue:r,columnId:q,relationship:e,count:a})},_setUpRelatedRecordInfos:function(a){var b=
a.records,d=this.relatedRecordInfos;n.forEach(a.relationships,function(a,e){d[a.id]=b[e]});return d},_updateRelatedRecordInfos:function(a){this.relatedRecordInfos=g.mergeDictionaries(this.relatedRecordInfos,a)},_updateRelatedRecordCounts:function(a){var b=this.relatedRecordCounts,d={};n.forEach(this.layer.relationships,function(b){var c=a[b.id];if(c){var c=c.relatedRecordGroups,f=b.id;d[f]={};n.forEach(c,function(a){d[f][a.objectId]={count:a.count}})}});this.relatedRecordCounts=g.mergeDictionaries(b,
d)},_getRelatedRecordsById:function(a){var b=a.featureId;a=a.relationshipId;return this.relatedRecordInfos[a]?this.relatedRecordInfos[a][b]:[]},_getRelatedRecordsCount:function(a){var b=a.featureId;a=a.relationshipId;return this.layerInfo.supportsAdvancedQueryRelated?(b=this.relatedRecordCounts[a]?this.relatedRecordCounts[a][b]:{})?b.count:0:(b=this._getRelatedRecordsById({featureId:b,relationshipId:a}))&&b.features?b.features.length:0},_generateRelatedRecordFieldInfos:function(a){var b=[],d=this.visibleLayerIds,
c=!1,e,f;n.some(a.relationships,function(a,h){h===this._relationshipColumnLimit&&(c=!0);f=g.isCyclicalRelationship(a);(e=d?d[d.length-1]===a.relatedTableId:!1)&&f&&!this.showCyclicalRelationships||b.push({alias:a.name,name:a.name,type:"esriRelatedRecords",hidden:c,relatedIndex:h,relationship:a})},this);return b},_validateRelatedColumnDisplay:function(a){return!(!a||a.hidden||-1===n.indexOf(this.columns,a)||"esriFieldTypeOID"===a.type||"esriFieldTypeGlobalID"===a.type)},_getExpressionValueForField:function(a,
b){var d=b[this.idProperty];a=this.expressionCache[a];b=this.layerInfo.isFeatureCollection?g.findFirst(this.layer.graphics,"attributes",b):this.store.data[d];return g.getExpressionValue(b,a)},_formatExpressionCellContent:function(a,b){if(g.isValueEmpty(b))return"";"number"==a.type?b=this._formatNumberCellContent({fieldInfo:a,value:b}):(b=String(b),b=B.encode(b),b=this._formatStringCellContent({fieldInfo:a,value:b}),b=b.replace(/(\n)/ig,"\x3cspan class\x3d'charNewLine'\x3e$1\x3c/span\x3e"));return b},
_showStatisticsHandler:function(a){var b=a.columnId,d=a.fieldInfo,c;a=this.where||this.layer.getDefinitionExpression?this.layer.getDefinitionExpression():"1\x3d1";g.getFieldStatistics({grid:this.dGrid,layer:this.layer,fieldInfo:d,idProperty:this.idProperty,filterIds:this.filterIds,where:a,columnId:b}).then(f.hitch(this,function(a){c=I.generateStatisticsDialog({data:a,fieldInfo:d,css:this.css});this.emit("show-statistics",c)}))},_addGridListeners:function(){this._setUpRowSelectListener();this._setUpRowDeselectListener();
this._setUpDataChangeListener();this._setUpRefreshListener();this._setUpColumnClickListener();this._setUpColumnStateChangeListener();this._setUpColumnResizeListener();this._setUpErrorListener();this._setUpSortListener();this._setUpFilterListener();this._setUpEditorShowListener();this._setUpEditorHideListener();this.own(this._setUpStoreLoadListener(),this._setUpLayerClickListener(),this._setUpLayerSelectionCompleteListener(),this._setUpLayerSelectionClearListener(),this._setUpLayerUpdateEndListener(),
this._setUpLayerRefreshTickListener())},_setUpStoreLoadListener:function(){var a=this.watch("store",f.hitch(this,function(b,d,c){null===d&&c&&(this.set("loaded",!0),this.emit("load",{loaded:!0}),a.remove())}));return a},_setUpRowSelectListener:function(){return this.dGrid.on("dgrid-select",f.hitch(this,function(a){this._updateSelection().then(f.hitch(this,function(){this.updateHeaderText();this.emit("row-select",a)}))}))},_setUpRowDeselectListener:function(){return this.dGrid.on("dgrid-deselect",
f.hitch(this,function(a){this._previousSelectedRowIds=this.selectedRowIds;this._updateSelection().then(f.hitch(this,function(){this.updateHeaderText();this.emit("row-deselect",a)}))}))},_setUpDataChangeListener:function(){return this.dGrid.on("dgrid-datachange",f.hitch(this,function(a){var b=a.cell.column.field,d=g.findFirst(this.fieldInfos,"name",b),c=a.cell.row.data,e=c[this.idProperty],k=a.value;a=a.oldValue;var m=g.isIntegerFieldType(d.type),d=g.isFloatFieldType(d.type),h={oldValue:a,fieldName:b,
rowId:e,row:c};""===k&&(k=null);m&&null!==k&&(k=parseInt(k,10));d&&null!==k&&(k=parseFloat(k));k&&k.getTime&&k.getTime()?c[b]=k.getTime():c[b]=k;this.showLoadingIndicator();this._updateSelection().then(f.hitch(this,function(){this.updateHeaderText();this._applyEdits({row:c,rollbackInfo:h})}));this.emit("data-change",{row:c,rollbackInfo:h})}))},_setUpRefreshListener:function(){return this.dGrid.on("dgrid-refresh-complete",f.hitch(this,function(a){this.dGrid.columns[0]&&this.emit("refresh",a)}))},_setUpColumnClickListener:function(){return this.dGrid.on(".dgrid-header .dgrid-cell:click",
f.hitch(this,this._generateColumnMenu))},_setUpColumnStateChangeListener:function(){return this.dGrid.on("dgrid-columnstatechange",f.hitch(this,function(a){this.emit("column-state-change",a)}))},_setUpColumnResizeListener:function(){return this.dGrid.on("dgrid-columnresize",f.hitch(this,function(a){this.emit("column-resize",a)}))},_setUpErrorListener:function(){return this.dGrid.on("dgrid-error",f.hitch(this,function(a){this.emit("error",a)}))},_setUpSortListener:function(){return this.dGrid.on("dgrid-sort",
f.hitch(this,function(a){this.emit("sort",a)}))},_setUpFilterListener:function(){return this.dGrid.on("dgrid-filter",f.hitch(this,function(a){this.emit("filter",a)}))},_setUpEditorShowListener:function(){return this.dGrid.on("dgrid-editor-show",f.hitch(this,function(a){this.emit("editor-show",a)}))},_setUpEditorHideListener:function(){return this.dGrid.on("dgrid-editor-hide",f.hitch(this,function(a){this.emit("editor-hide",a)}))},_setUpLayerClickListener:function(){return t(this.layer,"click",f.hitch(this,
function(a){this.emit("layer-click",a)}))},_setUpLayerSelectionCompleteListener:function(){return t(this.layer,"selection-complete",f.hitch(this,function(a){this.emit("layer-selection-complete",a)}))},_setUpLayerSelectionClearListener:function(){return t(this.layer,"selection-clear",f.hitch(this,function(a){this.emit("layer-selection-clear",a)}))},_setUpLayerUpdateEndListener:function(){return t(this.layer,"update-end",f.hitch(this,function(a){this.emit("layer-update-end",a)}))},_setUpLayerRefreshTickListener:function(){return t(this.layer,
"refresh-tick",f.hitch(this,function(a){this.emit("layer-refresh-tick",a)}))}});S("extend-esri")&&f.setObject("dijit.Grid",E,Q);return E});