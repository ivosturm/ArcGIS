// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.
//>>built
define("esri/dijit/analysis/AnalysisBase","require dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/_base/json dojo/has dojo/json dojo/Deferred dojo/promise/all dojo/when dojo/data/ItemFileWriteStore dojo/string dojo/Evented dojo/_base/kernel dojo/Stateful ../../kernel ../../lang ../../request ../../tasks/Geoprocessor dojo/i18n!../../nls/jsapi ./utils ./storageUtils ./ItemTypes ../../IdentityManager".split(" "),function(w,u,e,m,f,B,F,p,z,G,H,x,C,D,E,h,g,k,y,v,n,A,q){u=u([E,C],{declaredClass:"esri.dijit.analysis.AnalysisBase",
isOutputLayerItemUpdated:!1,analysisGpServer:null,toolName:null,portalUrl:null,jobParams:null,itemParams:null,gp:null,resultParameter:null,signInPromise:null,getResultLyrInfos:!1,checkCreditLimits:!1,useGPCreditTask:!0,_isGPCreditSync:!0,_jobInfo:null,_popupInfo:null,_toolServiceUrl:null,_counter:null,_analysisType:"feature",doRefreshItem:!0,doSaveJobInfo:!1,doSaveInStorage:!1,_doDeleteViewResult:!1,outputName:"OutputName",_freeGPTools:["CreateWatersheds","CreateViewshed","TraceDownstream"],constructor:function(a){this.isOutputLayerItemUpdated=
!1;this._rids=[];this._counter=0;this._popupInfo=[];a.analysisGpServer?this._signIn(a.analysisGpServer):a.portalUrl&&(this.portalUrl=a.portalUrl,this._signIn(a.portalUrl,!0));this.i18n={};e.mixin(this.i18n,v.common);e.mixin(this.i18n,v.analysisTools);e.mixin(this.i18n,v.analysisMsgCodes);e.mixin(this.i18n,v.analysisSettings);this.signInPromise.then(e.hitch(this,this._initErrorHelpMap))},execute:function(a){var b,c,d;this.jobParams=a.jobParams;this.jobParams.actualOutputName=this.outputName;d=this.jobParams[this.outputName];
this._analysisType=a.analysisType||"feature";this._updateContext();b=f.fromJson(this.jobParams.context);d&&(c=f.fromJson(d));!d||c&&!c.serviceProperties?(this.itemParams=null,this.jobParams.resultName=this.get("resultName")):this.showGeoAnalyticsParams&&d&&b&&b.dataStore&&-1===["BDS","GDB"].indexOf(b.dataStore)?(this.jobParams._gaxOutName=c.serviceProperties.name.replace(/[\s]|\-|\./g,"_"),this.jobParams[this.outputName]=null,this.jobParams.outputType=q.BDFSTEMPLATE,this.itemParams=null):this.itemParams=
a.itemParams;g.isDefined(a.isSpatioTemporalDataStore)&&(this._isSpatioTemporalDataStore=n.settingsVM&&n.settingsVM.datastore&&"CopyToDataStore"!==this.toolName?"BDS"===n.settingsVM.datastore:a.isSpatioTemporalDataStore);this.signInPromise.then(e.hitch(this,this._checkUser))},_updateContext:function(){var a;this.rerun&&this.context&&this._useExtentCheck&&!this._useExtentCheck.get("checked")&&(this.context.extent=null);this.context&&((a=f.fromJson(this.jobParams.context))||(a={}),this.context.outSR&&
!a.outSR&&(a.outSR=this.context.outSR),this.context.processSR&&!a.processSR&&(a.processSR=this.context.processSR),this.context.extent&&!a.extent&&(a.extent=this.context.extent),this.showGeoAnalyticsParams&&this.context.dataStore&&!a.dataStore&&(a.dataStore=this.context.dataStore),"raster"===this._analysisType&&(this.context.cellSize&&!a.cellSize&&(a.cellSize=this.context.cellSize),!this.context.mask||a.mask||this.isDLTool||(a.mask=this.context.mask),!this.context.snapRaster||a.snapRaster||this.isDetectObjectTool||
(a.snapRaster=this.context.snapRaster)),this.isDLTool&&(this.context.processorType&&!a.processorType&&(a.processorType=this.context.processorType),"feature"===this._analysisType&&this.context.cellSize&&!a.cellSize&&(a.cellSize=this.context.cellSize)),this.isPPFTool&&this.context.parallelProcessingFactor&&!a.parallelProcessingFactor&&(a.parallelProcessingFactor=this.context.parallelProcessingFactor),this.jobParams.context=f.toJson(a))},_checkUser:function(){var a;if(a=h.id.findCredential(this.portalUrl).userId)a=
this.portalUrl+"/sharing/rest/community/users/"+a,k({url:a,content:{f:"json"}}).then(e.hitch(this,this._handleUserProfileResponse),e.hitch(this,function(a){this.emit("job-fail",{message:a.message+(a.details?a.details.toString():""),jobParams:this.jobParams})}))},getUserProfile:function(){var a=new p;this.userProfile?a.resolve(this.userProfile):this.signInPromise.then(e.hitch(this,function(b){if(b=b.userId)b=this.portalUrl+"/sharing/rest/community/users/"+b,k({url:b,content:{f:"json"}}).then(e.hitch(this,
function(b){this.userProfile=b;a.resolve(b)}),e.hitch(this,function(b){a.reject(b)}))}));return a.promise},_handleUserProfileResponse:function(a){var b=this.jobParams.outputType&&this.jobParams.outputType===q.FLAYERVIEW;if(g.isDefined(a)&&g.isDefined(a.orgId))if(-1===m.indexOf(["account_admin","account_publisher","org_admin","org_publisher"],a.role))this.emit("job-fail",{message:this.i18n.pubRoleMsg,messageCode:"AB_0001",jobParams:this.jobParams});else if(g.isDefined(a.availableCredits)&&this.get("checkCreditLimits")&&
!b&&!this._byPassCreditCheck(this.toolName)){var c,b={},d,l;l=this._cleanUpJobParamsForSubmit();for(c in l)l.hasOwnProperty(c)&&("object"===typeof l[c]?b[c]=f.toJson(l[c]):-1!==m.indexOf(["measurementtype"],c.toLowerCase())&&"StraightLine"!==l[c]?(d=f.fromJson(l[c]),b[c]=d?d.name.replace(/[\s~`!#$%\^&*+=\-\[\]\\';,\/{}|\\":<>\?]/g,""):"DrivingTime"):b[c]=l[c]);this.getCreditsEstimate(this.toolName,b).always(e.hitch(this,function(b){var c=b&&g.isDefined(b.cost)?b.cost:b.maximumCost;g.isDefined(c)&&
a.availableCredits>c?g.isDefined(this.itemParams)?this._checkServiceName(a.orgId):(this.emit("start",this.jobParams),this._submitGpJob()):b&&(b.messageCode||b.message)&&0!==b.status?(c=g.isDefined(this.i18n[b.messageCode])?this.i18n[b.messageCode]:b.message,c=g.isDefined(b.params)?x.substitute(c,b.params):c,this.emit("job-fail",{message:c,messageCode:"AB_0001",jobParams:this.jobParams})):g.isDefined(this.itemParams)?this._checkServiceName(a.orgId):(this.emit("start",this.jobParams),this._submitGpJob())}))}else g.isDefined(this.itemParams)?
this._checkServiceName(a.orgId):(this.emit("start",this.jobParams),this._submitGpJob());else this.emit("job-fail",{message:this.i18n.orgUsrMsg,jobParams:this.jobParams})},_checkServiceName:function(a){var b;h.id.findCredential(this.portalUrl);a=this.portalUrl+"/sharing/rest/portals/"+a+"/isServiceNameAvailable";b=f.fromJson(this.jobParams[this.outputName]);g.isDefined(b.serviceProperties)&&g.isDefined(b.serviceProperties.name)&&(b.serviceProperties.name=b.serviceProperties.name.replace(/[\s]|\-|\./g,
"_"),this.jobParams[this.outputName]=f.toJson(b));k({url:a,content:{name:b.serviceProperties.name,type:"raster"===this._analysisType?"Image Service":"Feature Service",f:"json"}}).then(e.hitch(this,function(a){a.available?("raster"===this._analysisType?this._createImageService():this._createService(),this.emit("start",this.jobParams)):this.emit("job-fail",{message:this.i18n.servNameExists,type:"warning",messageCode:"AB_0002",jobParams:this.jobParams})}),e.hitch(this,function(a){this.emit("job-fail",
{message:a.message+(a.details?a.details.toString():""),jobParams:this.jobParams})}))},_createService:function(){var a,b,c,d=this._submitGpJob;a=h.id.findCredential(this.portalUrl).userId;b=f.fromJson(this.jobParams[this.outputName]);a&&(c=this.itemParams.folder,a=this.portalUrl+"/sharing/rest/content/users/"+a+(c&&"/"!==c?"/"+c:"")+"/createService",b={createParameters:f.toJson({currentVersion:10.2,serviceDescription:"",hasVersionedData:!1,supportsDisconnectedEditing:!1,hasStaticData:!0,maxRecordCount:2E3,
supportedQueryFormats:"JSON",capabilities:"Query",description:"",copyrightText:"",allowGeometryUpdates:!1,syncEnabled:!1,editorTrackingInfo:{enableEditorTracking:!1,enableOwnershipAccessControl:!1,allowOthersToUpdate:!0,allowOthersToDelete:!0},xssPreventionInfo:{xssPreventionEnabled:!0,xssPreventionRule:"InputOnly",xssInputRule:"rejectInvalid"},tables:[],name:b.serviceProperties.name}),outputType:"featureService",f:"json"},this._isSpatioTemporalDataStore&&(c=f.fromJson(b.createParameters),c.options=
{dataSourceType:"spatiotemporal"},b.createParameters=f.toJson(c)),this.jobParams.outputType&&this.jobParams.outputType===q.FLAYERVIEW&&(c=f.fromJson(b.createParameters),e.mixin(b,this._getViewCreateParams()),b.createParameters=f.toJson(c),d=this._addViewDefinition),k({url:a,content:b},{usePost:!0}).then(e.hitch(this,d),e.hitch(this,this._handleCreateServiceError)))},_createImageService:function(){var a,b,c;a=h.id.findCredential(this.portalUrl).userId;b=f.fromJson(this.jobParams[this.outputName]);
a&&(c=this.itemParams.folder,a=this.portalUrl+"/sharing/rest/content/users/"+a+(c&&"/"!==c?"/"+c:"")+"/createService",b={createParameters:f.toJson({name:b.serviceProperties.name,description:"",capabilities:"Image",properties:{path:"@",description:"",copyright:""}}),outputType:"imageService",f:"json"},k({url:a,content:b},{usePost:!0}).then(e.hitch(this,this._submitGpJob),e.hitch(this,this._handleCreateServiceError)))},_handleCreateServiceError:function(a){this.emit("job-fail",{message:a.message+(a.details?
a.details.toString():""),jobParams:this.jobParams})},_getViewCreateParams:function(){return{isView:!0}},_addViewDefinition:function(a){var b,c;this.itemParams&&(this.currentGpItemId=a.itemId,b=f.fromJson(this.jobParams[this.outputName]),b.serviceProperties&&(b.serviceProperties.serviceUrl=a.serviceurl),b.itemProperties={itemId:a.itemId},this.itemParams.folder&&(b.itemProperties.folderId=this.itemParams.folder),this.jobParams[this.outputName]=f.toJson(b));this.getViewParams({jobParams:this.jobParams,
resultService:{url:a.serviceurl,itemId:a.itemId}}).then(e.hitch(this,function(b){c=b;var d={jobId:"ViewJob_"+(new Date).getTime(),jobStatus:"esriJobSubmitted",jobParams:this.jobParams};this._addToDefinition(a.serviceurl,c).then(e.hitch(this,function(a){var b={value:{}};this._doDeleteViewResult||(this._jobInfo.jobStatus="esriJobSucceeded",setTimeout(e.hitch(this,function(){this.itemParams.properties={jobUrl:a.serviceurl+"/jobs/"+this._jobInfo.jobId,jobType:"GPServer",jobId:this._jobInfo.jobId,jobStatus:"completed"};
this._readItem()}),300),this.doSaveJobInfo&&this.saveJobInfo(this._jobInfo),b.outputLayerName=f.fromJson(this.jobParams[this.outputName]).serviceProperties.name,b.value.itemId=this.currentGpItemId,b.analysisInfo={toolName:this.toolName,secondaryOutputs:this.secondaryOutputs,jobParams:this.jobParams},this.emit("job-result",b))}),e.hitch(this,this._gpJobFailed));this.emit("job-submit",this.jobParams);setTimeout(e.hitch(this,function(){this._jobInfo=d;this._jobInfo.jobStatus="esriJobExecuting";this._readItem();
this.emit("job-status",this._jobInfo)},0))}),e.hitch(this,this._gpJobFailed))},_addToDefinition:function(a,b){a=a.replace("/rest/services","/rest/admin/services")+"/addToDefinition";var c=h.id.findCredential(this.portalUrl);b={f:"json",addToDefinition:f.toJson(b),token:c.token};return k({url:a,content:b},{usePost:!0})},_getAdminLayerInfo:function(a){a=a.replace("/rest/services","/rest/admin/services");var b;b={f:"json",token:h.id.findCredential(this.portalUrl).token};return k({url:a,content:b})},
_getSelf:function(a){return k({url:a+"/sharing/rest/portals/self",content:{culture:D.locale,f:"json"},callbackParamName:"callback",timeout:0},{})},_submitGpJob:function(a){var b,c,d;c=f.fromJson(this.jobParams.context);this._doCancelCleanup=!1;this.itemParams&&(this.currentGpItemId=a.itemId,b=f.fromJson(this.jobParams[this.outputName]),b.serviceProperties&&(b.serviceProperties.serviceUrl=a.serviceurl),b.itemProperties={itemId:a.itemId},this.itemParams.folder&&(b.itemProperties.folderId=this.itemParams.folder),
this.jobParams[this.outputName]=f.toJson(b));this.analysisGpServer?(this._toolServiceUrl&&this.gp||this.set("toolServiceUrl",this.analysisGpServer+"/"+this.toolName),this.gp.setUpdateDelay(3E3),this.showGeoAnalyticsParams&&this.jobParams._gaxOutName&&c.dataStore&&-1===["BDS","GDB"].indexOf(c.dataStore)&&(d=this.jobParams[this.outputName]=this.jobParams._gaxOutName,delete this.jobParams._gaxOutName),this.itemParams||delete this.jobParams.resultName,this.gp.submitJob(this._cleanUpJobParamsForSubmit(),
e.hitch(this,this._gpJobComplete),e.hitch(this,this._gpJobStatus),e.hitch(this,this._gpJobFailed)),this.itemParams||(this.jobParams.resultName=this.get("resultName")),d&&(this.jobParams[this.outputName]=null),this.emit("job-submit",this.jobParams)):this._getSelf(this.portalUrl).then(e.hitch(this,function(a){this.analysisGpServer=a.helperServices.analysis&&a.helperServices.analysis.url?a.helperServices.analysis.url:null;this.set("toolServiceUrl",this.analysisGpServer+"/"+this.toolName);this.gp.setUpdateDelay(3E3);
this.itemParams||delete this.jobParams.resultName;this.gp.submitJob(this.jobParams,e.hitch(this,this._gpJobComplete),e.hitch(this,this._gpJobStatus),e.hitch(this,this._gpJobFailed));this.itemParams||(this.jobParams.resultName=this.get("resultName"));this.emit("job-submit",this.jobParams)}))},_cleanUpJobParamsForSubmit:function(){var a=e.mixin({},this.jobParams),b=["actualOutputName","aLayer","attributeExprObj","data","resultName"].concat(this.removeJobParamKeys||[]),c;for(c in a)a.hasOwnProperty(c)&&
-1!==b.indexOf(c)&&delete a[c];return a},_updateItem:function(a){var b,c,d;if(b=h.id.findCredential(this.portalUrl).userId)return c=this.itemParams.folder,b=this.portalUrl+"/sharing/rest/content/users/"+b+(c&&"/"!==c?"/"+c:"")+"/items/"+this.currentGpItemId+"/update",a&&(d=a.item.properties),g.isDefined(d)||(d={}),g.isDefined(d.jobUrl)||(d.jobUrl=this._toolServiceUrl+"/jobs/"+this._jobInfo.jobId,d.jobType="GPServer",d.jobId=this._jobInfo.jobId,d.jobStatus="processing",this.itemParams.properties=d),
d=e.mixin({f:"json"},this.itemParams),a&&d.folder===a.item.folder&&delete d.folder,a&&a.item&&d.tags===a.item.tags.toString()&&delete d.tags,a&&a.item&&d.snippet===a.item.snippet&&delete d.snippet,a&&a.item&&d.description===a.item.description&&delete d.description,d.properties&&(d.properties=f.toJson(d.properties)),d.text&&(d.text=f.toJson(d.text)),a=k({url:b,content:d},{usePost:!0}),a.then(e.hitch(this,this._handleItemUpdate),e.hitch(this,this._handleUpdateItemError)),a},_handleItemUpdate:function(a){this.isOutputLayerItemUpdated=
!0},_handleItemDataUpdate:function(a){},_handleUpdateItemError:function(a){this.isOutputLayerItemUpdated=!0;this.emit("job-fail",{message:a.message+(a.details?a.details.toString():""),jobParams:this.jobParams})},_handleErrorResponse:function(a){this.emit("job-fail",a)},_refreshItem:function(){var a,b;(a=h.id.findCredential(this.portalUrl).userId)?(b=this.itemParams.folder,a=this.portalUrl+"/sharing/rest/content/users/"+a+(b&&"/"!==b?"/"+b:"")+"/items/"+this.currentGpItemId+"/refresh",a=k({url:a,content:{f:"json"}},
{usePost:!0})):(a=new p,a.resolve());return a.promise},_handleItemRefresh:function(a){},_readItem:function(){var a,b;if(a=h.id.findCredential(this.portalUrl).userId)return b=this.itemParams.folder,a=this.portalUrl+"/sharing/rest/content/users/"+a+(b&&"/"!==b?"/"+b:"")+"/items/"+this.currentGpItemId,a=k({url:a,content:{f:"json"}}),a.then(e.hitch(this,this._updateItem))},getItemInfo:function(a){if(h.id.findCredential(this.portalUrl).userId)return a=this.portalUrl+"/sharing/rest/content/items/"+a,k({url:a,
content:{f:"json"}})},_gpJobStatus:function(a){a.jobParams=this.jobParams;a.resultParameter=this.resultParameter;a.returnProcessInfo=this.jobParams.returnProcessInfo;a.getResultLyrInfos=this.getResultLyrInfos;a.currentGpItemId=this.currentGpItemId;a.itemParams=this.itemParams;"esriJobFailed"===a.jobStatus||"esriJobSucceeded"===a.jobStatus||"esriJobTimedOut"===a.jobStatus?(a.messages&&(a.message=this._buildErrorMsg(a)),this._checkTimer&&(clearInterval(this._checkTimer),this._checkTimer=null,this._gpJobComplete(a)),
"esriJobFailed"!==a.jobStatus&&"esriJobTimedOut"!==a.jobStatus||this._deleteItem(!1)):-1===["esriJobCancelling","esriJobCancelled"].indexOf(a.jobStatus)||this._doCancelCleanup||(this._handleOnCancel(a),this._doCancelCleanup=!0);this.doSaveJobInfo&&this.saveJobInfo(a);this.emit("job-status",a);this._jobInfo=a;this.itemParams&&!this.isOutputLayerItemUpdated&&this._readItem()},_updateRefreshItem:function(a){var b=[],c=a[0];b.push(this._readItem(this.doRefreshItem));z(b).then(e.hitch(this,function(a){c.outputLayerName=
f.fromJson(this.jobParams[this.outputName]).serviceProperties.name;c.value.itemId=this.currentGpItemId;c.analysisInfo={toolName:this.toolName,secondaryOutputs:this.secondaryOutputs,jobParams:this.jobParams};this.doRefreshItem?this._refreshItem().always(e.hitch(this,function(){this.emit("job-result",c)})):this.emit("job-result",c)}),e.hitch(this,this._handleDeleteItemError))},_gpJobComplete:function(a){var b;"esriJobSucceeded"===a.jobStatus&&(a.jobParams=this.jobParams,this.emit("job-success",a),z(this._getGpResultData(a)).then(e.hitch(this,
function(c){c=m.filter(c,function(a){var b=!0;g.isDefined(a.value.empty)?b=a.value.empty:g.isDefined(a.value.url)||g.isDefined(a.value.itemId)?b=!1:g.isDefined(a.value.featureSet)?b=!1:this.jobParams.outputType===q.BDFSTEMPLATE&&(b=!1);if(!b)return a},this);0===c.length?(this.currentGpItemId&&this._deleteItem(!1),this.showGeoAnalyticsParams&&a.messages&&(a.message=this._buildErrorMsg(a)),this.emit("job-fail",{message:this.showGeoAnalyticsParams?a.message:this.i18n.emptyResultInfoMsg,type:"warning",
jobParams:this.jobParams})):(g.isDefined(this.itemParams)&&this.itemParams.properties&&this.itemParams.properties.jobStatus&&"processing"===this.itemParams.properties.jobStatus&&(this.itemParams.properties.jobStatus="completed"),m.forEach(c,function(a){if(a.value.featureSet&&!a.value.url)a.value.featureSet.spatialReference=a.value.layerDefinition.spatialReference;else if(a.value.url&&-1!==a.value.url.indexOf("/FeatureServer/")&&a.value.layerInfo&&a.value.layerInfo.popupInfo){var b=a.value.url.match(/[0-9]+$/g)[0];
this._popupInfo[b]=a.value.layerInfo.popupInfo}},this),b=c[0],b.results=c,this.jobParams.returnProcessInfo?this.gp.getResultData(a.jobId,"ProcessInfo").then(e.hitch(this,function(a){var d=[];m.forEach(a.value,function(a){d.push(f.fromJson(a))},this);this.currentGpItemId?(this.itemParams.description=n.buildReport(d),this._updateRefreshItem(c)):(b.analysisReport=n.buildReport(d),b.outputLayerName=this.jobParams.resultName,this.emit("job-result",b))})):this.currentGpItemId?this._updateRefreshItem(c):
(b.outputLayerName=this.jobParams.resultName,this.emit("job-result",b)))})))},_gpJobFailed:function(a){e.clone(a).jobParams=this.jobParams;this._checkTimer&&(clearInterval(this._checkTimer),this._checkTimer=null);a.messages&&(a.message=this._buildErrorMsg(a));this.emit("job-fail",a)},_getGpResultData:function(a){var b=[],c=[];"string"===typeof this.resultParameter?c.push(this.resultParameter):this.resultParameter instanceof Array&&(c=this.resultParameter);m.forEach(c,function(c,e){b.push(this.gp.getResultData(a.jobId,
c))},this);return b},_handleOnCancel:function(a){this.itemParams?this._deleteItem(!0,a):this.emit("job-cancel",a)},cancel:function(a){this.jobParams.outputType&&this.jobParams.outputType===q.FLAYERVIEW?(this._doDeleteViewResult=!0,this._deleteItem(!0)):this.gp.cancelJob(a.jobId).then(e.hitch(this,function(a){"esriJobCancelled"===a.jobStatus&&this._handleOnCancel(a)}),function(a){})},checkJobStatus:function(a){this.signInPromise.then(e.hitch(this,function(){this.gp.setUpdateDelay(3E3);this._checkTimer=
setInterval(e.hitch(this,this._checkStatus,a,e.hitch(this,this._gpJobStatus),e.hitch(this,this._gpJobFailed)),3E3)}))},_checkStatus:function(a,b,c){this.gp.checkJobStatus(a,b,c)},_deleteItem:function(a,b){var c,d;(c=h.id.findCredential(this.portalUrl).userId)&&this.itemParams&&(d=g.isDefined(this.itemParams.folder)?this.itemParams.folder:"",c=this.portalUrl+"/sharing/rest/content/users/"+c+(d&&"/"!==d?"/"+d:"")+"/items/"+this.currentGpItemId+"/delete",k({url:c,content:{f:"json"}},{usePost:!0}).then(e.hitch(this,
this._handleItemDelete,a,b),e.hitch(this,this._handleDeleteItemError)))},_handleItemDelete:function(a,b,c){a&&this.emit("job-cancel",b)},_handleDeleteItemError:function(a){this.emit("job-fail",{message:a.message+(a.details?a.details.toString():""),jobParams:this.jobParams})},_initFolderStore:function(a,b){this._fportal=this.portalSelf?new a.Portal({url:this.portalUrl,self:this.portalSelf}):new a.Portal(this.portalUrl);this._fportal.signIn().then(e.hitch(this,function(a){this.portalUser=a;this.portalUser.getFolders().then(e.hitch(this,
function(a){a=n.createFolderStore(a,this.portalUser.username);b.resolve(a)}))}))},getFolderStore:function(){var a=new p,b,c,d,l;this.folderStore?a.resolve(this.folderStore):this.signInPromise.then(e.hitch(this,function(e){b=["../../arcgis/Portal"];c=this._counter++;d=this;this._rids&&this._rids.push(c);w(b,function(b){l=d._rids?m.indexOf(d._rids,c):-1;-1!==l&&(d._rids.splice(l,1),d._initFolderStore(b,a))})}));return a},_checkToolUrl:function(){var a=new p;this.analysisGpServer?(this._toolServiceUrl&&
this.gp||this.set("toolServiceUrl",this.analysisGpServer+"/"+this.toolName),a.resolve({success:!0})):this._getSelf(this.portalUrl).then(e.hitch(this,function(b){(this.analysisGpServer=b.helperServices.analysis&&b.helperServices.analysis.url?b.helperServices.analysis.url:null)&&this.set("toolServiceUrl",this.analysisGpServer+"/"+this.toolName);a.resolve({success:!0})}));return a},getCreditsEstimate:function(a,b){this.start=window.performance.now();var c,d,l,g,h,t;d=new p;this._checkToolUrl().then(e.hitch(this,
function(r){this._toolServiceUrl?h=this._toolServiceUrl:(g=this.portalUrl&&-1!==this.portalUrl.indexOf("dev")?"dev":this.portalUrl&&-1!==this.portalUrl.indexOf("qa")?"qa":"",h="http://analysis"+g+".arcgis.com/arcgis/rest/services/tasks/GPServer/"+this.toolName);this.useGPCreditTask?(c=(t=this.portalSelf||this._portal)&&t.helperServices&&t.helperServices.creditEstimation&&t.helperServices.creditEstimation.url?t.helperServices.creditEstimation.url+"/EstimateCredits":h.replace("/tasks/GPServer/"+a,"/Estimate/GPServer/EstimateCredits"),
r={jobParams:{taskName:a,taskParameters:f.toJson(b)},resultParameter:"creditEstimate",def:d,isGPCreditSync:this._isGPCreditSync},this._getGPCreditEstimate(c,r)):(c=h.replace("/"+a,"/exts/Estimate/"+a),l=e.mixin({f:"json"},b),k({url:c,content:l},{usePost:!0}).then(e.hitch(this,function(a){this.end=window.performance.now();console.log("Analysis Credit Estimator SOE Sync Time : "+(this.end-this.start)+" milliseconds");d.resolve(a)}),function(a){d.resolve(a)}))}));return d.promise},_getGPCreditEstimate:function(a,
b){this.creditGP=new y(a);this.creditGP.setUpdateDelay(1E3);b.isGPCreditSync?this.creditGP.execute(b.jobParams,e.hitch(this,this._getGPCreditResult,b.def,b.resultParameter,b.isGPCreditSync),e.hitch(this,this._creditGPJobFailed,b.def,b.isGPCreditSync)):this.creditGP.submitJob(b.jobParams,e.hitch(this,this._getGPCreditResult,b.def,b.resultParameter,b.isGPCreditSync),e.hitch(this,this._creditGPJobFailed,b.def,b.isGPCreditSync),e.hitch(this,this._creditGPJobFailed,b.def,b.isGPCreditSync))},_getGPCreditResult:function(a,
b,c,d){c?(this.end=window.performance.now(),console.log("Analysis Credit Estimator GP Sync Time : "+(this.end-this.start)+" milliseconds"),a.resolve(d[0].value)):this.creditGP.getResultData(d.jobId,b).then(e.hitch(this,function(a,b){b&&b.value&&b.value.credits&&(b.value.cost=b.value.credits);this.end=window.performance.now();console.log("Analysis Credit Estimator GP Async Time : "+(this.end-this.start)+" milliseconds");a.resolve(b.value)},a),e.hitch(this,function(a,b){a.resolve(b)},a))},_creditGPJobFailed:function(a,
b,c){b?!c.code||400!==c.code&&-1===c.code.indexOf("IdentityManagerBase.")?0===c.status&&c.message&&(c.messages=[c.message],a.resolve(this._buildErrorMsg(c))):(c.messages=c.details,a.resolve(c)):"esriJobFailed"!==c.jobStatus&&"esriJobCancelled"!==c.jobStatus||a.resolve(this._buildErrorMsg(c))},_signIn:function(a,b){var c,d,f,r;this.signInPromise=new p;b?(b=["../../arcgis/Portal"],c=this._counter++,d=this,this._rids&&this._rids.push(c),w(b,e.hitch(this,function(b){f=d._rids?m.indexOf(d._rids,c):-1;
-1!==f&&(d._rids.splice(f,1),this._portal=this.portalSelf?new b.Portal({url:a,self:this.portalSelf}):new b.Portal(a),this._portal.signIn().then(e.hitch(this,function(a){this.portalUser=a;this._portal.helperServices&&this._portal.helperServices.analysis&&this._portal.helperServices.analysis.url?(this.analysisGpServer=this._portal.helperServices.analysis.url,this.showGeoAnalyticsParams&&this._portal.helperServices.geoanalytics&&(this.analysisGpServer=this._portal.helperServices.geoanalytics.url),k({url:this.analysisGpServer,
content:{f:"json"},callbackParamName:"callback"}).then(e.hitch(this,function(a){r=h.id.findCredential(this.analysisGpServer);this.signInPromise.resolve(r)}),e.hitch(this,function(a){this.signInPromise.reject(a)}))):this.signInPromise.resolve(a)}),e.hitch(this,this._handleSignInError)))}))):k({url:a,content:{f:"json"},callbackParamName:"callback"}).then(e.hitch(this,function(b){var c;b=h.id.findCredential(a);g.isDefined(b)?(c=h.id.findServerInfo(this._toolServiceUrl),g.isDefined(c)&&g.isDefined(c.owningSystemUrl)&&
(this.portalUrl=c.owningSystemUrl),this.signInPromise.resolve(b)):h.id.getCredential(a).then(e.hitch(this,function(b){b=h.id.findCredential(a);c=h.id.findServerInfo(this._toolServiceUrl);g.isDefined(c)&&g.isDefined(c.owningSystemUrl)&&(this.portalUrl=c.owningSystemUrl);this.signInPromise.resolve(b)}),e.hitch(this,this._handleSignInError))}),e.hitch(this,this._handleSignInError));return this.signInPromise},_handleSignInError:function(a){this.emit("job-fail",{message:this.i18n.analysisSignInErrorMsg,
messageCode:"AB_0003"});this.signInPromise.reject(a)},_buildErrorMsg:function(a){var b="",c=[],d,e;this.errorHelpMap||this._initErrorHelpMap();c=m.filter(a.messages,function(a){if(("esriJobMessageTypeError"===a.type||"esriJobMessageTypeWarning"===a.type)&&-1!==a.description.indexOf("messageCode"))return a.description},this);0<c.length&&m.forEach(c,function(c){try{d=f.fromJson(c.description)}catch(I){d=c.description}e="";"esriJobMessageTypeWarning"===c.type&&(a.type="warning");d.messageCode?(e=g.isDefined(this.i18n[d.messageCode])?
this.i18n[d.messageCode]:d.message,e=g.isDefined(d.params)?x.substitute(e,d.params):e,b+=e+"\x26nbsp;",(c=this._addLearnMoreErrorLink(d.messageCode))&&(b+=c)):d.error&&d.error.messageCode?(e=g.isDefined(this.i18n[d.error.messageCode])?this.i18n[d.error.messageCode]:d.error.message,e=g.isDefined(d.error.params)?x.substitute(e,d.error.params):e,b+=e+"\x26nbsp;",(c=this._addLearnMoreErrorLink(d.error.messageCode))&&(b+=c)):b+=d+"\x26nbsp;"},this);return b},_toolServiceUrlSetter:function(a){this._toolServiceUrl=
a;this.gp=new y(a)},_setToolServiceUrlAttr:function(a){this._toolServiceUrl=a;this.gp=new y(a)},checkCreditLimitsAttr:function(a){this.checkCreditLimits=a},saveJobInfo:function(a){var b;if(this.doSaveJobInfo&&this.currentGpItemId&&-1!==m.indexOf(["esriJobSucceeded"],a.jobStatus)){e.mixin(a.jobParams,{extentCheck:this._useExtentCheck&&this._useExtentCheck.get("checked")});m.forEach(a.messages,function(a){a.description=n.safetagsReplace(a.description)},this);a={toolName:this.toolName,jobParams:a.jobParams,
timestamp:Date.now(),portalUrl:this.portalUrl,jobInfo:{jobId:a.jobId,jobStatus:a.jobStatus,messages:a.messages,analysisServer:"bigdata"===this.analysisMode?"geoanalytics":"default"===this.analysisMode?"standard":this.analysisMode}};"CopyToDataStore"===this.toolName&&(a.jobParams.isSpatioTemporalDataStore=this._isSpatioTemporalDataStore);"bigdata"===this.analysisMode&&a.jobParams.timeStepReference&&(a.jobParams.timeReferenceType=this.get("timeReferenceType"));"bigdata"===this.analysisMode&&a.jobParams.timeBoundaryReference&&
(a.jobParams.timeBoundaryReferenceType=this.get("timeBoundaryReferenceType"));for(b in a.jobParams)if(a.jobParams.hasOwnProperty(b)&&g.isDefined(a.jobParams[b])){if("object"===typeof a.jobParams[b]&&a.jobParams[b].serviceToken||"string"===typeof a.jobParams[b]&&-1!==a.jobParams[b].indexOf("serviceToken")){var c="string"===typeof a.jobParams[b]?f.fromJson(a.jobParams[b]):a.jobParams[b];c&&c.serviceToken&&(delete c.serviceToken,a.jobParams[b]="string"===typeof a.jobParams[b]?f.toJson(c):c)}if("object"===
typeof a.jobParams[b]&&!e.isArray(a.jobParams[b])&&a.jobParams[b].filter||"string"===typeof a.jobParams[b]&&-1!==a.jobParams[b].search(/[<>]/g))"object"===typeof a.jobParams[b]&&a.jobParams[b].filter&&!e.isArray(a.jobParams[b])?a.jobParams[b].filter=n.safetagsReplace(a.jobParams[b].filter):"string"===typeof a.jobParams[b]&&-1!==a.jobParams[b].search(/[<>]/g)&&(a.jobParams[b]=n.safetagsReplace(a.jobParams[b]))}b=h.id.findCredential(this.portalUrl);this.currentGpItemId&&(b={id:this.currentGpItemId,
folderId:this.itemParams.folder,owner:b.userId},A.addToItemResource(b,a));this.doSaveInStorage&&A.addToStorage(a)}},_initErrorHelpMap:function(){if(this.isSingleTenant){var a=w.toUrl("./help/errorhelpmap_enterprise.json");k({url:a}).then(e.hitch(this,function(a){this.errorHelpMap=a.map}))}},_addLearnMoreErrorLink:function(a){if(this.isSingleTenant){var b,c=this.portalSelf&&this.portalSelf.helpMap&&this.portalSelf.helpMap.m;a=c&&c[this.errorHelpMap[a]];var c=this&&this.portalSelf?this.portalSelf.helpBase:
null,d=this.analysisGpServer&&-1!==this.analysisGpServer.indexOf("dev")?"dev":this.analysisGpServer&&-1!==this.analysisGpServer.indexOf("qa")?"uat":"";g.isDefined(a)&&(b="http://doc"+d+".arcgis.com/en/arcgis-online/analyze/"+a,this.isSingleTenant&&c?b=c+a:this.isSingleTenant&&!c&&(b="http://server"+d+".arcgis.com/en/portal/latest/use/"+a));b&&(b="\x3cbr/\x3e\x3cbr/\x3e\x3cdiv class\x3d'esriHelpPopup'\x3e\x3ca class\x3d'action zoomTo' href\x3d'"+b+"' target\x3d'_help'\x3e"+this.i18n.learnMore+"\x3c/a\x3e\x3c/div\x3e\x3cbr/\x3e\x3cbr/\x3e");
return b}},getLearnMoreLink:function(a){return a?this._addLearnMoreErrorLink(a):""},_byPassCreditCheck:function(a){return-1!==this._freeGPTools.indexOf(a)}});B("extend-esri")&&e.setObject("dijit.analysis.AnalysisBase",u,h);return u});