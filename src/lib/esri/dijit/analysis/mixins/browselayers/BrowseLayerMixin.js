// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.
//>>built
define("esri/dijit/analysis/mixins/browselayers/BrowseLayerMixin","dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has dojo/query ../../../../kernel ../../../../request ../../../../lang ../../../../layers/CSVLayer ../../../../arcgis/Portal ../../../../SpatialReference ../../ProjectExtent dojo/Deferred ../../ItemTypes ../../utils ./configs/AGOLBrowseItem ./configs/EnterpriseBrowseItem dojo/i18n!../../nls/BrowseLayerMixin".split(" "),function(m,d,w,x,p,r,u,q,y,t,z,A,n,g,v,B,C,D){m=m([],{tableSupportedTools:"JoinFeatures SummarizeAttributes ExtractData GeocodeLocationsfromTable CopyToDataStore AppendData CalculateField MergeLayers DescribeDataset DetectIncidents".split(" "),
allowedItemTypes:[],defaultItemTypes:[g.MS,g.FS],availableItemTypeFilters:["layers","featureLayers"],_createBrowseItems:function(a,b,c){a=a||{};var e=a.browseValue||{};b=b||{};var f=this.defaultItemTypes.concat(this.get("allowedItemTypes"));if(this.useArcGISComponents)this.setUpItemBrowser(a,b,c).then(function(){this.map&&this._chopExtentAtDateLine(this.map.extent).then(this._projectExtentAndDispatch.bind(this))}.bind(this));else{var d=[];f.forEach(function(a){d.push('type:"'+a+'"')});"browse"===
e?(c=this._browsedlg.browseItems.get("query"),c.custom=this._queryTagsForLivingAtlasBrowseItems(b),this._browsedlg.browseItems.set("extent",this.get("map").extent),this._browsedlg.browseItems.set("query",c),this._browsedlg.show()):(this.showGeoAnalyticsParams&&d.push('type:"'+g.BIGDATA+'"'),c=this._browseLyrsdlg.browseItems.get("query"),c.types=d,this._browseLyrsdlg.browseItems.set("query",c),b.geometryTypes?(this._browseLyrsdlg.browseItems.plugIn.checkGeometryType=!0,0<b.geometryTypes.length&&(this._browseLyrsdlg.browseItems.plugIn.geometryTypes=
b.geometryTypes)):this._browseLyrsdlg.browseItems.plugIn.checkGeometryType=!1,b.layerTypes?(this._browseLyrsdlg.browseItems.plugIn.checkLayerType=!0,0<b.layerTypes.length&&(this._browseLyrsdlg.browseItems.plugIn.layerTypes=b.layerTypes)):this._browseLyrsdlg.browseItems.plugIn.checkLayerType=!1,b.customCheck?(this._browseLyrsdlg.browseItems.plugIn.customCheckHandler=b.customCheck.customCheckHandler,this._browseLyrsdlg.browseItems.plugIn.customCheckFailureMessage=b.customCheck.customCheckFailureMessage):
this._browseLyrsdlg.browseItems.plugIn.customCheckHandler=void 0,this._browseLyrsdlg.show())}},setUpItemBrowser:function(a,b,c){var e=new n;window.require(["arcgis-components/wrappers/ItemBrowser","esri/arcgis/Portal"],function(f,E){if(!this.ib){var k=document.createElement("div");!a.isDialog&&document.body.appendChild(k);var h=new E.Portal(this.portalSelf&&this.portalSelf.urlKey&&this.portalSelf.customBaseUrl?location.protocol+"//"+this.portalSelf.urlKey+"."+this.portalSelf.customBaseUrl+"/sharing/rest":
(this.portalSelf&&this.portalSelf.portalHostname?location.protocol+"//"+this.portalSelf.portalHostname:this.portalUrl)+"/sharing/rest"),l=this.defaultItemTypes.concat(this.get("allowedItemTypes")),m=function(){this.ib.dispatch({type:"CLOSE_FULLSCREEN_BROWSER"});a.isDialog&&this._closeDialog();this._resetSelectBox(c);!a.isDialog&&this._removeDOMfromBody(k)},n=function(b){this.ib.dispatch({type:"CLOSE_FULLSCREEN_BROWSER"});a.isDialog&&this._closeDialog();b[0]&&b[0].type===g.RFT?this.onSelectRFTTool.bind(this)(b[0],
h):this.onBrowseItemSelect.bind(this)(b[0],h,c);!a.isDialog&&this._removeDOMfromBody(k)},p=function(b){this.ib.dispatch({type:"CLOSE_FULLSCREEN_BROWSER"});a.isDialog&&this._closeDialog();this.onSelectGPTool.bind(this)(b);!a.isDialog&&this._removeDOMfromBody(k)},q=function(b){this.ib.dispatch({type:"CLOSE_FULLSCREEN_BROWSER"});a.isDialog&&this._closeDialog();this.onEditRFTTool.bind(this)(b,h);!a.isDialog&&this._removeDOMfromBody(k)},r=function(b){this.ib.dispatch({type:"CLOSE_FULLSCREEN_BROWSER"});
a.isDialog&&this._closeDialog();this.onBrowseItemSelect.bind(this)(b,h,c);!a.isDialog&&this._removeDOMfromBody(k)},t=function(b){this.ib.dispatch({type:"CLOSE_FULLSCREEN_BROWSER"});a.isDialog&&this._closeDialog();b&&b.type===g.RFT?this.onEditRFTTool.bind(this)(b,h):this.onBrowseItemSelect.bind(this)(b,h,c,!0);!a.isDialog&&this._removeDOMfromBody(k)};-1<this.tableSupportedTools.indexOf(this.helpFileName)&&(l=l.concat([this.showGeoAnalyticsParams?g.TABLE:g.BTABLE]));h.signIn().then(function(){this._fetchGroupForRFT(h).then(function(c){-1<
l.indexOf(g.IS)?this.availableItemTypeFilters=["layers","featureLayers","mapImageLayers","imageryLayers"]:-1===l.indexOf(g.GPSERVICE)&&-1===l.indexOf(g.RFT)&&(this.availableItemTypeFilters=this.availableItemTypeFilters.concat(["layers","featureLayers"]));-1<this.tableSupportedTools.indexOf(this.helpFileName)&&(this.availableItemTypeFilters=this.availableItemTypeFilters.concat(["tables"]));c={allowedItemTypes:this.showGeoAnalyticsParams?[g.BIGDATA].concat(l):l,availableItemTypeFilters:this.showGeoAnalyticsParams?
this.availableItemTypeFilters.concat(["bigDataFileShares"]):this.availableItemTypeFilters,customQueryTags:b,addQueryParameters:a.addQueryParameters,portal:h,isPortal:this.isSingleTenant,onSelectSubLayer:r.bind(this),onActionSubLayer:t.bind(this),onSelectGPTool:p.bind(this),onEditRFT:q.bind(this),rftGroupId:c,disableLAAL:a.disableLAAL,disableBoundary:a.disableBoundary,title:a.title,disabledSubResources:this._getDisableResources(a.disabledSubResources)};c=d.mixin(f.initialState.settings.config,this.isSingleTenant?
C.getConfig(c):B.getConfig(c));this.ib=new f.ItemBrowserWrapper(k,{apiVersion:3,portal:h,request:u,initialState:d.mixin(f.initialState,{settings:d.mixin(f.initialState.settings,{config:d.mixin(c,{onBack:m.bind(this),onSelect:n.bind(this)})}),ui:d.mixin(f.initialState.ui,{expanded:d.mixin(f.initialState.ui.expanded,{filters:!0})})}),parameters:d.mixin(f.initialState.parameters,{section:"myContent",filter:d.mixin(f.initialState.parameters.filter,{searchMapArea:!1})})});a.isDialog&&this._createDialog(k,
h);e.resolve()}.bind(this))}.bind(this))}}.bind(this));return e},_queryTagsForLivingAtlasBrowseItems:function(a){if((a=a&&a.tags)&&0!==a.length){if(1===a.length)return['tags:"'+a[0]+'"'];p=[];a.forEach(function(a){p.push('tags:"'+a+'"')});return p}},onBrowseItemSelect:function(a,b,c,e){b=this._getPortalItem(a,b);var f={selection:b,dialog:this._browseLyrsdlg||this._browsedlg};!a.url||v.isHostedService(a.url)||this.isSingleTenant||b.selectedLayer instanceof y?this._handleBrowseItemsSelect(f,e):this._getProxyServiceInfo(a).then(function(){q.isDefined(a.analysisProxyCheck)&&
"failure"===a.analysisProxyCheck?this._resetSelectBox(c):this._handleBrowseItemsSelect(f,e)}.bind(this),function(){this._resetSelectBox(c)}.bind(this))},onSelectGPTool:function(a){a.resource.url=a.url;this._handleSelectGpTool(a.resource)},onSelectRFTTool:function(a,b){this._handleSelectRFTTool(this._getPortalItem(a,b))},onEditRFTTool:function(a,b){this._handleEditRFTTool(this._getPortalItem(a,b))},_getPortalItem:function(a,b){a.resource&&a.item?(b=new t.PortalItem(d.mixin(a.item,{portal:b})),b.selectedLayer=
a.resource,b.selectedLayer.url=a.url):(b=new t.PortalItem(d.mixin(a,{portal:b})),a.type&&-1<[g.CSV,g.XLS].indexOf(a.type)&&(b.selectedLayer=b));return b},_createDialog:function(a,b){window.require(["dijit/Dialog","esri/dijit/analysis/mixins/browselayers/configs/Common"],function(b,e){this.itemBrowserDialog||(this.itemBrowserDialog=new b({style:"width: 900px; height:900px; overflow: auto",id:"itemBrowserDialog",closable:!1,title:D.customAnalysisLayerTitle}));this.itemBrowserDialog.set("content",a);
this.itemBrowserDialog.show()}.bind(this))},_closeDialog:function(){this.itemBrowserDialog.hide();this.itemBrowserDialog.destroy();delete this.itemBrowserDialog;delete this.ib},_setAllowedItemTypesAttr:function(a){this.allowedItemTypes=a},_setAvailableItemTypeFiltersAttr:function(a){this.availableItemTypeFilters=a},_getDisableResources:function(a){var b={};a&&a.length&&a.forEach(function(a){a&&a.url&&(b[a.url]=!0)},this);return b},_projectExtentAndDispatch:function(a){this.sr||(this.sr=new z(4326));
A(a,this.sr,function(a){this._dispatchExtentToItemBrowser(a[0])}.bind(this),function(a){console.error(a)}.bind(this))},_chopExtentAtDateLine:function(a){var b=new n;window.esri.geometry.normalizeCentralMeridian([a],null,function(c){if(c[0].rings){var e=(new window.esri.geometry.Polygon(a.spatialReference)).addRing(c[0].rings[0]).getExtent();c=(new window.esri.geometry.Polygon(a.spatialReference)).addRing(c[0].rings[1]).getExtent();b.resolve(e.getWidth()>c.getWidth()?e:c)}else b.resolve(c[0])},function(a){b.reject(a)});
return b},_dispatchExtentToItemBrowser:function(a){window.require(["arcgis-components/wrappers/ItemBrowser"],function(b){this.ib.dispatch(b.updateExtent({minx:a.xmin,miny:a.ymin,maxx:a.xmax,maxy:a.ymax}))}.bind(this))},_fetchGroupForRFT:function(a){var b=new n;-1===this.allowedItemTypes.indexOf(g.RFT)&&b.resolve();this._systemRFTsGroup&&b.resolve(this._systemRFTsGroup);v.fetchGroupForRFT(a).then(function(a){this._systemRFTsGroup=a;b.resolve(a)}.bind(this));return b},_removeDOMfromBody:function(a){setTimeout(function(){document.body.removeChild(a)},
300);delete this.ib},_resetSelectBox:function(a){a&&a.reset()},_getProxyServiceInfo:function(a){var b=new n,c,e,f;q.isDefined(a)&&q.isDefined(a.url)||b.reject({error:"mapLayer is not defined"});c=a.url+(-1<a.url.indexOf("?")?"\x26":"?")+"f\x3djson";var d=r.id.findCredential(a.url);e=a.url;this.proxyCheckedServers||(this.proxyCheckedServers=[]);w.some(this.proxyCheckedServers,function(b){f=e.substring(0,e.indexOf("/",9));if(b.server===f)return a.analysisProxyCheck=b.check,!0},this)?b.resolve({}):(d&&
d.token&&(c+="\x26token\x3d"+d.token),b=u({url:c,content:null},{useProxy:!0}),b.then(function(){a.analysisProxyCheck="success";this.proxyCheckedServers.push({server:e.substring(0,e.indexOf("/",9)),check:"success"})}.bind(this),function(){a.analysisProxyCheck="failure";this.proxyCheckedServers.push({server:e.substring(0,e.indexOf("/",9)),check:"failure"})}.bind(this)));return b.promise}});x("extend-esri")&&d.setObject("dijit.analysis.mixins.browselayers.BrowseLayerMixin",m,r);return m});