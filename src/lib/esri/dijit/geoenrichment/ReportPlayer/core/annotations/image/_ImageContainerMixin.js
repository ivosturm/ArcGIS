// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/ReportPlayer/core/annotations/image/_ImageContainerMixin","dojo/_base/declare esri/dijit/geoenrichment/Deferred dojo/sniff esri/dijit/geoenrichment/when dojo/dom-class dojo/dom-construct esri/dijit/geoenrichment/utils/ImageInfoUtil ../utils/AnnotationsUtil ../utils/CircularMaskUtil ../utils/ScaleToCoverUtil ../../supportClasses/images/ImageDataHolder esri/dijit/geoenrichment/utils/DomUtil esri/dijit/geoenrichment/utils/MathUtil esri/dijit/geoenrichment/utils/WaitingUtil dojo/i18n!esri/nls/jsapi ../../../_devConfig".split(" "),
function(n,p,q,h,r,e,t,k,u,v,l,c,w,m,f,x){f=f.geoenrichment.dijit.ReportPlayer.ReportPlayer;return n(null,{isImage:!0,viewModel:null,theme:null,currentFeatureIndex:null,imageJson:null,imageTriggerJson:null,alignParams:null,showError:!0,parentWidget:null,_circularMask:!1,_scaleToCover:!1,_fitParent:!0,_angle:0,_opacity:1,_isLogoPlaceholder:!1,_logoPlaceholderType:null,_dynamicBehavior:null,_useDefaultImageSizeFlag:!1,_fileName:null,_imageData:null,postCreate:function(){this._configurePropertiesFromImageJson();
this.content=e.create("img",{"class":"imageContainer_content"});this.inherited(arguments);r.add(this.domNode,"esriGEImageContainer");this.setPosition(this.imageJson.style.left||0,this.imageJson.style.top||0);this._addAdditionalUI();this._isLogoPlaceholder&&(this.content._wToHRatio=1,this.resize());this._applyRotation();this.alignParams&&k.alignAnnotationContainer(this,this.alignParams);(this._fileName||this._isLogoPlaceholder||this._imageData)&&this._initWithImageData()},_configurePropertiesFromImageJson:function(){this.fieldStyle=
this.fieldStyle||{};this.fieldStyle.width=this.imageJson.style.width||150;this.fieldStyle.height=this.imageJson.style.height||0;this._fileName=this.imageJson.fileName;this._imageData=this.imageJson.data;this._opacity=Math.max(0,Math.min(1,void 0!==this.imageJson.style.opacity?this.imageJson.style.opacity:1));this._angle=this.imageJson.style.angle||0;this._dynamicBehavior=this.imageJson.dynamicBehavior;this._fitParent=!1!==this.imageJson.fitParent;this._circularMask=!!this.imageJson.circularMask;this._scaleToCover=
!!this.imageJson.scaleToCover;this.imageJson.style.width||(this._useDefaultImageSizeFlag=!0);this.alignParams||!this.imageJson.style.horizontalAlign&&!this.imageJson.style.verticalAlign||(this.alignParams={horizontalAlign:this.imageJson.style.horizontalAlign,verticalAlign:this.imageJson.style.verticalAlign});this._isLogoPlaceholder=!!this.imageJson.isLogoPlaceholder;this._logoPlaceholderType=this.imageJson.logoPlaceholderType},_addAdditionalUI:function(){},setAngle:function(a){this._angle=w.angleTo180_180Range(Number(a)||
0);this._applyRotation()},_applyRotation:function(){if(!this.domNode)return null;this._angle=0<this._angle||0>this._angle?this._angle:0;var a=q("webkit")?"webkitTransform":"transform";this.content.style[a]="rotate("+this._angle+"deg)";this._updateCircularMaskAndScaleToCover()},_applyOpacity:function(){if(!this.domNode)return null;0<=this._opacity&&1>this._opacity?(this._clickMaskDiv&&(this._clickMaskDiv.style.opacity=this._opacity),this._scaleToCoverDiv&&(this._scaleToCoverDiv.style.opacity=this._opacity),
this.content.style.opacity=this._opacity):(this.content.style.opacity="",this._clickMaskDiv&&(this._clickMaskDiv.style.opacity=""),this._scaleToCoverDiv&&(this._scaleToCoverDiv.style.opacity=""))},_initPromise:null,isInitialized:function(){return this._initPromise},_initWithImageData:function(){var a=this;return this._initPromise=h(this._loadImageData(),function(){a.onInitialized();a._updateCircularMaskAndScaleToCover()})},_loadImageData:function(){function a(a,d){return b._setImageData({data:a,fileName:d,
recalcImageContainerDimentions:b._useDefaultImageSizeFlag,preserveHeight:!1,dispatchEvents:!1})}var b=this;if(this.domNode){var d=l.getImageData(this._fileName)||this._imageData;this.content.src="";if(this._isLogoPlaceholder){if(this.viewModel.getDynamicImageFunc)return m.showProgress(this.domNode),this.onContentLoadingStart(),h(this.viewModel.getDynamicImageFunc(this._dynamicBehavior,this.theme,d),function(c){return c&&a(c,d&&b._fileName)})["finally"](function(){m.removeProgress(b.domNode);b.onContentLoadingEnd()})}else return a(d,
this._fileName)}},_setImageData:function(a){if(this.domNode&&a.data){var b=this,d=a.data,c=a.fileName,f=a.recalcImageContainerDimentions,h=a.preserveHeight,e=a.dispatchEvents,g=new p;this._showErrorMessage(!1);this.domNode.style.opacity="0.001";t.getImageInfo(d,c).then(function(a){if(b.domNode){e&&b.onImageDataPreChanged();var c=a.width/a.height;b.content._wToHRatio=c;var d;d=b._fitParent?b._useDefaultImageSizeFlag?150:Math.min(b.getWidth(),b.getHeight()*c):b.imageJson.style.width||150;b.content.style.width=
d+"px";b.content.style.height=d/c+"px";b.content.onload=function(){f&&b._recalcImageContainerDimentions(h);e&&b.onImageDataChanged();g.resolve()};b.content.onerror=function(a){g.reject(a)};b._fileName=a.filename;b._imageData=a.dataUrl;b.content.src=a.dataUrl;l.putImageData(a.filename,a.dataUrl);b._syncLogoStateAfterLoadingImage();b._updateCircularMaskAndScaleToCover()}else g.resolve()},g.reject);return g.promise.then(function(){b.domNode&&(b.domNode.style.opacity="")},function(a){console.log(a);b._showErrorMessage(!0)})}},
_syncLogoStateAfterLoadingImage:function(){this._isLogoPlaceholder=!this._fileName},_showErrorMessage:function(a){this.showError&&this.domNode&&(x.emulateErrors.contentErrors&&(a=!0),a&&!this.errorMessageDiv&&(this.errorMessageDiv=e.create("div",{"class":"esriGEReportPlayerPanelErrorMessage",innerHTML:f.imageLoadError},this.domNode),this.errorMessageDiv.style.paddingTop=this.getHeight()/2-20+"px"),c[a?"show":"hide"](this.errorMessageDiv),c[a?"hide":"show"](this.contentBlock))},_recalcImageContainerDimentions:function(a){if(this.domNode){var b=
this.getImageBox(!0),c=a&&this.getHeight();this.setWidth(b.w);this.setHeight(b.h);a&&this.setHeight(c)}},_lastAlignParams:null,resize:function(a,b){if(!this.domNode)return null;a&&(this.setWidth(a.w),this.setHeight(a.h),this._useDefaultImageSizeFlag=!1);this._lastAlignParams=b||this.alignParams;this._resizeContentImage();this._updateCircularMaskAndScaleToCover()},_getContentImageWToHRatio:function(){return this.content._wToHRatio||(this.imageJson.style.innerImageW||this.imageJson.style.width)/(this.imageJson.style.innerImageH||
this.imageJson.style.height)},_resizeContentImage:function(){var a=this._getContentImageWToHRatio(),b;b=this._fitParent?Math.min(this.getWidth(),this.getHeight()*a):Math.min(this.imageJson.style.width,this.imageJson.style.height*a,this.getWidth(),this.getHeight()*a);this.content.style.width=b+"px";this.content.style.height=b/a+"px";k.alignAnnotationContainer(this,this._lastAlignParams);this._updateCircularMaskAndScaleToCover()},scaleProportionallyWithinParent:function(a){if(!this.domNode)return null;
this.resize({w:this.getWidth()*a.xScale,h:this.getHeight()*a.yScale});this.setPosition(this._left*a.xScale,this._top*a.yScale)},_clickMaskDiv:null,_scaleToCoverDiv:null,_updateCircularMaskAndScaleToCover:function(){if(this.domNode){var a=this.content.src;this._clickMaskDiv=u.setCircularMask(this._circularMask&&this._imageData,this.content,a,this._angle);this._scaleToCoverDiv=v.setScaleToCover(this._scaleToCover&&this._imageData,this.content,a,this._angle);c[this._clickMaskDiv||this._scaleToCoverDiv?
"hide":"show"](this.content);this._applyOpacity()}},getFitParent:function(){return this._fitParent},setFitParent:function(a){this._fitParent=a;this._resizeContentImage()},getImageBox:function(a){return a?c.noTransformPosition(this.content):{w:this.getWidth(),h:this.getHeight(),l:this._left,t:this._top}},setImageWidth:function(a){this._fitParent||(this.imageJson.style.width=a,this.imageJson.style.height=a/this._getContentImageWToHRatio(),this._resizeContentImage())},setImageHeight:function(a){this._fitParent||
(this.imageJson.style.height=a,this.imageJson.style.width=a*this._getContentImageWToHRatio(),this._resizeContentImage())},_left:0,_top:0,getLeft:function(){return this._left},getTop:function(){return this._top},setPosition:function(a,b){void 0!==a&&(this._left=a||0,this.domNode.style.left=this._left+"px");void 0!==b&&(this._top=b||0,this.domNode.style.top=this._top+"px")},onInitialized:function(){},onImageDataPreChanged:function(){},onImageDataChanged:function(){},onContentLoadingStart:function(){},
onContentLoadingEnd:function(){},toJson:function(){var a=this.getImageBox(!0),b=this._lastAlignParams||this.alignParams,b={id:"img",fileName:this._fileName,circularMask:this._circularMask,scaleToCover:this._scaleToCover,isLogoPlaceholder:this._isLogoPlaceholder,logoPlaceholderType:this._isLogoPlaceholder?this._logoPlaceholderType:null,dynamicBehavior:this._isLogoPlaceholder?this._dynamicBehavior:null,fitParent:this._fitParent,style:{left:this._left,top:this._top,angle:this._angle,opacity:this._opacity,
horizontalAlign:b&&b.horizontalAlign,verticalAlign:b&&b.verticalAlign,innerImageW:a&&a.w,innerImageH:a&&a.h}};this._fitParent?(b.style.width=this.getWidth(),b.style.height=this.getHeight()):(b.style.width=a.w,b.style.height=a.h);return b}})});