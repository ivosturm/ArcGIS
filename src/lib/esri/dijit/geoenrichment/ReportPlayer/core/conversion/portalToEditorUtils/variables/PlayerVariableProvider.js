// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/ReportPlayer/core/conversion/portalToEditorUtils/variables/PlayerVariableProvider",["dojo/_base/declare","dojo/_base/lang","esri/dijit/geoenrichment/when","dojo/string","../../../../dataProvider/supportClasses/dataCollections/DataCollectionsLoader"],function(l,k,m,n,p){var q=l(null,{variable:null,constructor:function(a){this.variable=a},calculate:function(a){return 0},getCalcType:function(){return"n/"},getAliasWithType:function(){return this.variable.alias},getDescriptionWithType:function(){return this.variable.alias},
getDecimals:function(){return this.variable.precision||0}});return l(null,{isPlayerOnly:!0,_fieldNameToVariableCache:null,_templateNameToVariableCache:null,_variableIdToVintageCache:null,_variableIdToSourceCache:null,constructor:function(a){this._templateNameToVariableCache=a&&a.templateNameToVariableCache||{};this._fieldNameToVariableCache={};for(var c in this._templateNameToVariableCache){var b=this._templateNameToVariableCache[c];this._fieldNameToVariableCache[b.fieldName]=b}this._variableIdToVintageCache=
a&&a.variableIdToVintageCache;this._variableIdToSourceCache=a&&a.variableIdToSourceCache},get:function(a){return this._templateNameToVariableCache[a]||this._fieldNameToVariableCache[a]},toCalculator:function(a){return(a=this.get(a))&&new q(a)},addVariable:function(a){this._fieldNameToVariableCache[a.fieldName]=a;this._templateNameToVariableCache[a.templateName]=a},addScriptVariable:function(a){this._fieldNameToVariableCache[a.fieldName]=a;this._templateNameToVariableCache[a.templateName]=a},getVariables:function(){return Object.keys(this._fieldNameToVariableCache).map(function(a){return this._fieldNameToVariableCache[a]},
this)},getVariablesDataVintageDescription:function(a){var c=this;return m(this.tryFetchDataVintageInfo(a),function(b){if(!b)return null;b={};var d={},e;for(e in a.usedVariablesCache){e=e.toLowerCase();var f=c._variableIdToVintageCache[e];f&&(d[f]=1);(f=c._variableIdToSourceCache[e])&&(b[f]=1)}if(!Object.keys(b).length&&!Object.keys(d).length)return null;e=[];Object.keys(b).length&&e.push(n.substitute("This infographic contains data provided by ${source}.",{source:Object.keys(b).join(", ")}));Object.keys(d).length&&
e.push(n.substitute("The vintage of the data is ${vintage}.",{vintage:Object.keys(d).join(", ")}));return e.join(" ")})},getVariableVintage:function(a){return this._variableIdToVintageCache&&this._variableIdToVintageCache[a.toLowerCase()]},tryFetchDataVintageInfo:function(a,c){var b=this;return this._variableIdToVintageCache?(c&&this._trimDataVintageInfoCaches(c),!0):p.canLoad()?m(p.loadVariables({countryID:a.countryID,hierarchy:a.hierarchy,outFields:["vintage","filteringTags"],forceLowerCase:!0}),
function(a){function d(a){var b;a.filteringTags&&a.filteringTags.some(function(a){if("Source"===a.name)return b=a.value,!0});return b}b._variableIdToVintageCache={};b._variableIdToSourceCache={};var f=a.fullNameToVariableCache,h;for(h in f){var g=f[h];g.vintage&&(b._variableIdToVintageCache[h]=g.vintage);(g=d(g))&&(b._variableIdToSourceCache[h]=g)}a.dataCollections.forEach(function(a){var c=a.data[0];c&&(a=a.dataCollectionID+".*",a=a.toLowerCase(),c.vintage&&(b._variableIdToVintageCache[a]=c.vintage),
(c=d(c))&&(b._variableIdToSourceCache[a]=c))});c&&b._trimDataVintageInfoCaches(c);return!0}):!1},_trimDataVintageInfoCaches:function(a){var c={},b={},d;for(d in a)d=d.toLowerCase(),(a=this._variableIdToVintageCache[d])&&(c[d]=a),(a=this._variableIdToSourceCache[d])&&(b[d]=a);this._variableIdToVintageCache=c;this._variableIdToSourceCache=b},toJson:function(){return{templateNameToVariableCache:k.clone(this._templateNameToVariableCache),variableIdToVintageCache:this._variableIdToVintageCache&&k.clone(this._variableIdToVintageCache),
variableIdToSourceCache:this._variableIdToSourceCache&&k.clone(this._variableIdToSourceCache)}}})});