// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/ReportPlayer/core/infographics/simpleInfographic/dataDrilling/EnrichUtil",["../../../supportClasses/templateJsonUtils/query/TemplateJsonQueryUtil","../../utils/InfographicJsonUtil"],function(l,m){var d={processChartJson:function(a,b){var e=[];a.seriesItems.forEach(function(a){a.points.forEach(function(a){e.push({fieldName:a.fieldInfo.name,mapTo:b?b(a.fieldInfo.fullName):a.fieldInfo.fullName})})});var c=a.comparisonInfo;return this._createChartInfo(e,c&&c.levels,d.buildCalculatorNameForChart(a))},
_createChartInfo:function(a,b,e){a=a||[];var c={isChart:!0,fields:[],levels:b,calculatorName:e,_cache:{}};a.forEach(function(a){d._addField(c,a)});return c},buildCalculatorNameForChart:function(a){if((a=a.comparisonInfo)&&a.calculatorName)return a.calculatorName;var b=a&&a.levels&&a.levels.length?a.levels.join("_"):null;b&&(a.calculatorName=b);return b},processEsriInfographic:function(a){return{isInfographic:!0,type:a.type,variables:a.variables&&a.variables.slice(),fieldInfos:a.fieldInfos&&a.fieldInfos,
levels:m.getLevels(a)}},optimizeInfos:function(a){var b=[],e=[],c=[];a.forEach(function(a){a.isGeneral?b.push(a):a.isChart?e.push(a):a.isInfographic&&c.push(a)});var f=d._createGeneralInfo();b.forEach(function(a){a.fields.forEach(function(a){d._addField(f,a)})});var h={};e.forEach(function(a){if(a.calculatorName){var b=h[a.calculatorName]=h[a.calculatorName]||a;b!==a&&a.fields.forEach(function(a){d._addField(b,a)})}else a.fields.forEach(function(a){d._addField(f,a)})});var g={};c.forEach(function(a){var b=
(a.fieldInfos&&a.fieldInfos.map(function(a){return a.fullName}).join("_")||a.variables.join("_"))+"_"+a.levels.join("_");g[b]=a});a=[];f.fields.length&&a.push(f);for(var k in h)a.push(h[k]);for(k in g)a.push(g[k]);return a},_createGeneralInfo:function(a){a=a||[];var b={isGeneral:!0,fields:[],_cache:{}};a.forEach(function(a){d._addField(b,a)});return b},_addField:function(a,b){b&&b.fieldName&&!a._cache[b.fieldName]&&(a._cache[b.fieldName]=!0,a.fields.push(b))}},g={ddLibrary:null,_getStandardEnrichInfos:function(a,
b,e){var c=[];a=g.ddLibrary.getDrillingOptions(a,b,e);if(!a)return c;a.forEach(function(a){c=c.concat(g._getStandardEnrichInfosForTableInfo(a,!1))});return c},_getStandardEnrichInfosForTableInfo:function(a,b){var e=[],c;for(c in a.stateData){var f=a.stateData[c];f.fieldInfo.isChart?e.push(d.processChartJson(f.fieldInfo.chartJson,function(a){var b="n"===c?"":"_"+c.toUpperCase();return a+b})):!b&&f.fieldInfo.isInfographic&&(f.fieldInfo.infographicJson.variables||f.fieldInfo.infographicJson.fieldInfos)&&
e.push(d.processEsriInfographic(f.fieldInfo.infographicJson))}return e},_getCustomEnrichInfos:function(a){var b=[];l.processSectionFieldInfos(a,function(a){a.isInfographic&&(a.infographicJson.variables||a.infographicJson.fieldInfos)&&b.push(d.processEsriInfographic(a.infographicJson))});return b},getEnrichInfosForTemplateJson:function(a,b){var e=[];l.processTemplateFieldInfos(b,function(b){b.isInfographic&&b.infographicJson.variableTables&&b.infographicJson.variableTables.forEach(function(c,d){c.variable&&
c.variable.fieldInfo&&(d=m.getDataDrilling(b.infographicJson,d))&&(d.sectionJson?e=e.concat(g._getCustomEnrichInfos(d.sectionJson)):d.isStandard&&(e=e.concat(g._getStandardEnrichInfos(a,d.standardId||c.variable.fieldInfo))))})});return d.optimizeInfos(e)}};g.buildCalculatorNameForChart=d.buildCalculatorNameForChart;g.optimizeInfos=d.optimizeInfos;return g});