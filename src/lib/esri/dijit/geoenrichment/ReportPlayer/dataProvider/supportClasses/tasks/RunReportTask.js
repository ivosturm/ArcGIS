// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/ReportPlayer/dataProvider/supportClasses/tasks/RunReportTask","dojo/_base/declare dojo/_base/lang esri/dijit/geoenrichment/promise/all esri/dijit/geoenrichment/Deferred esri/dijit/geoenrichment/when ./parsers/DataXMLParser ./EnrichAreasTask ../areas/AnalysisAreaJsonUtil esri/dijit/geoenrichment/utils/ArrayUtil esri/dijit/geoenrichment/ReportPlayer/config esri/dijit/geoenrichment/ReportPlayer/_devConfig".split(" "),function(d,f,n,g,h,p,q,r,t,k,u){var l={_cache:{},_buildKey:function(a){return[a.countryID,
a.hierarchy,JSON.stringify(r.areasToJson(a.analysisAreas,{excludeInfoTemplate:!0})),a.report.reportID,a.report.portalUrl,a.report.modified].join("_")},getCopy:function(a){a=this._buildKey(a);return(a=this._cache[a])&&f.clone(a)},copyAndPut:function(a,b){a=this._buildKey(a);this._cache[a]=b&&f.clone(b)},getResults:function(){var a=[],b;for(b in this._cache)a.push(this._cache[b]);return a}},w={execute:function(a){var b=a.cacheResult&&l.getCopy(a);if(b)return h(b);var b=t.splitArrayToBunches(a.analysisAreas,
5),d;return n(b.map(function(b){function c(){var e=f.mixin({},a,{analysisAreas:b});e.getAttributes=function(v){if(!a.attachmentsStore)return null;if(!a.attachmentsStore.supportsMultipleAreas&&d)return d;a.attachmentsStore.supportsMultipleAreas&&a.attachmentsStore.setCurrentAnalysisAreaIndex(a.analysisAreas.indexOf(v));return h(a.attachmentsStore.getAttributes(),function(a){d=d||a;return a})};return(new q).createReport(e).then(function(a){var e=a&&a.taskID;a=a&&a.result;try{u.emulateErrors.createReportError&&
(a={error:{message:"Error test: something crashed on the server!"}});var b;a&&"object"===typeof a&&(b=a.error);if(!b&&"string"===typeof a&&-1!==a.indexOf("{"))try{var c=JSON.parse(a);b=c&&c.error}catch(m){}if(b)if(k.runReportTask.ignoreErrors)a=[];else return(new g).reject(b);return{taskID:e,areaData:p.parse(a),originalXML:a,error:b}}catch(m){return(new g).reject(m)}})}return h(c(),function(a){return!a||a.error?k.runReportTask.secondAttempt?c():a:a},function(a){return k.runReportTask.secondAttempt?
c():(new g).reject(a)})})).then(function(b){var c={taskIDs:[],areaData:[],originalXMLs:[],errors:[]};b.forEach(function(a){c.taskIDs.push(a.taskID);c.originalXMLs.push(a.originalXML);a.error&&c.errors.push(a.error);c.areaData=c.areaData.concat(a.areaData)});a.cacheResult&&!c.errors.length&&l.copyAndPut(a,c);return c})}};d=d(null,{execute:function(a){console.log("Creating a new report...");return w.execute(a)}});d.CreateReportResultCache=l;return d});