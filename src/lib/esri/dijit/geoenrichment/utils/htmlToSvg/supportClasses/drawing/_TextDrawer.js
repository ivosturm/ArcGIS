// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/utils/htmlToSvg/supportClasses/drawing/_TextDrawer",["dojo/_base/lang","../ElementBuilder","../text/TextMeasurer","../text/TextStyleBuilder"],function(x,h,l,y){function z(d,c){for(var b=[],a,g=0===c.style.whiteSpace.indexOf("pre"),f=c.style.textAlign,m=0;m<d.length;m++){var e=d[m];if(g||"justify"!==f||e.text.trim()){g&&"justify"===f&&a&&(e.text.trim()?a.text.trim()||(a=null):a.text.trim()&&(a=null));if(a){var n=r.test(e.text),k=a._isRtl===n;if(t(a,e)&&k){var k=e.box.x+
e.box.w/2>a.box.x+a.box.w/2,p=Math.abs(e.box.x+e.box.w-a.box.x),h=Math.abs(a.box.x+a.box.w-e.box.x),l=n&&!k&&p<=u;if(!n&&k&&h<=u||l){a.text+=e.text;a.box.h=Math.max(a.box.y+a.box.h,e.box.y+e.box.h)-Math.min(a.box.y,e.box.y);a.box.y=Math.min(a.box.y,e.box.y);a._isRtl?(a.box.x-=e.box.w+p,a.box.w+=e.box.w+p):a.box.w+=e.box.w+h;a._boxes.push(e);continue}}}a={_isRtl:r.test(e.text),text:e.text,box:x.mixin({},e.box),_boxes:[e]};b.push(a)}else a=null}g||"justify"!==f||q(b).forEach(function(a,b,d){if(!(2>
a.boxes.length||b===d.length-1)){a.boxes.sort(function(a,b){a.box.x-b.box.x});var e=0;a.boxes.forEach(function(a){e+=a.box.w});var f=(c.style.cw-e)/(a.boxes.length-1),v=c.style.getPaddings().l+c.style.getBorder().l.width;a.boxes.forEach(function(a){a.box.x=v;v+=a.box.w+f})}});g&&"left"===f&&q(b).forEach(function(a,b,c){!a.isNewLine&&w(a)});g&&"justify"===f&&q(b).forEach(function(a,b,d){if(2>a.boxes.length||a.isLastLine)a.isLastLine&&w(a);else{a.boxes.sort(function(a,b){a.box.x-b.box.x});b=0;a.isNewLine&&
!a.boxes[0].text.trim()&&(b=a.boxes[0].box.w,a.boxes.shift());a.boxes=a.boxes.filter(function(a){return!a.text.trim()&&2>a._boxes.length?!1:!0});var e=0;a.boxes.forEach(function(a){e+=a.box.w});var f=(c.style.cw-b-e)/(a.boxes.length-1),g=b+c.style.getPaddings().l+c.style.getBorder().l.width;a.boxes.forEach(function(a){a.box.x=g;g+=a.box.w+f})}});return b}function t(d,c){d=d.box.y+d.box.h/2;return d>c.box.y&&d<c.box.y+c.box.h}function q(d){var c=[],b;d.forEach(function(a,d){if(b&&t(b.boxes[0],a))b.boxes.push(a);
else{var f=c.length&&c[c.length-1],f=f&&f.boxes[f.boxes.length-1];b={boxes:[a],isNewLine:0===d||f&&f.text.indexOf("\n")===f.text.length-1,isLastLine:!1};c.push(b)}});for(d=1;d<c.length;d++){var a=c[d-1];c[d].isNewLine&&(a.isLastLine=!0)}c.length&&(c[c.length-1].isLastLine=!0);return c}function w(d){var c=d.boxes[0],b=d.boxes[1],a=c._boxes[0],b=c._boxes[1]||b&&b._boxes[0];!a.text.trim()&&b&&b.text.trim()&&(c._boxes.shift(),c.text=c.text.replace(a.text,""),c.box.w-=a.box.w,d.boxes.forEach(function(b,
c){0<c&&(b.box.x-=a.box.w)}))}var u=.1,r=/^[^A-Za-z\u00c0-\u00d6\u00d8-\u00f6\u00f8-\u02b8\u0300-\u0590\u0800-\u1fff\u2c00-\ufb1c\ufdfe-\ufe6f\ufefd-\uffff]*[\u0591-\u07ff\ufb1d-\ufdfd\ufe70-\ufefc]/;return{drawText:function(d,c,b,a){d=l.getBoxes(d,c,b);if(!d||!d.boxes.length)return null;var g=[];z(d.boxes,b).forEach(function(c){if(c.text.trim()){var d={fill:b.style.color,x:b.box.x+c.box.x,y:b.box.y+c.box.y+(b.style.fontSize-(.5+.0375*(b.style.fontSize-10))),style:y.buildTextStyleString(b,b.isLink?
{"text-decoration":"underline"}:void 0),opacity:b.style.opacity*b.style.colorOpacity,transform:b.style.transform,clipParams:a,"text-anchor":"start"};c=h.buildElement("text",d,c.text.replace("\n",""));b.isLink&&(c=h.buildElement("a",{"xlink:href":b.href,target:b.target},c));g.push(c)}});return g}}});