// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.
//>>built
define("esri/layers/FeatureLayer","require module dojo/_base/declare dojo/_base/connect dojo/_base/lang dojo/_base/array dojo/_base/json dojo/_base/Deferred dojo/date/locale dojo/io-query dojo/dom-construct dojo/i18n dojo/when dojo/global dojo/promise/all ../sniff ../kernel ../lang ../request ../config ../deferredUtils ../promiseList ../SpatialReference ../urlUtils ../symbols/SimpleMarkerSymbol ../symbols/SimpleLineSymbol ../symbols/SimpleFillSymbol ../symbols/jsonUtils ../renderers/SimpleRenderer ../renderers/UniqueValueRenderer ../renderers/jsonUtils ../support/expressionUtils ../arcadeProfiles/labelingProfile ../tasks/QueryTask ../tasks/query ../tasks/FeatureSet ../tasks/StatisticDefinition ../geometry/Extent ../geometry/jsonUtils ../geometry/normalizeUtils ../geometry/scaleUtils ./GraphicsLayer ./Field ./TimeInfo ./TimeReference ./FeatureType ./FeatureTemplate ./FeatureEditResult ./LabelClass ./SnapshotMode ./OnDemandMode ./SelectionMode ./StreamMode ./GridLayout ./TrackManager ./HeatmapManager ./clustering/ClusterManager dojo/i18n!../nls/jsapi dojo/has!extend-esri?./agscommon".split(" "),
function(N,W,X,B,p,h,F,w,Y,Z,aa,Fa,O,J,ba,x,G,r,z,ca,y,P,K,da,ea,fa,Q,ga,R,ha,ia,S,ja,ka,L,H,la,T,ma,na,oa,pa,qa,ra,sa,ta,ua,E,va,I,M,wa,xa,ya,U,V,za,Aa){var Ba=ca.defaults,Ca=!!x("esri-pbf"),Da=!!x("esri-featurelayer-pbf"),l=X(pa,{declaredClass:"esri.layers.FeatureLayer",invalidParams:"query contains one or more unsupported parameters",reHostedFS:/(https?:)?\/\/services.*\.arcgis\.com/i,maxPointCountForAuto:4E3,maxRecordCountForAuto:2E3,maxVertexCountForAuto:25E4,generalizeForScale:4E3,_eventMap:{"add-attachment-complete":["result"],
"before-apply-edits":["adds","updates","deletes"],"delete-attachments-complete":["results"],"edits-complete":["adds","updates","deletes"],"query-attachment-infos-complete":["results"],"query-count-complete":["count"],"query-features-complete":["featureSet"],"query-ids-complete":["objectIds"],"query-related-features-complete":["featureSets"],"selection-complete":["features","method"],"update-end":["error","info"]},constructor:function(a,b){this._preventInit||this._initFeatureLayer(a,b)},_initFeatureLayer:function(a,
b){b=b||{};this._tileWidth=b.tileWidth||512;this._tileHeight=b.tileHeight||512;this.i18n=Aa;this._featureReduction=this._featureReduction||b.featureReduction;this._featureReductionEnabled=null!=b.featureReductionEnabled?b.featureReductionEnabled:!0;this.showLabels=null!=b.showLabels?b.showLabels:!0;this._outFields=b.outFields;this._defnExpr=b.definitionExpression;this._loadCallback=b.loadCallback;this._trackIdField=b.trackIdField;this.objectIdField=b.objectIdField;var c=null!=b.resolution,d=null!=
b.maxAllowableOffset;this._maxOffset=this._optMaxOffset=c||d?c?b.resolution:b.maxAllowableOffset:this.maxAllowableOffset;this.quantize=null!=b.quantize?b.quantize:!0;this._optEditable=b.editable;this._optAutoGen=b.autoGeneralize;this.editSummaryCallback=b.editSummaryCallback;this.userId=b.userId;this.userIsAdmin=b.userIsAdmin;this.useMapTime=b.hasOwnProperty("useMapTime")?!!b.useMapTime:!0;this.source=b.source;this.gdbVersion=b.gdbVersion;this.orderByFields=b.orderByFields;this.maxPointCountForAuto=
null!=b.maxPointCountForAuto?b.maxPointCountForAuto:this.maxPointCountForAuto;this.maxRecordCountForAuto=null!=b.maxRecordCountForAuto?b.maxRecordCountForAuto:this.maxRecordCountForAuto;this.maxVertexCountForAuto=null!=b.maxVertexCountForAuto?b.maxVertexCountForAuto:this.maxVertexCountForAuto;this.generalizeForScale=null!=b.generalizeForScale?b.generalizeForScale:this.generalizeForScale;this.queryPagination=this._optQueryPagination=null!=b.queryPagination?b.queryPagination:!0;this.multipatchOption=
b.multipatchOption;this._selectedFeatures={};this._newFeatures=[];this._deletedFeatures={};this._ulid=this._getUniqueId();c=r.isDefined(b.mode)?b.mode:l.MODE_ONDEMAND;this._isStream&&(c=l.MODE_STREAM);this.mode=c;switch(c){case l.MODE_SNAPSHOT:this.currentMode=l.MODE_SNAPSHOT;this._mode=new I(this);break;case l.MODE_ONDEMAND:case l.MODE_AUTO:this.currentMode=l.MODE_ONDEMAND;this._mode=new M(this);this.latticeTiling=b.latticeTiling;break;case l.MODE_SELECTION:this.currentMode=l.MODE_SELECTION;this._mode=
new wa(this);this._isSelOnly=!0;break;case l.MODE_STREAM:this.currentMode=l.MODE_STREAM,this._mode=new xa(this),this._isStream=!0}this._initLayer=p.hitch(this,this._initLayer);this._selectHandler=p.hitch(this,this._selectHandler);this._editable=!1;if(p.isObject(a)&&a.layerDefinition)return this._collection=!0,this.mode=this._isStream?l.MODE_STREAM:l.MODE_SNAPSHOT,this._isStream||this._outFields||(this._outFields=["*"]),this._initLayer(a),this;this._task=new ka(this.url,{source:this.source,gdbVersion:this.gdbVersion});
a=this._url.path;this._fserver=!1;-1!==a.search(/\/FeatureServer\//i)&&(this._fserver=!0);this._checkFeatureLimit();(b=b.resourceInfo)?this._initLayer(b):(this.source&&(b={source:this.source.toJson()},this._url.query=p.mixin(this._url.query,{layer:F.toJson(b)})),this.gdbVersion&&(this._url.query=p.mixin(this._url.query,{gdbVersion:this.gdbVersion})),z({url:a,content:p.mixin({f:"json"},this._url.query),callbackParamName:"callback",load:this._initLayer,error:this._errorHandler}));this.registerConnectEvents()},
_initLayer:function(a,b){if(a||b){this._json=a;this._findCredential();if(this.credential&&this.credential.ssl||a&&a._ssl)this._useSSL(),this._task._useSSL();this._collection&&(this._isStream||(this.currentMode=l.MODE_SNAPSHOT,this._mode=new I(this)),this._featureSet=a.featureSet,this._nextId=a.nextObjectId,a=a.layerDefinition);this.version=a.currentVersion;this.version||(this.version="capabilities"in a||"drawingInfo"in a||"hasAttachments"in a||"htmlPopupType"in a||"relationships"in a||"timeInfo"in
a||"typeIdField"in a||"types"in a?10:9.3);this.geometryType=a.geometryType;a.bandCount&&a.fields&&1<a.fields.length&&(this.geometryType="esriGeometryPolygon",this._isImageService=!0);"string"!==typeof this.multipatchOption&&"esriGeometryMultiPatch"===this.geometryType&&(this.multipatchOption="xyFootprint");a.hasOwnProperty("capabilities")?(b=this.capabilities=a.capabilities)&&-1!==b.toLowerCase().indexOf("editing")?this._editable=!0:this._editable=!1:this._collection||(this._editable=this._fserver);
r.isDefined(this._optEditable)?(this._editable=this._optEditable,delete this._optEditable):"esriGeometryMultiPatch"===this.geometryType&&(this._editable=!1);this._isImageService&&(this._editable=!1);this._json=F.toJson(this._json);this.isEditable()?this._setMaxOffset(null):this._canAutoGeneralize()&&(this._autoGeneralize=r.isDefined(this._optAutoGen)?this._optAutoGen:this.mode===l.MODE_ONDEMAND||this.mode===l.MODE_AUTO,delete this._optAutoGen);b=a.effectiveMinScale||a.minScale;var c=a.effectiveMaxScale||
a.maxScale;!this._hasMin&&b&&this.setMinScale(b);!this._hasMax&&c&&this.setMaxScale(c);this.layerId=a.id;this.name=a.name;this.description=a.description;this.copyright=a.copyrightText;this.type=a.type;this.displayField=a.displayField;this.defaultDefinitionExpression=a.definitionExpression||(a.isView?a.viewDefinitionQuery:a.definitionQuery);this.fullExtent=new T(a.extent);this.initialExtent=new T(this.fullExtent.toJson());this.fullExtent.spatialReference&&(this.spatialReference=new K(this.fullExtent.spatialReference.toJson()));
this.defaultVisibility=a.defaultVisibility;this.editingInfo=a.editingInfo;if("esriGeometryPoint"===this.geometryType||"esriGeometryMultipoint"===this.geometryType)this.latticeTiling=!1;this.hasM=a.hasM||!1;this.hasZ=a.hasZ||!1;this.indexedFields=a.indexedFields;this.indexes=a.indexes;this.maxRecordCount=a.maxRecordCount;this.canModifyLayer=a.canModifyLayer;this.supportsStatistics=a.supportsStatistics;this.supportsAdvancedQueries=this._collection?!1:a.supportsAdvancedQueries;this.supportsCalculate=
a.supportsCalculate;this.supportsASyncCalculate=a.supportsASyncCalculate;this.supportsAttachmentsByUploadId=a.supportsAttachmentsByUploadId;this.supportsCoordinatesQuantization=a.supportsCoordinatesQuantization;this.supportsQuantizationEditMode=a.supportsQuantizationEditMode;this.supportsFieldDescription=a.supportsFieldDescriptionProperty;this.supportsFormatPBF=a.supportedQueryFormats?-1!==h.map(a.supportedQueryFormats.toLowerCase().split(","),p.trim).indexOf("pbf"):!1;this.quantize=this.quantize&&
this.supportsCoordinatesQuantization;this.hasLabels=a.hasLabels;this.canScaleSymbols=a.canScaleSymbols;this.supportsRollbackOnFailureParameter=this.supportsRollbackOnFailure=a.supportsRollbackOnFailure;this.syncCanReturnChanges=a.syncCanReturnChanges;this.isDataVersioned=a.isDataVersioned;this.editFieldsInfo=a.editFieldsInfo;this.ownershipBasedAccessControlForFeatures=a.ownershipBasedAccessControlForFeatures;this.editFieldsInfo&&this.ownershipBasedAccessControlForFeatures&&(this.creatorField=this.editFieldsInfo.creatorField);
this.relationships=a.relationships;this.allowGeometryUpdates=r.isDefined(a.allowGeometryUpdates)?a.allowGeometryUpdates:!0;this.allowUpdateWithoutMValues=!!a.allowUpdateWithoutMValues;this.enableZDefaults=!!a.enableZDefaults;this.zDefault=r.isDefined(a.zDefault)?a.zDefault:null;this.advancedQueryCapabilities=a.advancedQueryCapabilities||{supportsStatistics:this.supportsStatistics,supportsOrderBy:this.supportsAdvancedQueries,supportsDistinct:this.supportsAdvancedQueries};this.geometryProperties=a.hasGeometryProperties&&
a.geometryProperties||null;this.url&&(this.advancedQueryCapabilities.supportsPagination=this.advancedQueryCapabilities.supportsPagination&&(this.reHostedFS.test(this.url)||10.3<this.version));this.queryPagination=this._optQueryPagination&&this.advancedQueryCapabilities.supportsPagination;this.useStandardizedQueries=a.useStandardizedQueries;this.tileMaxRecordCount=a.tileMaxRecordCount;this.standardMaxRecordCount=a.standardMaxRecordCount;if(b=a.dateFieldsTimeReference)this.dateFieldsTimeReference=new sa(b);
this._setMaxOffset(this._maxOffset,!0);this._isTable="Table"===this.type;c=a.fields;this._createFields(c);if(!this.objectIdField){this.objectIdField=a.objectIdField;if(!this.objectIdField)for(c=a.fields,b=0;b<c.length;b++){var d=c[b];if("esriFieldTypeOID"===d.type){this.objectIdField=d.name;break}}this.objectIdField||this._isStream||console.debug("esri.layers.FeatureLayer: "+r.substitute({url:this.url},"objectIdField is not set [url: ${url}]"))}if(!r.isDefined(this._nextId)){c=this.objectIdField;
d=-1;if(this._collection&&c){var e=(b=this._featureSet)&&b.features,f=e?e.length:0,m;for(b=0;b<f;b++)m=(m=e[b].attributes)&&m[c],m>d&&(d=m)}this._nextId=d+1}this.globalIdField=a.globalIdField;if(b=this.typeIdField=a.typeIdField)if(b=!this._getField(b)&&this._getField(b,!0))this.typeIdField=b.name;this.visibilityField=a.visibilityField;if(c=a.defaultSymbol)this.defaultSymbol=ga.fromJson(c);var g=this.types=[],q=a.types,k,n,d=(b=this.editFieldsInfo)&&b.creatorField,e=b&&b.editorField;m=d||e;f=[];if(q)for(b=
0;b<q.length;b++)k=new ta(q[b]),n=k.templates,m&&n&&n.length&&(f=f.concat(n)),g.push(k);q=a.templates;k=this.templates=[];if(q)for(b=0;b<q.length;b++)g=new ua(q[b]),m&&f.push(g),k.push(g);for(b=0;b<f.length;b++)if(m=p.getObject("prototype.attributes",!1,f[b]))d&&delete m[d],e&&delete m[e];if(b=a.timeInfo)this.timeInfo=new ra(b),this._startTimeField=b.startTimeField,this._endTimeField=b.endTimeField,this._startTimeField&&this._endTimeField&&(this._twoTimeFields=!0),this._trackIdField?b.trackIdField=
this._trackIdField:this._trackIdField=b.trackIdField;this.hasAttachments=!this._collection&&a.hasAttachments?!0:!1;this.htmlPopupType=a.htmlPopupType;b=a.drawingInfo;var t;(d=b&&b.labelingInfo)&&!this.labelingInfo&&(this.labelingInfo=h.map(d,function(a){return new va(a)}),this._fixLabelExpr());if(!this.renderer)if(b&&b.renderer){if(t=b.renderer,this.setRenderer(ia.fromJson(t,{geometryType:this.geometryType})),"classBreaks"===t.type&&this.renderer.setMaxInclusive(!0),!this._collection){var u=t.type,
c=[];t=this.renderer;switch(u){case "simple":c.push(t.symbol);break;case "uniqueValue":case "classBreaks":c.push(t.defaultSymbol),c=c.concat(h.map(t.infos,function(a){return a.symbol}))}var c=h.filter(c,r.isDefined),Ea=this._url.path+"/images/",v=this._getToken();h.forEach(c,function(a){var b=a.url;b&&(-1===b.search(/https?\:/)&&-1===b.indexOf("data:")&&(a.url=Ea+b),v&&-1!==a.url.search(/https?\:/)&&(a.url+="?token\x3d"+v))})}}else if(c)q=this.types,0<q.length?(t=new ha(this.defaultSymbol,this.typeIdField),
h.forEach(q,function(a){t.addValue(a.id,a.symbol)})):t=new R(this.defaultSymbol),this.setRenderer(t);else if(!this._isTable){switch(this.geometryType){case "esriGeometryPoint":case "esriGeometryMultipoint":u=new ea;break;case "esriGeometryPolyline":u=new fa;break;case "esriGeometryPolygon":u=new Q;break;default:this.hasXYFootprint()&&(u=new Q)}this.setRenderer(u?new R(u):null)}u=b&&b.transparency||0;!this.hasOwnProperty("opacity")&&0<u&&(this.opacity=1-u/100);(x("ie")||7<=x("trident")||x("safari"))&&
this.isEditable()&&10.02>this.version&&(this._ts=!0);this.statistics=a.statistics;this._fixRendererFields();this._updateRequiredFieldsFromLabelingInfo();this._checkFields();this._updateCaps();var A=function(){null==this._maxOffset||this._isFractionalOffsetAllowed()||this._setMaxOffset(this._maxOffset);this.loaded=!0;this.setFeatureReduction(this.getFeatureReduction());this.currentMode!==l.MODE_SNAPSHOT&&(this.queryPagination=!1);this.onLoad(this);var a=this._loadCallback;a&&(delete this._loadCallback,
a(this))};a=[];this._collection?(u=this._featureSet,this._featureSet=null,this._mode._drawFeatures(new H(u)),this._fcAdded=!0):(a.push(this._forceIdentity()),this._limitPromise&&a.push(this._limitPromise));a.push(this._evalArcadeSupport());a.length?P(a).then(p.hitch(this,function(){A.call(this)})):A.call(this)}},setShowLabels:function(a){var b=this.showLabels;this.showLabels=a;b!==this.showLabels&&(this._evalSurfaceType(),this.onShowLabelsChange())},onShowLabelsChange:function(){},onRendererChange:function(a){this.inherited(arguments);
var b=this._map;this._ager=!!(a&&a.observationAger&&a.observationRenderer);a&&"colors"in a&&"blurRadius"in a&&"maxPixelIntensity"in a?(this._evalSurfaceType(!0),"esriGeometryPoint"==this.geometryType&&!this._heatmapManager&&b&&(this._heatmapManager=new V(this),this._heatmapManager.initialize(b))):this.renderer&&this.renderer.getRendererInfo?h.some(this.renderer.rendererInfos,function(a){return a.renderer&&"colors"in a.renderer&&"blurRadius"in a.renderer})||(this._heatmapManager=null):this._heatmapManager=
null;this.timeInfo&&b&&(a&&(a.latestObservationRenderer||a.trackRenderer)?this._trackManager||(this._trackManager=new U(this),this._trackManager.initialize(b),this._childLayer=this._trackManager.container,this._mode._applyTimeFilter()):this._trackManager&&!this._isStream&&(this._trackManager.destroy(),this._trackManager=null));if(a){var c=[],b=h.filter([a,a.observationRenderer,a.latestObservationRenderer,a.trackRenderer],r.isDefined),d=function(a){return null!=a&&"function"!=typeof a&&a};h.forEach(b,
function(a){var b=d(a.attributeField),e=d(a.attributeField2);a=d(a.attributeField3);!1!==b&&c.push(b);!1!==e&&c.push(e);!1!==a&&c.push(a)});this._requiredFields=c}else this._requiredFields=[];this.loaded&&(this._fixRendererFields(),this._checkFields(this._requiredFields),this._collection&&(this._typesDirty=!0))},setFeatureReduction:function(a){a&&(a=p.mixin({},a),null!=a.clusterSize&&null==a.clusterRadius&&(a.clusterRadius=a.clusterSize),delete a.clusterSize);this.loaded?this._isFeatureReductionSupported(a)?
this._featureReduction=a:(this._featureReduction=null,a&&console.log("Clustering is not supported for this layer: "+this.url)):this._featureReduction=a;this._evalFeatureReduction(this._featureReduction)},hasFeatureReduction:function(){return!!this._featureReduction},getFeatureReduction:function(){var a=this._featureReduction;if(a){var a=p.mixin({},a),b=this._clusterManager;if(b=b&&b.aggregationInfo)a.clusterRadius=b.clusterRadius,a.infoTemplate=b.infoTemplate}return a},isFeatureReductionActive:function(){var a=
this._clusterManager;return!!(a&&a.isClusteringEnabled()&&a.isClusteringActive())},isFeatureReductionEnabled:function(){return this._featureReductionEnabled},enableFeatureReduction:function(){this._featureReductionEnabled||(this._featureReductionEnabled=!0,this._evalFeatureReduction(this._featureReduction))},disableFeatureReduction:function(){this._featureReductionEnabled&&(this._featureReductionEnabled=!1,this._evalFeatureReduction(this._featureReduction))},isFeatureReductionApplied:function(){return this.hasFeatureReduction()&&
this.isFeatureReductionEnabled()&&this._canCluster(this.getFeatureReduction())},getAggregateGraphics:function(){return this._clusterManager?this._clusterManager.getAggregateGraphics():[]},getChildGraphics:function(a){return this._clusterManager?this._clusterManager.getFeaturesInCluster(a):[]},getSingleGraphics:function(){return this._clusterManager?this._clusterManager.getSingleGraphics():[]},getFeatureReductionRenderer:function(){return this.isFeatureReductionActive()?this._clusterManager.getClusterRenderer():
null},getFeatureReductionLayer:function(){return this._clusterManager?this._clusterManager.container:null},getFeatureReductionField:function(a){var b,c=this._clusterManager?this._clusterManager.getClusterFields():null;a=a?a.toLowerCase():"";h.some(c,function(c){a===c.name.toLowerCase()&&(b=c);return!!b});return b},_isFeatureReductionSupported:function(a){return a&&"cluster"===a.type&&"esriGeometryPoint"===this.geometryType&&(this._collection||this._isStream||this._optQueryPagination&&this.advancedQueryCapabilities.supportsPagination)},
_isReductionCompatibleRenderer:function(a){a=a&&a.declaredClass||"";a=a.toLowerCase();return-1<a.indexOf("simplerenderer")||-1<a.indexOf("classbreaksrenderer")||-1<a.indexOf("uniquevaluerenderer")},_evalFeatureReduction:function(a){this.loaded&&this.getMap()&&(a=a||this.getFeatureReduction(),this._evalModeFromFReduction(a),a&&this.isFeatureReductionEnabled()?this._canCluster(a)?this._clusterManager?this._updateClusterManager(a):(this._clusterManager=this._createClusterManager(a),this.onFeatureReductionChange()):
(console.log("Clustering is supported only for point layers where map spatial reference is WGS84 or Web Mercator"),this._destroyClusterManager()):this._destroyClusterManager())},_canCluster:function(a){var b=this._map;if(!b)return!1;b=b.spatialReference;return this._isFeatureReductionSupported(a)&&this._isReductionCompatibleRenderer(this.renderer)&&(b.isWebMercator()||4326===b.wkid)},_createClusterManager:function(a){a=new za({layer:this,aggregationInfo:a});this._clusterHandles=[a.on("renderer-change",
p.hitch(this,function(){this.onFeatureReductionRendererChange()}))];a.initialize(this._map);return a},_updateClusterManager:function(a){var b=this._clusterManager;b&&b.setAggregationInfo(a)},_destroyClusterManager:function(a){h.forEach(this._clusterHandles,function(a){a.remove()});this._clusterHandles=null;this._clusterManager&&(this._clusterManager.destroy(a),this._clusterManager=null,this.onFeatureReductionChange())},redraw:function(){this.inherited(arguments);this._clusterManager&&this._clusterManager.redraw();
this._trackManager&&this._trackManager.container&&this._trackManager.container.redraw()},_evalSDRenderer:function(a){this.inherited(arguments);var b=this._getRenderer();this._ager=!!(b&&b.observationAger&&b.observationRenderer);this._trackManager&&this._trackManager.container&&this._trackManager.container.setRenderer(b&&b.trackRenderer);a&&this._evalFeatureReduction()},_graphicVisibilityChanged:function(a){this._clusterManager?this._clusterManager.toggleFeatureVisibility(a):this._heatmapManager&&
this._heatmapManager.redraw()},setWebGLFetchOptions:function(a){this._hasOnDemandDrillMode()&&(a=a||{},null!=a.maxDrillLevel&&(this._mode.maxDrillLevel=a.maxDrillLevel),null!=a.maxRecordCountFactor&&(this._mode.maxRecordCountFactor=a.maxRecordCountFactor),null!=a.enablePBFQuery&&(this._mode.enablePBFQuery=a.enablePBFQuery))},_isWebGLCompatible:function(){return this.loaded&&!this.isEditable()&&!this.isFeatureReductionApplied()&&(!this.labelingInfo||!1===this.showLabels)&&!this._isGeometryOperationsUsed()&&
this._isRendererSupportedInWebGL()&&this.supportsCoordinatesQuantization&&("esriGeometryPolygon"!==this.geometryType||this.advancedQueryCapabilities.supportsReturningGeometryCentroid)&&this.currentMode===l.MODE_ONDEMAND&&(!this._preSurfaceChangeState||this._preSurfaceChangeState.currentMode===l.MODE_ONDEMAND)},_isRendererSupportedInWebGL:function(){if(!this.renderer)return!1;var a=this.renderer,b=a.declaredClass?a.declaredClass.toLowerCase():"";return(-1<b.indexOf("simplerenderer")||-1<b.indexOf("classbreaksrenderer")||
-1<b.indexOf("uniquevaluerenderer"))&&this._hasWebGLCompatibleSymbols(a)&&this._hasWebGLCompatibleVVs(a)},_hasWebGLCompatibleSymbols:function(a){a=this._getAllSymbolsInRenderer(a);return!(this._hasSLSWithMarker(a)||this._hasIncompatibleSMSStyles(a)||this._hasGIFMarker(a))},_hasWebGLCompatibleVVs:function(a){return!h.some(a&&a.visualVariables,function(a){var b=a.type;return("colorInfo"===b||"opacityInfo"===b)&&a.stops&&8<a.stops.length||"sizeInfo"===b&&(a.field||a.valueExpression&&"$view.scale"!==
a.valueExpression||a.expression&&"view.scale"!==a.expression)&&a.stops&&6<a.stops.length?!0:!1})},_hasSLSWithMarker:function(a){return h.some(a,function(a){return a&&"simplelinesymbol"===a.type&&!!a.marker})},_hasIncompatibleSMSStyles:function(a){var b=void 0===x("ie")&&7==x("trident");return h.some(a,function(a){return a&&"simplemarkersymbol"===a.type&&("triangle"===a.style||"path"===a.style&&b)})},_hasGIFMarker:function(a){var b=/\.gif$/,c=/^image\/gif$/;return h.some(a,function(a){return a&&"picturemarkersymbol"===
a.type?b.test(a.url)||c.test(a.contentType):!1})},_getAllSymbolsInRenderer:function(a){var b=[];a&&(b.push(a.symbol),b.push(a.defaultSymbol),h.forEach(a.infos,function(a){b.push(a.symbol)}),b=h.filter(b,function(a){return!!a}));return b},_setMap:function(a){var b=this.inherited(arguments),c=this._mode,d=this;c&&a.loaded&&c.initialize(a);this.geometryType&&this.attr("data-geometry-type",this.geometryType.replace(/esriGeometry/i,"").toLowerCase());this._addHandle=this.on("graphic-node-add",function(a){a=
a.graphic.attributes;(a=d._selectedFeatures[a&&a[d.objectIdField]])&&a.attr("data-selected","")});return b},_unsetMap:function(a){var b=this._mode;b&&(b.suspend(),b.destroy());this._destroyClusterManager(!1);this._trackManager&&(this._trackManager.destroy(),this._trackManager=null);B.disconnect(this._zoomConnect);B.disconnect(this._addHandle);this._zoomConnect=this._addHandle=null;this._toggleTime(!1);this.inherited("_unsetMap",arguments)},onAttach:function(){this._evalModeFromSurface()},refresh:function(){this._needsRefresh=
!1;var a=this._mode;a&&a.refresh()},hasXYFootprint:function(){return"esriGeometryMultiPatch"===this.geometryType&&"xyFootprint"===this.multipatchOption},getOutFields:function(){return h.filter(this._getOutFields(),function(a){return"*"===a||!!this._getField(a)},this)},getField:function(a){return this._getField(a,!0)},isOutField:function(a){a=this.getField(a);if(!a)return!1;var b=this.getOutFields();return-1<h.indexOf(b,"*")||-1<h.indexOf(b,a.name)},getFieldLabel:function(a){var b=this.infoTemplate,
b=b&&b.getFieldInfo&&b.getFieldInfo(a);a=p.isFunction(a)?null:this.getField(a);var c=b||a,d="";c&&(d=b&&b.label||a&&a.alias||c.name||c.fieldName);return d},getDomain:function(a,b){var c,d,e=(b=b&&b.feature)&&this.typeIdField&&b.attributes&&b.attributes[this.typeIdField];null!=e&&h.some(this.types,function(b){return b.id==e?((c=b.domains&&b.domains[a])&&"inherited"===c.type&&(c=this._getLayerDomain(a),d=!0),!0):!1},this);d||c||(c=this._getLayerDomain(a));return c},_getLayerDomain:function(a){this._createFieldsIndex();
var b=this._fieldsIndex;if(b)return b=b.caseSensitive,(b=b.get(a))?b.domain:null;var c;h.some(this.fields,function(b){b.name===a&&(c=b.domain);return!!c});return c},getType:function(a){var b,c=a&&this.typeIdField&&a.attributes&&a.attributes[this.typeIdField];h.some(this.types,function(a){a.id==c&&(b=a);return!!b});return b},setEditable:function(a){if(!this._collection)return console.log("FeatureLayer:setEditable - this functionality is not yet supported for layer in a feature service"),this;if(this._isImageService)return this;
if(!this.loaded)return this._optEditable=a,this;var b=this._editable;this._editable=a;this._updateCaps();if(b!==a)this.onCapabilitiesChange();return this},getEditCapabilities:function(a){var b={canCreate:!1,canUpdate:!1,canDelete:!1,canUpdateGeometry:!1};if(!this.loaded||!this.isEditable())return b;var c=a&&a.feature;a=a&&a.userId||this.getUserId();var d=h.map(this.capabilities?this.capabilities.toLowerCase().split(","):[],p.trim),e=(b=-1<h.indexOf(d,"editing"))&&-1<h.indexOf(d,"create"),f=b&&-1<
h.indexOf(d,"update"),d=b&&-1<h.indexOf(d,"delete"),m=this.ownershipBasedAccessControlForFeatures,g=this.editFieldsInfo,q=g&&g.creatorField,g=g&&g.realm,c=(c=c&&c.attributes)&&q?c[q]:void 0,k=!!this.userIsAdmin,q=!m||k||!(!m.allowOthersToUpdate&&!m.allowUpdateToOthers),n=!m||k||!(!m.allowOthersToDelete&&!m.allowDeleteToOthers),l=!m||k||!m.hasOwnProperty("allowAnonymousToUpdate")||m.allowAnonymousToUpdate,m=!m||k||!m.hasOwnProperty("allowAnonymousToDelete")||m.allowAnonymousToDelete;a&&g&&(a=a+"@"+
g);if(k||b&&!(e||f||d))e=f=d=!0;b={canCreate:e,canUpdate:f,canDelete:d,canUpdateGeometry:k||this.allowGeometryUpdates};a||(b.canUpdate=b.canUpdate&&l,b.canDelete=b.canDelete&&m);null===c?(b.canUpdate=b.canUpdate&&q,b.canDelete=b.canDelete&&n):""!==c&&c&&a.toLowerCase()!==c.toLowerCase()&&(b.canUpdate=b.canUpdate&&q,b.canDelete=b.canDelete&&n);return b},getUserId:function(){var a;this.loaded&&(a=this.credential&&this.credential.userId||this.userId||"");return a},setUserIsAdmin:function(a){this.userIsAdmin=
a},setEditSummaryCallback:function(a){this.editSummaryCallback=a},getEditSummary:function(a,b,c){c=r.isDefined(c)?c:(new Date).getTime();var d="";c=this.getEditInfo(a,b,c);(b=b&&b.callback||this.editSummaryCallback)&&(c=b(a,c)||"");if(p.isString(c))d=c;else{if(c){a=c.action;b=c.userId;var e=c.timeValue,f=0;a&&f++;b&&f++;r.isDefined(e)&&f++;1<f&&(d=("edit"===a?"edit":"create")+(b?"User":"")+(r.isDefined(e)?c.displayPattern:""))}d=d&&r.substitute(c,this.i18n.layers.FeatureLayer[d])}return d},getEditInfo:function(a,
b,c){if(this.loaded){c=r.isDefined(c)?c:(new Date).getTime();b=b&&b.action||"last";var d=this.editFieldsInfo,e=d&&d.creatorField,f=d&&d.creationDateField,m=d&&d.editorField,d=d&&d.editDateField,m=(a=a&&a.attributes)&&m?a[m]:void 0,d=a&&d?a[d]:null,e=this._getEditData(a&&e?a[e]:void 0,a&&f?a[f]:null,c);c=this._getEditData(m,d,c);var g;switch(b){case "creation":g=e;break;case "edit":g=c;break;case "last":g=c||e}g&&(g.action=g===c?"edit":"creation");return g}},_getEditData:function(a,b,c){var d,e,f;
r.isDefined(b)&&(e=c-b,f=0>e?"Full":6E4>e?"Seconds":12E4>e?"Minute":36E5>e?"Minutes":72E5>e?"Hour":864E5>e?"Hours":6048E5>e?"WeekDay":"Full");if(void 0!==a||f)d=d||{},d.userId=a,f&&(a=Y.format,c=new Date(b),d.minutes=Math.floor(e/6E4),d.hours=Math.floor(e/36E5),d.weekDay=a(c,{datePattern:"EEEE",selector:"date"}),d.formattedDate=a(c,{selector:"date"}),d.formattedTime=a(c,{selector:"time"}),d.displayPattern=f,d.timeValue=b);return d},isEditable:function(){return!(!this._editable&&!this.userIsAdmin)},
isQueryable:function(){var a=h.map(this.capabilities?this.capabilities.toLowerCase().split(","):[],p.trim);return this._isStream||this.userIsAdmin||this._collection||-1!==h.indexOf(a,"query")||-1!==h.indexOf(a,"catalog")},setResolution:function(a){return this.setMaxAllowableOffset(a)},setMaxAllowableOffset:function(a){this.isEditable()||(this._optMaxOffset=a,this._setMaxOffset(a,!0));return this},_resetMaxAllowableOffset:function(){this.setMaxAllowableOffset(this._optMaxOffset);this._prevScale=null;
this._refreshMaxAllowableOffset()},_refreshMaxAllowableOffset:function(){this._calcMaxOffsetForAutoSnapshot();this._updateMaxOffset();this._needsRefresh=!1},getResolution:function(){return this.getMaxAllowableOffset()},getMaxAllowableOffset:function(){var a=this._quantizationParameters?this._quantizationParameters.tolerance:void 0;return null!=this._maxOffset?this._maxOffset:a},_setMaxOffset:function(a,b){if(null==a)return delete this._maxOffset,delete this._quantizationParameters,this;this.quantize&&
this.supportsCoordinatesQuantization?("esriGeometryPolyline"===this.geometryType?this._maxOffset=a:delete this._maxOffset,this._quantizationParameters=a?{mode:"view",originPosition:"upperLeft",tolerance:a,extent:this.fullExtent}:null):(this._isFractionalOffsetAllowed()&&b||(a=Math.floor(a)),isNaN(a)||0===a?delete this._maxOffset:this._maxOffset=a,delete this._quantizationParameters);return this},_isFractionalOffsetAllowed:function(){return null==this.version||10.1<=this.version||navigator.languages&&
this._isLangWithDot(navigator.languages[0])},_isLangWithDot:function(a){a=(a=a&&a.split("-"))&&a[0]&&a[0].toLowerCase();return-1!==h.indexOf(this._langsWithDot,a)},_langsWithDot:"ar en et fr he ja ko th vi zh".split(" "),setAutoGeneralize:function(a){this.loaded?this._canAutoGeneralize()&&((this._autoGeneralize=a)?(this._isAutoSnapshotMode()&&(this._prevScale=null),this._updateMaxOffset()):this._setMaxOffset(null)):this._optAutoGen=a;return this},_canAutoGeneralize:function(){return!this.isEditable()&&
this.mode!==l.MODE_SNAPSHOT},setGDBVersion:function(a){this._collection||a===this.gdbVersion||!a&&!this.gdbVersion||(this.gdbVersion=a,this._task.gdbVersion=a,this._url.query=p.mixin(this._url.query,{gdbVersion:a}),this.loaded&&(this.clearSelection(),this._map&&this.refresh()),this.onGDBVersionChange());return this},hasAllFeatures:function(){return this._mode?this._mode.hasAllFeatures():!0},hasUpdateError:function(){return this._mode?this._mode.hasUpdateError():!1},setDefinitionExpression:function(a){this._defnExpr=
a;this._hasPendingLimitQuery()||((a=this._checkFeatureLimit())?this._evalModeAndApplyDefnExpr(a):this._applyDefnExpr());return this},_applyDefnExpr:function(){var a=this._mode;a&&a.propertyChangeHandler(1)},_evalModeAndApplyDefnExpr:function(a){a.then(p.hitch(this,function(a){a&&(a instanceof Error||!a.modeChanged)&&this._applyDefnExpr()}))},getDefinitionExpression:function(){return this._defnExpr},setTimeDefinition:function(a){this._isSnapshotMode()?(this._timeDefn=a,(a=this._mode)&&a.propertyChangeHandler(2)):
console.log("FeatureLayer.setTimeDefinition: layer in on-demand or selection mode does not support time definitions. Layer id \x3d "+this.id+", Layer URL \x3d "+this.url);return this},getTimeDefinition:function(){return this._timeDefn},setTimeOffset:function(a,b){this._timeOffset=a;this._timeOffsetUnits=b;(a=this._mode)&&a.propertyChangeHandler(0);return this},setUseMapTime:function(a){this.useMapTime=a;this._toggleTime(!this.suspended);(a=this._mode)&&a.propertyChangeHandler(0)},selectFeatures:function(a,
b,c,d){b=b||l.SELECTION_NEW;this._hasSelectionError=this._hasPartialSelectedFeatures=!1;a=this._getShallowClone(a);var e=this._map,f,m=this,g=y._fixDfd(new w(y._dfdCanceller));a.outFields=this.getOutFields();a.returnGeometry=!0;a.multipatchOption=this.multipatchOption;e&&(a.outSpatialReference=new K(e.spatialReference.toJson()));if(!this._applyQueryFilters(a,!0))return f={features:[]},this._selectHandler(f,b,c,d,g),g;if(e=this._canDoClientSideQuery(a))g._pendingDfd=O(this._doQuery(a,e)),g._pendingDfd.then(function(a){f=
{features:a};m._selectHandler(f,b,c,d,g)});else{if(this._collection)return this._resolve([Error("FeatureLayer::selectFeatures - "+this.invalidParams)],null,d,g,!0),g;if(this.loaded&&!this.isQueryable())return this._resolve([Error("Layer does not support query capability.")],null,d,g,!0),g;var h=this;this._ts&&(a._ts=(new Date).getTime());e=this._canFetchPBFForQuery(a);this._enableEditModeQuantization(a,e);(g._pendingDfd=this._task.execute(a,null,null,e?{format:"pbf"}:null)).addCallbacks(function(a){h._selectHandler(a,
b,c,d,g)},function(a){h._hasPartialSelectedFeatures=!0;h._hasSelectionError=!0;h._resolve([a],null,d,g,!0)})}return g},getSelectedFeatures:function(){var a=this._selectedFeatures,b=[],c;for(c in a)a.hasOwnProperty(c)&&b.push(a[c]);return b},clearSelection:function(a){var b=this._selectedFeatures,c=this._mode,d;for(d in b)b.hasOwnProperty(d)&&(this._unSelectFeatureIIf(d,c),c._removeFeatureIIf(d));this._selectedFeatures={};this._isSelOnly&&c._applyTimeFilter(!0);if(!a)this.onSelectionClear();return this},
setSelectionSymbol:function(a){if(this._selectionSymbol=a){var b=this._selectedFeatures,c;for(c in b)b.hasOwnProperty(c)&&b[c].setSymbol(a)}return this},getSelectionSymbol:function(){return this._selectionSymbol},setLabelingInfo:function(a){a?(this.labelingInfo=a,this._fixLabelExpr()):delete this.labelingInfo;this._collection&&(this._typesDirty=!0);this._evalSurfaceType();this.onLabelingInfoChange()},_fixLabelExpr:function(){var a=/\[([^\[\]]+)\]/ig,b,c=this,d=function(a,b){a=c._getField(b,!0);return"["+
(a&&a.name||b)+"]"};h.forEach(this.labelingInfo,function(c){if(b=c.labelExpression)c.labelExpression=b.replace(a,d)})},_updateRequiredFieldsFromLabelingInfo:function(){var a=[];h.forEach(this.labelingInfo,function(b){var c=b.labelExpressionInfo;if(b.labelExpression){var d=/[\[\]]/ig;b=b.labelExpression.match(/\[[^\[\]]+\]/ig);(b=h.map(b,function(a){return a.replace(d,"")}))&&(a=a.concat(b))}if(c){if(c.value){var e=/[\{\}]/ig;b=c.value.match(/\{[^\{\}]+\}/ig);(b=h.map(b,function(a){return a.replace(e,
"")}))&&(a=a.concat(b))}c.expression&&(a=a.concat(S.extractFieldNames(c.expression)))}});a=h.map(a,function(a){var b=this.getField(a);return b?b.name:a},this);this._requiredFields&&(this._requiredFields=this._requiredFields.concat(a))},__msigns:[{n:"applyEdits",c:5,a:[{i:0},{i:1}],e:4,f:1}],applyEdits:function(a,b,c,d,e,f){var m=f.assembly,g=f.dfd;this._applyNormalized(a,m&&m[0]);this._applyNormalized(b,m&&m[1]);this.onBeforeApplyEdits(a,b,c);var q={},k=this.objectIdField,m={f:"json"},n=!1;if(this._collection)f=
{},f.addResults=a?h.map(a,function(){n=!0;return{objectId:this._nextId++,success:!0}},this):null,f.updateResults=b?h.map(b,function(a){n=!0;var b=a.attributes[k];q[b]=a;return{objectId:b,success:!0}},this):null,f.deleteResults=c?h.map(c,function(a){n=!0;return{objectId:a.attributes[k],success:!0}},this):null,n?this._editHandler(f,a,q,d,e,g):this._resolve([f.addResults,f.updateResults,f.deleteResults],null,d,g);else{a&&0<a.length&&(m.adds=this._convertFeaturesToJson(a,0,1),n=!0);if(b&&0<b.length){for(f=
0;f<b.length;f++){var l=b[f];q[l.attributes[k]]=l}m.updates=this._convertFeaturesToJson(b,0,0,1);n=!0}if(c&&0<c.length){b=[];for(f=0;f<c.length;f++)b.push(c[f].attributes[k]);m.deletes=b.join(",");n=!0}if(n){var u=this;return z({url:this._url.path+"/applyEdits",content:p.mixin(m,this._url.query),callbackParamName:"callback",load:function(b){u._editHandler(b,a,q,d,e,g)},error:function(a){u._resolve([a],null,e,g,!0)}},{usePost:!0})}this._resolve([],null,d,g)}},queryFeatures:function(a,b,c,d){return this._query("execute",
"onQueryFeaturesComplete",a,b,c,d)},queryRelatedFeatures:function(a,b,c){return this._query("executeRelationshipQuery","onQueryRelatedFeaturesComplete",a,b,c)},queryIds:function(a,b,c,d){return this._query("executeForIds","onQueryIdsComplete",a,b,c,d)},queryCount:function(a,b,c,d){return this._query("executeForCount","onQueryCountComplete",a,b,c,d)},queryExtent:function(a,b,c,d){return this._query("executeForExtent","onQueryExtentComplete",a,b,c,d)},queryAttachmentInfos:function(a,b,c){var d=this._url.path+
"/"+a+"/attachments",e=new w(y._dfdCanceller),f=this,d=da.normalize(d);e._pendingDfd=z({url:d,content:p.mixin({f:"json"},this._url.query),callbackParamName:"callback",load:function(c){c=c.attachmentInfos;var g;h.forEach(c,function(b){g=Z.objectToQuery({gdbVersion:f._url.query&&f._url.query.gdbVersion,layer:f._url.query&&f._url.query.layer,token:f._getToken()});b.url=d+"/"+b.id+(g?"?"+g:"");b.objectId=a});f._resolve([c],"onQueryAttachmentInfosComplete",b,e)},error:function(a){f._resolve([a],null,c,
e,!0)}});return e},addAttachment:function(a,b,c,d){return this._sendAttachment("add",a,b,c,d)},updateAttachment:function(a,b,c,d,e){c.appendChild(aa.create("input",{type:"hidden",name:"attachmentId",value:b}));return this._sendAttachment("update",a,c,d,e)},deleteAttachments:function(a,b,c,d){var e=this._url.path+"/"+a+"/deleteAttachments",f=new w(y._dfdCanceller),m=this;b={f:"json",attachmentIds:b.join(",")};f._pendingDfd=z({url:e,content:p.mixin(b,this._url.query),callbackParamName:"callback",load:p.hitch(this,
function(b){b=b.deleteAttachmentResults;b=h.map(b,function(b){b=new E(b);b.attachmentId=b.objectId;b.objectId=a;return b});m._resolve([b],"onDeleteAttachmentsComplete",c,f)}),error:function(a){m._resolve([a],null,d,f,!0)}},{usePost:!0});return f},addType:function(a){var b=this.types;if(b){if(h.some(b,function(b){return b.id==a.id?!0:!1}))return!1;b.push(a)}else this.types=[a];return this._typesDirty=!0},deleteType:function(a){if(this._collection){var b=this.types;if(b){var c=-1;h.some(b,function(b,
e){return b.id==a?(c=e,!0):!1});if(-1<c)return this._typesDirty=!0,b.splice(c,1)[0]}}},toJson:function(){var a=this._json;if(a=p.isString(a)?F.fromJson(a):p.clone(a)){var a=a.layerDefinition?a:{layerDefinition:a},b=a.layerDefinition,c=this._collection;if(c&&this._typesDirty){b.types=h.map(this.types||[],function(a){return a.toJson()});var d=this.renderer,e=this.labelingInfo,f=b.drawingInfo;!d&&!e||f||(f=b.drawingInfo={});f&&d&&-1===d.declaredClass.indexOf("TemporalRenderer")&&(f.renderer=d.toJson());
e&&(f.labelingInfo=h.map(e,function(a){return a.toJson()}))}d=null;if(!c||this._fcAdded)d={geometryType:b.geometryType,features:this._convertFeaturesToJson(this.graphics,!0)};a.featureSet=p.mixin({},a.featureSet||{},d);a.featureSet.transform&&(e=a.featureSet.transform,delete a.featureSet.transform,d=new H(a.featureSet),d.quantize(e),a.featureSet=d.toJson());c&&(a.nextObjectId=this._nextId,b.capabilities=this.capabilities);return a}},onSelectionComplete:function(){},onSelectionClear:function(){},onBeforeApplyEdits:function(){},
onEditsComplete:function(){},onQueryFeaturesComplete:function(){},onQueryRelatedFeaturesComplete:function(){},onQueryIdsComplete:function(){},onQueryCountComplete:function(){},onQueryExtentComplete:function(){},onQueryAttachmentInfosComplete:function(){},onAddAttachmentComplete:function(){},onUpdateAttachmentComplete:function(){},onDeleteAttachmentsComplete:function(){},onCapabilitiesChange:function(){},onGDBVersionChange:function(){},onQueryLimitExceeded:function(){},onLabelingInfoChange:function(){},
onFeatureReductionRendererChange:function(){},onFeatureReductionChange:function(){},_evalArcadeSupport:function(){var a=new w;setTimeout(p.hitch(this,function(){this._initializeArcadeEngine().always(function(){a.resolve()})}),0);return a.promise},_initializeArcadeEngine:function(){var a=[],b=this.infoTemplate;b&&b.initializeArcadeEngine&&a.push(b.initializeArcadeEngine());(b=this.renderer)&&b.initializeArcadeEngine&&a.push(b.initializeArcadeEngine());var c=[];h.forEach(this.labelingInfo,function(a){(a=
a.labelExpressionInfo)&&a.expression&&c.push(a.expression)});a.push(ja.initialize(c));return P(a)},_isGeometryOperationsUsed:function(){var a=this.infoTemplate,b=this.renderer,c=this.labelingInfo;return a&&a.hasGeometryOperations&&a.hasGeometryOperations()||b&&b.hasGeometryOperations&&b.hasGeometryOperations()||h.some(c,function(a){return S.hasGeometryOperations(a.labelExpressionInfo&&a.labelExpressionInfo.expression)})?!0:!1},_forceIdentity:function(){var a=new w,b=this,c,d=this._url&&this._url.path;
c=d&&d.toLowerCase().indexOf("/rest/services");var e=this.editFieldsInfo,e=e&&(e.creatorField||e.editorField);(this.userIsAdmin||e)&&!this._getToken()&&-1<c&&G.id?(c=d.substring(0,c)+"/rest/info",z({url:c,content:{f:"json"},handleAs:"json",callbackParamName:"callback"}).then(function(a){if(a.owningSystemUrl)return G.id.checkSignInStatus(a.owningSystemUrl+"/sharing")}).then(function(a){if(a)return G.id.getCredential(d)}).then(function(a){a&&b._findCredential()}).always(function(){a.resolve()})):a.resolve();
return a.promise},_isSnapshotMode:function(){return this._mode?this._mode.isInstanceOf(I):!1},_isOnDemandMode:function(){return this._mode?this._mode.isInstanceOf(M):!1},_isAutoSnapshotMode:function(){return this._isAutoModeEnabled()&&this.currentMode===l.MODE_SNAPSHOT},_getMaxFeaturesForAutoSnapshotMode:function(){var a=this.geometryType,b;"esriGeometryPolyline"===a||"esriGeometryPolygon"===a||"esriGeometryMultipoint"===a||this.hasXYFootprint()?b=this.maxRecordCountForAuto:"esriGeometryPoint"===
a&&(b=this.maxPointCountForAuto);return b},getLastExceedsLimitResult:function(){return this._lastExceedsLimitResult},_canUseSnapshotMode:function(a){this._lastExceedsLimitResult=a=(a=a&&a.features&&a.features[0])&&a.attributes&&a.attributes.exceedslimit;return!(this.mode!==l.MODE_AUTO||this.isEditable()||0!==a||!(this._isPaginationAllowed()||this.maxRecordCount>=this._getMaxFeaturesForAutoSnapshotMode()))},_evalModeFromFLimit:function(a){this._canUseSnapshotMode(a)?this._enableAutoSnapshotMode():
this._enableAutoOnDemandMode()},_enableAutoSnapshotMode:function(){var a=l.MODE_SNAPSHOT;this.isFeatureReductionApplied()?this._updatePreFReductionState(a):this._preSurfaceChangeState?(this._updatePreSurfaceChangeState(a),this._evalSurfaceType(!0)):this.currentMode!==a&&this._setFetchMode(l.MODE_AUTO,a)},_enableAutoOnDemandMode:function(){var a=l.MODE_ONDEMAND;this.isFeatureReductionApplied()?this._updatePreFReductionState(a):this._preSurfaceChangeState?this._updatePreSurfaceChangeState(a):this.currentMode!==
a&&(this._setFetchMode(l.MODE_AUTO,a),this._evalSurfaceType())},_evalModeFromFReduction:function(a){this.loaded&&(a&&this.isFeatureReductionEnabled()&&this._canCluster(a)?this._enableFReductionMode():this._disableFReductionMode())},_enableFReductionMode:function(){this._evalSurfaceType(!0);if(!this._preFReductionState){var a=this.currentMode;a!==l.MODE_SNAPSHOT&&a!==l.MODE_STREAM&&a!==l.MODE_SELECTION&&(this._preFReductionState={mode:this.mode,currentMode:this.currentMode},this._setFetchMode(this.mode===
l.MODE_AUTO?l.MODE_AUTO:l.MODE_SNAPSHOT,l.MODE_SNAPSHOT))}},_disableFReductionMode:function(){var a=this._preFReductionState;this._preFReductionState=null;!a||a.mode===this.mode&&a.currentMode===this.currentMode||(this._setFetchMode(a.mode,a.currentMode),this._evalSurfaceType())},_updatePreFReductionState:function(a){this._preFReductionState=this._preFReductionState||{};this._preFReductionState.mode=l.MODE_AUTO;this._preFReductionState.currentMode=a},_evalModeFromSurface:function(){this.hasWebGLSurface()?
this._enableWebGLSurfaceMode():this._disableWebGLSurfaceMode()},_enableWebGLSurfaceMode:function(){this._preSurfaceChangeState||(this._preSurfaceChangeState={mode:this.mode,currentMode:this.currentMode},this._setFetchMode(this.mode===l.MODE_AUTO?l.MODE_AUTO:l.MODE_ONDEMAND,l.MODE_ONDEMAND,this.webglDeps.OnDemandDrillMode))},_disableWebGLSurfaceMode:function(){var a=this._preSurfaceChangeState;a&&(this._preSurfaceChangeState=null,this._setFetchMode(a.mode,a.currentMode))},_updatePreSurfaceChangeState:function(a){this._preSurfaceChangeState=
this._preSurfaceChangeState||{};this._preSurfaceChangeState.mode=l.MODE_AUTO;this._preSurfaceChangeState.currentMode=a},_setFetchMode:function(a,b,c){this.clearSelection();this._mode.suspend();this._mode.destroy();this.mode=a;this.currentMode=b;c=c||this._getModeConstructor(b);this._mode=new c(this);this.queryPagination=b===l.MODE_ONDEMAND&&-1===c.prototype.declaredClass.toLowerCase().indexOf("ondemanddrillmode")?!1:this._isPaginationAllowed();(a=this.getMap())&&a.loaded&&(this._resetMaxAllowableOffset(),
this._mode.initialize(a),this._mode.startup())},_isPaginationAllowed:function(){return!(!this._optQueryPagination||this.loaded&&!this.advancedQueryCapabilities.supportsPagination)},_getModeConstructor:function(a){var b;a===l.MODE_SNAPSHOT?b=I:a===l.MODE_ONDEMAND&&(b=M);return b},_hasOnDemandDrillMode:function(){var a=this._mode,a=a&&a.declaredClass;return!!(a&&-1<a.toLowerCase().indexOf("ondemanddrillmode"))},_checkFeatureLimit:function(){this._limitPromise&&(this._limitPromise.cancel(),this._limitPromise=
null);var a=this._queryLimit();a&&(this._lastExceedsLimitResult=null,this._limitPromise=a.then(p.hitch(this,function(a){var b=this.currentMode;this._evalModeFromFLimit(a);return{modeChanged:this.currentMode!==b}})).always(p.hitch(this,function(a){this._limitPromise=null;return a})));return this._limitPromise},_hasPendingLimitQuery:function(){return!!this._exceedsLimitTimer},_queryLimit:function(){if(this._isAutoModeEnabled()){var a,b,c=new w(function(){clearTimeout(a);a=null;b&&!b.isFulfilled()&&
b.cancel();b=null});this._exceedsLimitTimer=a=setTimeout(p.hitch(this,function(){this._exceedsLimitTimer=null;var a=new L,e=new la;e.statisticType="exceedslimit";e.maxPointCount=this.maxPointCountForAuto;e.maxRecordCount=this.maxRecordCountForAuto;e.maxVertexCount=this.maxVertexCountForAuto;e.outStatisticFieldName="exceedslimit";a.outStatistics=[e];b=this.queryFeatures(a).promise.then(function(a){c.resolve(a)}).otherwise(function(a){c.reject(a)})}),0);return c.promise}},_isAutoModeEnabled:function(){return this.mode===
l.MODE_AUTO&&this.reHostedFS.test(this.url)},_updateCaps:function(){var a=this._editable,b=p.trim(this.capabilities||""),c=h.map(b?b.split(","):[],p.trim),d=h.map(b?b.toLowerCase().split(","):[],p.trim),b=h.indexOf(d,"editing"),e,d={Create:h.indexOf(d,"create"),Update:h.indexOf(d,"update"),Delete:h.indexOf(d,"delete")};if(a&&-1===b)c.push("Editing");else if(!a&&-1<b){a=[b];for(e in d)-1<d[e]&&a.push(d[e]);a.sort();for(e=a.length-1;0<=e;e--)c.splice(a[e],1)}this.capabilities=c.join(",")},_counter:{value:0},
_getUniqueId:function(){return this._counter.value++},onSuspend:function(){this.inherited(arguments);this._toggleTime(!1);var a=this._mode;a&&a.suspend()},onResume:function(a){this.inherited(arguments);this._toggleTime(!0);var b=this._map,c=this._getRenderer();if(a.firstOccurrence){if(this._fixRendererFields(),this._updateRequiredFieldsFromLabelingInfo(),this._checkFields(),this.clearSelection(),this._evalFeatureReduction(),this.timeInfo&&!this._trackManager&&(this._trackIdField||c&&(c.latestObservationRenderer||
c.trackRenderer))&&(this._trackManager=new U(this),this._trackManager.initialize(b),this._childLayer=this._trackManager.container),c&&"colors"in c&&"blurRadius"in c&&"maxPixelIntensity"in c&&"esriGeometryPoint"==this.geometryType&&!this._heatmapManager&&(this._heatmapManager=new V(this),this._heatmapManager.initialize(b)),this._zoomConnect=B.connect(b,"onZoomEnd",this,this._zoomEndHandler),this._refreshMaxAllowableOffset(),c=this._mode)c._init||c.initialize(b),c.startup()}else this._zoomEndHandler(),
this._mode&&this._mode.resume()},_zoomEndHandler:function(){var a=this._map;this._updateMaxOffset();this._prevScale=a.getScale();!this.suspended&&this._needsRefresh&&this.refresh()},_updateMaxOffset:function(){var a=this._map;a&&a.loaded&&this._autoGeneralize&&(this._isAutoSnapshotMode()?(a=this.getMaxAllowableOffset(),this._setMaxOffset(this._getMaxOffsetForScale(),!0),this._needsRefresh||(this._needsRefresh=a!=this.getMaxAllowableOffset())):this._setMaxOffset(a.extent.getWidth()/a.width,!a.extent.spatialReference.isWebMercator()))},
_getMaxOffsetForScale:function(){if(this._map){var a=this._map.getScale(),b=this._calculatedScale,c=this._calcMaxOffset,d=this._prevScale;return a>=b&&(null==d||d<b)?c:a<b&&(null==d||d>=b)?null:this.getMaxAllowableOffset()}},_calcMaxOffsetForAutoSnapshot:function(){var a=this._map;if(a&&this._canAutoGeneralize()&&this._isAutoSnapshotMode()&&this._autoGeneralize&&null==this.getMaxAllowableOffset()){var b=this.generalizeForScale;this._calculatedScale=b=this.maxScale?this.maxScale:this.minScale?Math.min(b,
this.minScale):Math.min(b,oa.getScale(a,this.initialExtent));this._calcMaxOffset=a.extent.getWidth()/a.width/a.getScale()*b}else this._calculatedScale=this._calcMaxOffset=void 0},_toggleTime:function(a){var b=this._map;a&&this.timeInfo&&this.useMapTime&&b?(this._mapTimeExtent=b.timeExtent,this._timeConnect||(this._timeConnect=B.connect(b,"onTimeExtentChange",this,this._timeChangeHandler))):(this._mapTimeExtent=null,B.disconnect(this._timeConnect),this._timeConnect=null)},_timeChangeHandler:function(a){this._mapTimeExtent=
a;(a=this._mode)&&a.propertyChangeHandler(0)},_getOffsettedTE:function(a){var b=this._timeOffset,c=this._timeOffsetUnits;return a&&b&&c?a.offset(-1*b,c):a},_getTimeOverlap:function(a,b){return a&&b?a.intersection(b):a||b},_getTimeFilter:function(a){var b=this.getTimeDefinition(),c;if(b&&(c=this._getTimeOverlap(b,null),!c))return[!1];if(a){if(a=c?this._getTimeOverlap(a,c):a,!a)return[!1]}else a=c;return[!0,a]},_getAttributeFilter:function(a){var b=this.getDefinitionExpression();return a?b?"("+b+") AND ("+
a+")":a:b},_applyQueryFilters:function(a,b){a.where=this._getAttributeFilter(a.where);a.returnGeometry&&null==a.maxAllowableOffset&&!a.quantizationParameters&&(a.maxAllowableOffset=this._maxOffset,a.quantizationParameters=this._quantizationParameters);b&&this.supportsAdvancedQueries&&(a.orderByFields=a.orderByFields||this.getOrderByFields());if(this.timeInfo)if(b=this._getTimeFilter(a.timeExtent),b[0])a.timeExtent=b[1];else return!1;return!0},_add:function(a){var b=this._selectionSymbol,c=a.attributes,
d=this.visibilityField;b&&this._isSelOnly&&a.setSymbol(b);if(d&&c&&c.hasOwnProperty(d))a[c[d]?"show":"hide"]();return this.add.apply(this,arguments)},_remove:function(){return this.remove.apply(this,arguments)},_canDoClientSideQuery:function(a,b){var c=[],d=this._map,e;if((this._collection||!this._isTable&&d)&&!(a.text||a.where&&a.where!==this.getDefinitionExpression()||a.orderByFields&&a.orderByFields.length&&(e=this.getOrderByFields()||[])&&a.orderByFields.join()!==e.join()||a.outStatistics||a.returnDistinctValues)){e=
this._isSnapshotMode();var f=this._isSelOnly;b=e?null:b?this._getExtentOfTiles(d.extent):d.extent;if(d=a.geometry){if(f||a.spatialRelationship!==L.SPATIAL_REL_INTERSECTS||"extent"!==d.type||!e&&!b.contains(d))return;c.push(1)}if(b=a.objectIds)if(e)c.push(2);else{var d=b.length,m=this._mode,g=0,q;for(q=0;q<d;q++)m._getFeature(b[q])&&g++;if(g===d)c.push(2);else return}if(this.timeInfo)if(a=a.timeExtent,b=this._mapTimeExtent,e)a&&c.push(3);else if(f){if(a)return}else if(b)if(-1!==h.indexOf(c,2))a&&c.push(3);
else if(-1!==h.indexOf(c,1))a==b&&c.push(3);else return;else if(0<c.length)a&&c.push(3);else if(a)return;return 0<c.length?c:null}},_getAbsMid:function(a){return N.toAbsMid?N.toAbsMid(a):W.id.replace(/\/[^\/]*$/ig,"/")+a},_doQuery:function(a,b,c){var d=[],e=this.objectIdField,f=this,m=new w,g=new w,q=this.graphics;if(-1!==h.indexOf(b,1)){var k=this.spatialIndex||this._map&&this._map.spatialIndex,n,l=a.geometry._normalize(null,!0);null==k&&Ba.autoSpatialIndexing?n=(this._map||this).addPlugin(this._getAbsMid("../plugins/spatialIndex")).then(p.hitch(this,
p.partial(this._getFromIndex,l,k)),function(a){g.resolve(p.hitch(this,p.partial(this._filterByExtent,q,l)))}):k&&(n=this._getFromIndex(l,k));n?n.then(function(a){for(var b=0;b<a.length;b++)a[b].results&&(d=d.concat(a[b].results));g.resolve(d)}).otherwise(function(a){g.reject(a)}):g.resolve(this._filterByExtent(q,l))}else g.resolve(q);g.then(function(g){d=g;if(-1!==h.indexOf(b,2)){var k=a.objectIds;d=h.filter(d,function(a){return-1<h.indexOf(k,a.attributes[e])})}-1!==h.indexOf(b,3)&&f.timeInfo&&(g=
a.timeExtent,d=f._filterByTime(d,g.startTime,g.endTime).match);c&&(d=h.map(d,function(a){return a.attributes[e]},this));m.resolve(d)});return m},_getFromIndex:function(a,b){b=b||this.spatialIndex||this._map.spatialIndex;a instanceof Array||(a=[a]);var c=this.id;return ba(h.map(a,function(a){return b.intersects(a,c)}))},_filterByExtent:function(a,b){for(var c=[],d=0,e=a.length;d<e;d++){var f=a[d],m=f.geometry;m&&(this.normalization&&b.length?(b[0].intersects(m)||b[1].intersects(m))&&c.push(f):b.intersects(m)&&
c.push(f))}return c},_filterByTime:function(a,b,c){var d=this._startTimeField,e=this._endTimeField,f;this._twoTimeFields||(f=d||e);var m=r.isDefined,g=[],h=[],k,n=a.length,l,p;b=b?b.getTime():-Infinity;c=c?c.getTime():Infinity;if(f)for(k=0;k<n;k++)l=a[k],p=l.attributes,d=p[f],d>=b&&d<=c?g.push(l):h.push(l);else for(k=0;k<n;k++)l=a[k],p=l.attributes,f=p[d],p=p[e],f=m(f)?f:-Infinity,p=m(p)?p:Infinity,f>=b&&f<=c||p>=b&&p<=c||b>=f&&c<=p?g.push(l):h.push(l);return{match:g,noMatch:h}},_getSizeVariables:function(a){return a&&
h.filter(a.getVisualVariablesForType("sizeInfo",!1),function(a){return!(!a.field&&!a.valueExpression)})},_needClientSideSorting:function(a){return this._collection?!(!a||!a.length):h.some(a,function(a){return!!a.valueExpression})},_sortFeatures:function(a){var b=this.renderer,c=this._getSizeVariables(b);if(a&&1<a.length&&this._needClientSideSorting(c)){var d=c[0],e=this;a.sort(function(a,c){a._layer||(a._layer=e);c._layer||(c._layer=e);a=b._getDataValue(a,d,"sizeInfo");c=b._getDataValue(c,d,"sizeInfo");
return null==a?-1:null==c?1:c-a})}return a},_resolve:function(a,b,c,d,e){b&&this[b].apply(this,a);c&&c.apply(null,a);d&&y._resDfd(d,a,e)},_getShallowClone:function(a){var b=new L,c;for(c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b},_canFetchPBF:function(){return!!(Ca&&Da&&this.supportsFormatPBF)},_canFetchPBFForQuery:function(a){return!(!this._canFetchPBF()||!this._isCacheHintEnabled(a)&&this._isAutoSnapshotMode()||!(a.quantizationParameters||!this.isEditable()&&this.supportsQuantizationEditMode)||
a.outStatistics)},_enableEditModeQuantization:function(a,b){a&&b&&!a.quantizationParameters&&(a.quantizationParameters={mode:"edit"})},_enableCacheHint:function(a,b){var c=this.advancedQueryCapabilities;c&&c.supportsQueryWithCacheHint?null==a.cacheHint&&(a.cacheHint=!0):c&&c.supportsQueryWithResultType&&this.reHostedFS.test(this.url)&&!a.resultType&&(a.resultType=b||"coherent")},_isCacheHintSupported:function(){var a=this.advancedQueryCapabilities;return a?!!(a.supportsQueryWithCacheHint||a.supportsQueryWithResultType&&
this.reHostedFS.test(this.url)):!1},_isCacheHintEnabled:function(a){var b=this.advancedQueryCapabilities;return a&&b?!!(b.supportsQueryWithCacheHint&&a.cacheHint||b.supportsQueryWithResultType&&this.reHostedFS.test(this.url)&&("coherent"===a.resultType||"tile"===a.resultType)):!1},_query:function(a,b,c,d,e,f){var m=this,g=this._map;f=f&&f.snapToTiles;var l=new w(y._dfdCanceller),k=c,n,p,u;if("executeRelationshipQuery"!==a){var k=this._getShallowClone(c),r=this.getOutFields();k.outFields||(k.outFields=
r);k.outFields&&k.outFields.length&&(p=-1<h.indexOf(r,"*")?!1:!h.every(k.outFields,function(a){return-1<h.indexOf(r,a)}));k.returnGeometry=c.hasOwnProperty("returnGeometry")?c.returnGeometry:!c.outStatistics;k.returnGeometry&&(k.multipatchOption=this.multipatchOption,null!=k.maxAllowableOffset||k.quantizationParameters)&&(c=null!=k.maxAllowableOffset?k.maxAllowableOffset:k.quantizationParameters.tolerance,null!=c&&c!==this.getMaxAllowableOffset()&&(u=!0));var v;g&&(g=g&&g.spatialReference,(c=k.outSpatialReference)?
n=!c.equals(g):k.outSpatialReference=new K(g.toJson()));f&&(g=k.geometry)&&"extent"===g.type&&(k.geometry=this._getExtentOfTiles(g),g!==k.geometry&&this._enableCacheHint(k));if(!this._applyQueryFilters(k,"execute"===a&&!k.outStatistics)){switch(a){case "execute":v=new H({features:[]});break;case "executeForIds":v=[];break;case "executeForCount":v=0;break;case "executeForExtent":v={}}this._resolve([v],b,d,l);return l}if(f="executeForExtent"!==a&&!n&&!p&&!u&&this._canDoClientSideQuery(k,f))return l._pendingDfd=
O(this._doQuery(k,f,"executeForIds"===a||"executeForCount"===a)),l._pendingDfd.then(function(c){switch(a){case "execute":v=new H;v.features=c;break;case "executeForIds":v=c;break;case "executeForCount":v=c.length}m._resolve([v],b,d,l)}),l}if(this._collection)return this._resolve([Error("FeatureLayer::_query - "+this.invalidParams)],null,e,l,!0),l;if(this.loaded&&!this.isQueryable())return this._resolve([Error("Layer does not support query capability.")],null,e,l,!0),l;this._ts&&(k._ts=(new Date).getTime());
f="execute"===a&&this._canFetchPBFForQuery(k);this._enableEditModeQuantization(k,f);(l._pendingDfd=this._task[a](k,null,null,f?{format:"pbf"}:null)).addCallbacks(function(c){var e=!!k.outStatistics||n||p||u;if("execute"===a||"executeRelationshipQuery"===a){var f,g;if("execute"===a)for(f=c.features,g=f.length,--g;0<=g;g--){if(f[g]._layer=m,!e&&!m._isTable){var h=m._mode._getFeature(f[g].attributes[m.objectIdField]);h&&f.splice(g,1,h)}}else for(h in c)if(c.hasOwnProperty(h))for(f=c[h].features,g=f.length,
--g;0<=g;g--)f[g]._layer=m}m._resolve([c],b,d,l)},function(a){m._resolve([a],null,e,l,!0)});return l},_getExtentOfTiles:function(a){var b=this._isOnDemandMode()&&this._mode._gridLayer||ya.createFromFeatureLayer({layer:this}),c=this.getMap(),c=c&&c.getTargetExtent(a);return b&&c&&b.getExtentOfIntersectingCells(c)||a},_convertFeaturesToJson:function(a,b,c,d){var e=[],f=this._selectionSymbol,m=this.visibilityField,g,l=this.objectIdField;this.loaded&&(c||d)&&(g=h.filter(this.fields,function(a){return!1===
a.editable&&(!d||a.name!==l)}));for(c=0;c<a.length;c++){var k=a[c],n={},t=k.geometry,u=k.attributes,r=k.symbol;!t||d&&this.loaded&&!this.allowGeometryUpdates||(n.geometry=t.toJson());m?(n.attributes=u=p.mixin({},u),u[m]=k.visible?1:0):u&&(n.attributes=p.mixin({},u));n.attributes&&g&&g.length&&h.forEach(g,function(a){delete n.attributes[a.name]});r&&r!==f&&(n.symbol=r.toJson());e.push(n)}return b?e:F.toJson(e)},_selectHandler:function(a,b,c,d,e){var f;switch(b){case l.SELECTION_NEW:this.clearSelection(!0);
f=!0;break;case l.SELECTION_ADD:f=!0;break;case l.SELECTION_SUBTRACT:f=!1}d=a.features;var h=this._mode,g=[],p=this.objectIdField,k,n;if(f)for(f=0;f<d.length;f++)k=d[f],n=k.attributes[p],k=h._addFeatureIIf(n,k),g.push(k),this._selectFeatureIIf(n,k,h);else for(f=0;f<d.length;f++)k=d[f],n=k.attributes[p],this._unSelectFeatureIIf(n,h),n=h._removeFeatureIIf(n),g.push(n||k);this._isSelOnly&&h._applyTimeFilter(!0);this._isImageService&&10.7>this.version&&void 0===a.exceededTransferLimit&&(a.exceededTransferLimit=
d.length===this.maxRecordCount);this._hasPartialSelectedFeatures=!!a.exceededTransferLimit;this._resolve([g,b,a.exceededTransferLimit?{queryLimitExceeded:!0}:null],"onSelectionComplete",c,e);if(a.exceededTransferLimit)this.onQueryLimitExceeded()},_selectFeatureIIf:function(a,b,c){var d=this._selectedFeatures,e=d[a];e||(c._incRefCount(a),d[a]=b,this._isTable||(this._setSelectSymbol(b),b.attr("data-selected","")));return e||b},_unSelectFeatureIIf:function(a,b){var c=this._selectedFeatures[a];c&&(b._decRefCount(a),
delete this._selectedFeatures[a],this._isTable||(this._setUnSelectSymbol(c),c.attr("data-selected")));return c},_setSelectSymbol:function(a){var b=this._selectionSymbol;b&&!this._isSelOnly&&a.setSymbol(b)},_setUnSelectSymbol:function(a){var b=this._selectionSymbol;b&&!this._isSelOnly&&b===a.symbol&&a.setSymbol(null,!0)},_getOutFields:function(){var a=[this.objectIdField,this.typeIdField,this.creatorField,this._startTimeField,this._endTimeField,this._trackIdField].concat(this._requiredFields).concat(this.dataAttributes),
a=h.filter(a,function(a,b,e){return!!a&&h.indexOf(e,a)===b}),b=p.clone(this._outFields);if(b){if(-1!==h.indexOf(b,"*"))return b;h.forEach(a,function(a){-1===h.indexOf(b,a)&&b.push(a)});return b}return a},_checkFields:function(a){var b=a||this._getOutFields();h.forEach(b,function(a){"*"!==a&&(this._getField(a)||console.debug("esri.layers.FeatureLayer: "+r.substitute({url:this.url,field:a},"unable to find '${field}' field in the layer 'fields' information [url: ${url}]")))},this);a||this._isTable||
this._fserver||this._collection||this._isStream||h.some(this.fields,function(a){return a&&"esriFieldTypeGeometry"===a.type?!0:!1})||console.debug("esri.layers.FeatureLayer: "+r.substitute({url:this.url},"unable to find a field of type 'esriFieldTypeGeometry' in the layer 'fields' information. If you are using a map service layer, features will not have geometry [url: ${url}]"))},_fixFieldCase:function(a,b,c){var d=a&&a[b],e;if(d&&!p.isFunction(d)){if(e=!this._getField(d)&&this._getField(d,!0))d=a[b]=
e.name;c&&c.push(d)}return d},_fixRendererFields:function(){var a=this.renderer;this._orderBy=null;this._requiredFields=[];if(a&&0<this.fields.length){var b=[],c,a=h.filter([a,a.observationRenderer,a.latestObservationRenderer,a.trackRenderer],r.isDefined),d=[].concat(a);h.forEach(a,function(a){h.forEach(a.rendererInfos,function(a){a.renderer&&d.push(a.renderer)})});h.forEach(d,function(a){this._fixFieldCase(a,"attributeField",b);this._fixFieldCase(a,"attributeField2",b);this._fixFieldCase(a,"attributeField3",
b);this._fixFieldCase(a.rotationInfo,"field",b);(c=this._fixFieldCase(a.sizeInfo,"field",b))&&!this._orderBy&&(this._orderBy=[c+" DESC"]);this._fixFieldCase(a.sizeInfo,"normalizationField",b);this._fixFieldCase(a.colorInfo,"field",b);this._fixFieldCase(a.colorInfo,"normalizationField",b);this._fixFieldCase(a.field,"field",b);this._fixFieldCase(a.opacityInfo,"field",b);this._fixFieldCase(a.opacityInfo,"normalizationField",b);h.forEach(a.visualVariables,function(a){c=this._fixFieldCase(a,"field",b);
"sizeInfo"===a.type&&c&&!this._orderBy&&(this._orderBy=[c+" DESC"]);this._fixFieldCase(a,"normalizationField",b)},this);var d=h.map(a.getFieldsUsedInExpressions(),function(a){var b=this.getField(a);return b?b.name:a},this);b=b.concat(d);this._orderBy||!a.addBreak||p.isFunction(a.attributeField)||!a.backgroundFillSymbol&&!this._hasSizeDiff(a)||(this._orderBy=[a.attributeField+" DESC"])},this);this._requiredFields=h.filter(b,r.isDefined)}},_hasSizeDiff:function(a){var b=Number.MAX_VALUE,c=-Number.MAX_VALUE,
d,e;h.forEach(a.infos,function(a){if(e=a.symbol){d=0;switch(e.type){case "simplemarkersymbol":d=e.size;break;case "picturemarkersymbol":d=(e.width+e.height)/2;break;case "simplelinesymbol":case "cartographiclinesymbol":d=e.width;break;case "simplefillsymbol":case "picturefillsymbol":d=e.outline&&e.outline.width}d&&(b=Math.min(b,d),c=Math.max(c,d))}});return b!==Number.MAX_VALUE&&c!==-Number.MAX_VALUE&&1<Math.abs(c-b)},getOrderByFields:function(){var a=this.orderByFields||this._orderBy;return this.supportsAdvancedQueries&&
a?h.filter(a,function(a){a=a.split(" ")[0];return!!this._getField(a,!0)},this):null},_createFields:function(a){var b=a?a.length:0,c,d=[];for(c=0;c<b;c++)d.push(new qa(a[c]));this.fields=d},_createFieldsIndex:function(){if(this._fieldsIndexDirty){var a,b=this.fields,c=b?b.length:0;if(50<c&&this._canUseFieldsIndex()){a=new Map;for(var d=new Map,e=0;e<c;e++){var f=b[e];a.set(f.name,f);d.set(f.name.toLowerCase(),f)}a={caseSensitive:a,caseInsensitive:d}}this._fieldsIndex=a;this._fieldsIndexDirty=!1}},
_canUseFieldsIndex:function(){var a=J.Map;return!("function"!==typeof J.Proxy||"function"!==typeof J.Proxy.revocable||"function"!==typeof a||!a.prototype||"function"!==typeof a.prototype.set)},_getField:function(a,b){var c=this.fields;if(!c||0===c.length)return null;b&&(a=a.toLowerCase());this._createFieldsIndex();var d=this._fieldsIndex;if(d)return d=b?d.caseInsensitive:d.caseSensitive,d.get(a);var e;h.some(c,function(c){var d=!1;(d=b?c&&c.name.toLowerCase()===a?!0:!1:c&&c.name===a?!0:!1)&&(e=c);
return d});return e},_getDateOpts:function(){this._dtOpts||(this._dtOpts={properties:h.map(h.filter(this.fields,function(a){return!(!a||"esriFieldTypeDate"!==a.type)}),function(a){return a.name})});return this._dtOpts},_applyNormalized:function(a,b){a&&b&&h.forEach(a,function(a,d){a&&b[d]&&a.setGeometry(b[d])})},_editHandler:function(a,b,c,d,e,f){e=a.addResults;var m=a.updateResults;a=a.deleteResults;var g,q,k,n,t,r=this.objectIdField,w=this._mode,v=this._isTable;g=this.editFieldsInfo;n=this.getOutFields()||
[];var A=g&&g.creatorField,x=g&&g.creationDateField,C=g&&g.editorField,D=g&&g.editDateField;g=g&&g.realm;-1===h.indexOf(n,"*")&&(A&&-1===h.indexOf(n,A)&&(A=null),x&&-1===h.indexOf(n,x)&&(x=null),C&&-1===h.indexOf(n,C)&&(C=null),D&&-1===h.indexOf(n,D)&&(D=null));var z=x||D?(new Date).getTime():null,y=A||C?this.getUserId():void 0;y&&g&&(y=y+"@"+g);if(e){var B=this.globalIdField;for(g=0;g<e.length;g++)e[g]=new E(e[g]),v||(q=e[g],q.success&&(k=q.objectId,n=b[g],(t=n._graphicsLayer)&&t!==this&&t.remove(n),
t=n.attributes||{},t[r]=k,k=q.globalId,B&&k&&(t[B]=k),A&&(t[A]=y),C&&(t[C]=y),x&&(t[x]=z),D&&(t[D]=z),n.setAttributes(t),w._init&&w.drawFeature(n)))}if(m)for(g=0;g<m.length;g++)if(m[g]=new E(m[g]),!v&&(q=m[g],q.success)){k=q.objectId;n=c[k];if(b=w._getFeature(k))b.geometry!==n.geometry&&n.geometry&&b.setGeometry(ma.fromJson(n.geometry.toJson())),b.attributes!==n.attributes&&n.attributes&&b.setAttributes(p.mixin(b.attributes,n.attributes)),this._repaint(b,k);n=b||n;t=n.attributes||{};C&&(t[C]=y);D&&
(t[D]=z);n.setAttributes(t)}if(a){c=[];for(g=0;g<a.length;g++)if(a[g]=new E(a[g]),!v&&(q=a[g],q.success&&(k=q.objectId,n=w._getFeature(k))))this._unSelectFeatureIIf(k,w)&&c.push(n),n._count=0,w._removeFeatureIIf(k);if(0<c.length)this.onSelectionComplete(c,l.SELECTION_SUBTRACT)}this._resolve([e,m,a],"onEditsComplete",d,f)},_sendAttachment:function(a,b,c,d,e){var f=this;return z({url:this._url.path+"/"+b+"/"+("add"===a?"addAttachment":"updateAttachment"),form:c,content:p.mixin(this._url.query,{f:"json",
token:this._getToken()||void 0}),callbackParamName:"callback.html",handleAs:"json"}).addCallback(function(c){var e="add"===a?"onAddAttachmentComplete":"onUpdateAttachmentComplete";c=new E(c["add"===a?"addAttachmentResult":"updateAttachmentResult"]);c.attachmentId=c.objectId;c.objectId=b;f._resolve([c],e,d);return c}).addErrback(function(a){f._resolve([a],null,e,null,!0)})},_repaint:function(a,b,c){b=r.isDefined(b)?b:a.attributes[this.objectIdField];b in this._selectedFeatures&&this._selectionSymbol||
a.setSymbol(a.symbol,c)},_getKind:function(a){var b=this._trackManager;return b?b.isLatestObservation(a)?1:0:0}});p.mixin(l,{MODE_SNAPSHOT:0,MODE_ONDEMAND:1,MODE_SELECTION:2,SELECTION_NEW:3,SELECTION_ADD:4,SELECTION_SUBTRACT:5,MODE_AUTO:6,MODE_STREAM:7,POPUP_NONE:"esriServerHTMLPopupTypeNone",POPUP_HTML_TEXT:"esriServerHTMLPopupTypeAsHTMLText",POPUP_URL:"esriServerHTMLPopupTypeAsURL"});na._createWrappers(l);Object.defineProperty(l.prototype,"graphics",{get:function(){return this._hasOnDemandDrillMode()?
this._mode.graphics:this._graphicsVal},set:function(a){this._graphicsVal=a}});Object.defineProperty(l.prototype,"name",{get:function(){return this.arcgisProps&&this.arcgisProps.title?this.arcgisProps.title:this._name},set:function(a){this._name=a;this.loaded&&this.arcgisProps&&(this.arcgisProps.title=null)}});Object.defineProperty(l.prototype,"fields",{get:function(){return this._fields},set:function(a){a&&this._canUseFieldsIndex()&&(a=new Proxy(a,{set:p.hitch(this,function(a,c,d){if(c)if("length"===
c)this._fieldsIndexDirty=!0;else{var b=Number(c);"number"!==typeof b||isNaN(b)||(this._fieldsIndexDirty=!0)}a[c]=d;return!0})}));this._fields=a;this._fieldsIndexDirty=!0}});x("extend-esri")&&p.setObject("layers.FeatureLayer",l,G);return l});