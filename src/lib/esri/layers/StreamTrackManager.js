// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.
//>>built
define("esri/layers/StreamTrackManager","dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has ../kernel ../graphic ../geometry/Point ../geometry/Polyline ./TrackManager".split(" "),function(m,x,k,y,z,A,B,C,D){m=m([D],{declaredClass:"esri.layers._StreamTrackManager",constructor:function(a){this.inherited(arguments);var b=a.getMap().spatialReference;this.isWebMercator=b.isWebMercator();this.canWrap=b._isWrappable();this.wrapThreshold=this.isWebMercator?2.0037508342788905E7:180},initialize:function(a){this.inherited(arguments)},
addFeatures:function(a,b){function c(a,b){var c,f,e;g[a]||(g[a]=[]);a=g[a];0<h&&(b.length>h&&b.splice(0,b.length-h),f=b.length+a.length,f>h&&(c=a.splice(0,f-h)));f=b.length;for(e=0;e<f;e+=1)a.push(b[e]);return{deletes:c,adds:b}}var g,f,p,h,d={},e={},q;if(b)return this.inherited(arguments),d;g=this.trackMap;f=this.layer;p=f._trackIdField;h=f.maximumTrackPoints||0;k.forEach(a,function(a){var b=a.attributes[p];a.visible&&(e[b]||(e[b]=[]),e[b].push(a))});for(q in e)e.hasOwnProperty(q)&&(f=c(q,e[q]),d[q]=
f);return d},removeFeatures:function(a){var b=[],c=this.layer.objectIdField,g=this.layer._trackIdField;a&&(k.forEach(a,function(a){var f,h,d,e;h=a.attributes[g];f=a.attributes[c];if(d=this.trackMap[h])for(a=0;a<d.length;a+=1)if(e=d[a],e.attributes[c]===f){this.trackMap[h].splice(a,1);-1===k.indexOf(h)&&b.push(h);break}},this),0<a.length&&this.refreshTracks(b))},drawTracks:function(a){function b(a){var b=f[a],d=b&&1<b.length,e=c.trackLineMap[a];e&&!d&&(g.remove(e),delete c.trackLineMap[a],e=null);
if(!d)return!1;for(var k,d=[],n=[],l,m=b.length,u=0;u<m;u++)if(l=b[u].geometry){l=l.normalize();var r=l.x,v=0,w=!1;k&&c.canWrap&&(v=r-k.x,Math.abs(v)>c.wrapThreshold&&(w=!0));w?(n.push([c.getWrappedX(r),l.y]),d.push(n.slice(0)),n=[[r,l.y]]):n.push([r,l.y]);k=new B(r,l.y,p)}1<n.length&&d.push(n);b={};b[h]=a;if(d.length)if(e){for(var t=e.geometry;t.paths.length;)t.removePath(t.paths.length-1);d.forEach(function(a){t.addPath(a)});e.setGeometry(t)}else e=new A(new C({paths:d,spatialReference:p}),null,
b),g.add(e),c.trackLineMap[a]=e}var c=this,g=this.container,f,p,h,d;if(g)if(f=this.trackMap,p=this.map.spatialReference,h=this.layer._trackIdField,a)k.forEach(a,function(a){b(a)});else for(d in f)f.hasOwnProperty(d)&&b(d)},refreshTracks:function(a){function b(a){var b,d;a=c[a]||[];b=a.length;for(d=0;d<b;d++)g._repaint(a[d],null,!0)}var c=this.trackMap,g=this.layer,f;this.drawTracks(a);if(a)k.forEach(a,function(a){b(a)});else for(f in c)c.hasOwnProperty(f)&&b(f)},getLatestObservations:function(){var a,
b,c=this.trackMap,g=[];for(a in c)c.hasOwnProperty(a)&&(b=c[a],g.push(b[b.length-1]));return g},destroy:function(){this.inherited(arguments);this.trackLineMap=null},getWrappedX:function(a){var b=this.isWebMercator,c=b?2.0037508342788905E7:180,b=b?-2.0037508342788905E7:-180;return(0<a?b:c)-((0<a?c:b)-a)}});y("extend-esri")&&x.setObject("layers._StreamTrackManager",m,z);return m});