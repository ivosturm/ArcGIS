// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.
//>>built
define("esri/layers/rasterLib/raster/FunctionRaster","require dojo/_base/declare dojo/_base/lang dojo/_base/Deferred dojo/_base/array dojo/_base/config dojo/_base/json dojo/sniff ../DeferredList2 dojo/when ../../../kernel ../../../Evented ../../../request ../../../deferredUtils ../../../geometry/Extent ../../../geometry/Point ../../../SpatialReference ../../../deferredUtils ../../../urlUtils ../../rasterFormats/rasterCodec ./RasterInfo ./BasicRaster ../../rasterLib/function/rasterFunctionHelper".split(" "),
function(h,p,k,l,v,w,x,q,m,y,r,z,A,t,B,C,D,E,F,G,H,u,n){h=p([u],{declaredClass:"esri.layers.rasterLib.raster.FunctionRaster",rasterFunction:null,sourceType:"Function",constructor:function(a){a&&a.rasterFx&&this._init(a.rasterFx,a.rasterFxArgs)},open:function(){var a=this.getMemberRasters().map(function(a){return a.open()});this.identifiers=this.getMemberRasters().map(function(a){return a._rasterId});var b=new l;(new m(a,null,null,!0)).then(function(a){a.some(function(a){return!a[0]})?b.reject(a):
(this.rasterFunction.bind(),this.rasterInfo=this.rasterFunction.rasterInfo,this.dataType=this.rasterInfo.keyProperties&&this.rasterInfo.keyProperties.DataType||"Generic",this.tileInfo=a[0][1].tileInfo,b.resolve(this))}.bind(this));return b.promise},getProjectedFullExtent:function(a){var b=new l;this.getMemberRasters()[0].getProjectedFullExtent(a).then(k.hitch(this,function(a){this.projectedFullExtent=a;b.resolve(a)}));return b.promise},setProcessingContext:function(a){var b=a;a.layer&&(a=a.layer,
b={id:a.id,rawRasterInfo:a.raster.rasterInfo,glSetting:a._glSetting,xformSetting:a.tileManager&&a.tileManager.xformSetting,useWebGL:a.useWebGL,resampling:a.tileMode&&a.tileManager&&a.tileManager.xformSetting.requireProjection&&!a._hasTilingEffects&&"Thematic"!==a.raster.dataType?1:0,tileMode:a.tileMode});this.rasterFunction.setProcessingContext(b);this._layerOptions=b},alterDefinition:function(a){if(a=a||this.rasterFunction)1===this.memberRasters.length&&!a._bindComplete&&(this.rasterFunction=n.create(a,
{raster:this.memberRasters[0]}))&&(this.rasterFunction.bind(),this.rasterInfo=this.rasterFunction.rasterInfo,this.dataType=this.rasterInfo.keyProperties&&this.rasterInfo.keyProperties.DataType||"Generic",this.rasterFunction.setProcessingContext(this._layerOptions)),this._rasterHandler&&this._rasterHandler._connected&&this.rasterFunction&&this._rasterHandler.setRasterFunction({layerId:this._layerOptions.id,data:this.rasterFunction.toJson(!0)})},setFetchParameters:function(a,b){var d=this.getMemberRasters();
d&&1===d.length&&d[0].setFetchParameters(a,b)},getMemberRasters:function(){this.memberRasters||(this.memberRasters=[],this._getMemberRasters(this.rasterFunction.functionArguments,this.memberRasters));return this.memberRasters},read:function(a){var b=new l(t._dfdCanceller),d;if(a.src)return d=this.rasterFunction.read(a),b.resolve(d),b.promise;var e=this.getMemberRasters().map(function(b){return b.read(a)}),e=new m(e),f,c,g=this.identifiers;b._pendingDfd=e;e.then(k.hitch(this,function(e){if(f=e.some(function(a){return a[0]}))c=
{},e.forEach(function(a,b){c[g[b]]=a[0]?a[1]:null});d=c?this.rasterFunction.read({extent:a.extent,src:c}):null;d.srcData=c;b.resolve(d)}));return b},_init:function(a,b){if(this.rasterFunction=n.create(a,b))this.rasterFunction._bindComplete=!0;else throw"Cannot initialize a function raster without a raster function";},_getMemberRasters:function(a,b){var d=Object.keys(a),e,f,c,g;for(e=0;e<d.length;e++)if(c=a[d[e]])for(g=c instanceof Array?c:[c],f=0;f<g.length;f++)(c=g[f])&&("function"===typeof c||"object"===
typeof c)&&c.read&&(c.functionArguments?this._getMemberRasters(c.functionArguments,b):c.sourceType&&"Function"!==c.sourceType&&(c._identifier=c._getRasterIdentifier(),b.some(function(a){return a._identifier===c._identifier})||b.push(c)));return b}});q("extend-esri")&&k.setObject("layers.rasterLib.raster.FunctionRaster",h,r);return h});