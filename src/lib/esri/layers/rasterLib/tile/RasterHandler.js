// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.
//>>built
define("esri/layers/rasterLib/tile/RasterHandler","require exports module dojo/Deferred dojo/promise/all ../../PixelBlock ../../vectorTiles/core/workers ../../vectorTiles/core/promiseUtils ../../vectorTiles/core/requireUtils ../../vectorTiles/request ../../rasterLib/function/rasterFunctionHelper ../../rasterLib/renderer/rasterRendererHelper".split(" "),function(l,q,m,f,n,g,k,c,p,r,t,u){function h(b){var a=new f;n(b).then(function(d){a.resolve()});return a.promise}return function(){function b(a){this.customModules=
a&&a.customModules}b.prototype.destroy=function(){this.stop();this.customModules=this.rasterLayer=null};b.prototype.start=function(){this.stop();var a=new f,d=0,e=this.customModules?this.customModules.length+1:1,b=p.getAbsMid("esri/layers/rasterLib/tile/RasterWorker",l,m),c=k.open(b,{client:this}).then(function(b){this._connection=b;d++;d===e&&(this._connected=!0,a.resolve())}.bind(this));this._openDL=[c];this.customModules&&this.customModules.forEach(function(b){c=k.open(b,{client:this}).then(function(b){d++;
d===e&&(this._connected=!0,a.resolve())});this._openDL.push(c);console.log(b)}.bind(this));return this._connectionPromise=a.promise};b.prototype.stop=function(){this._openDL?this._openDL.forEach(function(a){a.isFulfilled()||a.cancel()}.bind(this)):this._connectionPromise&&!this._connectionPromise.isFulfilled()&&this._connectionPromise.cancel();this._connection&&(this._connection.close(),this._connection=null)};b.prototype.decode=function(a){if(!this._connectionPromise.isFulfilled()||!this._connection)return c.reject(Error("no connection"));
var b={id:null};return this._connection.invoke("decode",a,[],b).then(function(a){a.targetWorker=b;return a})};b.prototype.process=function(a){if(!this._connectionPromise.isFulfilled()||!this._connection)return c.reject(Error("no connection"));var b={id:null};a.layerId=this.rasterLayer.layerId;var e=new f;this._connection.invoke("process",a,[],b).then(function(a){a.targetWorker=b;a.src?Object.keys(a.src).forEach(function(b){a.src[b].pixelBlock=new g(a.src[b].pixelBlock)}):a.src=null;a.pixelBlock&&
(a.pixelBlock=new g(a.pixelBlock));e.resolve(a)});return e.promise};b.prototype.render=function(a){if(!this._connectionPromise.isFulfilled()||!this._connection)return c.reject(Error("no connection"));var b={id:null};a.layerId=this.rasterLayer.layerId;return this._connection.invoke("render",a,[],b).then(function(a){a.targetWorker=b;a.pixelBlock=a.pixelBlock?new g(a.pixelBlock):null;return a})};b.prototype.setLayer=function(a){if(!this._connectionPromise.isFulfilled()||!this._connection)return c.reject(Error("no connection"));
this.rasterLayer=a;a=this._connection.broadcast("setLayer",a,[],{id:null});return h(a)};b.prototype.setRasterFunction=function(a){if(!this._connectionPromise.isFulfilled()||!this._connection)return c.reject(Error("no connection"));a=this._connection.broadcast("setRasterFunction",a,[],{id:null});return h(a)};b.prototype.setRasterRenderer=function(a){if(!this._connectionPromise.isFulfilled()||!this._connection)return c.reject(Error("no connection"));a=this._connection.broadcast("setRasterRenderer",
a,[],{id:null});return h(a)};return b}()});