// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.
//>>built
define("esri/layers/vectorTiles/views/2d/engine/webgl/GlyphMosaic","require exports dojo/has dojo/promise/all ./Rect ./RectangleBinPack ../../../webgl/Texture".split(" "),function(w,x,q,t,u,p,v){var n;q("stable-symbol-rendering")&&(n=new Set);return function(){function d(c,b,a){this.height=this.width=0;this._dirties=[];this._glyphData=[];this._currentPage=0;this._glyphIndex={};this._textures=[];this._rangePromises=new Map;(0>=c||0>=b)&&console.error("Glyph mosaic width and height must be greater than zero!");
this.width=c;this.height=b;this._glyphSource=a;this._binPack=new p(c-4,b-4);this._glyphData.push(new Uint8Array(c*b));this._dirties.push(!0);this._textures.push(void 0);this._addDecorationGlyph()}d.prototype.getGlyphItems=function(c,b){for(var a=this,r=[],f=this._glyphSource,l=new Set,d=1/256,g=0;g<b.length;g++)l.add(Math.floor(b[g]*d));var h=[];l.forEach(function(b){if(256>=b){var e=c+b;a._rangePromises.has(e)?h.push(a._rangePromises.get(e)):(b=f.getRange(c,b).then(function(){a._rangePromises["delete"](e)}).catch(function(){a._rangePromises["delete"](e);
throw Error("Unable to query resource");}),a._rangePromises.set(e,b),h.push(b))}});return t(h).then(function(d){d=a._glyphIndex[c];d||(d={},a._glyphIndex[c]=d);var e;if(q("stable-symbol-rendering")){n.clear();for(var m=0;m<b.length;m++)e=b[m],n.add(e);var g=[];l.forEach(function(a){g.push(a)});g.sort();e=[];for(m=0;m<g.length;m++)for(var h=g[m],k=0;256>k;++k)e.push(256*h+k)}else e=b;m=0;for(h=e;m<h.length;m++)if(e=h[m],k=d[e]){if(!q("stable-symbol-rendering")||n.has(e))r[e]={rect:k.rect,metrics:k.metrics,
page:k.page}}else if((k=f.getGlyph(c,e))&&k.metrics){var p=a._recordGlyph(k,e);d[e]={rect:p,metrics:k.metrics,tileIDs:null,page:a._currentPage};if(!q("stable-symbol-rendering")||n.has(e))r[e]={rect:p,metrics:k.metrics,page:a._currentPage};a._dirties[a._currentPage]=!0}return r})};d.prototype._recordGlyph=function(c,b){var a=c.metrics;if(0===a.width)a=new u(0,0,0,0);else{b=a.width+6;var d=a.height+6,f=b%4?4-b%4:4,l=d%4?4-d%4:4;1===f&&(f=5);1===l&&(l=5);a=this._binPack.allocate(b+f,d+l);a.isEmpty&&
(this._dirties[this._currentPage]||(this._glyphData[this._currentPage]=null),this._currentPage=this._glyphData.length,this._glyphData.push(new Uint8Array(this.width*this.height)),this._dirties.push(!0),this._textures.push(void 0),this._binPack=new p(this.width-4,this.height-4),a=this._binPack.allocate(b+f,d+l));f=this._glyphData[this._currentPage];c=c.bitmap;var n=l=void 0;if(c)for(var g=0;g<d;g++)for(var l=b*g,n=this.width*(a.y+g+1)+a.x,h=0;h<b;h++)f[n+h+1]=c[l+h]}return a};d.prototype._addDecorationGlyph=
function(){for(var c=[117,149,181,207,207,181,149,117],b=[],a=0;a<c.length;a++)for(var d=c[a],f=0;11>f;f++)b.push(d);c={metrics:{width:5,height:2,left:0,top:0,advance:0},bitmap:new Uint8Array(b)};this._recordGlyph(c,0)};d.prototype.bind=function(c,b,a,d){this._textures[a]||(this._textures[a]=new v(c,{pixelFormat:6406,dataType:5121,width:this.width,height:this.height},new Uint8Array(this.width*this.height)));var f=this._textures[a];f.setSamplingMode(b);this._dirties[a]&&f.setData(this._glyphData[a]);
c.bindTexture(f,d);this._dirties[a]=!1};d.prototype.dispose=function(){this._binPack=null;for(var c=0,b=this._textures;c<b.length;c++){var a=b[c];a&&a.dispose()}this._textures.length=0;this._glyphData.length=0};return d}()});