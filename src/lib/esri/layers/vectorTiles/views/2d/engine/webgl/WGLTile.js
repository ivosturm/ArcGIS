// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.
//>>built
define("esri/layers/vectorTiles/views/2d/engine/webgl/WGLTile","require exports ../../../../core/tsSupport/extendsHelper ../../../../core/libs/gl-matrix/mat2d ../../../../core/libs/gl-matrix/mat4 ../../../../core/libs/gl-matrix/vec2 ../DisplayObject ./definitions ./DirtyMap ./DisplayRecordStore ./enums ./number ./Utils ./WGLBuffers ./WGLDisplayList ./WGLDisplayObject ../../tiling/enums ../../tiling/TileKey".split(" "),function(G,H,v,w,x,t,y,p,z,u,n,A,q,B,C,D,e,E){function F(e,b){return e.sortKey-
b.sortKey}return function(r){function b(a,f){var c=r.call(this)||this;c.status=e.TileStatus.INITIALIZED;c._data=null;c.hlDisplayList=null;c._wglBuffers=null;c._dirtyMap=new z.default;c.coords=[0,0];c.bounds=[0,0,0,0];c.tileTransform={transform:Float32Array[16],screenTransform:Float32Array[16],displayCoord:Float32Array[2],screenCoord:Float32Array[2]};c._hasVisualVariables=!1;c._labelIndex=null;c.tileTransform.screenTransform=w.create();c.tileTransform.transform=x.create();c.tileTransform.displayCoord=
t.create();c.tileTransform.screenCoord=t.create();c.key=E.pool.acquire(a);c.coords[0]=f[0];c.coords[1]=f[3];c.bounds=f;return c}v(b,r);Object.defineProperty(b.prototype,"iconGeometry",{get:function(){return this.getGeometry(n.WGLGeometryType.MARKER)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"textGeometry",{get:function(){return this.getGeometry(n.WGLGeometryType.TEXT)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"fillGeometry",{get:function(){return this.getGeometry(n.WGLGeometryType.FILL)},
enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"lineGeometry",{get:function(){return this.getGeometry(n.WGLGeometryType.LINE)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"labelGeometry",{get:function(){return this.getGeometry(n.WGLGeometryType.LABEL)},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"displayObjects",{get:function(){return this._data.tileDisplayData.displayObjects},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,
"canDisplay",{get:function(){return!!this.attached&&!!this._data},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"isDirty",{get:function(){return this.status===e.TileStatus.MODIFIED},set:function(a){a&&this.status===e.TileStatus.READY?this.setStatus(e.TileStatus.MODIFIED):a||this.status!==e.TileStatus.MODIFIED||this.setStatus(e.TileStatus.READY);this.requestRender()},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"hasData",{get:function(){return this.status===
e.TileStatus.MODIFIED||this.status===e.TileStatus.READY},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"labelIndex",{get:function(){return this._labelIndex},enumerable:!0,configurable:!0});b.prototype.getGeometry=function(a){return this._wglBuffers&&this._wglBuffers.has(a)?this._wglBuffers.get(a):null};b.prototype.getDisplayList=function(a){switch(a){case n.WGLDrawPhase.HIGHLIGHT:return this.hlDisplayList;default:return this._data&&this._data.tileDisplayData.displayList}};Object.defineProperty(b.prototype,
"data",{get:function(){return this._data},enumerable:!0,configurable:!0});b.prototype.setData=function(a,f,c){this._hasVisualVariables=f;a&&a.tileDisplayData?(this._dispRecStore=u.default.fromTileData(a,this._dirtyMap),this._data=a,a.tileBufferData.geometries[4].indexBuffer.length?(this.setStatus(c?e.TileStatus.MODIFIED:e.TileStatus.READY),this._rebuildLabelIndex()):this.setStatus(e.TileStatus.READY),this._dirtyMap.markAllDirty()):(this.clear(),this.setStatus(e.TileStatus.NO_DATA))};b.prototype.patchData=
function(a,f){this._data||(this.setData(a.addOrUpdate,this._hasVisualVariables,f),a.addOrUpdate=null);this._patchData(a)||(this._dirtyMap.markAllDirty(),this._data.reshuffle(),this._dispRecStore=u.default.fromTileData(this._data,this._dirtyMap));a.addOrUpdate.tileBufferData.geometries[4].indexBuffer.length?(this.setStatus(f?e.TileStatus.MODIFIED:e.TileStatus.READY),this._rebuildLabelIndex()):this.setStatus(e.TileStatus.READY)};b.prototype.commitChanges=function(a){this._data&&this.status===e.TileStatus.READY&&
(this._wglBuffers||(this._wglBuffers=new B.default(a.context,this._hasVisualVariables)),this._wglBuffers.upload(this._data.tileBufferData,this._dirtyMap),this._dirtyMap.markAllClean())};b.prototype.setVisibility=function(a,f){for(var c=this._data.tileBufferData.geometries.map(function(a){return{vertexFrom:void 0,vertexTo:void 0,geometry:a}}),b=0;b<a.length;b++)for(var g=a[b],k=0,h=this._data.tileDisplayData.displayObjectRegistry.get(g.id).displayRecords;k<h.length;k++){var d=h[k];if(null==f||f===
d.geometryType){var l=c[d.geometryType],m=l.geometry.vertexBuffer[q.C_VBO_VISIBILITY];if(m){l.vertexFrom=null==l.vertexFrom?d.vertexFrom:Math.min(l.vertexFrom,d.vertexFrom);l.vertexTo=null==l.vertexTo?d.vertexFrom+d.vertexCount:Math.max(l.vertexTo,d.vertexFrom+d.vertexCount);for(var l=d.vertexFrom*m.stride/4,d=d.vertexCount*m.stride/4,n=0;n<d;++n)m.data[l+n]=g.visibility?4294967295:0}}}f=!1;for(a=0;a<c.length;++a)l=c[a],null!=l.vertexFrom&&null!=l.vertexTo&&(f=l.vertexTo?l.vertexTo-l.vertexFrom:0,
this.setStatus(e.TileStatus.MODIFIED),this._dirtyMap.markDirtyVertices(a,q.C_VBO_VISIBILITY,l.vertexFrom,f),f=!0);f&&this.requestRender()};b.prototype.setVisibilityRange=function(a,f,c,b){c=A.i8888to32(c,b,c,b);var g=b=void 0,k=this._data.tileBufferData.geometries[n.WGLGeometryType.LABEL].vertexBuffer[q.C_VBO_VISIBILITY_RANGE];a=this._data.tileDisplayData.displayObjectRegistry.get(a);f=a.metrics[f];var h=f.range.from;for(f=h+f.range.count;h<f;++h){var d=a.displayRecords[h];if(d.geometryType===n.WGLGeometryType.LABEL){b=
null==b?d.vertexFrom:Math.min(b,d.vertexFrom);for(var g=null==g?d.vertexFrom+d.vertexCount:Math.max(g,d.vertexFrom+d.vertexCount),e=d.vertexFrom*k.stride/4,d=d.vertexCount*k.stride/4,m=0;m<d;++m)k.data[e+m]=c}}this._dirtyMap.markDirtyVertices(n.WGLGeometryType.LABEL,q.C_VBO_VISIBILITY_RANGE,b,g?g-b:0)};b.prototype.setStatus=function(a){this.status=a;if(a===e.TileStatus.READY||a===e.TileStatus.NO_DATA)this.attached=!0};b.prototype.clear=function(){this._data=null;this.setStatus(e.TileStatus.INVALID);
this._wglBuffers&&(this._wglBuffers.dispose(),this._wglBuffers=null);this.hlDisplayList&&(this.hlDisplayList=null)};b.prototype.dispose=function(){this.clear()};b.prototype.attach=function(a){return this.canDisplay};b.prototype.detach=function(a){r.prototype.detach.call(this,a)};b.prototype.doRender=function(a){var b=this;this.attached&&(this.commitChanges(a),a.context.setStencilFunction(514,this.stencilRef,255),a.painter.getBrushes(a.drawPhase).forEach(function(c){return c.draw(a,b)}))};b.prototype.buildHLList=
function(a){var b=this;this.hlDisplayList=new C;a.forEach(function(a){b._addToHLDisplayList(b.hlDisplayList,a)})};b.prototype._addToHLDisplayList=function(a,b){if(this._data){var c=this._data.tileDisplayData.displayObjectRegistry.get(b);if(c){b=[];for(var f=0,c=c.displayRecords;f<c.length;f++){var g=c[f].copy();g.meshData=null;g.symbolLevel=0;g.zOrder=0;b.push(g)}b.sort(F);a.addToList(b)}}};b.prototype._rebuildLabelIndex=function(){this._labelIndex=this._initLabelIndex();for(var a=0,b=this.displayObjects;a<
b.length;a++)this._insertIntoLabelIndex(b[a])};b.prototype._insertIntoLabelIndex=function(a){var b=a.anchor;-1!==a.xBucket&&b&&this.labelIndex[a.yBucket][a.xBucket].push(a)};b.prototype._initLabelIndex=function(){for(var a=[],b=0;b<p.TILE_SIZE/p.COLLISION_BUCKET_SIZE;b++){a.push([]);for(var c=0;c<p.TILE_SIZE/p.COLLISION_BUCKET_SIZE;c++)a[b].push([])}return a};b.prototype._patchData=function(a){for(var b=!0,c=0,e=a.remove||[];c<e.length;c++){var g=e[c],k=this._data.tileDisplayData.displayObjectRegistry.get(g);
if(k){this._data.tileDisplayData.displayList.removeFromList(k.displayRecords);for(var h=0,d=k.displayRecords;h<d.length;h++)this._dispRecStore.delete(d[h]);this._data.tileDisplayData.displayObjectRegistry.delete(g);k=this._data.tileDisplayData.displayObjects.indexOf(k);this._data.tileDisplayData.displayObjects.splice(k,1)}}c=0;for(e=a.addOrUpdate&&a.addOrUpdate.tileDisplayData&&a.addOrUpdate.tileDisplayData.displayObjects||[];c<e.length;c++){g=e[c];if(k=this._data.tileDisplayData.displayObjectRegistry.get(g.id)){for(var l=
k.displayRecords.length,h=0;h<l;++h){var d=k.displayRecords[h],m=g.displayRecords[h];if(h>=g.displayRecords.length||d.geometryType!==m.geometryType||d.symbolLevel!==m.symbolLevel||d.zOrder!==m.zOrder||d.materialInfo.materialKey!==m.materialInfo.materialKey)this._dispRecStore.delete(k.displayRecords[h]),h<g.displayRecords.length&&(k.displayRecords[h]=void 0)}k.displayRecords.length=g.displayRecords.length}else k=new D(g.id),this._data.tileDisplayData.displayObjectRegistry.set(g.id,k),this._data.tileDisplayData.displayObjects.push(k);
l=g.displayRecords.length;for(h=0;h<l;++h){m=g.displayRecords[h];(d=k.displayRecords[h])?(d.meshData=m.meshData,d.materialInfo=m.materialInfo):(d=m.copy(),d.vertexFrom=void 0,d.indexFrom=void 0,k.displayRecords[h]=d);var n=a.addOrUpdate.tileBufferData.geometries[m.geometryType],b=this._dispRecStore.setMeshData(d,m,n.vertexBuffer,n.indexBuffer)&&b}}return b};return b}(y)});