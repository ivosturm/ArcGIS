// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.
//>>built
define("esri/layers/vectorTiles/views/2d/engine/webgl/lineMeshUtil","require exports ../../../../core/screenUtils ./color ./LineTess ./MeshData ./number ./TileClipper ./Utils ./visualVariablesUtils".split(" "),function(ha,X,ba,ca,a,da,J,ea,fa,ga){function Y(r,g,h,K,x){"butt"===x?q.buttCap(r,g,h):"round"===x?q.roundCap(r,g,h,K,a.getNumberOfSlices(Math.PI),K===a.CapPosition.START?-1:1):"square"===x?q.squareCap(r,g,h,K):(q.buttCap(r,g,h),console.error("Unknown cap type!"))}function U(a,g,h,q,x,y,F,d,
H,k,C,G){var r=0,c;for(c=0;c<C.vectors.count;++c){var D=C.vectors.items[c].vector[0],A=C.vectors.items[c].vector[1],t=C.vectors.items[c].texCoords[0],v=C.vectors.items[c].texCoords[1],n=C.vectors.items[c].direction[0],p=C.vectors.items[c].direction[1],f=H+r;++r;G.push(J.i1616to32(a,g),F,q,J.i8888to32(Math.round(31*D),Math.round(31*A),Math.round(31*t),Math.round(31*v)),J.i1616to32(h,31*d),J.i1616to32(x[0],x[1]),J.i1616to32(y[0],y[1]),J.i8888to32(Math.round(31*n),Math.round(31*p),0,0));k&&G.push(k.size,
k.color,k.opacity);C.vectors.items[c].base={index:f,point:[a,g]}}return r}function Z(a,g,h){q.bridge(Q,a,g);for(a=0;a<Q.count;++a)g=Q.items[a],h.push(g.v1.base.index,g.v2.base.index,g.v3.base.index)}Object.defineProperty(X,"__esModule",{value:!0});var q=new a.Tessellator({distanceAlongCorrection:!0}),R=new Float32Array(1),V=new Uint32Array(R.buffer),S=[a.allocExtrudeVectors(),a.allocExtrudeVectors()],aa=a.allocExtrudeVectors(),Q=a.allocTriangles(20),W=a.allocTriangles(20),N=new ea.TileClipper(0,0,
0,1,8);N.setExtent(512);X.createLineMeshData=function(r,g,h,K,x,y,F){var d=null!=K?K.spriteMosaicItem:null,H=y.geometry,k=!fa.isPictureSymbol(F)&&F.color?ca.copyAndPremultiply(F.color):[255,255,255,1];K=J.numTo32(r);x=Math.round(x*ba.pt2px(0<F.width?.5*(F.width+1/x):0));F=null!=d;var C=h.vvColor||h.vvOpacity||h.vvSizeMinMaxValue||h.vvSizeScaleStops||h.vvSizeFieldStops||h.vvSizeUnitValue,G=0,M=0,c=0;if(C){c=g.vvFields;G=c.opacity?g.getValue(y,c.opacity):0;M=c.color?g.getValue(y,c.color):0;c=c.size&&
!h.vvSizeScaleStops?g.getValue(y,c.size):0;h.vvSizeUnitValue&&(c=ga.getVisualVariableSizeValueRepresentationRatio(c,g.vvRanges.size.unitValue.valueRepresentation));if(null===c||isNaN(c))c=NaN;if(null===M||isNaN(M))M=NaN;if(null===G||isNaN(G))G=NaN;R[0]=c;c=V[0];R[0]=G;G=V[0];R[0]=M;M=V[0]}g=J.i8888to32(k[0],k[1],k[2],k[3]);h=[0,0];y=[0,0];if(d){var k=d.rect.x,D=d.rect.y,A=d.width,d=d.height;h[0]=k+1;h[1]=D+1;y[0]=k+1+A;y[1]=D+1+d}for(var k=H.rings||H.paths,H=[],D=k.length,A=0,t=!1;A<D;){var v=k[A],
d=[];N.reset(2);var n=v[0][0],p=v[0][1];if(t)N.moveTo(n,p);else{if(-8>n||520<n||-8>p||520<p){t=!0;continue}d.push({x:n,y:p})}for(var f=!1,L=v.length,u=1;u<L;++u)if(n+=v[u][0],p+=v[u][1],t)N.lineTo(n,p);else{if(-8>n||520<n||-8>p||520<p){f=!0;break}d.push({x:n,y:p})}if(f)t=!0;else{if(t){if(t=N.resultWithStarts())for(d=0;d<t.length;d++)H.push(t[d])}else H.push({line:d,start:0});A++;t=!1}}k=0;D=[];A=[];for(t=0;t<H.length;t++)if(p=H[t],d=p.line,!(2>d.length))for(var v=d.length,f=d[0],L=d[v-1],n=L.x-f.x,
f=L.y-f.y,n=1E-6>n*n+f*f,I=p.start%65535,p=S[1],f=void 0,L=C?{size:c,color:M,opacity:G}:null,f=0;f<v;++f){var E=d[f],u=p===S[f%2]?S[(f+1)%2]:S[f%2];if(f<v-1||!n||F){a:{var l=u,m=f,z=d,w=v,T=n,B=z[m],b=[void 0,void 0],e=[void 0,void 0];if(0<m&&m<w-1){var O=z[(m+w-1)%w],P=z[(m+1)%w];a.normalize(b,[B.x-O.x,B.y-O.y]);a.normalize(e,[P.x-B.x,P.y-B.y])}else if(0===m)P=z[(m+1)%w],a.normalize(e,[P.x-B.x,P.y-B.y]),T?(z=z[w-2],a.normalize(b,[B.x-z.x,B.y-z.y])):b=e;else if(m===w-1)O=z[(m+w-1)%w],a.normalize(b,
[B.x-O.x,B.y-O.y]),T?(z=z[1],a.normalize(e,[z.x-B.x,z.y-B.y])):e=b;else{console.error("Vertex index 'i' out of range.");break a}T||0!==m?T||m!==w-1?(m=a.getRads(b,e),m>Math.PI-.05?q.rectJoin(l,b,e):.1>m?.05>m?q.fastMiterJoin(l,b,e):m<a.MITER_SAFE_RADS?q.miterJoin(l,b,e):q.bevelJoin(l,b,e,a.SYSTEM_MAG_LIMIT):(w=a.getNumberOfSlices(m),2.3>m?2>w||.5>m?q.bevelJoin(l,b,e,1):q.roundJoin(l,b,e,w):q.unitRoundJoin(l,b,e,w))):Y(l,b,e,a.CapPosition.END,"round"):Y(l,b,e,a.CapPosition.START,"round")}k+=U(E.x,
E.y,I,g,h,y,K,x,k,L,u,D);if(u.capCenter&&(!n||f!==v-1))for(e=A,q.pie(W,u),b=void 0,b=0;b<W.count;++b)l=W.items[b],e.push(l.v1.base.index,l.v2.base.index,l.v3.base.index);n&&0===f&&!F&&a.copyExtrudeVectors(aa,u)}else a.copyExtrudeVectors(u,aa);0<f&&Z(p,u,A);f<v-1&&(b=d[f+1],e=[b.x-E.x,b.y-E.y],l=a.length(e),e=[e[0]/l,e[1]/l],l=I+l,65535<l?(m=(65535-I)/(l-I),I=E.x+(b.x-E.x)*m,E=E.y+(b.y-E.y)*m,b=p,q.buttCap(b,e,e),k+=U(I,E,65535,g,h,y,r,x,k,L,b,D),q.bridge(Q,u,b),Z(u,b,A),q.buttCap(b,e,e),k+=U(I,E,
0,g,h,y,r,x,k,L,b,D),I=l-65535):(I=l,p=u))}r=new da;r.update({geometry:D},k,A);return r}});