// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.
//>>built
define("esri/tasks/locationproviders/QueryTaskLocationProvider","../../declare dojo/_base/lang dojo/_base/array ../../tasks/query ../../request ../../SpatialReference ./LocationProviderRemoteBase".split(" "),function(p,n,g,q,r,t,u){return p("esri.tasks.locationproviders.QueryTaskLocationProvider",u,{queryTask:null,queryParameters:null,whereFields:null,unicode:!1,maxWhereLength:2E3,constructor:function(){this.queryParameters||(this.queryParameters={})},_getFieldMapping:function(){return this.whereFields},
_init:function(){if(this.queryTask&&this.queryTask.url){var a=this.getInherited(arguments);r({url:this.queryTask.url,callbackParamName:"callback",content:{f:"json"}}).then(n.hitch(this,function(b){this.geometryType=b.geometryType;a.call(this)}))}},_batchWillOverflow:function(a,b){a=g.map(a,function(a){return a.expression}).concat(b.expression);b=this.queryParameters.where?this.queryParameters.where.length+7:0;if(a.join(" OR ").length+b>this.maxWhereLength)return!0},_locateBatch:function(a,b){var f=
g.map(a,function(a){return a.expression}).join(" OR "),d=g.map(this._fields,function(a){return a.outField}),e=this.queryParameters.outFields?d.concat(g.filter(this.queryParameters.outFields,function(a){return-1===g.indexOf(d,a)})):d,h=n.hitch(this,function(b){if(b&&b.features)return b.exceededTransferLimit&&console.warn("exceededTransferLimit"),this._merge(a,b.features,d)}),c=new q;c.where=this.queryParameters.where?this.queryParameters.where+" AND ("+f+")":f;c.outFields=e;c.outSpatialReference=b.outSpatialReference||
new t(4326);c.geometry=this.queryParameters.geometry;c.returnGeometry=!1===this.queryParameters.returnGeometry?!1:!0;c.maxAllowableOffset=this.queryParameters.maxAllowableOffset;return this.queryTask.execute(c).then(h)},_merge:function(a,b,f){for(var d=[],e=0;e<a.length;e++)for(var h=a[e],c=0;c<b.length;c++){var k=b[c],l=this._createKey(k,f);if(h.key===l){for(c=0;c<h.features.length;c++){var m=h.features[c];if(l=k.geometry)m.geometry=l;g.forEach(this.queryParameters.outFields,function(a){m.attributes[a]=
k.attributes[a]});d.push(m)}break}}return d},_createQueryExpression:function(a){for(var b=[],f=0;f<this._fields.length;f++){var d=this._fields[f],e=a.attributes[d.inField];if(void 0!==e&&null!==e)b.push(d.outField+(this.unicode?"\x3dN'":"\x3d'")+this._escape(e)+"'");else return}return 1<b.length?"("+b.join(" AND ")+")":b[0]},_escape:function(a){return"string"===typeof a?a.replace(/'/g,"''"):a}})});