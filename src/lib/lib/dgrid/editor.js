//>>built
define("dgrid/editor","dojo/_base/kernel dojo/_base/lang dojo/_base/array dojo/_base/Deferred dojo/on dojo/aspect dojo/has dojo/query dojo/when ./Grid put-selector/put dojo/_base/sniff".split(" "),function(C,r,D,v,l,m,q,E,F,w,p){function t(a,b){a.value=b;if("radio"==a.type||"checkbox"==a.type)a.checked=a.defaultChecked=!!b}function x(a,b){"number"==typeof b?a=isNaN(a)?a:parseFloat(a):"boolean"==typeof b?a="true"==a?!0:"false"==a?!1:a:b instanceof Date&&(b=new Date(a),a=isNaN(b.getTime())?a:b);return a}
function G(a,b){return"function"==typeof b.get?x(b.get("value")):x(b["checkbox"==b.type||"radio"==b.type?"checked":"value"])}function H(a,b,e,c,d){var g,f,k;if((e&&e.valueOf())!=(c&&c.valueOf())&&(g=b.element,f=b.row,k=b.column,k.field&&f))if(b={grid:a,cell:b,rowId:f.id,oldValue:e,value:c,bubbles:!0,cancelable:!0},d&&d.type&&(b.parentType=d.type),l.emit(g,"dgrid-datachange",b))a.updateDirty?(a.updateDirty(f.id,k.field,c),k.autoSave&&setTimeout(function(){a._trackError("save")},0)):f.data[k.field]=
c;else{var h;(h=g.widget)?(h._dgridIgnoreChange=!0,h.set("value",e),setTimeout(function(){h._dgridIgnoreChange=!1},0)):(h=g.input)&&t(h,e);return e}return c}function u(a,b,e){var c=a.cell(b.domNode||b),d=c.column,g,f;f=a._activeCell;if(!b.isValid||b.isValid())if(e=H(a,c,f?a._activeValue:b._dgridLastValue,G(d,b),e),f?a._activeValue=e:b._dgridLastValue=e,"radio"===b.type&&b.name&&!d.editOn&&d.field)for(g in f=a.row(b),E("input[type\x3dradio][name\x3d"+b.name+"]",a.contentNode).forEach(function(c){var h=
a.row(c);c!==b&&c._dgridLastValue&&(c._dgridLastValue=!1,a.updateDirty?a.updateDirty(h.id,d.field,!1):h.data[d.field]=!1)}),a.dirty)f.id!==g&&a.dirty[g][d.field]&&a.updateDirty(g,d.field,!1)}function y(a){var b=a.editor,e=a.editOn,c=a.grid,d="string"!=typeof b,g,f,k;g=a.editorArgs||{};"function"==typeof g&&(g=g.call(c,a));if(d)f=new b(g),a=f.focusNode||f.domNode,a.className+=" dgrid-input",f.connect(f,e?"onBlur":"onChange",function(){f._dgridIgnoreChange||u(c,this,{type:"widget"})});else if(k=function(a){var h=
a.target;"_dgridLastValue"in h&&-1<h.className.indexOf("dgrid-input")&&u(c,h,a)},a.grid._hasInputListener||(c._hasInputListener=!0,c.on("change",function(a){k(a)})),f=a=p(("textarea"==b?"textarea":"input[type\x3d"+b+"]")+".dgrid-input",r.mixin({name:a.field,tabIndex:isNaN(a.tabIndex)?-1:a.tabIndex},g)),9>q("ie")||q("ie")&&q("quirks"))"radio"==b||"checkbox"==b?l(f,"click",function(a){k(a)}):l(f,"change",function(a){k(a)});return f}function I(a,b){function e(){var a=d._activeCell;k.blur();"function"===
typeof d.focus&&setTimeout(function(){d.focus(a)},g&&9>q("ie")?15:0)}var c=y(a),d=a.grid,g=c.domNode,f=c.domNode||c,k=c.focusNode||f,h=g?function(){c.set("value",c._dgridLastValue)}:function(){t(c,c._dgridLastValue);u(a.grid,c)};l(k,"keydown",function(b){b=b.keyCode||b.which;27==b?(h(),d._activeValue=c._dgridLastValue,e()):13==b&&!1!==a.dismissOnEnter&&e()});(a._editorBlurHandle=l.pausable(c,"blur",function(){var b=f.parentNode,h=b.children.length-1,e={alreadyHooked:!0},k=d.cell(f);l.emit(k.element,
"dgrid-editor-hide",{grid:d,cell:k,column:a,editor:c,bubbles:!0,cancelable:!1});a._editorBlurHandle.pause();b.removeChild(f);if(k.row){for(p(k.element,"!dgrid-cell-editing");h--;)p(b.firstChild,"!");w.appendIfNode(b,a.renderCell(a.grid.row(b).data,d._activeValue,b,d._activeOptions?r.delegate(e,d._activeOptions):e))}d._focusedEditorCell=d._activeCell=d._activeValue=d._activeOptions=null})).pause();return c}function z(a,b,e,c){var d=a.domNode;d||t(a,c);e.innerHTML="";p(e,".dgrid-cell-editing");p(e,
a.domNode||a);d&&!b.editOn?b.grid._editorsPendingStartup.push([a,b,e,c]):A(a,b,e,c)}function A(a,b,e,c){var d=b.grid;a.domNode&&(a._started||a.startup(),a._dgridIgnoreChange=!0,a.set("value",c),setTimeout(function(){a._dgridIgnoreChange=!1},0));a._dgridLastValue=c;d._activeCell&&(d._activeValue=c,l.emit(e,"dgrid-editor-show",{grid:d,cell:d.cell(e),column:b,editor:a,bubbles:!0,cancelable:!1}))}function B(a){for(var b=a._editorsPendingStartup,e=b.length;e--;)A.apply(null,b[e]);a._editorsPendingStartup=
[]}function J(a){function b(a){c.grid._activeCell=d;z(c.editorInstance,c,d,k);c._editTimer=setTimeout(function(){h.focus&&h.focus();c._editorBlurHandle&&c._editorBlurHandle.resume();c._editTimer=null;a.resolve(h)},0)}var e,c,d,g,f,k,h,n;a.column||(a=this.cell(a));if(!a||!a.element)return null;c=a.column;f=c.field;d=a.element.contents||a.element;if(h=c.editorInstance){if(c.grid._activeCell!=d&&(e=a.row,k=(g=this.dirty&&this.dirty[e.id])&&f in g?g[f]:c.get?c.get(e.data):e.data[f],!c.canEdit||c.canEdit(a.row.data,
k)))return n=new v,a=h.domNode||h,a.offsetWidth?(a.blur(),setTimeout(function(){b(n)},0)):b(n),n.promise}else if(c.editor&&(h=d.widget||d.input))return n=new v,h.focus&&h.focus(),n.resolve(h),n.promise;return null}r.getObject("dgrid.editor",!0);return dgrid.editor=function(a,b,e){function c(a){var b=a.grid,c,d;b.edit||(b.edit=J,b._editorsPendingStartup=[],g.push(l(b.domNode,".dgrid-input:focusin",function(){b._focusedEditorCell=b.cell(this)})),c=b._editorFocusoutHandle=l.pausable(b.domNode,".dgrid-input:focusout",
function(){b._focusedEditorCell=null}),g.push(c),g.push(m.before(b,"removeRow",function(a){var e=b._focusedEditorCell;a=b.row(a);e&&e.row.id===a.id&&(d=e,c.pause(),setTimeout(function(){c.resume();d=null},0))})),g.push(m.after(b,"insertRow",function(a){var c=b.row(a);d&&d.row.id===c.id&&b.edit(b.cell(c,d.column.id));return a})),g.push(m.after(b,"renderArray",function(a){F(a,function(a){a.length?B(b):b._editorsPendingStartup=[]});return a})),g.push(m.after(b,"_onNotification",function(){B(b)})))}var d=
a.renderCell||w.defaultRenderCell,g=[],f;a||(a={});a.editor=b=b||a.editor||"text";a.editOn=e=e||a.editOn;f="string"!=typeof b;a.widgetArgs&&(C.deprecated("column.widgetArgs","use column.editorArgs instead","dgrid 0.4"),a.editorArgs=a.widgetArgs);m.after(a,"init",e?function(){c(a);a.editorInstance=I(a,d)}:function(){var b=a.grid;c(a);f&&g.push(m.before(b,"removeRow",function(c){if(c=(c=b.cell(c,a.id).element)&&(c.contents||c).widget)b._editorFocusoutHandle.pause(),c.destroyRecursive()}))});m.after(a,
"destroy",function(){D.forEach(g,function(a){a.remove()});a._editorBlurHandle&&a._editorBlurHandle.remove();a._editTimer&&clearTimeout(a._editTimer);e&&f&&a.editorInstance.destroyRecursive();a.grid.edit=null;a.grid._editorsPendingStartup=null});a.renderCell=e?function(b,c,f,g){var h=a.grid;g&&g.alreadyHooked||l("TD"==f.tagName?f:f.parentNode,e,function(){h._activeOptions=g;h.edit(this)});return d.call(a,b,c,f,g)}:function(b,c,e,g){if(!a.canEdit||a.canEdit(b,c))b=y(a),z(b,a,e,c),e[f?"widget":"input"]=
b;else return d.call(a,b,c,e,g)};return a}});