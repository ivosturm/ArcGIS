// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.
//>>built
define("esri/PopupManager","./geometry/Extent ./geometry/ScreenPoint ./kernel ./layerUtils ./tasks/query dijit/registry dojo/_base/array dojo/_base/declare dojo/_base/Deferred dojo/_base/lang esri/sniff dojo/on dojo/promise/all dojo/Stateful require".split(" "),function(F,y,G,D,H,I,l,q,v,x,E,J,K,L,M){var z;q=q(L,{declaredClass:"esri.PopupManager",enabled:!1,map:null,_mapClickHandle:null,_featureLayersCache:{},constructor:function(a){this._mapClickHandler=x.hitch(this,this._mapClickHandler)},setMap:function(a){if(this.map)if(a!==
this.map)this.unsetMap();else return;this.map=a;this._setupClickHandler()},unsetMap:function(){this.map&&(this.map=null);this._mapClickHandle&&(this._mapClickHandle.remove(),this._mapClickHandle=null)},getMapLayer:function(a){var b;if(a&&(b=a.getLayer())&&(a=b.id,this._featureLayersCache[a])){var c=a.lastIndexOf("_");-1<c&&(a=a.substring(0,c),b=this.map.getLayer(a))}return b},_enabledSetter:function(a){this.enabled=a;this._setupClickHandler()},_setupClickHandler:function(){this._mapClickHandle&&(this._mapClickHandle.remove(),
this._mapClickHandle=null);this.enabled&&this.map&&(this._mapClickHandle=this.map.on("click",this._mapClickHandler))},_mapClickHandler:function(a){var b=this.map.infoWindow,c=a.graphic;b&&this.map.loaded&&(b.clearFeatures&&b.setFeatures?this._showPopup(a):c&&c.getInfoTemplate()&&this._showInfoWindow(c,a.mapPoint))},_showPopup:function(a){var b=this.map,c=b.infoWindow,d=this,g=[],n=[b.graphics].concat(l.map(b.graphicsLayerIds,b.getLayer,b));l.forEach(n,function(a){a&&a.loaded&&a.infoTemplate&&!a.suspended&&
g.push(a)});var p=[];l.forEach(b.layerIds,function(a){(a=b.getLayer(a))&&a.loaded&&!a.suspended&&(d._isImageServiceLayer(a)&&a.infoTemplate?g.push(a):"esri.layers.WMSLayer"===a.declaredClass&&a.getFeatureInfoURL?g.push(a):"esri.layers.ArcGISDynamicMapServiceLayer"!==a.declaredClass&&"esri.layers.ArcGISTiledMapServiceLayer"!==a.declaredClass||!a.infoTemplates||p.push(a))});var q=b.getResolutionForPopup();this._getSubLayerFeatureLayers(p,q).then(function(e){g=g.concat(e);e=a.graphic&&a.graphic.getParentGraphic()||
a.graphic;var f=null;e&&e.getInfoTemplate()&&!d._isImageServiceLayer(e.getLayer())&&(f=e);if(g.length||f){var h=d._calculateClickTolerance(g),n=a.screenPoint;e=b.toMap(new y(n.x-h,n.y+h));var h=b.toMap(new y(n.x+h,n.y-h)),p=new F(e.x,e.y,h.x,h.y,b.spatialReference);if(p=p.intersects(b.extent)){var t=new H,m=!!f,u=!0;e=l.map(g,function(c){t.timeExtent=c.useMapTime?b.timeExtent:null;var g=d._isReductionEnabled(c);c=g?c.getFeatureReductionLayer():c;var e,k=d._featureLayersCache[c.id];if(d._isImageServiceLayer(c))t.geometry=
a.mapPoint,u=!1,e=c.queryVisibleRasters(t,{rasterAttributeTableFieldPrefix:"Raster.",returnDomainValues:!0}),e.addCallback(function(){var a=c.getVisibleRasters();m=m||0<a.length;return a});else if("esri.layers.WMSLayer"===c.declaredClass){e=new v;var h=c._getPopupGraphic(b,a.screenPoint);h?(e.resolve([h]),m=!0):e.resolve([])}else k||"function"===typeof c.queryFeatures&&(0===c.currentMode||1===c.currentMode)?(t.geometry=p,e=c.queryFeatures(t),e.addCallback(function(a){var b=[];l.forEach(a.features,
function(a){a.visible&&(b.push(a),k&&a.setResolution(q))});m=m||0<b.length;return b})):(e=new v,h=l.filter(c.graphics,function(a){return a&&a.visible&&p.intersects(a.geometry)}),g&&d._isParentLayer(c,f)&&(g=d._findGraphicById(h,f,"cluster_id"))&&(f=g),m=m||0<h.length,e.resolve(h));return e});f&&(h=new v,h.resolve([f]),e.unshift(h));l.some(e,function(a){return!a.isFulfilled()})||m?(c.setFeatures(e),c.show(a.mapPoint,{closestFirst:u})):(c.hide(),c.clearFeatures())}}})},_getSubLayerFeatureLayers:function(a,
b,c){b=b||null;var d=c||new v,g=[];c=a.length;var n=this.map.getScale(),p=!1,q=this,e=0;a:for(;e<c;e++){var f=a[e],h=f.dynamicLayerInfos||f.layerInfos;if(h){var A=null;f._params&&(f._params.layers||f._params.dynamicLayers)&&(A=f.visibleLayers);for(var A=D._getVisibleLayers(h,A),y=D._getLayersForScale(n,h),t=h.length,m=0;m<t;m++){var u=h[m],r=u.id,w=f.infoTemplates[r];if(!u.subLayerIds&&w&&w.infoTemplate&&-1<l.indexOf(A,r)&&-1<l.indexOf(y,r)){if(!z){p=!0;break a}var B=f.id+"_"+r,k=this._featureLayersCache[B];
k&&k.loadError||(k||((k=w.layerUrl)||(k=u.source?this._getLayerUrl(f.url,"/dynamicLayer"):this._getLayerUrl(f.url,r)),k=new z(k,{parentLayer:f,id:B,drawMode:!1,mode:z.MODE_SELECTION,outFields:this._getOutFields(w.infoTemplate),resourceInfo:w.resourceInfo,source:u.source}),this._featureLayersCache[B]=k),k.setDefinitionExpression(f.layerDefinitions&&f.layerDefinitions[r]),k.setGDBVersion(f.gdbVersion),k.setInfoTemplate(w.infoTemplate),k.setMaxAllowableOffset(b),k.setUseMapTime(!!f.useMapTime),f.layerDrawingOptions&&
f.layerDrawingOptions[r]&&f.layerDrawingOptions[r].renderer&&k.setRenderer(f.layerDrawingOptions[r].renderer),g.push(k))}}}}if(p){var x=new v;M(["./layers/FeatureLayer"],function(a){z=a;x.resolve()});x.then(function(){q._getSubLayerFeatureLayers(a,b,d)})}else{var C=[];l.forEach(g,function(a){if(!a.loaded){var b=new v;J.once(a,"load, error",function(){b.resolve()});C.push(b.promise)}});C.length?K(C).then(function(){g=l.filter(g,function(a){return!a.loadError&&a.isVisibleAtScale(n)});d.resolve(g)}):
(g=l.filter(g,function(a){return a.isVisibleAtScale(n)}),d.resolve(g))}return d.promise},_getLayerUrl:function(a,b){var c=a.indexOf("?");return-1===c?a+"/"+b:a.substring(0,c)+"/"+b+a.substring(c)},_getOutFields:function(a){var b;a.info&&"esri.dijit.PopupTemplate"===a.declaredClass?(b=[],l.forEach(a.info.fieldInfos,function(a){var c=a.fieldName&&a.fieldName.toLowerCase();c&&"shape"!==c&&0!==c.indexOf("relationships/")&&b.push(a.fieldName)})):b=["*"];return b},_calculateClickTolerance:function(a){var b=
E("esri-touch")?9:6,c,d;l.forEach(a,function(a){if(c=a.renderer)"esri.renderer.SimpleRenderer"===c.declaredClass?((d=c.symbol)&&d.xoffset&&(b=Math.max(b,Math.abs(d.xoffset))),d&&d.yoffset&&(b=Math.max(b,Math.abs(d.yoffset)))):"esri.renderer.UniqueValueRenderer"!==c.declaredClass&&"esri.renderer.ClassBreaksRenderer"!==c.declaredClass||l.forEach(c.infos,function(a){(d=a.symbol)&&d.xoffset&&(b=Math.max(b,Math.abs(d.xoffset)));d&&d.yoffset&&(b=Math.max(b,Math.abs(d.yoffset)))})});return b},_showInfoWindow:function(a,
b){var c=this.map.infoWindow,d=a.geometry;b=d&&"point"===d.type?d:b;d=a.getContent();c.setTitle(a.getTitle());d&&x.isString(d.id)&&(a=I.byId(d.id))&&a.set&&/_PopupRenderer/.test(a.declaredClass)&&a.set("showTitle",!1);c.setContent(d);c.show(b)},_findGraphicById:function(a,b,c){var d,g=(b=b.attributes)&&b[c];l.some(a,function(a){var b=a.attributes;b&&b[c]===g&&(d=a);return!!d});return d},_isParentLayer:function(a,b){b=b&&b.getLayer();return a&&b===a},_isReductionEnabled:function(a){return a&&a.isFeatureReductionActive&&
a.isFeatureReductionActive()},_isImageServiceLayer:function(a){return"esri.layers.ArcGISImageServiceLayer"===a.declaredClass||"esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass}});E("extend-esri")&&(G.PopupManager=q);return q});