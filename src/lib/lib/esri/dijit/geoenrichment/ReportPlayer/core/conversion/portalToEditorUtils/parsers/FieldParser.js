// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/ReportPlayer/core/conversion/portalToEditorUtils/parsers/FieldParser","esri/dijit/geoenrichment/utils/JsonXmlConverter ../../../supportClasses/templateJsonUtils/fieldInfo/RichTextJsonUtil ../../../supportClasses/templateJsonUtils/fieldInfo/FieldInfoBuilder ../../../supportClasses/templateJsonUtils/fieldInfo/FieldInfoFormatUtil ../../ConversionUtil ../../ShapeConverter ../../../annotations/shape/ShapeJsonUtil ./_FieldInfoBuilder ./ImageParser ./MapParser ./AlignParser ../../../../_devConfig".split(" "),
function(q,w,g,x,l,r,y,m,z,t,A,u){function n(a){a=a.attributes||{};x.processFieldInfoTagAttributes(a);return a}function v(a){return q.queryJson(a,/^d$|^text$|^reportName$|^reportTitle2/)}var h={},p={parseImageTrigger:function(a,b){var c=m.getCalculatorOrScriptFieldInfo(a.attributes.field,b);if(!c)return console.log("Parse template error \x3d\x3e can't build fieldInfo for field "+a.attributes.field),console.log(a),null;var d={fieldInfo:c,cases:[]},e=this;a.tags.forEach(function(a){var c="case"===a.name?
a.attributes.key:"default";a=a.tags[0];var f=b.processFileName(a.attributes.value);d.cases.push({compareInfos:e._getCompareInfosFromTriggerKey(c),setters:[{property:a.attributes.property,value:f}]});b.putImageData(f)});return d},parseFieldTrigger:function(a,b,c){b.triggerJson={fieldInfo:c&&m.getCalculatorOrScriptFieldInfo(a.attributes.field,c),cases:[]};var d=this;a.tags.forEach(function(a){var c={compareInfos:d._getCompareInfosFromTriggerKey("case"===a.name?a.attributes.key:"default"),setters:[]};
b.triggerJson.cases.push(c);a.tags.forEach(function(a){c.setters.push({property:a.attributes.property,value:a.attributes.value})})})},_getCompareInfosFromTriggerKey:function(a){return a.split(l.KEY_INTERVAL_SEPARATOR).map(function(a){var b=l.ONE_FIELD_KEY_TEST.test(a)?a.replace(l.KEY_OPERATOR_RE,""):a;a=a.substr(0,a.length-b.length)||"\x3d";return{value:b,operator:a}})}},B={getFieldInfo:function(a,b,c,d){return(a=d.parsers.getParser("chart").portalToEditor(a,b,d))&&g.createFieldInfoFromChart(a)}},
C={getFieldInfo:function(a,b,c,d){return(a=d.parsers.getParser("infographic").portalToEditor(a,b,d))&&g.createFieldInfoFromInfographic(a)}},D={getFieldInfo:function(a,b,c,d){b=z.getElement(a,d);var e;a.tags&&a.tags[0]&&"trigger"===a.tags[0].name&&(e=p.parseImageTrigger(a.tags[0],d));return g.createFieldInfoFromImage(b,e)}},E={getFieldInfo:function(a,b,c,d){a=t.getElement(a,d);return g.createFieldInfoFromMap(a)}},F={getFieldInfo:function(a,b,c,d){b=r.svgJsonToShapeObject(a);c=r.getStylesFromSvgJson(a);
b=y.createShapeJsonFromShapeObj(b,c);a=a.attributes;b.style.angle=Number(a.angle)||0;A.parseAlign(a,b.style);return g.createFieldInfoFromShape(b)}},G={getFieldInfo:function(a,b,c,d){a=d.parsers.getParser("section").parseSection(a,d);return g.createFieldInfoFromSection(a)}},k={getFieldInfo:function(a,b,c,d,e){a=n(a);b=b||a.f;if(e.templateJson.metadata.mapImageInfosHash[b])return b=t.parseMapImageDField(b,e),g.createFieldInfoFromMap(b);var f=g.createFieldInfoFromSpecialFieldName(b,a.m);if(!f){var h;
2===c.tags.length&&c.tags[1].text&&(h=c.tags[1].text);f=m.getCalculatorOrScriptFieldInfo(b,e,{format:a.m,additionalText:h,summaryType:a.summary})}f&&d&&(p.parseFieldTrigger(d,f,e),f.triggerJson&&!f.triggerJson.fieldInfo&&(f.triggerJson.fieldInfo=null,console.log("Parse template error \x3d\x3e can't build fieldInfo for field "+d.attributes.field),console.log(d)));return f}};h.parseField=function(a,b,c,d){var e;if(u.emulateErrors.layoutParseError)throw u.emulateErrors.layoutParseError--,Error("Error test: something crashed during the parsing of the layout!");
if(a){if("chart"===a.name)return B.getFieldInfo(a,b,c,d);if("infographic"===a.name)return C.getFieldInfo(a,b,c,d)||!1;if("img"===a.name&&a.attributes)return D.getFieldInfo(a,b,c,d);if("mapImage"===a.name&&a.attributes)return E.getFieldInfo(a,b,c,d);if("svg"===a.name)return F.getFieldInfo(a,b,c,d);if("section"===a.name)return G.getFieldInfo(a,b,c,d);if("d"===a.name)e=k.getFieldInfo(a,null,b,c,d);else if("a"===a.name&&a.tags&&"d"===a.tags[0].name){var f=a.tags[0];(e=k.getFieldInfo(f,null,b,c,d))&&a.attributes&&
a.attributes.hreff&&(e.linkFieldInfo=k.getFieldInfo(f,a.attributes.hreff,b,c,d))}else e="text"===a.name?g.createFieldInfoFromSpecialFieldName(n(a).name):g.createFieldInfoFromSpecialFieldName(a.name,n(a).m)}if(!e){a=v(b);if(1===a.length&&a[0].attributes&&"TrialUrlText"===a[0].attributes.name)return g.createFieldInfoFromSpecialFieldName(a[0].attributes.name);e=h.parseRichTextTag(b,d)}return e};h.parseRichTextTag=function(a,b){var c,d=v(a);if(d.length){var e=[],f=[],h=!0;d.some(function(d,c){c=d.attributes?
d.attributes.name:d.name;c="d"===d.name?k.getFieldInfo(d,null,a,null,b):c&&g.createFieldInfoFromSpecialFieldName(c);if(!c)return h=!1,!0;"d"===d.name?e.push(c):f.push(c)});h&&(c=w.createFieldInfoFromRichText(q.getInnerHTML(a),e,f))}return c};h.parseFieldTrigger=function(a,b,c){b=b||{};p.parseFieldTrigger(a,b,c);return b.triggerJson};return h});