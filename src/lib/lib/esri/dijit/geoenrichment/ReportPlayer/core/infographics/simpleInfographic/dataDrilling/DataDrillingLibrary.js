// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/ReportPlayer/core/infographics/simpleInfographic/dataDrilling/DataDrillingLibrary","dojo/_base/lang ./_FieldInfoBuilder ../../../supportClasses/tableJson/TableJsonUtil ../../../supportClasses/templateJsonUtils/fieldInfo/FieldInfoNameUtil ../../../../dataProvider/supportClasses/dataCollections/DataCollectionsLoader ./_config ./EnrichUtil".split(" "),function(h,v,w,x,q,g,r){function t(a){return"string"===typeof a?a.split(",").map(function(a){return a+"/"}):a}var e={};
r.ddLibrary=e;e.getDrillingOptions=function(a,c,b){if(c){var d=function(){function k(a,c){return e&&-1!==e.indexOf(a)?!0:d&&d.some(function(b){return-1!==b.indexOf(a)||-1!==b.indexOf(c)})}if("string"===typeof c){var f=g.getById(a+"."+c);return f?[f]:null}var d=c.usedFields||b&&b(c),d=d&&d.map(function(a){return a.toUpperCase()});if(!c.variableID&&!d)return null;var e=c.variableID&&c.variableID.toUpperCase(),f=g.LIBRARY[a],m;for(m in f){var h=m.toUpperCase(),l=x.createFieldNameFromVariable(m).toUpperCase();
if(k(h,l))return f[m]}return null}();d&&d.forEach(function(a){e._provideStateData(a)});return d}};e.getDrillingOptionInfo=function(a,c,b,d,k,f,g){a=(a=e.getDrillingOptions(a,c,g))&&(b?a.filter(function(a){return a.name===b})[0]:a[0]);if(!a)return null;!f&&a.defaultState&&(f=a.defaultState);f=f&&f.charAt(0)||"n";var p;a.calcGroup&&(p=h.clone(a.calcGroup),p.value=f+"/");f=a.stateData[f];d=w.createSingleCellTable({fieldInfo:f.fieldInfo,width:d,height:k});k=a.stateData.n||f;return{name:k.fieldInfo.chartJson&&
k.fieldInfo.chartJson.visualProperties.title.text,calculationStatesGroup:p,tableJson:h.clone(d),enrichInfos:r._getStandardEnrichInfosForTableInfo(a,!0)}};e._provideStateData=function(a){if(!a.stateData){var c=a.states?h.clone(a.fieldInfo):a.fieldInfo;a.stateData={n:{fieldInfo:a.fieldInfo}};a.fieldInfo.isChart&&e._updateChartJsonForState(a.fieldInfo.chartJson,"n",a.stateSettings&&a.stateSettings.n);a.states&&(a.states=t(a.states),a.states.forEach(function(b){b=b.charAt(0);if("n"!==b){var d=h.clone(c);
a.stateData[b]={fieldInfo:d};d.isChart&&e._updateChartJsonForState(d.chartJson,b,a.stateSettings&&a.stateSettings[b])}}),a.calcGroup=e.createCalculationStatesGroup(a.states));for(var b in a.stateData){var d=a.stateData[b];d.fieldInfo.isChart&&d.fieldInfo.chartJson.seriesItems.forEach(function(a){a.points.forEach(function(c){v.provideFieldInfoForChartPoint(c,a,1===d.fieldInfo.chartJson.seriesItems.length,b,d.fieldInfo.chartJson.comparisonInfo&&d.fieldInfo.chartJson.comparisonInfo.calculatorName)})})}delete a.states;
delete a.stateSettings;delete a.fieldInfo}};e._updateChartJsonForState=function(a,c,b){b&&b.title?a.visualProperties.title.text=b&&b.title:"n"!==c&&(a.visualProperties.title.text+=" ("+g.STATE_LOCALIZATION_MAP_SHORT[c]+")");a.visualProperties.yAxis&&(a.visualProperties.yAxis.title=b&&b.yAxisTitle||("n"===c?"":g.STATE_LOCALIZATION_MAP[c]),"i"===c&&(a.visualProperties.yAxis.baseLineValue=100));"n"!==c&&(a.visualProperties.dataLabelsDecimals="p"===c?1:0);"p"===c&&(a.visualProperties.dataLabelsShowValuePercentSymbol=
!0,a.visualProperties.yAxis&&(a.visualProperties.yAxis.showPercentSymbol=!0,a.visualProperties.yAxis.showSymbolForAllLabels=!0));b&&b.isCurrency&&(a.visualProperties.dataLabelsShowValueCurrencySymbol=!0,a.visualProperties.yAxis&&(a.visualProperties.yAxis.showCurrencySymbol=!0,a.visualProperties.yAxis.showSymbolForAllLabels=!0));h.mixin(a.visualProperties,b&&b.visualProps)};e.createCalculationStatesGroup=function(a){if(a)return a=t(a),{states:{ids:a,names:a.slice(),labels:a.map(function(a){return g.STATE_LOCALIZATION_MAP_SHORT[a.charAt(0)]})},
value:a[0]}};var l,u,n;e.init=function(a){if(a&&a.countryID){var c=a.countryID,b=c+";"+(a.hierarchy||"census");if(l&&u===b)return l;u=b;var b=n=n||g.collectSubstitutionVariables(),d={};if(b[c]){if(q.canLoad()){var e=b[c].fields,f=b[c].variables;return l=q.loadVariables({countryID:c,hierarchy:a.hierarchy||"census",outFields:e,forceLowerCase:!0}).then(function(a){var b={fields:e,variables:[]};f.forEach(function(c){var d=a.fullNameToVariableCache[c];d.fullName=c;b.variables.push(d)});d[c]=b}).then(function(){g.replaceSubstitutionVariables(d)})}if(a.variableProvider){var h=
{fields:b[c].fields,variables:[]};d[c]=h;b[c].variables.forEach(function(b){var c=a.variableProvider.getVariableVintage(b);h.variables.push({fullName:b,vintage:c||"N/A"})});g.replaceSubstitutionVariables(d)}}}l=!0};e.getSubstitutionVariables=function(a){return(a=(n=n||g.collectSubstitutionVariables())[a])&&a.variables};return e});