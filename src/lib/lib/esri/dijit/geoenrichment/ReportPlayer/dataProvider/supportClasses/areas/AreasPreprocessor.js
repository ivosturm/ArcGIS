// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/ReportPlayer/dataProvider/supportClasses/areas/AreasPreprocessor","dojo/_base/lang esri/dijit/geoenrichment/when esri/dijit/geoenrichment/promise/all dojo/string esri/graphic esri/symbols/jsonUtils ./FeatureNameUtil ../tasks/EnrichAreasTask esri/dijit/geoenrichment/utils/GeometryUtil esri/dijit/geoenrichment/ReportPlayer/config dojo/i18n!esri/nls/jsapi".split(" "),function(e,h,k,t,u,l,v,m,n,f,p){var q={preprocessAreas:function(b,a){b.analysisAreas=b.analysisAreas.filter(function(a){return a.feature&&
a.feature.geometry&&"polygon"===a.feature.geometry.type||a.geographies&&a.geographies.length||a.buffer});-1!==a.analysisAreasLimit&&(a.analysisAreasLimit=a.analysisAreasLimit||20,b.analysisAreas.length=Math.min(b.analysisAreas.length,a.analysisAreasLimit));q._provideAreasIndexes(b);b.analysisAreas.forEach(function(a){a.feature&&!a.feature.attributes&&(a.feature.attributes={})});b.analysisAreas.forEach(function(a){a.name=a.name||a.shortName;if(!a.name&&a.feature){var b=v.guessFeatureName(a.feature);
b&&(a.name=a.shortName=b)}});return h(w.generalize(b.analysisAreas),function(){return k([x.provideGeographyFeatures(b),y.provideBufferFeatures(b)])})},_provideAreasIndexes:function(b){var a=b.combinedAreasInfo.groups,c=a&&a.length;b.analysisAreas.forEach(function(b,g){b.index=g;a&&(a.forEach(function(a,c){-1!==a.indexes.indexOf(g)&&(b.isGrouped=!0,b.groupIndex=c)}),"number"!==typeof b.groupIndex&&(b.isGrouped=!1,b.groupIndex=c++))})},removeGroupInfo:function(b){b.forEach(function(a){delete a.isGrouped;
delete a.groupIndex})}},w={generalize:function(b){var a=[],c=[];b.forEach(function(b,g){!b.feature||b.geographies&&b.geographies.length||(a.push(b.feature),c.push(g))});return h(function(a){function b(a){var b=0;a.geometry.rings.forEach(function(a){b+=a.length});return b}var c,d,r=n.needGeneralizeGeometry(a,f.generalization.factor,f.generalization.maxVerticesInAllFeatures,f.generalization.numVerticesPerFeature),e;r&&(c=!0,d=[],a=a.map(function(a){d.push(b(a));return new u(a.geometry,a.symbol,a.attributes)}),
e=n.generalizeGeometry(a,r,f.generalization.numVerticesPerFeature,!0));return h(e,function(){c&&(console.log("Generalize features:"),a.forEach(function(a,c){console.log("#"+c+" "+d[c]+" \x3d\x3e "+b(a))}));return a})}(a),function(a){c.forEach(function(c){b[c].feature=a.shift()})})}},x={provideGeographyFeatures:function(b){return k(b.analysisAreas.map(function(a){if(!a.feature&&a.geographies&&a.geographies.length)return(new m).createFeatureForGeographies(a.geographies,{countryID:b.countryID,hierarchy:b.hierarchy}).then(function(b){a.feature=
b;a.name=a.name||a.feature.attributes.StdGeographyName;a.description=a.description||p.geoenrichment.dijit.ReportPlayer.ReportPlayer.geography;a.address=a.address||a.name;a.geographies[0].attributes&&e.mixin(a.feature.attributes,a.geographies[0].attributes);if(b=a.geographies[0].symbol)b=b.toJson?b:l.fromJson(b),a.feature.setSymbol(b)})}))}},y={provideBufferFeatures:function(b){var a=this,c=b.analysisAreas.filter(function(a){return!a.feature&&a.buffer}),e=c.map(function(a){return a.buffer});return(new m).createFeaturesForBuffers(e,
{countryID:b.countryID}).then(function(b){b.forEach(function(b,d){d=c[d];d.feature=b;a._applyBufferParamsToArea(d)})})},_applyBufferParamsToArea:function(b){var a=b.buffer;if(!b.name){var c=p.geoenrichment.dijit.bufferTitle.pointRing;c[a.units]&&(b.name=t.substitute(c[a.units],{radius:a.radius}))}b.description=b.description||"Ring";a.attributes&&e.mixin(b.feature.attributes,a.attributes);if(a=a.symbol)a=a.toJson?a:l.fromJson(a),b.feature.setSymbol(a)}};return q});