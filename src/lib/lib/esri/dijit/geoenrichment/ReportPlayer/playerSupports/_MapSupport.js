// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/ReportPlayer/playerSupports/_MapSupport","require dojo/_base/declare esri/dijit/geoenrichment/Deferred esri/dijit/geoenrichment/when esri/graphic esri/dijit/geoenrichment/utils/CoordinateUtil".split(" "),function(m,n,p,q,k,r){return n(null,{_initBuilderPromise:null,_mapBuilder:null,_initMapBuilder:function(){var e=this;if(this._initBuilderPromise)return this._initBuilderPromise;var a=new p;m(["../core/supportClasses/map/MapBuilder"],function(b){e._mapBuilder=new b({renderMapsFromCalculators:e.isPlayerOnServer,
getPlayerZoomScale:function(a){var b=e.getCurrentReportContainer();return b&&b.getPanelZoomScale?b.getPanelZoomScale(a):b&&b.getZoomInfo&&b.getZoomInfo().scale}});a.resolve()});return this._initBuilderPromise=a.promise},collectMaps:function(e){return this._mapBuilder?e&&e.allAreas?this._mapBuilder.collectAllAreasMaps():this._mapBuilder.collectAreaMaps(this.getCurrentAnalysisAreaIndex()):[]},_resetMapBuilder:function(){this._mapBuilder&&this._mapBuilder.reset()},_createMap:function(e,a){a=a||{};var b,
f={},h=a.areaIndex||0,d=this._reportData;this.isPlayerOnServer&&(d.analysisAreas.forEach(function(c){!c.location&&c.feature.attributes&&c.feature.attributes.STORE_LAT&&c.feature.attributes.STORE_LONG&&(c.location=new k({geometry:{x:c.feature.attributes.STORE_LONG,y:c.feature.attributes.STORE_LAT,spatialReference:{wkid:r.WGS_84_WKID}}}))}),d.combinedAreasInfo.groups&&d.combinedAreasInfo.groups.forEach(function(c){var b=d.analysisAreas[c.indexes[0]];!c.location&&b.location&&(c.location=new k({geometry:b.location.geometry.toJson()}))}));
if(d.isMultiFeature){b=[];var l=d.reverseAnalysisAreasOnMap?d.analysisAreas.slice().reverse():d.analysisAreas;l.forEach(function(c,a){var e=d.reverseAnalysisAreasOnMap?l.length-a-1:a;f[b.length]=e;b.push(c.feature);a=d.combinedAreasInfo.groups;a&&a.length&&a.some(function(b){return-1!==b.indexes.indexOf(e)})||(c.location&&(f[b.length]=e,b.push(c.location)),c.additionalFeatures&&c.additionalFeatures.forEach(function(a){f[b.length]=e;b.push(a)}))});d.combinedAreasInfo.groups&&d.combinedAreasInfo.groups.forEach(function(a){a.location&&
(f[b.length]=a.indexes[0],b.push(a.location),a.location.locationName=a.locationName);a.additionalFeatures&&a.additionalFeatures.forEach(function(c){f[b.length]=a.indexes[0];b.push(c)})})}else{var g=d.analysisAreas[h];b=[g.feature];g.location&&b.push(g.location);g.additionalFeatures&&(b=b.concat(g.additionalFeatures));b.forEach(function(a,b){f[b]=h})}return q(this._initMapBuilder(),function(){this._mapBuilder.setArcgisUrl(d.config.portalUrl);this._mapBuilder.setFallbackMapImageInfos(d.mapImageInfos);
return this._mapBuilder.createMap(e,{features:b,featureIndexToAreaIndexMap:f,analysisAreas:d.analysisAreas,areaIndex:h,defaultBasemapId:this._getDefaultBasemapId()||a.defaultBasemapId,webMapId:a.webMapId,additionalLayerInfos:a.additionalLayerInfos,calculatorFieldName:a.calculatorFieldName,pinSymbolJson:a.pinSymbolJson,areaSymbolJsons:a.areaSymbolJsons,areaSymbolRamp:a.areaSymbolRamp,locatorPointsControllers:a.locatorPointsControllers,stdPolygonsControllers:a.stdPolygonsControllers,thisAreasHighlightController:a.thisAreasHighlightController,
legendController:a.legendController,fieldData:this._viewModel.dynamicReportInfo.fieldData,geClient:this._viewModel.dynamicReportInfo.geClient,countryID:this._viewModel.dynamicReportInfo.countryID,hierarchy:this._viewModel.dynamicReportInfo.hierarchy,waitForLoad:a.waitForLoad,extent:a.extent,attachmentsStore:this._viewModel.dynamicReportInfo.attachmentsStore,onPanContainer:function(a,b){}})}.bind(this))},_getDefaultBasemapId:function(){return null}})});