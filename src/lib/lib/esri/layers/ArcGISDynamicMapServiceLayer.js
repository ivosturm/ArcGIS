// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.
//>>built
define("esri/layers/ArcGISDynamicMapServiceLayer","dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/_base/json dojo/sniff dojo/io-query ../kernel ../config ../lang ../request ../urlUtils ../layerUtils ../geometry/scaleUtils ./DynamicMapServiceLayer ./ArcGISMapServiceLayer ./TimeInfo ./LayerTimeOptions ./ImageParameters ./DynamicLayerInfo ./LayerMapSource".split(" "),function(l,f,h,p,q,v,w,r,x,y,m,k,z,A,B,C,D,t,E,F){l=l([A,B],{declaredClass:"esri.layers.ArcGISDynamicMapServiceLayer",_eventMap:{"visible-layers-change":["visibleLayers"]},
constructor:function(a,b,c){a=b&&b.imageParameters;var g=f.hitch;if(a){var e=a.layerDefinitions;e&&this.setLayerDefinitions(e);a.layerOption===t.LAYER_OPTION_SHOW&&(this.visibleLayers=[].concat(a.layerIds),this.onVisibleLayersChange(this.visibleLayers))}this._setIsPNG32=g(this,this._setIsPNG32);this.dpi=a&&a.dpi||96;this.imageFormat=a&&a.format||"png8";this.imageTransparency=a&&!1===a.transparent?!1:!0;this._setIsPNG32();this.gdbVersion=b&&b.gdbVersion;this._params.gdbVersion=this.gdbVersion;e=a&&
a.layerDefinitions;f.mixin(this._params,this._url.query,{dpi:this.dpi,transparent:this.imageTransparency,format:this.imageFormat},a?a.toJson():{});e&&(this._params.layerDefs=e);this.getImageUrl=g(this,this.getImageUrl);this._initLayer=g(this,this._initLayer);this._load=g(this,this._load);this.useMapImage=b?b.useMapImage:!1;this._loadCallback=b&&b.loadCallback;(b=b&&b.resourceInfo)?this._initLayer(b):void 0!==c&&!1!==c||this._load();this.registerConnectEvents()},disableClientCaching:!1,layerDefinitions:null,
_initLayer:function(a,b){this.inherited(arguments);a.timeInfo&&(this.timeInfo=new C(a.timeInfo));this.loaded=!0;this.onLoad(this);var c=this._loadCallback;c&&(delete this._loadCallback,c(this))},getImageUrl:function(a,b,c,g){var e=this._url.path+"/export",d=this._params,n=d.token=this._getToken(),u=a.spatialReference.wkid||p.toJson(a.spatialReference.toJson()),h=this._errorHandler;delete d._ts;f.mixin(d,{bbox:a.xmin+","+a.ymin+","+a.xmax+","+a.ymax,bboxSR:u,imageSR:u,size:b+","+c},this.disableClientCaching?
{_ts:(new Date).getTime()}:{});d.layerDefs&&(a=k._serializeLayerDefinitions(d.layerDefs,10.5<=this.version),d=f.mixin({},d),delete d.layerDefs,d.layerDefs=a);a=m.addProxy(m.normalize(e)+"?"+v.objectToQuery(f.mixin({},d,{f:"image"})));a.length>r.defaults.io.postLength||this.useMapImage?this._jsonRequest=y({url:e,content:f.mixin(d,{f:"json"}),callbackParamName:"callback",load:function(a){a.imageData?a="data:"+(a.contentType||"image")+";base64,"+a.imageData:(a=a.href,n&&(a+=-1===a.indexOf("?")?"?token\x3d"+
n:"\x26token\x3d"+n),a=m.addProxy(a));g(a)},error:h}):g(a)},_setIsPNG32:function(){var a=this.imageFormat.toLowerCase(),b=q("ie");this.isPNG32=b&&6===b&&("png32"===a||"png24"===a)&&this.imageTransparency},_setTime:function(a){var b=this.timeInfo;a=this._params.time=a?a.toJson().join(","):null;if(10.02>this.version&&b)if(a)this._params.layerTimeOptions=k._serializeTimeOptions(this.layerTimeOptions);else{var c=this.layerInfos;if(c){var g=this.layerTimeOptions,e=g?g.slice(0):[],d=[];h.forEach(c,function(a){a.subLayerIds||
d.push(a.id)});d.length&&(h.forEach(d,function(a){if(!e[a]){var b=new D;b.useTime=!1;e[a]=b}}),this._params.layerTimeOptions=k._serializeTimeOptions(e,d))}}10.02<=this.version&&b&&!a&&!b.hasLiveData&&(this._params.time="null,null")},setDPI:function(a,b){this.dpi=this._params.dpi=a;b||this.refresh(!0)},setImageFormat:function(a,b){this.imageFormat=this._params.format=a;this._setIsPNG32();b||this.refresh(!0)},setImageTransparency:function(a,b){this.imageTransparency=this._params.transparent=a;this._setIsPNG32();
b||this.refresh(!0)},setVisibleLayers:function(a,b){this.visibleLayers=a;this._params.layers=t.LAYER_OPTION_SHOW+":"+(a.length?a.join():"-1");this._updateDynamicLayers();b||this.refresh(!0);this.onVisibleLayersChange(this.visibleLayers)},onVisibleLayersChange:function(){},setDefaultVisibleLayers:function(a){this.visibleLayers=this._defaultVisibleLayers;this._params.layers=null;this._updateDynamicLayers();a||this.refresh(!0);this.onVisibleLayersChange(this.visibleLayers)},setLayerDefinitions:function(a,
b){this.layerDefinitions=a;this._params.layerDefs=a;this._updateDynamicLayers();b||this.refresh(!0)},setDefaultLayerDefinitions:function(a){this.layerDefinitions=this._params.layerDefs=null;this._updateDynamicLayers();a||this.refresh(!0)},setDisableClientCaching:function(a){this.disableClientCaching=a},setLayerTimeOptions:function(a,b){this.layerTimeOptions=a;this._params.layerTimeOptions=k._serializeTimeOptions(a);this._updateDynamicLayers();b||this.refresh(!0)},refresh:function(a){if(a)this.inherited(arguments);
else{var b=this.disableClientCaching;this.disableClientCaching=!0;this.inherited(arguments);this.disableClientCaching=b}},setLayerDrawingOptions:function(a,b){this.layerDrawingOptions=a;this._updateDynamicLayers();b||this.refresh(!0)},setDynamicLayerInfos:function(a,b){a&&0<a.length?(this.dynamicLayerInfos=a,this.visibleLayers=k._getDefaultVisibleLayers(a),this.onVisibleLayersChange(this.visibleLayers)):this.dynamicLayerInfos=this.layerDrawingOptions=null;this._updateDynamicLayers();b||this.refresh(!0)},
createDynamicLayerInfosFromLayerInfos:function(){var a=[],b;h.forEach(this.layerInfos,function(c){b=new E(c.toJson());b.source=new F({mapLayerId:c.id});a.push(b)});return a},_onDynamicLayersChange:function(){},_updateDynamicLayers:function(){if(this.dynamicLayerInfos&&0<this.dynamicLayerInfos.length||this.layerDrawingOptions&&0<this.layerDrawingOptions.length){this.dynamicLayerInfos&&0!==this.dynamicLayerInfos.length||(this.dynamicLayerInfos=this.createDynamicLayerInfosFromLayerInfos());var a;a=this._map&&
z.getScale(this._map);a=this._getDynLayerObjs(a);a=p.toJson(a);this._params.dynamicLayers&&this._params.dynamicLayers.length===a.length&&this._params.dynamicLayers===a||(this._params.dynamicLayers=a,this._onDynamicLayersChange(this._params.dynamicLayers))}else this._params.dynamicLayers?(this._params.dynamicLayers=null,this._onDynamicLayersChange(null)):this._params.dynamicLayers=null},_getDynLayerObjs:function(a){var b=this.dynamicLayerInfos,c=[],g=this.visibleLayers,e=a?k._getLayersForScale(a,b):
g;h.forEach(b,function(a){if(!a.subLayerIds){var b,d=a.id;if(-1!==h.indexOf(g,d)&&-1!==h.indexOf(e,d)){b={id:d,name:a.name};b.source=a.source&&a.source.toJson();var f;this.layerDefinitions&&this.layerDefinitions[d]&&(f=this.layerDefinitions[d]);f&&(b.definitionExpression=f);var k;this.layerDrawingOptions&&this.layerDrawingOptions[d]&&(k=this.layerDrawingOptions[d]);k&&(f=k.toJson(),this._fixMarkerColor(f.renderer),b.drawingInfo=f);var l;this.layerTimeOptions&&this.layerTimeOptions[d]&&(l=this.layerTimeOptions[d]);
l&&(b.layerTimeOptions=l.toJson());b.minScale=a.minScale||0;b.maxScale=a.maxScale||0;c.push(b)}}},this);return c},_fixMarkerColor:function(a){h.forEach(this._getAllSimpleMarkerSymbols(a),function(a){if(!a.color){var b=[0,0,0,0],g=a.outline&&a.outline.color;"esriSMSX"!==a.style&&"esriSMSCross"!==a.style||!g||(b=g.slice(0));a.color=b}})},_getAllSimpleMarkerSymbols:function(a){return h.filter(this._getAllSymbols(a),function(a){return"esriSMS"===a.type})},_getAllSymbols:function(a){var b=[];a&&(b.push(a.symbol),
b.push(a.defaultSymbol),h.forEach(a.uniqueValueInfos||a.classBreakInfos,function(a){b.push(a.symbol)}),b=h.filter(b,x.isDefined));return b},_onExtentChangeHandler:function(a,b,c){c&&this._updateDynamicLayers();this.inherited(arguments)},_setMap:function(a,b,c){this._map=a;this._updateDynamicLayers();return this.inherited(arguments)},onGDBVersionChange:function(){},setGDBVersion:function(a,b){this.gdbVersion=a;this._params.gdbVersion=a;this.onGDBVersionChange();b||this.refresh(!0)},exportMapImage:function(a,
b){var c=f.hitch(this,function(){var c=r.defaults.map,e=a&&a.layerDefinitions;a=a?a.toJson(this.normalization):{};e&&(a.layerDefs=e);a=f.mixin({size:c.width+","+c.height},this._params,a,{f:"json"});delete a._ts;a.layerDefs&&(c=k._serializeLayerDefinitions(a.layerDefs,10.5<=this.version),delete a.layerDefs,a.layerDefs=c);this._exportMapImage(this._url.path+"/export",a,b)});if(this.loaded)c();else this.on("load",c)}});q("extend-esri")&&f.setObject("layers.ArcGISDynamicMapServiceLayer",l,w);return l});