// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.
//>>built
define("esri/layers/SnapshotMode","dojo/_base/declare dojo/_base/lang dojo/has ../kernel ../SpatialReference ../srUtils ../tasks/query ./RenderMode ./support/ParallelSnapshot".split(" "),function(e,f,l,m,t,n,p,q,r){e=e([q],{declaredClass:"esri.layers._SnapshotMode",maxFeatures:5E4,maxRecordCountFactor:1,scaleToTileFactor:1,_isSuspendedAtStartup:!1,_pendingRefresh:!1,constructor:function(a){this.featureLayer=a;this._featureMap={};this._hasUpdateError=this._hasPartialFeatures=!1;this._drawFeatures=
f.hitch(this,this._drawFeatures);this._queryErrorHandler=f.hitch(this,this._queryErrorHandler);this._handleSuccess=f.hitch(this,this._handleSuccess);this._handleError=f.hitch(this,this._handleError);this._handleProgress=f.hitch(this,this._handleProgress)},startup:function(){if(!this._started||this._isSuspendedAtStartup){this.inherited(arguments);var a=this.featureLayer,b=a.reHostedFS.test(a.url);this.pagination=a.queryPagination&&null!=a.maxRecordCount;this._cacheHintSupported=a._isCacheHintSupported();
this.scaleToTileFactor=this._getScaleToTileFactor();b&&this.pagination&&(this._parallelSnapshot=new r({layer:a,mode:this,queryTask:a._task}));this._isSuspendedAtStartup=a.suspended;this._startup()}},propertyChangeHandler:function(a){this._init&&(a?this.featureLayer._collection?console.log("FeatureLayer: layer created by value (from a feature collection) does not support definition expressions and time definitions. Layer id \x3d "+this.featureLayer.id):this._fetchAll():this._applyTimeFilter())},destroy:function(){this._isSuspendedAtStartup=
this._pendingRefresh=!1;this._cancelPendingRequest(this._pendingRequest);this._parallelSnapshot&&this._parallelSnapshot.destroy();this.inherited(arguments)},drawFeature:function(a){var b=a.attributes[this.featureLayer.objectIdField];this._addFeatureIIf(b,a);this._incRefCount(b)},resume:function(){this._isSuspendedAtStartup||this._pendingRefresh?(this._isSuspendedAtStartup=!1,this._startup()):this.propertyChangeHandler(0)},refresh:function(){var a=this.featureLayer;a._collection?(a._fireUpdateStart(),
a._refresh(!0),a._fireUpdateEnd()):this._fetchAll()},hasAllFeatures:function(){return!this._hasPartialFeatures},hasUpdateError:function(){return this._hasUpdateError},canFetchPBF:function(a){return this.inherited(arguments)&&this.featureLayer._canFetchPBFForQuery(a)},_startup:function(){this.featureLayer._collection?this._applyTimeFilter():this._fetchAll()},_fetchAll:function(){var a=this.featureLayer;a._collection||a.suspended||!a.isQueryable()?this._pendingRefresh=a.suspended:(this._pendingRefresh=
!1,a._fireUpdateStart(),this._clearIIf(),this._hasUpdateError=this._hasPartialFeatures=!1,this._parallelSnapshot?this._parallelSnapshot.fetch().then(this._handleSuccess,this._handleError,this._handleProgress):this._sendRequest())},_handleSuccess:function(a){this._hasPartialFeatures=a.hasPartialFeatures;this._hasUpdateError=a.hasUpdateError;this.featureLayer._fireUpdateEnd(null)},_handleError:function(a){this._queryErrorHandler(a)},_handleProgress:function(a){a.isError?this.featureLayer._errorHandler(a.error):
this._addFeatures(a.features)},_getScaleToTileFactor:function(){var a=this.featureLayer.tileMaxRecordCount,b=this.featureLayer.maxRecordCount,c=1;null!=a&&null!=b&&(c=Number((a/b).toFixed(2)));return c},_getPageSize:function(a){var b=this.featureLayer.tileMaxRecordCount,b="tile"===a.resultType&&b?b:this.featureLayer.maxRecordCount;a.maxRecordCountFactor&&(b=Math.floor(b*a.maxRecordCountFactor));return b},_sendRequest:function(a){var b=this.featureLayer,c=this._createQueryInfo(),d=c.query;this.pagination&&
(this._pageSize=this._getPageSize(d),this._start=d.start=null==a?0:a,d.num=this._pageSize);this._pendingRequest&&this._cancelPendingRequest(this._pendingRequest);this._pendingRequest=b._task.execute(d,this._drawFeatures,this._queryErrorHandler,c.pbf?{format:"pbf"}:null)},_drawFeatures:function(a){this._pendingRequest=null;this.featureLayer._isImageService&&10.7>this.featureLayer.version&&void 0===a.exceededTransferLimit&&(a.exceededTransferLimit=a.features.length===this.featureLayer.maxRecordCount);
var b=this.featureLayer,c=a.exceededTransferLimit,d=c&&!b._collection;a=this._checkMaxLimit(a.features);var g=a.maxLimitReached;this._addFeatures(a.features);this.pagination&&d&&!g||(this._hasPartialFeatures=!!c,b._fireUpdateEnd(null,c?{queryLimitExceeded:!0}:null));d&&(this.pagination&&!g&&this._sendRequest(this._start+this._pageSize),b.onQueryLimitExceeded())},_queryErrorHandler:function(a){this._pendingRequest=null;this._hasUpdateError=this._hasPartialFeatures=!0;var b=this.featureLayer;b._errorHandler(a);
b._fireUpdateEnd(a)},_checkMaxLimit:function(a){var b=a?a.length:0,c=this.featureLayer.graphics.length+b,d=c>=this.maxFeatures;if(d){var g=c-this.maxFeatures;g&&a.splice(b-g,g)}return{maxLimitReached:d,featuresDiscarded:c>this.maxFeatures,features:a}},_createQueryInfo:function(){var a=this.featureLayer,b=new p;b.outFields=a.getOutFields();b.where=a.getDefinitionExpression()||"1\x3d1";b.returnGeometry=!0;b.outSpatialReference=n.createSpatialReference(this.map.spatialReference.toJson());b.timeExtent=
a.getTimeDefinition();b.maxAllowableOffset=a._maxOffset;b.quantizationParameters=a._quantizationParameters;b.orderByFields=a.supportsAdvancedQueries?a.getOrderByFields():null;b.multipatchOption=a.multipatchOption;a._ts&&(b._ts=(new Date).getTime());this._cacheHintSupported&&a._enableCacheHint(b);var c=this.canFetchPBF(b);a._enableEditModeQuantization(b,c);this._applyMaxRecordCountFactor(b,c);return{query:b,pbf:c}},_applyMaxRecordCountFactor:function(a,b){var c=this.featureLayer.advancedQueryCapabilities;
this.featureLayer._isCacheHintEnabled(a)&&c&&c.supportsMaxRecordCountFactor&&("tile"!==a.resultType&&1<this.scaleToTileFactor&&(a.maxRecordCountFactor=this.scaleToTileFactor),b&&1<this.maxRecordCountFactor&&(a.maxRecordCountFactor=this.maxRecordCountFactor),5<a.maxRecordCountFactor&&(a.maxRecordCountFactor=5))},_addFeatures:function(a){var b=this.featureLayer,c=b.objectIdField,d=a.length,g=b._selectedFeatures,f=b.mode===b.constructor.MODE_AUTO,e,h,k;b._fireUpdateStart();b._sortFeatures(a);for(b=0;b<
d;b++)h=a[b],k=h.attributes[c],e=this._addFeatureIIf(k,h),this._incRefCount(k),f&&e!==h&&g[k]&&(e.setGeometry(h.geometry),e.setAttributes(h.attributes));this._applyTimeFilter(!0)}});l("extend-esri")&&f.setObject("layers._SnapshotMode",e,m);return e});