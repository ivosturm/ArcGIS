// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.
//>>built
define("esri/layers/rasterLib/function/rasterUtils",["dojo/_base/lang"],function(t){return{mask:function(a,e){if(a&&a.pixels&&a.pixels.length){a=this._clonePixelBlock(a);var d=e.includedRanges,g=e.noDataInterpretation;e=e.noDataValues;if(null===d&&null===e)return a;var f=a.pixels,b=a.mask,h=a.width*a.height,l=f.length,c;if(null!==e&&e.length!==l)throw"expect "+l+" elements in noDataValues";if(null!==d&&d.length!==2*l)throw"expect "+2*l+" elements in IncludeRanges";var q,m,n,p,k;if(null==b){b=new Uint8Array(h);
for(c=0;c<h;c++)b[c]=1;a.mask=b}if(0===g)for(g=0;g<l;g++)if(n=f[g],q=null===d?null:d[2*g],m=null===d?null:d[2*g+1],p=null===e?null:parseFloat(e[g]),null===q||null===m)for(c=0;c<h;c++)b[c]&&(k=n[c],k===p&&(b[c]=0));else if(null===p)for(c=0;c<h;c++)b[c]&&(k=n[c],k<q||k>m)&&(b[c]=0);else for(c=0;c<h;c++)b[c]&&(k=n[c],k<q||k>m||k===p)&&(b[c]=0);else{var r=new Uint8Array(h);for(c=0;c<h;c++)r[c]=b[c];for(g=0;g<l;g++)if(n=f[g],q=null===d?null:d[2*g],m=null===d?null:d[2*g+1],p=null===e?null:parseFloat(e[g]),
null===q||null===m)for(c=0;c<h;c++)r[c]&&(k=n[c],k!==p&&(r=0));else if(null===p)for(c=0;c<h;c++)r[c]&&(k=n[c],k<=q&&k<=m&&(r=0));else for(c=0;c<h;c++)r[c]&&(k=n[c],k<=q&&k<=m&&k!==p&&(r=0));for(c=0;c<h;c++)b[c]&&r[c]&&(b[c]=0)}return a}},calculateStatisticsHistograms:function(a,e){a=this._clonePixelBlock(a);e=a.pixelType;var d=a.pixels,g=a.mask,f=d.length,b,h,l,c,q=[],m,n,p,k,r;for(l=0;l<f;l++){m={min:-.5,max:255.5,size:256,counts:new Uint32Array(256)};n=m.counts;k=d[l];if("U8"===e)if(g)for(c=0;c<
a.width*a.height;c++)g[c]&&n[k[c]]++;else for(c=0;c<a.width*a.height;c++)n[k[c]]++;else{b=a.statistics[l].minValue;h=a.statistics[l].maxValue;m.min=b;m.max=h;h=(h-b)/256;p=new Uint32Array(257);if(g)for(c=0;c<a.width*a.height;c++)g[c]&&p[Math.floor((k[c]-b)/h)]++;else for(c=0;c<a.width*a.height;c++)p[Math.floor((k[c]-b)/h)]++;for(c=0;255>c;c++)n[c]=p[c];n[255]=p[255]+p[256]}q.push(m);b=a.statistics[l].minValue;h=a.statistics[l].maxValue;for(c=p=r=k=0;c<m.size;c++)k+=n[c],r+=c*n[c];r/=k;for(c=0;c<m.size;c++)p+=
n[c]*Math.pow(c-r,2);n=Math.sqrt(p/(k-1));c=(r+.5)*(m.max-m.min)/m.size+m.min;m=n*(m.max-m.min)/m.size;a.statistics[l]={min:b,minValue:b,max:h,maxValue:h,mean:c,stddev:m}}a.histograms=q;return a},buildIndexedColormap:function(a,e){if(!a)return null;var d=0;0>a[0][0]&&(d=a[0][0]);var g=Math.max(256,a[a.length-1][0]-d);if(65536<g)return null;var f=new Uint8Array(4*g),b=[],h=0,l=5===a[0].length;if(e)for(b=a[h],e=b[0]-d;e<g;e++)f[4*e]=b[1],f[4*e+1]=b[2],f[4*e+2]=b[3],f[4*e+3]=l?b[4]:255,e===b[0]-d&&(b=
h===a.length-1?b:a[++h]);else for(e=0;e<a.length;e++)b=a[e],h=4*(b[0]-d),f[h]=b[1],f[h+1]=b[2],f[h+2]=b[3],f[h+3]=l?b[4]:255;return{indexedColormap:f,offset:d,alphaSpecified:l}},colorize:function(a,e){if(null!==a&&null!==a.pixels){a=this._clonePixelBlock(a);var d=a.pixels,g=a.width*a.height,f=a.mask,b=e.indexedColormap,h=e.indexedColormapOffset,l=b&&b.length-1,c=e.indexed2DColormap;e=e.alphaSpecified;if(3<=d.length)throw"colormap only works on single band image";var q=d[0],m=new Uint8Array(q.length),
n=new Uint8Array(q.length),p=new Uint8Array(q.length),k=0;if(b)if(f)for(d=0;d<g;d++)f[d]&&(k=4*(q[d]-h),k<h||k>l?f[d]=0:(m[d]=b[k],n[d]=b[k+1],p[d]=b[k+2],f[d]=b[k+3]));else{f=new Uint8Array(g);for(d=0;d<g;d++)k=4*(q[d]-h),k<h||k>l?f[d]=0:(m[d]=b[k],n[d]=b[k+1],p[d]=b[k+2],f[d]=b[k+3]);a.mask=f}else if(f)for(d=0;d<g;d++)f[d]&&(b=c[q[d]],m[d]=b[0],n[d]=b[1],p[d]=b[2],f[d]=b[3]);else{f=new Uint8Array(g);for(d=0;d<g;d++)b=c[q[d]],m[d]=b[0],n[d]=b[1],p[d]=b[2],f[d]=b[3];a.mask=f}a.pixels=[m,n,p];a.statistics=
null;a.pixelType="U8";a.maskIsAlpha=e;return a}},convolute:function(a,e){a=this._clonePixelBlock(a);var d=a.pixels,g=a.width,f=a.height,b=g*f,h=d.length,l,c,q,m,n,p,k=[],r=[],t=e.normalizedKernel,w=e.kernelRows,v=e.kernelCols,u;for(e=0;e<h;e++){q=d[e];m=new Float32Array(b);m.set(q);for(n=1;n<f-1;n++)for(u=n*g,p=1;p<g-1;p++){for(l=r=0;l<w;l++)for(c=0;c<v;c++)r+=q[u+p+(l-1)*g+c-1]*t[l*v+c];m[u+p]=r}k.push(m)}a.pixels=k;return a},contrastBrightnessStretch:function(a,e){if(null!==a&&null!==a.pixels){a=
this._clonePixelBlock(a);var d=a.pixels,g=a.mask,f=a.width*a.height,b=d.length,h;h=e&&e.contrastOffset;e=e&&e.brightnessOffset;if("U8"!==a.pixelType)throw"the contrast and brightness function only supports 8 bit unsigned integer data";var l=this._createContrastBrightnessLUT(h,e);if(null==g)for(h=0;h<f;h++)for(e=0;e<b;e++)d[e][h]=l[d[e][h]];else for(h=0;h<f;h++)if(g[h])for(e=0;e<b;e++)d[e][h]=l[d[e][h]];a.pixelType="U8";return a}},isNull:function(a,e){if(null!==a&&null!==a.pixels){a=this._clonePixelBlock(a);
e=a.mask;var d=a.pixels[0],g=d.length,f;if(e){for(f=0;f<g;f++)d[f]=e[f]?0:1;a.mask=null}else if(d.fill)d.fill(0);else for(f=0;f<g;f++)d[f]=0;return a}},setNull:function(a){if(null!==e&&null!==e.pixels){var e=this._clonePixelBlock(a);a=e.mask;var d=e.pixels[0],g=d.length,f;a=a||new Uint8Array(g);for(f=0;f<g;f++)a[f]=d[f]?0:1;e.mask=a;return e}},local:function(a,e){if(!e)return a[0];var d=e.rasterCountNeeded;e=e.functor;var g=this._clonePixelBlock(a[0]);if(null!==g&&null!==g.pixels){var f=g.width*g.height,
b;a=(b=a[1])&&b.pixels[0];var h=b&&b.mask,l=g.mask,c=g.pixels[0];if(2===d)if(!l&&h)l=h;else if(l&&h)for(b=0;b<f;b++)l[b]=l[b]&&h[b]?1:0;g.mask=l;if(1===d)if(null==l)for(b=0;b<f;b++)c[b]=e(c[b]);else for(b=0;b<f;b++)l[b]&&(c[b]=e(c[b]));else if(2===d)if(null==l)for(b=0;b<f;b++)c[b]=e(c[b],a[b]);else for(b=0;b<f;b++)l[b]&&(c[b]=e(c[b],a[b]));g.mask=l;g.calculateStatistics();return g}},_clonePixelBlock:function(a){return a.clone?a.clone():t.clone(a)},_createContrastBrightnessLUT:function(a,e){if(this._contrastCache&&
this._contrastCache.contrastOffset===a&&this._contrastCache.brightnessOffset===e)return this._contrastCache.lut;var d=Math.min(Math.max(a,-100),100),g=Math.min(Math.max(e,-100),100),f,b,h=new Uint8Array(256);for(f=0;256>f;f++)0<d&&100>d?b=(200*f-25500+510*g)/(2*(100-d))+128:0>=d&&-100<d?b=(200*f-25500+510*g)*(100+d)/2E4+128:100===d?(b=200*f-25500+256*(100-d)+510*g,b=0<b?255:0):-100===d&&(b=128),h[f]=255<b?255:0>b?0:b;this._contrastCache={contrastOffset:a,brightnessOffset:e,lut:h};return h}}});