// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.
//>>built
define("esri/layers/vectorTiles/views/2d/engine/webgl/mesh/factories/WGLMeshFactory","require exports ../../../../../../core/tsSupport/extendsHelper ../../../../../../core/Error ../../../../../../core/Logger ../../../../../../symbols/SimpleLineSymbol ../../definitions ../../enums ../../MaterialInfo ../../Utils ../../visualVariablesUtils ../../WGLDisplayObject ../VertexVector ../templates/meshTemplateUtils ../templates/WGLLabelTemplate ../templates/WGLLineTemplate ../templates/WGLMarkerTemplate ../../util/Matcher ../../util/serializationUtils ../../util/vvFlagUtils ../../util/Writer".split(" "),
function(I,C,V,A,M,N,r,f,D,E,J,O,n,t,P,Q,K,F,G,x,L){Object.defineProperty(C,"__esModule",{value:!0});var z=M.getLogger("esri.views.2d.engine.webgl.WGLMeshFactory"),R={esriGeometryPoint:"above-center above-left above-right center-center center-left center-right below-center below-left below-right".split(" "),esriGeometryPolygon:["always-horizontal"],esriGeometryPolyline:null,esriGeometryMultipoint:null,esriGeometryEnvelope:null},B=function(){function c(){this._materials=[];this._materialsIndex=new Map}
c.prototype.insert=function(a){var b=this._materials.length;this._materials.push(a);return b};c.prototype._hashGlyph=function(a,b,d){return"G-"+b+"-"+d+"-"+a.page};c.prototype._hashSprite=function(a,b,d){return"S-"+b+"-"+d+"-"+(a?a.page:-1)+"-"+(a?a.sdf:!1)};c.prototype.createSpriteMaterial=function(a,b,d){var e=this._hashSprite(a,b,d);if(this._materialsIndex.has(e))return this._materialsIndex.get(e);var g=this._materials.length;a=D.default.fromSprite(a,b,d);this._materials.push(a);this._materialsIndex.set(e,
g);return g};c.prototype.createGlyphMaterial=function(a,b,d){var e=this._hashGlyph(a,b,d);if(this._materialsIndex.has(e))return this._materialsIndex.get(e);var g=this._materials.length;a=D.default.fromGlyph(a,b,d);this._materials.push(a);this._materialsIndex.set(e,g);return g};c.prototype.get=function(a){return this._materials[a]};c.prototype.serialize=function(a){G.serializeList(a,this._materials);return a};c.deserialize=function(a){var b=new c;b._materials=G.deserializeList(a,D.default);return b};
return c}();C.MaterialStore=B;var S=function(){function c(a){this._bucketSize=a;this._rowsLength=r.TILE_SIZE/a;this._colsLength=r.TILE_SIZE/a;this._grid=this._initGrid()}c.prototype.checkOverlap=function(a,b){a=Math.floor(a/this._bucketSize);b=Math.floor(b/this._bucketSize);if(0>a||a>=this._rowsLength||0>b||b>=this._colsLength||this._grid[b][a])return!0;this._grid[b][a]=!0;return!1};c.prototype.reset=function(){this._grid=this._initGrid()};c.prototype._initGrid=function(){for(var a=[],b=0;b<this._rowsLength;b++)a.push(Array(this._colsLength));
return a};return c}(),T=function(){function c(a,b,d){this.displayObjects=a;this.vertexVectorsMap=b;this._materials=d;this.grid=new S(r.COLLISION_EARLY_REJECT_BUCKET_SIZE)}c.prototype.get=function(a){return this.vertexVectorsMap[a]};c.prototype.pushDisplayObject=function(a){this.displayObjects.push(a)};c.prototype.encode=function(a,b){var d=G.serializeList(new L.default(Uint32Array,this._guessSize()),this.displayObjects).buffer(),e=this._materials.serialize(new L.default(Uint32Array)).buffer(),g={};
b.push(d);b.push(e);for(var c=0;c<this.vertexVectorsMap.length;c++){var h=this.vertexVectorsMap[c];g[c]={};h.transfer(g[c],b)}a.displayObjects=d;a.materialStore=e;a.vertexBuffersMap=g;this.destroy()};c.prototype.destroy=function(){this.displayObjects=this.vertexVectorsMap=null};c.prototype._guessSize=function(){for(var a=this.displayObjects,b=Math.min(a.length,4),d=0,e=0;e<b;e++)d=Math.max(d,a[e].displayRecords.length);return 2*(12*a.length+a.length*d*40)};return c}(),U=function(){function c(){this._vvMap=
new Map}c.prototype.set=function(a,b){this._vvMap.set(a,b)};c.prototype.getValue=function(a,b,d){return this._vvMap.has(a)?this._vvMap.get(a)(b,d):0};return c}();I=function(){function c(a,b,d,e,g,c,h,f,y,m){var q=this;this._labelsDebugTemplate=null;this._matcher=a;this._materials=d;this._geometryType=e;this._idField=g;this._pixelRatio=y;this._vvMap=null;this._vvFlags=h;this._vvBuf=new ArrayBuffer(16);this._vvBufU32=new Uint32Array(this._vvBuf);this._vvBufF32=new Float32Array(this._vvBuf);this._createVVFunctionMap(c,
b,f);m&&(this._validateLabelingInfo(m)?this._labelTemplates=m.map(function(a){return P.default.fromText(q._materials,0,a.symbol,y,a.labelPlacement)}):z.error(new A("mapview-labeling:unsupported-geometry","LabelingInfo failed validation - unable to create labels for layer.")))}c.from=function(a,b,d,e,g,f,h,H){switch(a.type){case "simple":return c._fromSimpleRenderer(a,b,d,e,g,f,h,H);case "unique-value":case "uniqueValue":return c._fromUniqueValueRenderer(a,b,d,e,g,f,h,H);case "class-breaks":case "classBreaks":return c._fromClassBreaksRenderer(a,
b,d,e,g,f,h,H);default:return z.error(new A("mapview-mesh:invalid-renderer","Unable to handle unknown renderer type")),null}};Object.defineProperty(c.prototype,"materials",{get:function(){return this._materials},enumerable:!0,configurable:!0});c.prototype.createMeshData=function(a){var b=Array(5),d=this._matcher.getDefault(),e=!!x.getMarkerVVFlags(this._vvFlags),c=!!x.getFillVVFlags(this._vvFlags),q=!!x.getLineVVFlags(this._vvFlags,"esriGeometryPolyline"!==this._geometryType),h=!!x.getTextVVFlags(this._vvFlags);
!this._labelTemplates&&d&&1===d.length&&d[0]instanceof K.default?(b[f.WGLGeometryType.MARKER]=new n.VertexVectors(f.WGLGeometryType.MARKER,e,a),b[f.WGLGeometryType.FILL]=new n.VertexVectors(f.WGLGeometryType.FILL,c,0),b[f.WGLGeometryType.LINE]=new n.VertexVectors(f.WGLGeometryType.LINE,q,0),b[f.WGLGeometryType.TEXT]=new n.VertexVectors(f.WGLGeometryType.TEXT,h,0),b[f.WGLGeometryType.LABEL]=new n.VertexVectors(f.WGLGeometryType.LABEL,!1,0)):(b[f.WGLGeometryType.MARKER]=new n.VertexVectors(f.WGLGeometryType.MARKER,
e,a),b[f.WGLGeometryType.FILL]=new n.VertexVectors(f.WGLGeometryType.FILL,c,a),b[f.WGLGeometryType.LINE]=new n.VertexVectors(f.WGLGeometryType.LINE,q,a),b[f.WGLGeometryType.TEXT]=new n.VertexVectors(f.WGLGeometryType.TEXT,h,a),b[f.WGLGeometryType.LABEL]=new n.VertexVectors(f.WGLGeometryType.LABEL,!1,this._labelTemplates&&0<this._labelTemplates.length?a:0));return new T([],b,this._materials)};c.prototype.write=function(a,b,d,c,g){var e=1===this._matcher.size()&&this._matcher.getDefault()||this._matcher.match(b,
d),h=b.attributes[this._idField],f=new O(h),y=!!c&&!!this._labelTemplates;this._computeVV(b,d);if(e&&(b.geometry||b.centroid)){d=f.displayRecords;for(var m=0;m<e.length;m++){var l=e[m],k=a.get(l.geometryType);l.writeMesh(d,k,this._geometryType,h,b,this._pixelRatio,this._vvBufU32)}y&&(e=this._getLabelReference(e),this._writeLabelMesh(f,a,h,b,g,c.get(h),e));a.pushDisplayObject(f)}};c.prototype._hasBadLabelClass=function(a,b){var d=a.labelPlacement,c=R[b];if(!c)return z.error(new A("mapview-labeling:unsupported-geometry-type",
"Unable to create labels for WebGL Feature Layer, "+b+" is not supported")),!0;c.some(function(a){return a===d})||(c=c[0],z.warn("Found invalid label placement type "+d+" for "+b+". Defaulting to "+c),a.labelPlacement=c);return!1};c.prototype._validateLabelingInfo=function(a){var b=this;return!a.some(function(a){return b._hasBadLabelClass(a,b._geometryType)})};c.prototype._getLabelReference=function(a){for(var b=0;b<a.length;b++){var d=a[b];if(d instanceof K.default)return d}return null};c.prototype._writeLabelMesh=
function(a,b,d,c,g,f,h){for(var e=a.displayRecords,y=0,m=0,l=-1,k=-1,q=0;q<f.labelingInfo.length;q++){var p=f.labelingInfo[q],u=f.text[q],v=this._labelTemplates[p],n=b.get(v.geometryType),t=g.get(v.symbolId).glyphMosaicItems,x=e.length;v.bindReferenceTemplate(h);if(!v.computeGlyphs(t,u)){t=v.computeAnchor(this._geometryType,c);u=v.bounds;if(-1===l&&(l=Math.floor(t[0]/r.COLLISION_BUCKET_SIZE),k=Math.floor(t[1]/r.COLLISION_BUCKET_SIZE),b.grid.checkOverlap(t[0],t[1])))return;v.writeMesh(e,n,this._geometryType,
d,c,this._pixelRatio,this._vvBufU32);a.anchor=t;a.addMetric(u,x,e.length-x,p);p=u.center;y=Math.max(u.halfWidth+Math.abs(p[0]),y);m=Math.max(u.halfHeight+Math.abs(p[1]),m)}}-1!==l&&(d=2.5*Math.max(y,m),b=Math.ceil(Math.abs((d-a.anchor[0]%r.COLLISION_BUCKET_SIZE)/r.COLLISION_BUCKET_SIZE)),d=Math.ceil(Math.abs((d-a.anchor[1]%r.COLLISION_BUCKET_SIZE)/r.COLLISION_BUCKET_SIZE)),a.xBucket=l,a.yBucket=k,a.xOverflow=b,a.yOverflow=d)};c.prototype._debugLabels=function(a,b,c,e,g){e={geometry:{paths:[[[e[0]+
g.center[0]-g.width/2,e[1]+g.center[1]+g.height/2],[0,-g.height],[g.width,0],[0,g.height],[-g.width,0]]]},attributes:{}};g=this._getLabelDebugTemplate();b=b.get(g.geometryType);g.writeMesh(a,b,"esriGeometryPolyline",c,e,this._pixelRatio,this._vvBufU32)};c.prototype._getLabelDebugTemplate=function(){this._labelsDebugTemplate||(this._labelsDebugTemplate=this._createLabelsDebugTemplate());return this._labelsDebugTemplate};c.prototype._createLabelsDebugTemplate=function(){var a=new N({style:"solid",width:1,
color:[255,0,0,1]});return Q.default.fromSimpleLine(this._materials,0,a,null,this._pixelRatio)};c.prototype._isErrorVV=function(a){return null===a||isNaN(a)||Infinity===a};c.prototype._computeVV=function(a,b){if(!this._vvMap)return 0;var c=this._vvMap.getValue(f.VVType.SIZE,a,b),e=this._vvMap.getValue(f.VVType.COLOR,a,b),g=this._vvMap.getValue(f.VVType.OPACITY,a,b);a=this._vvMap.getValue(f.VVType.ROTATION,a,b);this._vvBufF32[f.VVType.SIZE]=this._isErrorVV(c)?NaN:c;this._vvBufF32[f.VVType.COLOR]=this._isErrorVV(e)?
NaN:e;this._vvBufF32[f.VVType.OPACITY]=this._isErrorVV(g)?NaN:g;this._vvBufF32[f.VVType.ROTATION]=this._isErrorVV(a)?NaN:a;return 0};c.prototype._createVVFunctionMap=function(a,b,c){if(a&&a.length)for(var d=0;d<a.length;d++){var g=a[d],f=E.getVVType(g.type);if(g=this._createGetValueFunction(g,b,c))this._vvMap||(this._vvMap=new U),this._vvMap.set(f,g)}};c.prototype._createGetValueFunction=function(a,b,c){if(E.getVVType(a.type)===f.VVType.SIZE){var d=J.getTypeOfSizeVisualVariable(a);return d===f.WGLVVFlag.SIZE_SCALE_STOPS?
null:this._createNormalizedFunction(a,b,c,d===f.WGLVVFlag.SIZE_UNIT_VALUE&&function(b){return J.getVisualVariableSizeValueRepresentationRatio(b,a.valueRepresentation)})}return this._createNormalizedFunction(a,b,c)};c.prototype._createNormalizedFunction=function(a,b,c,e){var d=a.field;if(d){if("string"===typeof d){var f=a.normalizationField;return f?function(a){if(a.attributes[d]&&a.attributes[f])return a=a.attributes[d]/a.attributes[f],e?e(a):a}:e?function(a){return e(a.attributes[d])}:function(a){return a.attributes[d]}}if("function"===
typeof d)return z.error(new A("mapview-rendering:unsupported-feature","Function field types are not currently supported. Please use a valueExpression instead")),function(a){};z.error(new A("mapview-rendering:invalid-type","The field for a vv must be a string or a number, but got "+typeof d));return function(a){}}if(a.valueExpression&&"$view.scale"!==a.valueExpression)return E.createArcadeFunction({valueExpression:a.valueExpression,spatialReference:c,layer:b},e);z.error("Unable to create a normalized function for visual variable: "+
a);return function(a){}};c._fromSimpleRenderer=function(a,b,d,e,f,q,h,n){var g=a.getSymbols();a=a.visualVariables;var m=x.getVVFlags(a),l=new F.default,k=new B;g.length&&l.setDefault(t.createMeshTemplates([],k,g[0],d,m,h));return new c(l,b,k,e,f,a,m,q,h,n)};c._fromUniqueValueRenderer=function(a,b,d,e,f,q,h,n){var g=a.uniqueValueInfos,m=a.visualVariables,l=x.getVVFlags(m),k=[a.field];a.field2&&k.push(a.field2);a.field3&&k.push(a.field3);for(var w=a.valueExpression,k=new F.MapMatcher(k,a.fieldDelimiter,
w?{valueExpression:w,spatialReference:q,layer:b}:null),w=new B,p=a.backgroundFillSymbol,p=p&&t.createMeshTemplates([],w,p,d,l,h),u=0;u<g.length;u++){var v=g[u],r=t.createMeshTemplates([],w,v.symbol,d,l,h);k.add(v.value,p?p.concat(r):r)}if(a=a.defaultSymbol)d=t.createMeshTemplates([],w,a,d,l,h),k.setDefault(p?p.concat(d):d);return new c(k,b,w,e,f,m,l,q,h,n)};c._fromClassBreaksRenderer=function(a,b,d,f,g,q,h,n){for(var e=a.isMaxInclusive,m=a.visualVariables,l=a.valueExpression,k=a.normalizationField,
w=a.normalizationTotal,p=a.normalizationType,u=x.getVVFlags(m),e=new F.IntervalMatcher(a.field,e,l?{valueExpression:l,spatialReference:q,layer:b}:null,{normalizationField:k,normalizationTotal:w,normalizationType:p}),l=new B,k=(k=a.backgroundFillSymbol)&&t.createMeshTemplates([],l,k,d,u,h,!0),w=0,p=a.classBreakInfos;w<p.length;w++){var v=p[w],r=t.createMeshTemplates([],l,v.symbol,d,u,h);e.add({min:v.minValue,max:v.maxValue},k?k.concat(r):r)}if(a=a.defaultSymbol)d=t.createMeshTemplates([],l,a,d,u,h),
e.setDefault(k?k.concat(d):d);return new c(e,b,l,f,g,m,u,q,h,n)};return c}();C.default=I});