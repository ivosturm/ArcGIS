// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.32/esri/copyright.txt for details.
//>>built
define("esri/layers/vectorTiles/views/2d/tiling/TileInfoView","require exports ../../../geometry/support/spatialReferenceUtils ./LODInfo ./TileCoverage ./TileKey ./TileSpan".split(" "),function(y,z,u,v,w,l,r){var q=new l("0/0/0/0"),x=function(){function d(b,a,c,n,d,f,k,e){this.x=b;this.ymin=a;this.ymax=c;this.invM=n;this.leftAdjust=d;this.rightAdjust=f;this.leftBound=k;this.rightBound=e}d.create=function(b,a){b[1]>a[1]&&(e=[a,b],b=e[0],a=e[1]);e=b[0];b=b[1];var c=a[0];a=a[1];var n=c-e,t=a-b,t=0!==
t?n/t:0,f=(Math.ceil(b)-b)*t,k=(Math.floor(b)-b)*t;return new d(e,Math.floor(b),Math.ceil(a),t,0>n?f:k,0>n?k:f,0>n?c:e,0>n?e:c);var e};d.prototype.incrRow=function(){this.x+=this.invM};d.prototype.getLeftCol=function(){return Math.max(this.x+this.leftAdjust,this.leftBound)};d.prototype.getRightCol=function(){return Math.min(this.x+this.rightAdjust,this.rightBound)};return d}(),g=[[0,0],[0,0],[0,0],[0,0]];return function(){function d(b,a){var c=this;this.tileInfo=b;this.fullExtent=a;this.scales=[];
this._lodInfos=null;this._infoByScale={};this._infoByLevel={};var n=b.lods.slice();n.sort(function(a,b){return b.scale-a.scale});var d=this._lodInfos=n.map(function(c){return v.create(b,c,a)});n.forEach(function(a,b){c._infoByLevel[a.level]=d[b];c._infoByScale[a.scale]=d[b];c.scales[b]=a.scale},this);this._wrap=b.isWrappable}d.prototype.getLODInfoAt=function(b){return this._infoByLevel[b.level]};d.prototype.getTileBounds=function(b,a,c){void 0===c&&(c=!1);q.set(a);return(a=this._infoByLevel[q.level])?
a.getTileBounds(b,q,c):b};d.prototype.getTileCoords=function(b,a,c){void 0===c&&(c=!1);q.set(a);return(a=this._infoByLevel[q.level])?a.getTileCoords(b,q,c):b};d.prototype.getTileCoverage=function(b,a,c){void 0===a&&(a=192);void 0===c&&(c="closest");c="closest"===c?this.getClosestInfoForScale(b.scale):this.getSmallestInfoForScale(b.scale);var n=w.pool.acquire(c),d=this._wrap,f;f=Infinity;var k=-Infinity,e,p,l=n.spans;g[0][0]=g[0][1]=g[1][1]=g[3][0]=-a;g[1][0]=g[2][0]=b.size[0]+a;g[2][1]=g[3][1]=b.size[1]+
a;for(a=0;a<g.length;a++){var h=g[a];b.toMap(h,h);h[0]=c.getColumnForX(h[0]);h[1]=c.getRowForY(h[1])}b=[];h=3;for(a=0;4>a;a++){if(g[a][1]!==g[h][1]){var m=x.create(g[a],g[h]);f=Math.min(m.ymin,f);k=Math.max(m.ymax,k);void 0===b[m.ymin]&&(b[m.ymin]=[]);b[m.ymin].push(m)}h=a}if(null==f||null==k||100<k-f)return null;for(h=[];f<k;){null!=b[f]&&(h=h.concat(b[f]));e=Infinity;p=-Infinity;for(a=h.length-1;0<=a;a--)m=h[a],e=Math.min(e,m.getLeftCol()),p=Math.max(p,m.getRightCol());e=Math.floor(e);p=Math.floor(p);
if(f>=c.first[1]&&f<=c.last[1])if(d)if(c.size[0]<c.worldSize[0])for(m=Math.floor(p/c.worldSize[0]),a=Math.floor(e/c.worldSize[0]);a<=m;a++)l.push(new r(f,Math.max(c.getFirstColumnForWorld(a),e),Math.min(c.getLastColumnForWorld(a),p)));else l.push(new r(f,e,p));else e>c.last[0]||p<c.first[0]||(e=Math.max(e,c.first[0]),p=Math.min(p,c.last[0]),l.push(new r(f,e,p)));f+=1;for(a=h.length-1;0<=a;a--)m=h[a],m.ymax>=f?m.incrRow():h.splice(a,1)}return n};d.prototype.getTileIdAtParent=function(b,a){a=l.pool.acquire(a);
var c=this._infoByLevel[a.level];if(b.resolution<c.resolution)throw Error("Cannot calculate parent tile. destination LOD's resolution "+b.resolution+" is not a parent resolution of "+c.resolution);return b.resolution===c.resolution?a.id:l.getId(b.level,Math.floor(a.row*c.resolution/b.resolution+.01),Math.floor(a.col*c.resolution/b.resolution+.01),a.world)};d.prototype.getTileParentId=function(b){b=l.pool.acquire(b);var a=this._lodInfos.indexOf(this._infoByLevel[b.level])-1;if(0>a)return l.pool.release(b),
null;a=this.getTileIdAtParent(this._lodInfos[a],b);l.pool.release(b);return a};d.prototype.getTileResolution=function(b){return(b=this._infoByLevel[b.level])?b.resolution:-1};d.prototype.getTileScale=function(b){return(b=this._infoByLevel[b.level])?b.scale:-1};d.prototype.intersects=function(b,a){var c=l.pool.acquire(a);a=this._infoByLevel[c.level];var d=b.lodInfo;if(d.resolution>a.resolution){var g=l.pool.acquire(this.getTileIdAtParent(d,c)),f=d.denormalizeCol(g.col,g.world);a=b.spans.some(function(a){return a.row===
g.row&&a.colFrom<=f&&a.colTo>=f});l.pool.release(c);l.pool.release(g);return a}if(d.resolution<a.resolution){var k=b.spans.reduce(function(a,b){a[0]=Math.min(a[0],b.row);a[1]=Math.max(a[1],b.row);a[2]=Math.min(a[2],b.colFrom);a[3]=Math.max(a[3],b.colTo);return a},[Infinity,-Infinity,Infinity,-Infinity]);b=k[0];var e=k[1],p=k[2],k=k[3],q=a.denormalizeCol(c.col,c.world),h=d.getColumnForX(a.getXForColumn(q)),m=d.getRowForY(a.getYForRow(c.row)),q=d.getColumnForX(a.getXForColumn(q+1))-1;a=d.getRowForY(a.getYForRow(c.row+
1))-1;l.pool.release(c);return!(h>k||q<p||m>e||a<b)}var r=d.denormalizeCol(c.col,c.world);a=b.spans.some(function(a){return a.row===c.row&&a.colFrom<=r&&a.colTo>=r});l.pool.release(c);return a};d.prototype.normalizeBounds=function(b,a,c){b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];this._wrap&&(a=u.getInfo(this.tileInfo.spatialReference),c=-c*(a.valid[1]-a.valid[0]),b[0]+=c,b[2]+=c);return b};d.prototype.getSmallestInfoForScale=function(b){var a=this.scales;if(this._infoByScale[b])return this._infoByScale[b];
if(b>a[0])return this._infoByScale[a[0]];for(var c=1;c<a.length-1;c++)if(b>a[c]+1E-6)return this._infoByScale[a[c-1]];return this._infoByScale[a[a.length-1]]};d.prototype.getClosestInfoForScale=function(b){var a=this.scales;this._infoByScale[b]||(b=a.reduce(function(a,d,g,f){return Math.abs(d-b)<Math.abs(a-b)?d:a},a[0]));return this._infoByScale[b]};return d}()});